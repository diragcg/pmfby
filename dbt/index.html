<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>संचालनालय कृषि छत्तीसगढ़</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Noto Sans', 'Noto Sans Devanagari', sans-serif;
            background-color: #f8f9fa;
        }
        .hindi { font-family: 'Noto Sans Devanagari', 'Noto Sans', sans-serif; }
        .header { background: #1B5E20; color: white; padding: 20px 0; }
        .nav-bar { background: white; padding: 10px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .cards { padding: 40px 0; }
        .card { border: none; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .footer { background: #e8f5e8; padding: 20px 0; margin-top: 40px; }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h2 class="hindi mb-0">संचालनालय कृषि छत्तीसगढ़</h2>
                    <p class="hindi mb-0">कृषि विकास एवं किसान कल्याण विभाग</p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-light hindi" data-bs-toggle="modal" data-bs-target="#loginModal">लॉगिन करें</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <div class="nav-bar">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <nav class="navbar navbar-expand-lg">
                        <div class="navbar-nav mx-auto">
                            <a class="nav-link hindi" href="#">होम</a>
                            <a class="nav-link hindi" href="#" onclick="openLogin('dbt')">DBT</a>
                            <a class="nav-link hindi" href="#" onclick="openLogin('pmfby')">PMFBY</a>
                            <a class="nav-link hindi" href="#" onclick="openLogin('store')">Store</a>
                            <a class="nav-link hindi" href="#" onclick="openLogin('gem')">GeM</a>
                            <a class="nav-link hindi" href="#" onclick="openLogin('admin')">Admin</a>
                        </div>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Cards -->
    <div class="cards">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <i class="fas fa-file-invoice fa-3x text-success mb-3"></i>
                            <h5 class="hindi">DBT</h5>
                            <p class="hindi">प्रत्यक्ष लाभ हस्तांतरण</p>
                            <button class="btn btn-success hindi" onclick="openLogin('dbt')">प्रवेश करें</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <i class="fas fa-seedling fa-3x text-success mb-3"></i>
                            <h5 class="hindi">PMFBY</h5>
                            <p class="hindi">फसल बीमा योजना</p>
                            <button class="btn btn-success hindi" onclick="openLogin('pmfby')">प्रवेश करें</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <i class="fas fa-store fa-3x text-success mb-3"></i>
                            <h5 class="hindi">Store</h5>
                            <p class="hindi">स्टोर प्रबंधन</p>
                            <button class="btn btn-success hindi" onclick="openLogin('store')">प्रवेश करें</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title hindi" id="modalTitle">लॉगिन करें</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label class="form-label hindi">उपयोगकर्ता नाम</label>
                            <input type="text" class="form-control" id="username" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label hindi">पासवर्ड</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label hindi">जिला</label>
                            <select class="form-control" id="district" required>
                                <option value="">-- जिला चुनें --</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-success w-100 hindi">लॉगिन करें</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h6 class="hindi">संपर्क करें</h6>
                    <p class="hindi">संचालनालय कृषि, छत्तीसगढ़</p>
                </div>
                <div class="col-md-6">
                    <h6 class="hindi">त्वरित लिंक</h6>
                    <a href="#" class="hindi text-decoration-none">होम</a><br>
                    <a href="#" class="hindi text-decoration-none">सेवाएं</a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Simple and working code
        const { createClient } = supabase;
        const supabaseClient = createClient(
            'https://txjbfqrbbtvzlxpeegkv.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4amJmcXJiYnR2emx4cGVlZ2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMTU2NTQsImV4cCI6MjA2ODY5MTY1NH0.sE5UbwEOSnd9ED-k_Ix5OfdZbf7dmwlHZSjQQrEAyCo'
        );

        let currentPortal = '';

        // Load districts - WORKING VERSION
        async function loadDistricts() {
            try {
                const { data, error } = await supabaseClient
                    .from('districts')
                    .select('id, name')
                    .order('name');

                const select = document.getElementById('district');
                select.innerHTML = '<option value="">-- जिला चुनें --</option>';

                if (data && data.length > 0) {
                    data.forEach(district => {
                        const option = document.createElement('option');
                        option.value = district.id;
                        option.textContent = district.name;
                        select.appendChild(option);
                    });
                    console.log('✅ Districts loaded:', data.length);
                } else {
                    // Fallback districts
                    const fallback = [
                        {id: '1', name: 'Raipur'},
                        {id: '2', name: 'Bilaspur'},
                        {id: '3', name: 'Durg'},
                        {id: '4', name: 'Korba'}
                    ];
                    fallback.forEach(district => {
                        const option = document.createElement('option');
                        option.value = district.id;
                        option.textContent = district.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('District loading failed:', error);
                // Add fallback districts
                const select = document.getElementById('district');
                const fallback = [
                    {id: '1', name: 'Raipur'},
                    {id: '2', name: 'Bilaspur'},
                    {id: '3', name: 'Durg'},
                    {id: '4', name: 'Korba'}
                ];
                fallback.forEach(district => {
                    const option = document.createElement('option');
                    option.value = district.id;
                    option.textContent = district.name;
                    select.appendChild(option);
                });
            }
        }

        // Open login modal
        function openLogin(portal) {
            currentPortal = portal;
            document.getElementById('modalTitle').textContent = portal.toUpperCase() + ' - लॉगिन';
            const modal = new bootstrap.Modal(document.getElementById('loginModal'));
            modal.show();
        }

        // Handle login - FIXED VERSION
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const district = document.getElementById('district').value;
        
            if (!username || !password || !district) {
                alert('सभी फील्ड भरें');
                return;
            }
        
            console.log('🔍 Login attempt:', { username, portal: currentPortal });
        
            try {
                // First, let's see what users exist
                const { data: allUsers, error: fetchError } = await supabaseClient
                    .from('test_users')
                    .select('*');
        
                console.log('📊 All users in database:', allUsers);
        
                if (fetchError) {
                    console.error('Database fetch error:', fetchError);
                    alert('डेटाबेस कनेक्शन में समस्या');
                    return;
                }
        
                // Find matching user
                const user = allUsers.find(u => {
                    console.log('Checking user:', {
                        db_username: u.username,
                        input_username: username,
                        username_match: u.username === username,
                        db_password: u.password,
                        input_password: password,
                        password_match: u.password === password,
                        db_portal: u.portal_access,
                        current_portal: currentPortal,
                        portal_match: u.portal_access === currentPortal || u.portal_access === 'all',
                        status: u.status,
                        status_active: u.status === 'active'
                    });
        
                    return u.username === username && 
                           u.password === password && 
                           (u.portal_access === currentPortal || u.portal_access === 'all') &&
                           u.status === 'active';
                });
        
                console.log('🎯 Found user:', user);
        
                if (user) {
                    alert(`स्वागत ${user.name}!`);
                    localStorage.setItem('user', JSON.stringify({
                        ...user,
                        district: district,
                        portal: currentPortal
                    }));
                    window.location.href = 'dashboard.html';
                } else {
                    alert('गलत लॉगिन जानकारी या पोर्टल एक्सेस नहीं है');
                }
        
            } catch (error) {
                console.error('❌ Login error:', error);
                alert('लॉगिन में त्रुटि: ' + error.message);
            }
        });


        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadDistricts();
        });
    </script>
</body>
</html>
