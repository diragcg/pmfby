<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>विकसित कृषि संकल्प अभियान द्वितीय चरण - संचलनालय कृषि छत्तीसगढ़</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- IMPORTANT: Make sure your existing CSS files (e.g., custom.css, dashboard.css, etc.) are linked here -->
    <!-- For example: -->
    <!-- <link rel="stylesheet" href="path/to/your/custom.css"> -->
    <!-- <link rel="stylesheet" href="path/to/your/dashboard.css"> -->
    <!-- <link rel="stylesheet" href="path/to/your/swiper-bundle.min.css"> -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script type="module" src="./supabase-config.js"></script>
    <style>
        /* General & Layout */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Mangal', 'Noto Sans Devanagari', sans-serif; background: url('https://github.com/diragcg/pmfby/blob/main/images/warli-art-1.svg?raw=true') no-repeat center center fixed; background-size: cover; min-height: 100vh; position: relative; }
        body::before { content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.3); z-index: -1; }
        .page-loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); display: flex; justify-content: center; align-items: center; z-index: 10000; backdrop-filter: blur(5px); }
        .page-loading .spinner { width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; }
        .page-loading .loading-text { margin-left: 15px; font-size: 18px; color: #007bff; font-weight: 600; }

        /* Admin Toolbar */
        .admin-toolbar { background: linear-gradient(135deg, #dc3545, #c82333); color: white; padding: 10px 20px; margin: 10px 20px 0 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3); display: none; align-items: center; gap: 15px; backdrop-filter: blur(10px); }
        .admin-toolbar.show { display: flex; }
        .admin-toolbar h3 { font-size: 16px; font-weight: 600; margin-right: auto; }
        .admin-btn { background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.3); color: white; padding: 8px 15px; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-size: 14px; display: flex; align-items: center; gap: 5px; }
        .admin-btn:hover { background: rgba(255, 255, 255, 0.3); transform: translateY(-2px); }

        /* Header Strip */
        .header-strip { background: rgba(204, 206, 206, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid #e9ecef; padding: 15px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin: 20px 20px 0 20px; border-bottom-left-radius: 15px; border-bottom-right-radius: 15px; }
        .header-container { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        .logo-section { display: flex; align-items: center; gap: 15px; }
        .cg-logo { height: 60px; width: auto; }
        .logo-text h1 { font-size: 24px; font-weight: 600; color: #2c3e50; margin-bottom: 5px; font-family: 'Mangal', 'Noto Sans Devanagari', sans-serif; }
        .logo-text p { font-size: 14px; color: #6c757d; font-weight: 400; font-family: 'Mangal', 'Noto Sans Devanagari', sans-serif; }
        .user-section { display: flex; align-items: center; gap: 15px; }
        .user-info { background: linear-gradient(135deg, #e8f5e8, #f0f8f0); color: #b8860b; padding: 12px 18px; border-radius: 12px; box-shadow: 0 2px 8px rgba(184, 134, 11, 0.2); transition: all 0.3s ease; border: 1px solid rgba(184, 134, 11, 0.3); min-width: 200px; }
        .user-info:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(184, 134, 11, 0.3); }
        .user-display { font-weight: 600; font-size: 14px; color: #b8860b; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); text-align: center; }

        /* Navigation Bar */
        .navbar { background: rgba(52, 58, 64, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid #dee2e6; border-bottom-left-radius: 15px; border-bottom-right-radius: 15px; margin: 0 20px; position: relative; z-index: 1000; }
        .nav-container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .nav-menu { display: flex; list-style: none; margin: 0; padding: 0; align-items: center; }
        .nav-item { position: relative; }
        .nav-link { display: flex; align-items: center; padding: 15px 20px; color: #ffffff; text-decoration: none; font-size: 14px; font-weight: 500; transition: all 0.2s; gap: 8px; font-family: 'Mangal', 'Noto Sans Devanagari', sans-serif; border-radius: 8px; }
        .nav-link:hover, .nav-link.active { background: #037af1; border-radius: 12px; padding: 12px 20px; }
        .nav-link:focus { outline: 2px solid #037af1; outline-offset: 2px; background: #037af1; }
        .nav-link i { font-size: 14px; }
        .dropdown { position: relative; }
        .dropdown-content { display: none; position: absolute; top: 100%; left: 0; background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); min-width: 250px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); border-radius: 8px; z-index: 9999; border: 1px solid #dee2e6; max-height: 400px; overflow-y: auto; }
        .dropdown:hover .dropdown-content, .dropdown:focus-within .dropdown-content { display: block; }
        .dropdown-category { padding: 8px 16px; background: #f8f9fa; font-weight: 600; color: #495057; font-size: 12px; text-transform: uppercase; border-bottom: 1px solid #dee2e6; }
        .dropdown-item { display: block; padding: 12px 16px; color: #2c3e50; text-decoration: none; font-size: 14px; transition: background-color 0.2s; border-bottom: 1px solid #f8f9fa; }
        .dropdown-item:hover, .dropdown-item:focus { background: #0480fc; color: white; outline: none; }
        .dropdown-item:last-child { border-bottom: none; }
        .profile-link, .logout-link { margin-left: auto; }
        .logout-link { background: #dc3545; border-radius: 12px; padding: 12px 20px !important; }
        .logout-link:hover, .logout-link:focus { background: #c82333 !important; outline: 2px solid #dc3545; outline-offset: 2px; }
        .profile-link:hover, .profile-link:focus { background: #28a745; border-radius: 8px; padding: 12px 12px; outline: 2px solid #28a745; outline-offset: 2px; }

        /* Main Content & Form Specific Styles */
        .main-content { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(8px); margin: 20px; border-radius: 15px; padding: 30px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); min-height: calc(100vh - 200px); /* Adjust based on header/navbar height */ }
        
        /* Green Strip for Title */
        .green-title-strip {
            background: linear-gradient(90deg, #28a745, #218838); /* Green gradient */
            color: white;
            padding: 15px 20px;
            margin: -30px -30px 20px -30px; /* Adjust to cover full width of content-card */
            border-radius: 15px 15px 0 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Allow wrapping on small screens */
        }
        .page-title-content { 
            font-size: 24px; font-weight: 700; color: white; margin-bottom: 5px; text-align: left; font-family: 'Mangal', 'Noto Sans Devanagari', sans-serif; flex-grow: 1;
        }
        .page-subtitle-date {
            font-size: 18px; color: white; margin-bottom: 0; text-align: right; font-family: 'Mangal', 'Noto Sans Devanagari', sans-serif;
            display: flex; /* For date picker alignment */
            align-items: center;
            gap: 10px;
        }
        .page-subtitle-date input[type="date"] {
            padding: 5px 10px;
            border-radius: 5px;
            border: 1px solid rgba(255,255,255,0.5);
            background: rgba(255,255,255,0.2);
            color: white;
            font-family: 'Mangal', sans-serif;
            font-size: 14px;
            cursor: pointer;
        }
        .page-subtitle-date input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1); /* Make calendar icon white */
        }
        .page-subtitle-date #rptButton {
            background: #007bff; /* Blue background */
            border: 1px solid #0056b3;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-family: 'Mangal', sans-serif;
            margin-left: 10px; /* Space from date input */
        }
        .page-subtitle-date #rptButton:hover {
            background: #0056b3;
        }
        .page-subtitle-date #displayedDate {
            background: #FFD700; /* Bright Yellow background */
            color: #2c3e50; /* Dark text for contrast */
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: 600;
        }

        .content-card { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(8px); border-radius: 15px; padding: 35px 25px; box-shadow: 0 6px 20px rgba(0,0,0,0.12); border: 1px solid rgba(255, 255, 255, 0.3); }
        
        /* Form Styling */
        .form-section-title {
            font-size: 18px;
            font-weight: 600;
            color: #0056b3;
            margin-top: 25px;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(0, 86, 179, 0.2);
        }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #28a745; /* Legal Green */ font-weight: 500; font-family: 'Mangal', 'Noto Sans Devanagari', sans-serif; font-size: 14px; }
        .form-group input, .form-group textarea, .form-group select { 
            width: 100%; padding: 12px; border: 2px solid rgba(0, 0, 0, 0.1); border-radius: 8px; font-size: 14px; 
            font-family: 'Mangal', 'Noto Sans Devanagari', sans-serif; 
            background: #E0F2D6; /* Lighter Pistachio Green Background */ 
            color: #2c3e50; transition: all 0.3s; 
        }
        .form-group input::placeholder, .form-group textarea::placeholder { color: rgba(44, 62, 80, 0.7); } /* Adjust placeholder color for pistachio green */
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: #037af1; box-shadow: 0 0 0 3px rgba(3, 122, 241, 0.2); background: #C2E0B2; /* Slightly darker pistachio on focus */ }
        .profile-submit-btn { width: 100%; background: #037af1; color: white; padding: 12px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; font-family: 'Mangal', 'Noto Sans Devanagari', sans-serif; margin-top: 10px; }
        .profile-submit-btn:hover { background: #0056b3; transform: translateY(-2px); }
        .profile-submit-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .form-message { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            padding: 15px 25px; border-radius: 10px; color: white; font-weight: 500; 
            z-index: 10002; box-shadow: 0 4px 15px rgba(0,0,0,0.3); max-width: 400px; text-align: center;
            font-size: 16px;
            display: none; 
        }
        .form-message.success { background: #28a745; }
        .form-message.error { background: #dc3545; }
        .input-group { display: flex; align-items: center; }
        .input-group .input-group-text {
            padding: 12px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-right: none;
            border-radius: 8px 0 0 8px;
            background: rgba(255, 255, 255, 0.9);
            color: #28a745; /* Legal Green for Rupee symbol */
            font-size: 14px;
        }
        .input-group input {
            border-left: none;
            border-radius: 0 8px 8px 0;
            background: #E0F2D6; /* Lighter Pistachio Green Background */
        }
        
        /* Dynamic Input Section Styling */
        .dynamic-input-entries-container {
            max-height: 400px; /* Fixed height for scrolling */
            overflow-y: auto;
            padding-right: 15px; /* Space for scrollbar */
            margin-bottom: 20px;
        }
        .dynamic-input-entry {
            border: 1px dashed #28a745; /* Green dashed border */
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.7); /* Slightly transparent background */
            position: relative;
        }
        .dynamic-input-entry .remove-entry-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .dynamic-input-entry .remove-entry-btn:hover {
            transform: scale(1.1);
            background: #c82333;
        }
        .add-more-btn {
            background: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.2s;
        }
        .add-more-btn:hover {
            background: #0056b3;
        }

        /* Radio button specific styling */
        .radio-group-label {
            color: #28a745; /* Legal Green */
            font-weight: 500;
            font-family: 'Mangal', 'Noto Sans Devanagari', sans-serif;
            font-size: 14px;
            margin-bottom: 8px;
            display: block;
        }
        .radio-option {
            display: inline-flex;
            align-items: center;
            margin-right: 15px;
            cursor: pointer;
            color: #2c3e50; /* Text color for radio options */
        }
        .radio-option input[type="radio"] {
            /* Hide default radio button */
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }
        .radio-option span {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid #28a745; /* Legal Green border */
            border-radius: 50%;
            margin-right: 8px;
            position: relative;
            background: #E0F2D6; /* Lighter Pistachio Green Background for radio */
        }
        .radio-option input[type="radio"]:checked + span::after {
            content: '';
            position: absolute;
            top: 4px;
            left: 4px;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #28a745; /* Legal Green dot when checked */
        }
        .radio-option:hover span {
            background: #C2E0B2; /* Slightly darker pistachio on hover */
        }

        /* Trade Name Datalist + Add Button */
        .trade-name-input-group {
            display: flex;
            align-items: center;
            position: relative;
        }
        .trade-name-input-group input {
            flex-grow: 1;
            border-right: none; /* Integrate with button */
            border-radius: 8px 0 0 8px;
        }
        .trade-name-input-group .admin-add-btn {
            background: #28a745; /* Green add button */
            color: white;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-left: none;
            border-radius: 0 8px 8px 0;
            padding: 12px 15px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        .trade-name-input-group .admin-add-btn:hover {
            background: #218838;
        }

        /* Modal for adding new Trade Name */
        .add-trade-name-modal-content {
            background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px);
            position: relative; margin: 10% auto; padding: 0; border-radius: 15px;
            width: 90%; max-width: 500px; box-shadow: 0 15px 40px rgba(0,0,0,0.4);
            animation: modalSlideIn 0.4s ease-out;
        }
        .add-trade-name-modal-content .modal-header {
            background: #007bff; color: white; border-radius: 15px 15px 0 0;
        }
        .add-trade-name-modal-content .modal-header h2 {
            color: white;
        }
        .add-trade-name-modal-content .modal-body {
            background: #f8f9fa; color: #2c3e50; border-radius: 0 0 15px 15px;
        }
        .add-trade-name-modal-content .form-group label {
            color: #2c3e50;
        }
        .add-trade-name-modal-content input, .add-trade-name-modal-content select {
            background: white;
            color: #2c3e50;
        }
        .add-trade-name-modal-content input::placeholder {
            color: #6c757d;
        }
        .add-trade-name-modal-content .profile-submit-btn {
            background: #28a745;
        }
        .add-trade-name-modal-content .profile-submit-btn:hover {
            background: #218838;
        }


        /* Animations & Media Queries */
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 768px) {
            .admin-toolbar { margin: 10px 10px 0 10px; flex-direction: column; gap: 10px; }
            .header-container { flex-direction: column; gap: 15px; text-align: center; } 
            .navbar { margin: 0 10px; }
            .nav-menu { flex-wrap: wrap; justify-content: center; }
            .main-content { margin: 10px; padding: 20px; }
            .form-row { grid-template-columns: 1fr; }
            .green-title-strip { 
                flex-direction: column; 
                align-items: flex-start; 
                padding: 15px;
                margin: -30px -25px 20px -25px;
            }
            .page-title-content { text-align: center; width: 100%; margin-bottom: 10px; }
            .page-subtitle-date { text-align: center; width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>
    <div id="pageLoading" class="page-loading">
        <div class="spinner"></div>
        <div class="loading-text">लोड हो रहा है...</div>
    </div>

    <!-- Admin Toolbar -->
    <div id="adminToolbar" class="admin-toolbar">
        <h3><i class="fas fa-shield-alt"></i> एडमिन कंट्रोल पैनल</h3>
        <button class="admin-btn" id="addCardBtn"><i class="fas fa-plus"></i> नया कार्ड जोड़ें</button>
        <button class="admin-btn" id="manageNavBtn"><i class="fas fa-bars"></i> नेवीगेशन प्रबंधन</button>
        <button class="admin-btn" id="toggleEditMode"><i class="fas fa-edit"></i> एडिट मोड</button>
        <button class="admin-btn" id="userManagementBtn"><i class="fas fa-users"></i> उपयोगकर्ता प्रबंधन</button>
        <button class="admin-btn" id="analyticsDashboardBtn"><i class="fas fa-chart-pie"></i> एनालिटिक्स</button>
        <button class="admin-btn" id="createDynamicFormBtn"><i class="fas fa-file-excel"></i> डायनेमिक फॉर्म</button>
        <button class="admin-btn" id="manageDynamicFormsBtn"><i class="fas fa-list-alt"></i> फॉर्म प्रबंधित करें</button>
    </div>

    <!-- Header Strip -->
    <div class="header-strip">
        <div class="header-container">
            <div class="logo-section">
                <img src="https://upload.wikimedia.org/wikipedia/commons/8/87/Coat_of_arms_of_Chhattisgarh.svg" alt="छत्तीसगढ़ सरकार" class="cg-logo">
                <div class="logo-text">
                    <h1>संचालनालय कृषि छत्तीसगढ़</h1>
                    <p>Directorate of Agriculture, Chhattisgarh</p>
                </div>
            </div>
            <div class="user-section">
                <div class="user-info">
                    <div class="user-display" id="user-display">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-container">
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="dashboard.html" class="nav-link">
                        <i class="fas fa-home"></i> होम
                    </a>
                </li>
                <li class="nav-item dropdown">
                    <a href="#" class="nav-link" id="sectionsDropdownToggle" role="button" aria-expanded="false">
                        <i class="fas fa-th-large"></i> सेक्शन <i class="fas fa-chevron-down"></i>
                    </a>
                    <div class="dropdown-content" id="dynamicDropdown">
                        <!-- Dynamic items will be loaded here by JS -->
                        <a href="dynamic_data_entry.html" class="dropdown-item">
                            <i class="fas fa-file-alt"></i> डायनेमिक फॉर्म
                        </a>
                        <a href="viksit_krishi_sankalp_abhiyan_dweetiye_charan.html" class="dropdown-item active">
                            <i class="fas fa-seedling"></i> विकसित कृषि संकल्प अभियान (द्वितीय चरण)
                        </a>
                        <a href="#" class="dropdown-item">
                            <i class="fas fa-chart-bar"></i> रिपोर्ट
                        </a>
                    </div>
                </li>
                <li class="nav-item profile-link">
                    <a href="#" class="nav-link" id="profileLink">
                        <i class="fas fa-user"></i> प्रोफाइल
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link logout-link" id="logoutLink">
                        <i class="fas fa-sign-out-alt"></i> लॉगआउट
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="main-content" id="main-content">
        <div class="content-card">
            <div class="green-title-strip">
                <h2 class="page-title-content">विकसित कृषि संकल्प अभियान द्वितीय चरण</h2>
                <p class="page-subtitle-date">
                    दैनिक प्रतिवेदन दिनांक: <span id="displayedDate"></span>
                    <input type="date" id="reportDate" name="reportDate" required>
                    <button type="button" id="rptButton"><i class="fas fa-print"></i> Rpt</button>
                </p>
            </div>

            <form id="dailyReportForm">
                <!-- Section 1: Basic Information -->
                <h4 class="form-section-title">मूलभूत जानकारी</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="districtSelect">जिले का नाम <span style="color: red;">*</span></label>
                        <select id="districtSelect" name="districtId" required></select>
                    </div>
                    <div class="form-group">
                        <label for="totalCamps">आयोजित शिविरों की कुल संख्या</label>
                        <input type="number" id="totalCamps" name="totalCamps" min="0" value="0" required>
                    </div>
                </div>

                <!-- Section 2: Attendance -->
                <h4 class="form-section-title">उपस्थिति विवरण</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="maleFarmers">पुरुष किसान</label>
                        <input type="number" id="maleFarmers" name="maleFarmers" min="0" value="0" required>
                    </div>
                    <div class="form-group">
                        <label for="femaleFarmers">महिला किसान</label>
                        <input type="number" id="femaleFarmers" name="femaleFarmers" min="0" value="0" required>
                    </div>
                    <div class="form-group">
                        <label for="totalFarmers">कुल किसान</label>
                        <input type="number" id="totalFarmers" name="totalFarmers" min="0" value="0" disabled>
                    </div>
                </div>

                <div class="form-group">
                    <label for="publicRepsCount">उपस्थित जनप्रतिनिधियों की संख्या</label>
                    <input type="number" id="publicRepsCount" name="publicRepsCount" min="0" value="0" required>
                </div>

                <div class="form-group" id="headedChairQuestionGroup" style="display:none;">
                    <label class="radio-group-label">क्या विधायक, सांसद, मंत्री ने अध्यक्षता की? <span style="color: red;">*</span></label>
                    <div style="display:flex; gap: 20px;">
                        <label class="radio-option">
                            <input type="radio" name="headedChair" value="yes" id="yesHeadedChair">
                            <span></span> हाँ
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="headedChair" value="no" id="noHeadedChair">
                            <span></span> नहीं
                        </label>
                    </div>
                </div>
                
                <div class="form-group" id="publicRepsNamesGroup" style="display:none;">
                    <label for="publicRepsNames">जनप्रतिनिधियों के नाम (प्रत्येक नाम नई पंक्ति में) <span style="color: red;">*</span></label>
                    <textarea id="publicRepsNames" name="publicRepsNames" rows="4" placeholder="माननीय विधायक, माननीय सांसद, माननीय मंत्री (राज्य), माननीय मंत्री (केंद्र), माननीय मुख्यमंत्री"></textarea>
                </div>

                <h4 class="form-section-title">उपस्थित अधिकारी</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="distAdminCount">जिला प्रशासन</label>
                        <input type="number" id="distAdminCount" name="distAdminCount" min="0" value="0" required>
                    </div>
                    <div class="form-group">
                        <label for="deptOfficersCount">विभागीय</label>
                        <input type="number" id="deptOfficersCount" name="deptOfficersCount" min="0" value="0" required>
                    </div>
                    <div class="form-group">
                        <label for="alliedDeptCount">संबद्ध विभाग</label>
                        <input type="number" id="alliedDeptCount" name="alliedDeptCount" min="0" value="0" required>
                    </div>
                    <div class="form-group">
                        <label for="kvkCount">केवीके</label>
                        <input type="number" id="kvkCount" name="kvkCount" min="0" value="0" required>
                    </div>
                    <div class="form-group">
                        <label for="igkvCount">आईजीकेवी वैज्ञानिक और पेशेवर</label>
                        <input type="number" id="igkvCount" name="igkvCount" min="0" value="0" required>
                    </div>
                    <div class="form-group">
                        <label for="totalOfficers">कुल अधिकारी</label>
                        <input type="number" id="totalOfficers" name="totalOfficers" min="0" value="0" disabled>
                    </div>
                </div>

                <h4 class="form-section-title">सामग्री वितरण</h4>
                <div class="form-group">
                    <label for="publicityMaterialCount">वितरित प्रचार सामग्री की संख्या</label>
                    <input type="number" id="publicityMaterialCount" name="publicityMaterialCount" min="0" value="0" required>
                </div>

                <!-- Section 3: Input Distribution -->
                <h4 class="form-section-title">इनपुट, नकद सब्सिडी और उपकरण</h4>
                <div class="form-group">
                    <label for="cashSubsidyAmountTotal">नकद सब्सिडी राशि (भारतीय रुपये)</label>
                    <div class="input-group">
                        <span class="input-group-text">₹</span>
                        <input type="number" id="cashSubsidyAmountTotal" name="cashSubsidyAmountTotal" min="0" step="0.01" value="0.00" disabled>
                    </div>
                </div>

                <!-- Dynamic Input Entries Container -->
                <div id="dynamicInputEntriesContainer" class="dynamic-input-entries-container">
                    <!-- Dynamic input entry forms will be appended here -->
                </div>
                <button type="button" id="addMoreInputBtn" class="add-more-btn"><i class="fas fa-plus"></i> और इनपुट/उपकरण जोड़ें</button>

                <button type="submit" class="profile-submit-btn" id="submitReportBtn" disabled>
                    <i class="fas fa-paper-plane"></i> रिपोर्ट सबमिट करें
                </button>
                <div id="formMessage" class="form-message" style="display:none;"></div>
            </form>
        </div>
    </main>

    <!-- Hidden Template for Dynamic Input Entries -->
    <template id="dynamicInputTemplate">
        <div class="dynamic-input-entry">
            <button type="button" class="remove-entry-btn"><i class="fas fa-times"></i></button>
            <div class="form-row">
                <div class="form-group">
                    <label>योजना का नाम <span style="color: red;">*</span></label>
                    <select class="scheme-select" required></select>
                </div>
                <div class="form-group">
                    <label>इनपुट का प्रकार <span style="color: red;">*</span></label>
                    <select class="input-type-select" required>
                        <option value="">प्रकार चुनें</option>
                    </select>
                </div>
            </div>

            <!-- Conditional Fields for Seed -->
            <div class="conditional-fields seed-fields" style="display:none;">
                <div class="form-row">
                    <div class="form-group">
                        <label>फसल का नाम <span style="color: red;">*</span></label>
                        <input type="text" class="crop-name" placeholder="गेहूं, धान, आदि">
                    </div>
                    <div class="form-group">
                        <label>किस्म <span style="color: red;">*</span></label>
                        <input type="text" class="variety" placeholder="एचडी 2967, पूसा बासमती, आदि">
                    </div>
                    <div class="form-group">
                        <label>मात्रा (किलोग्राम) <span style="color: red;">*</span></label>
                        <input type="number" class="quantity" min="0" step="0.01" value="0.00">
                    </div>
                </div>
            </div>

            <!-- Conditional Fields for Chemical/Fertilizer -->
            <div class="conditional-fields chemical-fields" style="display:none;">
                <div class="form-row">
                    <div class="form-group">
                        <label>व्यापारिक नाम <span style="color: red;">*</span></label>
                        <div class="trade-name-input-group">
                            <input type="text" class="trade-name" list="tradeNameDatalist" placeholder="व्यापारिक नाम चुनें या नया दर्ज करें">
                            <datalist id="tradeNameDatalist"></datalist>
                            <button type="button" class="admin-add-btn add-trade-name-btn" title="नया व्यापारिक नाम जोड़ें" style="display:none;"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>मात्रा <span style="color: red;">*</span></label>
                        <input type="number" class="quantity" min="0" step="0.01" value="0.00">
                    </div>
                    <div class="form-group">
                        <label>इकाई <span style="color: red;">*</span></label>
                        <select class="unit-select">
                            <!-- Populated dynamically -->
                        </select>
                    </div>
                </div>
            </div>

            <!-- Conditional Fields for Farm Tool -->
            <div class="conditional-fields farm-tool-fields" style="display:none;">
                <div class="form-row">
                    <div class="form-group">
                        <label>उपकरण का नाम <span style="color: red;">*</span></label>
                        <input type="text" class="equipment-name" placeholder="ट्रैक्टर, सीड ड्रिल, हल">
                    </div>
                    <div class="form-group">
                        <label>संख्या <span style="color: red;">*</span></label>
                        <input type="number" class="quantity" min="0" value="0">
                    </div>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>कुल राशि (भारतीय रुपये) <span style="color: red;">*</span></label>
                    <div class="input-group">
                        <span class="input-group-text">₹</span>
                        <input type="number" class="total-amount" min="0" step="0.01" value="0.00">
                    </div>
                </div>
                <div class="form-group">
                    <label>सब्सिडी राशि (भारतीय रुपये) <span style="color: red;">*</span></label>
                    <div class="input-group">
                        <span class="input-group-text">₹</span>
                        <input type="number" class="subsidy-amount" min="0" step="0.01" value="0.00">
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- Modal for Adding New Trade Name (Admin Only) -->
    <div id="addTradeNameModal" class="modal">
        <div class="add-trade-name-modal-content">
            <div class="modal-header">
                <h2>नया व्यापारिक नाम जोड़ें</h2>
                <span class="close" id="closeAddTradeNameModal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addTradeNameForm">
                    <div class="form-group">
                        <label for="newTradeName">व्यापारिक नाम (हिंदी) <span style="color: red;">*</span></label>
                        <input type="text" id="newTradeName" name="newTradeName" required>
                    </div>
                    <div class="form-group">
                        <label for="newTradeNameEn">Trade Name (English) <span style="color: red;">*</span></label>
                        <input type="text" id="newTradeNameEn" name="newTradeNameEn" required>
                    </div>
                    <div class="form-group">
                        <label for="tradeNameInputType">संबंधित इनपुट का प्रकार <span style="color: red;">*</span></label>
                        <select id="tradeNameInputType" name="tradeNameInputType" required>
                            <!-- Populated dynamically by JS -->
                        </select>
                    </div>
                    <button type="submit" class="profile-submit-btn" id="addTradeNameSubmitBtn">
                        <i class="fas fa-plus"></i> व्यापारिक नाम जोड़ें
                    </button>
                    <div id="addTradeNameMessage" class="form-message" style="display:none;"></div>
                </form>
            </div>
        </div>
    </div>


    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script type="module">
        import { supabaseClient } from './supabase-config.js';

        let isAdmin = false;
        let currentUser = null;
        let allDistricts = [];
        let allSchemes = []; // To store scheme names from Supabase
        let allUnits = []; // To store unit names from Supabase
        let allInputTypes = []; // New: To store input types from Supabase
        let allTradeNames = []; // New: To store trade names from Supabase

        window.addEventListener('load', function() {
            setTimeout(() => {
                document.getElementById('pageLoading').style.display = 'none';
            }, 500);
        });

        document.addEventListener('DOMContentLoaded', async function() {
            await loadUserData();
            await fetchDistricts();
            await fetchSchemes();
            await fetchUnits();
            await fetchInputTypes(); // New: Fetch input types
            await fetchTradeNames(); // New: Fetch trade names
            await loadNavigationItems();
            setupEventListeners();
            setupAccessibility();
            setupReportDateSelector();
            setupOfficerTotalCalculation();
            setupFarmerTotalCalculation();
            setupConditionalFields();
            addDynamicInputEntry(); // Add initial dynamic input entry
            validateForm(); // Initial form validation check
        });

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = `position: fixed; top: 20px; right: 20px; padding: 15px 20px; border-radius: 8px; color: white; font-weight: 500; z-index: 10001; transform: translateX(400px); transition: transform 0.3s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.2); max-width: 350px; background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#007bff'};`;
            document.body.appendChild(toast);
            setTimeout(() => { toast.style.transform = 'translateX(0)'; }, 100);
            setTimeout(() => {
                toast.style.transform = 'translateX(400px)';
                setTimeout(() => { if (document.body.contains(toast)) document.body.removeChild(toast); }, 300);
            }, 3000);
        }

        async function loadUserData() {
            try {
                const userId = sessionStorage.getItem('userId') || localStorage.getItem('userId');
                if (!userId) {
                    window.location.href = 'header.html';
                    return;
                }

                const { data: user, error } = await supabaseClient
                    .from('test_users')
                    .select('id, full_name, role, username, districts (id, name)')
                    .eq('id', userId)
                    .single();

                if (error || !user) {
                    document.getElementById('user-display').textContent = 'Unknown User';
                    return;
                }

                currentUser = user;
                const displayName = user.full_name || user.username;
                const districtName = user.districts ? currentUser.districts.name : 'Unknown District';
                document.getElementById('user-display').textContent = displayName + ' - ' + districtName;

                isAdmin = user.role === 'admin';
                if (isAdmin) {
                    document.getElementById('adminToolbar').style.display = 'flex';
                }

            } catch (error) {
                console.error('Error loading user data:', error);
                document.getElementById('user-display').textContent = 'Error Loading';
            }
        }

        async function fetchDistricts() {
            try {
                const { data, error } = await supabaseClient
                    .from('districts')
                    .select('id, name')
                    .order('name', { ascending: true });

                if (error) throw error;
                allDistricts = data;

                const districtSelect = document.getElementById('districtSelect');
                if (districtSelect) {
                    districtSelect.innerHTML = '<option value="">जिले का नाम चुनें</option>';
                    allDistricts.forEach(district => {
                        const option = document.createElement('option');
                        option.value = district.id;
                        option.textContent = district.name;
                        districtSelect.appendChild(option);
                    });
                    // Pre-select user's district if available
                    if (currentUser && currentUser.districts) {
                        districtSelect.value = currentUser.districts.id;
                    }
                }

            } catch (error) {
                console.error('Error fetching districts:', error);
                showToast('जिलों को लोड करने में त्रुटि', 'error');
            }
        }

        async function fetchSchemes() {
            try {
                const { data, error } = await supabaseClient
                    .from('schemes') // Corrected table name to lowercase 'schemes'
                    .select('id, scheme_name')
                    .eq('is_active', true)
                    .order('scheme_name', { ascending: true });

                if (error) throw error;
                allSchemes = data;

            } catch (error) {
                console.error('Error fetching schemes:', error);
                showToast('योजनाएं लोड करने में त्रुटि', 'error');
            }
        }

        async function fetchUnits() { // New function to fetch units
            try {
                const { data, error } = await supabaseClient
                    .from('units') // Assuming your units table is named 'units'
                    .select('id, unit_name_hi, unit_name_en, unit_type')
                    .eq('is_active', true)
                    .order('unit_name_hi', { ascending: true });

                if (error) throw error;
                allUnits = data;

            } catch (error) {
                console.error('Error fetching units:', error);
                showToast('इकाइयां लोड करने में त्रुटि', 'error');
            }
        }

        async function fetchInputTypes() { // New function to fetch input types
            try {
                const { data, error } = await supabaseClient
                    .from('input_types') // Assuming your input_types table
                    .select('id, type_name_hi, type_name_en, unit_category_types') // unit_category_types is an array of text
                    .eq('is_active', true)
                    .order('type_name_hi', { ascending: true });

                if (error) throw error;
                allInputTypes = data;

                // Populate input type dropdowns in templates
                document.querySelectorAll('.input-type-select').forEach(select => {
                    populateInputTypeSelect(select);
                });

            } catch (error) {
                console.error('Error fetching input types:', error);
                showToast('इनपुट प्रकार लोड करने में त्रुटि', 'error');
            }
        }

        async function fetchTradeNames() { // New function to fetch trade names
            try {
                const { data, error } = await supabaseClient
                    .from('trade_names') // Assuming your trade_names table
                    .select('id, trade_name_hi, trade_name_en, input_type_id')
                    .eq('is_active', true)
                    .order('trade_name_hi', { ascending: true });

                if (error) throw error;
                allTradeNames = data;

                // Populate all datalists
                document.querySelectorAll('.trade-name-datalist').forEach(datalist => {
                    populateTradeNameDatalist(datalist);
                });

            } catch (error) {
                console.error('Error fetching trade names:', error);
                showToast('व्यापारिक नाम लोड करने में त्रुटि', 'error');
            }
        }

        async function loadNavigationItems() {
            try {
                const { data: navItems, error: itemError } = await supabaseClient
                    .from('navigation_items')
                    .select('*, navigation_categories(name_hi, name_en)')
                    .eq('is_active', true)
                    .order('parent_id, display_order', { ascending: true });

                if (itemError) throw itemError;

                const navMenuContainer = document.querySelector('.navbar .nav-menu'); // Target the top navbar
                navMenuContainer.innerHTML = '';

                // Add Home link
                const homeItem = document.createElement('li');
                homeItem.className = 'nav-item';
                homeItem.innerHTML = `
                    <a href="dashboard.html" class="nav-link">
                        <i class="fas fa-home"></i> होम
                    </a>
                `;
                navMenuContainer.appendChild(homeItem);

                // Add Sections dropdown
                const sectionsDropdown = document.createElement('li');
                sectionsDropdown.className = 'nav-item dropdown';
                sectionsDropdown.innerHTML = `
                    <a href="#" class="nav-link" id="sectionsDropdownToggle" role="button" aria-expanded="false">
                        <i class="fas fa-th-large"></i> सेक्शन <i class="fas fa-chevron-down"></i>
                    </a>
                    <div class="dropdown-content" id="dynamicDropdown">
                        <!-- Dynamic items will be loaded here -->
                    </div>
                `;
                navMenuContainer.appendChild(sectionsDropdown);

                const dynamicDropdownContent = sectionsDropdown.querySelector('#dynamicDropdown');
                const groupedNavItems = navItems.reduce((acc, item) => {
                    const parentId = item.parent_id === null ? 'top-level' : item.parent_id;
                    if (!acc[parentId]) acc[parentId] = [];
                    acc[parentId].push(item);
                    return acc;
                }, {});

                const topLevelItems = groupedNavItems['top-level'] || [];
                topLevelItems.sort((a, b) => a.display_order - b.display_order);

                topLevelItems.forEach(parentItem => {
                    // Skip Home, Profile, Logout if they are also in DB as top-level
                    if (parentItem.url === 'dashboard.html' || parentItem.url === '#' && (parentItem.name_en === 'Profile' || parentItem.name_en === 'Logout')) {
                        return;
                    }

                    const parentNavElement = document.createElement('a');
                    parentNavElement.href = parentItem.url;
                    parentNavElement.className = 'dropdown-item';
                    if (window.location.pathname.includes(parentItem.url)) { // Set active class for current page
                        parentNavElement.classList.add('active');
                    }
                    if (parentItem.is_external) parentNavElement.target = '_blank';
                    parentNavElement.innerHTML = `<i class="${parentItem.icon_class}"></i> ${parentItem.name_hi}`;
                    dynamicDropdownContent.appendChild(parentNavElement);

                    const children = groupedNavItems[parentItem.id] || [];
                    children.sort((a, b) => a.display_order - b.display_order);

                    children.forEach(child => {
                        const childNavElement = document.createElement('a');
                        childNavElement.href = child.url;
                        childNavElement.className = 'dropdown-item';
                         if (window.location.pathname.includes(child.url)) { // Set active class for current page
                            childNavElement.classList.add('active');
                        }
                        if (child.is_external) childNavElement.target = '_blank';
                        childNavElement.innerHTML = `<i class="${child.icon_class}" style="margin-left: 15px;"></i> ${child.name_hi}`;
                        dynamicDropdownContent.appendChild(childNavElement);
                    });
                });

                // Add Profile link
                const profileItem = document.createElement('li');
                profileItem.className = 'nav-item profile-link';
                profileItem.innerHTML = `
                    <a href="#" class="nav-link" id="profileLink">
                        <i class="fas fa-user"></i> प्रोफाइल
                    </a>
                `;
                navMenuContainer.appendChild(profileItem);

                // Add Logout link
                const logoutItem = document.createElement('li');
                logoutItem.className = 'nav-item';
                logoutItem.innerHTML = `
                    <a href="#" class="nav-link logout-link" id="logoutLink">
                        <i class="fas fa-sign-out-alt"></i> लॉगआउट
                    </a>
                `;
                navMenuContainer.appendChild(logoutItem);

            } catch (error) {
                console.error('Error loading navigation items:', error);
                showToast('नेवीगेशन लोड करने में त्रुटि', 'error');
            }
        }


        function setupAccessibility() {
            const skipLink = document.createElement('a');
            skipLink.href = '#main-content';
            skipLink.textContent = 'मुख्य सामग्री पर जाएं';
            skipLink.style.cssText = 'position: absolute; top: -40px; left: 6px; background: #000; color: #fff; padding: 8px; text-decoration: none; z-index: 10000; border-radius: 4px;';
            skipLink.addEventListener('focus', () => { skipLink.style.top = '6px'; });
            skipLink.addEventListener('blur', () => { skipLink.style.top = '-40px'; });
            document.body.insertBefore(skipLink, document.body.firstChild);
            document.querySelector('.main-content').id = 'main-content';
        }

        function setupEventListeners() {
            // Dropdown toggle for sections
            document.getElementById('sectionsDropdownToggle').addEventListener('click', function(e) {
                e.preventDefault();
                this.nextElementSibling.classList.toggle('show');
                this.setAttribute('aria-expanded', this.nextElementSibling.classList.contains('show'));
            });

            // Close dropdown if clicked outside
            window.addEventListener('click', function(e) {
                if (!e.target.matches('#sectionsDropdownToggle') && !e.target.closest('.dropdown-content')) {
                    const dropdownContent = document.getElementById('dynamicDropdown');
                    if (dropdownContent.classList.contains('show')) {
                        dropdownContent.classList.remove('show');
                        document.getElementById('sectionsDropdownToggle').setAttribute('aria-expanded', 'false');
                    }
                }
            });

            document.getElementById('profileLink').addEventListener('click', (e) => { e.preventDefault(); showToast('प्रोफाइल सेटिंग्स यहां लोड होंगी', 'info'); });
            document.getElementById('logoutLink').addEventListener('click', (e) => { e.preventDefault(); if (confirm('लॉगआउट करें?')) logout(); });

            if (isAdmin) {
                document.getElementById('addCardBtn').addEventListener('click', () => showToast('कार्ड जोड़ने का फ़ंक्शन यहां नहीं है', 'error'));
                document.getElementById('manageNavBtn').addEventListener('click', () => showToast('नेवीगेशन प्रबंधन फ़ंक्शन यहां नहीं है', 'error'));
                document.getElementById('toggleEditMode').addEventListener('click', () => showToast('एडिट मोड फ़ंक्शन यहां नहीं है', 'error'));
                document.getElementById('userManagementBtn').addEventListener('click', () => showToast('उपयोगकर्ता प्रबंधन फ़ंक्शन यहां नहीं है', 'error'));
                document.getElementById('analyticsDashboardBtn').addEventListener('click', () => showToast('एनालिटिक्स फ़ंक्शन यहां नहीं है', 'error'));
                document.getElementById('createDynamicFormBtn').addEventListener('click', () => showToast('डायनेमिक फॉर्म क्रिएटर फ़ंक्शन यहां नहीं है', 'error'));
                document.getElementById('manageDynamicFormsBtn').addEventListener('click', () => showToast('फॉर्म प्रबंधन फ़ंक्शन यहां नहीं है', 'error'));
            }

            // Form validation and submission
            const formElements = document.querySelectorAll('#dailyReportForm input, #dailyReportForm select, #dailyReportForm textarea');
            formElements.forEach(element => {
                element.addEventListener('input', validateForm);
                element.addEventListener('change', validateForm);
            });
            document.getElementById('dailyReportForm').addEventListener('submit', handleFormSubmission);

            // Rpt Button functionality
            document.getElementById('rptButton').addEventListener('click', generateAndPrintReport); // Rpt button calls print function

            // Add more dynamic input button
            document.getElementById('addMoreInputBtn').addEventListener('click', addDynamicInputEntry);

            // Admin add trade name modal
            document.getElementById('closeAddTradeNameModal').addEventListener('click', closeAddTradeNameModal);
            document.getElementById('addTradeNameForm').addEventListener('submit', handleAddTradeName);
        }

        function setupReportDateSelector() {
            const reportDateInput = document.getElementById('reportDate');
            const displayedDateSpan = document.getElementById('displayedDate');

            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const todayISO = `${yyyy}-${mm}-${dd}`;

            // Set default date to today and restrict future dates
            reportDateInput.value = todayISO;
            reportDateInput.setAttribute('max', todayISO); 
            // Set min date (e.g., beginning of 2025, adjust as needed)
            reportDateInput.setAttribute('min', '2025-01-01'); // Example: No entry before 2025-01-01
            
            // Display date in DDMMYYYY format initially
            displayedDateSpan.textContent = `${dd}${mm}${yyyy}`;

            reportDateInput.addEventListener('change', function() {
                const selectedDate = new Date(this.value);
                const displayDd = String(selectedDate.getDate()).padStart(2, '0');
                const displayMm = String(selectedDate.getMonth() + 1).padStart(2, '0');
                const displayYyyy = selectedDate.getFullYear();
                displayedDateSpan.textContent = `${displayDd}${displayMm}${displayYyyy}`;
                validateForm();
            });
        }

        function setupOfficerTotalCalculation() {
            const officerInputs = [
                document.getElementById('distAdminCount'),
                document.getElementById('deptOfficersCount'),
                document.getElementById('alliedDeptCount'),
                document.getElementById('kvkCount'),
                document.getElementById('igkvCount')
            ];
            const totalOfficersInput = document.getElementById('totalOfficers');

            const calculateTotal = () => {
                let total = 0;
                officerInputs.forEach(input => {
                    total += parseInt(input.value) || 0;
                });
                totalOfficersInput.value = total;
                validateForm();
            };

            officerInputs.forEach(input => {
                input.addEventListener('input', calculateTotal);
            });
            calculateTotal();
        }

        function setupFarmerTotalCalculation() {
            const maleFarmersInput = document.getElementById('maleFarmers');
            const femaleFarmersInput = document.getElementById('femaleFarmers');
            const totalFarmersInput = document.getElementById('totalFarmers');

            const calculateTotal = () => {
                const male = parseInt(maleFarmersInput.value) || 0;
                const female = parseInt(femaleFarmersInput.value) || 0;
                totalFarmersInput.value = male + female;
                validateForm();
            };

            maleFarmersInput.addEventListener('input', calculateTotal);
            femaleFarmersInput.addEventListener('input', calculateTotal);
            calculateTotal();
        }

        function setupConditionalFields() {
            const publicRepsCountInput = document.getElementById('publicRepsCount');
            const headedChairQuestionGroup = document.getElementById('headedChairQuestionGroup');
            const publicRepsNamesGroup = document.getElementById('publicRepsNamesGroup');
            const publicRepsNamesTextarea = publicRepsNamesGroup.querySelector('textarea');
            const yesHeadedChairRadio = document.getElementById('yesHeadedChair');
            const noHeadedChairRadio = document.getElementById('noHeadedChair');

            const toggleHeadedChairQuestion = () => {
                if (parseInt(publicRepsCountInput.value) > 0) {
                    headedChairQuestionGroup.style.display = 'block';
                    yesHeadedChairRadio.setAttribute('required', 'true');
                    noHeadedChairRadio.setAttribute('required', 'true');
                } else {
                    headedChairQuestionGroup.style.display = 'none';
                    publicRepsNamesGroup.style.display = 'none'; // Hide names if count is 0
                    yesHeadedChairRadio.removeAttribute('required');
                    noHeadedChairRadio.removeAttribute('required');
                    yesHeadedChairRadio.checked = false;
                    noHeadedChairRadio.checked = false;
                    publicRepsNamesTextarea.removeAttribute('required');
                    publicRepsNamesTextarea.value = '';
                }
                validateForm();
            };

            const togglePublicRepsNames = () => {
                if (yesHeadedChairRadio.checked) {
                    publicRepsNamesGroup.style.display = 'block';
                    publicRepsNamesTextarea.setAttribute('required', 'true');
                } else {
                    publicRepsNamesGroup.style.display = 'none';
                    publicRepsNamesTextarea.removeAttribute('required');
                    publicRepsNamesTextarea.value = '';
                }
                validateForm();
            };

            publicRepsCountInput.addEventListener('input', toggleHeadedChairQuestion);
            yesHeadedChairRadio.addEventListener('change', togglePublicRepsNames);
            noHeadedChairRadio.addEventListener('change', togglePublicRepsNames);

            toggleHeadedChairQuestion(); // Initial check on load
        }

        function calculateTotalCashSubsidy() {
            let totalSubsidy = 0;
            document.querySelectorAll('.dynamic-input-entry .subsidy-amount').forEach(input => {
                totalSubsidy += parseFloat(input.value) || 0;
            });
            document.getElementById('cashSubsidyAmountTotal').value = totalSubsidy.toFixed(2);
            validateForm();
        }

        function validateForm() {
            const form = document.getElementById('dailyReportForm');
            const requiredInputs = form.querySelectorAll('input[required], select[required], textarea[required]');
            let allFieldsFilled = true;

            requiredInputs.forEach(input => {
                if (input.type === 'number') {
                    if (input.value === '' || isNaN(input.value) || parseFloat(input.value) < 0) {
                        allFieldsFilled = false;
                    }
                } else if (input.type === 'radio') {
                    const radioGroup = form.querySelectorAll(`input[name="${input.name}"]`);
                    if (!Array.from(radioGroup).some(radio => radio.checked)) {
                        allFieldsFilled = false;
                    }
                } else if (input.value.trim() === '') {
                    allFieldsFilled = false;
                }
            });

            // Specific validation for dynamic fields
            document.querySelectorAll('.dynamic-input-entry').forEach(entry => {
                const schemeSelect = entry.querySelector('.scheme-select');
                const inputTypeSelect = entry.querySelector('.input-type-select');
                
                if (schemeSelect && schemeSelect.value.trim() === '') allFieldsFilled = false;
                if (inputTypeSelect && inputTypeSelect.value.trim() === '') allFieldsFilled = false;

                const selectedType = inputTypeSelect ? inputTypeSelect.value : '';
                if (selectedType === 'Seed') {
                    if (entry.querySelector('.crop-name').value.trim() === '') allFieldsFilled = false;
                    if (entry.querySelector('.variety').value.trim() === '') allFieldsFilled = false;
                    if (entry.querySelector('.quantity').value === '' || isNaN(entry.querySelector('.quantity').value) || parseFloat(entry.querySelector('.quantity').value) < 0) allFieldsFilled = false;
                } else if (['Insecticide/Pesticide', 'Fertilizer', 'Biofertilizer'].includes(selectedType)) {
                    if (entry.querySelector('.trade-name').value.trim() === '') allFieldsFilled = false;
                    if (entry.querySelector('.quantity').value === '' || isNaN(entry.querySelector('.quantity').value) || parseFloat(entry.querySelector('.quantity').value) < 0) allFieldsFilled = false;
                    if (entry.querySelector('.unit-select').value.trim() === '') allFieldsFilled = false; // Unit is now required
                } else if (selectedType === 'Farm Tool or Equipment') {
                    if (entry.querySelector('.equipment-name').value.trim() === '') allFieldsFilled = false;
                    if (entry.querySelector('.quantity').value === '' || isNaN(entry.querySelector('.quantity').value) || parseInt(entry.querySelector('.quantity').value) < 0) allFieldsFilled = false;
                }
                if (entry.querySelector('.total-amount').value === '' || isNaN(entry.querySelector('.total-amount').value) || parseFloat(entry.querySelector('.total-amount').value) < 0) allFieldsFilled = false;
                if (entry.querySelector('.subsidy-amount').value === '' || isNaN(entry.querySelector('.subsidy-amount').value) || parseFloat(entry.querySelector('.subsidy-amount').value) < 0) allFieldsFilled = false;
            });

            document.getElementById('submitReportBtn').disabled = !allFieldsFilled;
        }

        // --- Dynamic Input Section Functions ---
        // Unit filtering map based on unit_type from fetched input_types
        const unitTypeMap = {}; // Will be populated from allInputTypes

        function populateInputTypeSelect(selectElement) {
            selectElement.innerHTML = '<option value="">प्रकार चुनें</option>';
            allInputTypes.forEach(inputType => {
                const option = document.createElement('option');
                option.value = inputType.type_name_en; // Use English name as value for internal logic
                option.textContent = inputType.type_name_hi;
                selectElement.appendChild(option);
            });
        }

        function populateSchemeSelect(selectElement) {
            selectElement.innerHTML = '<option value="">योजना चुनें</option>';
            allSchemes.forEach(scheme => {
                const option = document.createElement('option');
                option.value = scheme.id; // Store scheme ID
                option.textContent = scheme.scheme_name;
                selectElement.appendChild(option);
            });
        }

        function populateUnitSelect(unitSelectElement, selectedType) {
            unitSelectElement.innerHTML = '<option value="">इकाई चुनें</option>'; // Default option
            const inputType = allInputTypes.find(type => type.type_name_en === selectedType);
            const allowedUnitTypes = inputType ? inputType.unit_category_types : []; // Array of unit_type strings

            allUnits.filter(unit => allowedUnitTypes.includes(unit.unit_type))
                    .forEach(unit => {
                        const option = document.createElement('option');
                        option.value = unit.id; // Store unit ID
                        option.textContent = unit.unit_name_hi;
                        unitSelectElement.appendChild(option);
                    });
            
            // Auto-select specific units if only one is relevant or for fixed types
            if (selectedType === 'Seed') {
                const kgUnit = allUnits.find(unit => unit.unit_name_en === 'kg');
                if (kgUnit) unitSelectElement.value = kgUnit.id;
            } else if (selectedType === 'Farm Tool or Equipment') {
                const numberUnit = allUnits.find(unit => unit.unit_name_en === 'number');
                if (numberUnit) unitSelectElement.value = numberUnit.id;
            }

            // Set required based on if a selection is needed (i.e., multiple options)
            if (unitSelectElement.options.length > 1 && selectedType !== 'Seed' && selectedType !== 'Farm Tool or Equipment') {
                unitSelectElement.setAttribute('required', 'true');
            } else {
                unitSelectElement.removeAttribute('required');
            }
        }

        function populateTradeNameDatalist(datalistElement, inputTypeId) {
            datalistElement.innerHTML = '';
            allTradeNames.filter(tradeName => tradeName.input_type_id == inputTypeId)
                         .forEach(tradeName => {
                             const option = document.createElement('option');
                             option.value = tradeName.trade_name_hi;
                             datalistElement.appendChild(option);
                         });
        }

        function updateDynamicInputFields(entryDiv, selectedType) {
            entryDiv.querySelectorAll('.conditional-fields').forEach(fieldGroup => {
                fieldGroup.style.display = 'none';
                fieldGroup.querySelectorAll('input, select, textarea').forEach(input => {
                    input.removeAttribute('required');
                    input.value = ''; // Clear values when hidden
                });
            });

            let targetFields = null;
            const unitSelect = entryDiv.querySelector('.unit-select');
            const tradeNameInputGroup = entryDiv.querySelector('.trade-name-input-group');
            const addTradeNameBtn = entryDiv.querySelector('.add-trade-name-btn');
            const tradeNameDatalist = entryDiv.querySelector('.trade-name-datalist');
            const inputTypeId = allInputTypes.find(type => type.type_name_en === selectedType)?.id;

            if (tradeNameInputGroup) { // Hide trade name specific elements initially
                tradeNameInputGroup.style.display = 'none';
                if (addTradeNameBtn) addTradeNameBtn.style.display = 'none';
            }

            if (selectedType === 'Seed') {
                targetFields = entryDiv.querySelector('.seed-fields');
            } else if (['Insecticide/Pesticide', 'Fertilizer', 'Biofertilizer'].includes(selectedType)) {
                targetFields = entryDiv.querySelector('.chemical-fields');
                if (tradeNameInputGroup) tradeNameInputGroup.style.display = 'flex';
                if (isAdmin && addTradeNameBtn) addTradeNameBtn.style.display = 'flex';
                if (tradeNameDatalist) populateTradeNameDatalist(tradeNameDatalist, inputTypeId);
            } else if (selectedType === 'Farm Tool or Equipment') {
                targetFields = entryDiv.querySelector('.farm-tool-fields');
            }

            if (targetFields) {
                targetFields.style.display = 'block';
                targetFields.querySelectorAll('input, select').forEach(input => {
                    input.setAttribute('required', 'true');
                });
            }
            
            // Populate and manage unit select
            populateUnitSelect(unitSelect, selectedType);

            validateForm();
            calculateTotalCashSubsidy(); // Recalculate total cash subsidy
        }

        function addDynamicInputEntry() {
            const template = document.getElementById('dynamicInputTemplate');
            const clone = template.content.cloneNode(true);
            const entryDiv = clone.querySelector('.dynamic-input-entry');
            const dynamicInputEntriesContainer = document.getElementById('dynamicInputEntriesContainer');
            dynamicInputEntriesContainer.appendChild(clone);

            const schemeSelect = entryDiv.querySelector('.scheme-select');
            populateSchemeSelect(schemeSelect); // Populate schemes for the new entry

            const inputTypeSelect = entryDiv.querySelector('.input-type-select');
            populateInputTypeSelect(inputTypeSelect); // Populate input types for new entry
            inputTypeSelect.addEventListener('change', () => updateDynamicInputFields(entryDiv, inputTypeSelect.value));
            
            // Set up event listeners for inputs within the new entry for validation and auto-sum
            entryDiv.querySelectorAll('input, select, textarea').forEach(element => {
                element.addEventListener('input', () => {
                    validateForm();
                    if (element.classList.contains('subsidy-amount')) {
                        calculateTotalCashSubsidy(); // Recalculate if a subsidy amount changes
                    }
                });
                element.addEventListener('change', () => {
                    validateForm();
                    if (element.classList.contains('subsidy-amount')) {
                        calculateTotalCashSubsidy(); // Recalculate if a subsidy amount changes
                    }
                    if (element.classList.contains('input-type-select')) {
                        // When input type changes, re-validate to ensure new required fields are checked
                        validateForm();
                    }
                });
            });

            entryDiv.querySelector('.remove-entry-btn').addEventListener('click', () => {
                entryDiv.remove();
                validateForm(); // Re-validate after removing an entry
                calculateTotalCashSubsidy(); // Recalculate after removing an entry
            });

            // Admin add trade name button for this specific entry
            const addTradeNameBtn = entryDiv.querySelector('.add-trade-name-btn');
            if (addTradeNameBtn) {
                if (isAdmin) {
                    addTradeNameBtn.style.display = 'flex';
                    addTradeNameBtn.addEventListener('click', () => openAddTradeNameModal(inputTypeSelect.value));
                } else {
                    addTradeNameBtn.style.display = 'none';
                }
            }

            // Initial setup for the new entry
            updateDynamicInputFields(entryDiv, inputTypeSelect.value); // Set up initial conditional fields
            validateForm(); // Re-validate after adding new entry
            calculateTotalCashSubsidy(); // Recalculate after adding new entry
        }
        // --- End Dynamic Input Section Functions ---

        // --- Admin Add Trade Name Modal Functions ---
        function openAddTradeNameModal(selectedInputType) {
            document.getElementById('addTradeNameModal').style.display = 'block';
            document.getElementById('newTradeName').value = '';
            document.getElementById('newTradeNameEn').value = '';
            document.getElementById('addTradeNameMessage').style.display = 'none';

            const inputTypeSelect = document.getElementById('tradeNameInputType');
            inputTypeSelect.innerHTML = '<option value="">प्रकार चुनें</option>';
            allInputTypes.filter(type => ['Insecticide/Pesticide', 'Fertilizer', 'Biofertilizer'].includes(type.type_name_en))
                         .forEach(type => {
                             const option = document.createElement('option');
                             option.value = type.id;
                             option.textContent = type.type_name_hi;
                             inputTypeSelect.appendChild(option);
                         });
            
            // Pre-select the input type from the dynamic entry if applicable
            const inputTypeId = allInputTypes.find(type => type.type_name_en === selectedInputType)?.id;
            if (inputTypeId) {
                inputTypeSelect.value = inputTypeId;
            }
            document.getElementById('newTradeName').focus();
        }

        function closeAddTradeNameModal() {
            document.getElementById('addTradeNameModal').style.display = 'none';
        }

        async function handleAddTradeName(event) {
            event.preventDefault();
            const submitBtn = document.getElementById('addTradeNameSubmitBtn');
            const messageDiv = document.getElementById('addTradeNameMessage');
            messageDiv.style.display = 'none';

            const newTradeNameHi = document.getElementById('newTradeName').value.trim();
            const newTradeNameEn = document.getElementById('newTradeNameEn').value.trim();
            const inputTypeId = document.getElementById('tradeNameInputType').value;

            if (!newTradeNameHi || !newTradeNameEn || !inputTypeId) {
                messageDiv.className = 'form-message error';
                messageDiv.textContent = 'कृपया सभी आवश्यक फ़ील्ड भरें।';
                messageDiv.style.display = 'block';
                return;
            }

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> जोड़ा जा रहा है...';

            try {
                const { data, error } = await supabaseClient
                    .from('trade_names')
                    .insert([{
                        trade_name_hi: newTradeNameHi,
                        trade_name_en: newTradeNameEn,
                        input_type_id: inputTypeId,
                        is_active: true
                    }]);

                if (error) throw error;

                messageDiv.className = 'form-message success';
                messageDiv.textContent = `व्यापारिक नाम "${newTradeNameHi}" सफलतापूर्वक जोड़ा गया!`;
                messageDiv.style.display = 'block';
                showToast('नया व्यापारिक नाम जोड़ा गया', 'success');

                await fetchTradeNames(); // Reload trade names for all datalists
                document.getElementById('addTradeNameForm').reset();
                setTimeout(closeAddTradeNameModal, 1500);

            } catch (error) {
                console.error('Error adding trade name:', error);
                messageDiv.className = 'form-message error';
                messageDiv.textContent = 'व्यापारिक नाम जोड़ने में त्रुटि: ' + error.message;
                messageDiv.style.display = 'block';
                showToast('व्यापारिक नाम जोड़ने में त्रुटि', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-plus"></i> व्यापारिक नाम जोड़ें';
            }
        }
        // --- End Admin Add Trade Name Modal Functions ---


        // --- Report Generation Functions ---
        function generateAndPrintReport() {
            const formData = collectFormDataForReport(); // Collect all current form data
            const reportWindow = window.open('', '_blank');

            const today = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            const reportDateFormatted = today.toLocaleDateString('hi-IN', options);

            let reportContent = `
                <html>
                <head>
                    <title>दैनिक प्रतिवेदन: ${reportDateFormatted}</title>
                    <style>
                        body { font-family: 'Mangal', 'Noto Sans Devanagari', sans-serif; margin: 20px; color: #333; }
                        h1, h2, h3 { color: #0056b3; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-top: 20px; }
                        h1 { text-align: center; color: #28a745; }
                        h2 { text-align: center; font-size: 1.2em; }
                        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .section-title { font-weight: bold; margin-top: 15px; margin-bottom: 5px; color: #0056b3; }
                        .value { font-weight: normal; }
                        .note { margin-top: 20px; font-style: italic; color: #666; }
                        .rupee-symbol { font-family: 'Times New Roman', serif; } /* Specific font for Rupee symbol */
                    </style>
                </head>
                <body>
                    <h1>विकसित कृषि संकल्प अभियान द्वितीय चरण</h1>
                    <h2>दैनिक प्रतिवेदन दिनांक: ${reportDateFormatted}</h2>
                    <hr>

                    <h3>मूलभूत जानकारी</h3>
                    <table>
                        <tr><th>जिले का नाम</th><td>${formData.district_name || ''}</td></tr>
                        <tr><th>आयोजित शिविरों की कुल संख्या</th><td>${formData.total_camps_organized || 0}</td></tr>
                    </table>

                    <h3>उपस्थिति विवरण</h3>
                    <table>
                        <tr><th>कुल किसान</th><td>${formData.total_farmers_participated || 0}</td></tr>
                        <tr><th>पुरुष किसान</th><td>${formData.male_farmers || 0}</td></tr>
                        <tr><th>महिला किसान</th><td>${formData.female_farmers || 0}</td></tr>
                        <tr><th>उपस्थित जनप्रतिनिधियों की संख्या</th><td>${formData.public_reps_count || 0}</td></tr>
                        ${formData.public_reps_count > 0 ? `
                            <tr><th>क्या विधायक, सांसद, मंत्री ने अध्यक्षता की?</th><td>${formData.headed_chair_by_rep ? 'हाँ' : 'नहीं'}</td></tr>
                            ${formData.headed_chair_by_rep && formData.public_reps_names ? `
                                <tr><th>जनप्रतिनिधियों के नाम</th><td>${formData.public_reps_names.replace(/\n/g, '<br>')}</td></tr>
                            ` : ''}
                        ` : ''}
                    </table>

                    <h4>उपस्थित अधिकारी</h4>
                    <table>
                        <tr><th>जिला प्रशासन</th><td>${formData.officers_dist_admin || 0}</td></tr>
                        <tr><th>विभागीय</th><td>${formData.officers_departmental || 0}</td></tr>
                        <tr><th>संबद्ध विभाग</th><td>${formData.officers_allied_dept || 0}</td></tr>
                        <tr><th>केवीके</th><td>${formData.officers_kvk || 0}</td></tr>
                        <tr><th>आईजीकेवी वैज्ञानिक और पेशेवर</th><td>${formData.officers_igkv_scient_prof || 0}</td></tr>
                        <tr><th>कुल अधिकारी</th><td>${formData.total_officers_present || 0}</td></tr>
                    </table>

                    <h3>सामग्री वितरण</h3>
                    <table>
                        <tr><th>वितरित प्रचार सामग्री की संख्या</th><td>${formData.publicity_material_distributed || 0}</td></tr>
                    </table>

                    <h3>इनपुट, नकद सब्सिडी और उपकरण</h3>
                    <table>
                        <tr><th>नकद सब्सिडी राशि</th><td><span class="rupee-symbol">₹</span> ${formData.cash_subsidy_amount.toFixed(2) || '0.00'}</td></tr>
                    </table>
                    
                    ${formData.dynamic_inputs && formData.dynamic_inputs.length > 0 ? `
                        <h4>विभिन्न इनपुट और उपकरण</h4>
                        <table>
                            <thead>
                                <tr>
                                    <th>योजना</th>
                                    <th>प्रकार</th>
                                    <th>विवरण</th>
                                    <th>मात्रा/संख्या</th>
                                    <th>इकाई</th>
                                    <th>कुल राशि</th>
                                    <th>सब्सिडी राशि</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${formData.dynamic_inputs.map(input => `
                                    <tr>
                                        <td>${input.scheme_name || ''}</td>
                                        <td>${input.input_type || ''}</td>
                                        <td>
                                            ${input.input_type === 'Seed' ? 
                                                `फसल: ${input.input_details.crop_name || ''}<br>किस्म: ${input.input_details.variety || ''}` :
                                            ['Insecticide/Pesticide', 'Fertilizer', 'Biofertilizer'].includes(input.input_type) ?
                                                `व्यापारिक नाम: ${input.input_details.trade_name || ''}` :
                                            input.input_type === 'Farm Tool or Equipment' ?
                                                `उपकरण: ${input.input_details.equipment_name || ''}` : ''
                                            }
                                        </td>
                                        <td>${input.input_details.quantity || '0'}</td>
                                        <td>${input.input_details.unit_name || ''}</td>
                                        <td><span class="rupee-symbol">₹</span> ${input.total_amount.toFixed(2) || '0.00'}</td>
                                        <td><span class="rupee-symbol">₹</span> ${input.subsidy_amount.toFixed(2) || '0.00'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : ''}

                    <div class="note">यह रिपोर्ट ${new Date().toLocaleString('hi-IN')} को उत्पन्न की गई थी।</div>
                </body>
                </html>
            `;

            reportWindow.document.write(reportContent);
            reportWindow.document.close();
            reportWindow.focus();
            reportWindow.print();
        }

        function collectFormDataForReport() {
            const form = document.getElementById('dailyReportForm');
            const formData = {
                report_date: document.getElementById('reportDate').value,
                district_id: document.getElementById('districtSelect').value,
                district_name: document.getElementById('districtSelect').options[document.getElementById('districtSelect').selectedIndex].textContent,
                total_camps_organized: parseInt(document.getElementById('totalCamps').value) || 0,
                total_farmers_participated: parseInt(document.getElementById('totalFarmers').value) || 0,
                male_farmers: parseInt(document.getElementById('maleFarmers').value) || 0,
                female_farmers: parseInt(document.getElementById('femaleFarmers').value) || 0,
                public_reps_count: parseInt(document.getElementById('publicRepsCount').value) || 0,
                headed_chair_by_rep: document.querySelector('input[name="headedChair"]:checked') ? document.querySelector('input[name="headedChair"]:checked').value === 'yes' : false,
                public_reps_names: document.getElementById('publicRepsNames').value.trim(),
                officers_dist_admin: parseInt(document.getElementById('distAdminCount').value) || 0,
                officers_departmental: parseInt(document.getElementById('deptOfficersCount').value) || 0,
                officers_allied_dept: parseInt(document.getElementById('alliedDeptCount').value) || 0,
                officers_kvk: parseInt(document.getElementById('kvkCount').value) || 0,
                officers_igkv_scient_prof: parseInt(document.getElementById('igkvCount').value) || 0,
                total_officers_present: parseInt(document.getElementById('totalOfficers').value) || 0,
                publicity_material_distributed: parseInt(document.getElementById('publicityMaterialCount').value) || 0,
                cash_subsidy_amount: parseFloat(document.getElementById('cashSubsidyAmountTotal').value) || 0.00,
                dynamic_inputs: []
            };

            document.querySelectorAll('.dynamic-input-entry').forEach(entry => {
                const inputType = entry.querySelector('.input-type-select').value;
                const schemeId = entry.querySelector('.scheme-select').value;
                const schemeName = entry.querySelector('.scheme-select').options[entry.querySelector('.scheme-select').selectedIndex].textContent;
                const unitId = entry.querySelector('.unit-select') ? entry.querySelector('.unit-select').value : null;
                const unitName = entry.querySelector('.unit-select') && unitId ? entry.querySelector('.unit-select').options[entry.querySelector('.unit-select').selectedIndex].textContent : null;

                let specificInputDetails = {};
                if (inputType === 'Seed') {
                    specificInputDetails = {
                        crop_name: entry.querySelector('.crop-name').value.trim(),
                        variety: entry.querySelector('.variety').value.trim(),
                        quantity: parseFloat(entry.querySelector('.quantity').value) || 0,
                        unit_id: unitId,
                        unit_name: unitName
                    };
                } else if (['Insecticide/Pesticide', 'Fertilizer', 'Biofertilizer'].includes(inputType)) {
                    specificInputDetails = {
                        trade_name: entry.querySelector('.trade-name').value.trim(),
                        quantity: parseFloat(entry.querySelector('.quantity').value) || 0,
                        unit_id: unitId,
                        unit_name: unitName
                    };
                } else if (inputType === 'Farm Tool or Equipment') {
                    specificInputDetails = {
                        equipment_name: entry.querySelector('.equipment-name').value.trim(),
                        quantity: parseInt(entry.querySelector('.quantity').value) || 0,
                        unit_id: unitId,
                        unit_name: unitName
                    };
                }

                formData.dynamic_inputs.push({
                    scheme_id: schemeId,
                    scheme_name: schemeName,
                    input_type: inputType,
                    input_details: specificInputDetails,
                    total_amount: parseFloat(entry.querySelector('.total-amount').value) || 0.00,
                    subsidy_amount: parseFloat(entry.querySelector('.subsidy-amount').value) || 0.00
                });
            });

            return formData;
        }

        async function handleFormSubmission(event) {
            event.preventDefault();
            const submitBtn = document.getElementById('submitReportBtn');
            const formMessage = document.getElementById('formMessage');
            formMessage.style.display = 'none';

            if (!currentUser || !currentUser.id) {
                showMessage(formMessage, 'error', 'उपयोगकर्ता प्रमाणीकरण त्रुटि। कृपया पुनः लॉग इन करें।');
                return;
            }

            const districtId = document.getElementById('districtSelect').value;
            if (!districtId) {
                showMessage(formMessage, 'error', 'कृपया जिले का नाम चुनें।');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> सबमिट हो रहा है...';

            const dynamicInputsData = [];
            document.querySelectorAll('.dynamic-input-entry').forEach(entry => {
                const inputType = entry.querySelector('.input-type-select').value;
                const schemeId = entry.querySelector('.scheme-select').value;
                const schemeName = entry.querySelector('.scheme-select').options[entry.querySelector('.scheme-select').selectedIndex].textContent;
                const unitId = entry.querySelector('.unit-select') ? entry.querySelector('.unit-select').value : null;
                const unitName = entry.querySelector('.unit-select') && unitId ? entry.querySelector('.unit-select').options[entry.querySelector('.unit-select').selectedIndex].textContent : null;

                let specificInputDetails = {}; 
                if (inputType === 'Seed') {
                    specificInputDetails = {
                        crop_name: entry.querySelector('.crop-name').value.trim(),
                        variety: entry.querySelector('.variety').value.trim(),
                        quantity: parseFloat(entry.querySelector('.quantity').value) || 0,
                        unit_id: unitId,
                        unit_name: unitName
                    };
                } else if (['Insecticide/Pesticide', 'Fertilizer', 'Biofertilizer'].includes(inputType)) {
                    specificInputDetails = {
                        trade_name: entry.querySelector('.trade-name').value.trim(),
                        quantity: parseFloat(entry.querySelector('.quantity').value) || 0,
                        unit_id: unitId,
                        unit_name: unitName
                    };
                } else if (inputType === 'Farm Tool or Equipment') {
                    specificInputDetails = {
                        equipment_name: entry.querySelector('.equipment-name').value.trim(),
                        quantity: parseInt(entry.querySelector('.quantity').value) || 0,
                        unit_id: unitId,
                        unit_name: unitName
                    };
                }

                dynamicInputsData.push({
                    scheme_id: schemeId,
                    scheme_name: schemeName,
                    input_type: inputType,
                    input_details: specificInputDetails, 
                    total_amount: parseFloat(entry.querySelector('.total-amount').value) || 0.00,
                    subsidy_amount: parseFloat(entry.querySelector('.subsidy-amount').value) || 0.00
                });
            });

            const formData = {
                report_date: document.getElementById('reportDate').value,
                district_id: districtId,
                total_camps_organized: parseInt(document.getElementById('totalCamps').value) || 0,
                total_farmers_participated: parseInt(document.getElementById('totalFarmers').value) || 0,
                male_farmers: parseInt(document.getElementById('maleFarmers').value) || 0,
                female_farmers: parseInt(document.getElementById('femaleFarmers').value) || 0,
                public_reps_count: parseInt(document.getElementById('publicRepsCount').value) || 0,
                headed_chair_by_rep: document.querySelector('input[name="headedChair"]:checked') ? document.querySelector('input[name="headedChair"]:checked').value === 'yes' : false, 
                public_reps_names: document.getElementById('publicRepsNames').value.trim(),
                officers_dist_admin: parseInt(document.getElementById('distAdminCount').value) || 0,
                officers_departmental: parseInt(document.getElementById('deptOfficersCount').value) || 0,
                officers_allied_dept: parseInt(document.getElementById('alliedDeptCount').value) || 0,
                officers_kvk: parseInt(document.getElementById('kvkCount').value) || 0,
                officers_igkv_scient_prof: parseInt(document.getElementById('igkvCount').value) || 0,
                total_officers_present: parseInt(document.getElementById('totalOfficers').value) || 0,
                publicity_material_distributed: parseInt(document.getElementById('publicityMaterialCount').value) || 0,
                cash_subsidy_amount: parseFloat(document.getElementById('cashSubsidyAmountTotal').value) || 0.00, 
                dynamic_inputs: dynamicInputsData, 
                created_by: currentUser.id
            };

            try {
                const { data, error } = await supabaseClient
                    .from('viksit_krishi_report')
                    .insert([formData]);

                if (error) throw error;

                const submittedDate = new Date(formData.report_date).toLocaleDateString('hi-IN', { year: 'numeric', month: 'long', day: 'numeric' });
                showMessage(formMessage, 'success', `दैनिक रिपोर्ट सफलतापूर्वक सबमिट की गई! दिनांक: ${submittedDate}`);
                showToast('रिपोर्ट सबमिट की गई', 'success');
                event.target.reset(); // Clear the form
                // Re-initialize dynamic input entries
                document.getElementById('dynamicInputEntriesContainer').innerHTML = '';
                addDynamicInputEntry(); // Add one default entry
                setupOfficerTotalCalculation();
                setupFarmerTotalCalculation();
                setupConditionalFields(); // Reset conditional fields visibility
                validateForm(); // Re-validate after reset
                
            } catch (error) {
                console.error('Error submitting report:', error);
                showMessage(formMessage, 'error', 'रिपोर्ट सबमिट करने में त्रुटि: ' + error.message);
                showToast('रिपोर्ट सबमिट करने में त्रुटि', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> रिपोर्ट सबमिट करें';
            }
        }

        function showMessage(element, type, message) {
            element.className = `form-message ${type}`;
            element.textContent = message;
            element.style.display = 'block';
            // Hide message after 5 seconds
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }

        window.logout = async function() {
            try {
                const userId = sessionStorage.getItem('userId') || localStorage.getItem('userId');
                showToast('लॉगआउट हो रहा है...', 'info');
                
                if (userId) {
                    await supabaseClient
                        .from('test_users')
                        .update({ is_online: false, last_activity: new Date().toISOString() })
                        .eq('id', userId);
                }

                sessionStorage.removeItem('userId');
                localStorage.removeItem('userId');
                showToast('सफलतापूर्वक लॉगआउट हो गए', 'success');
                setTimeout(() => { window.location.href = 'header.html'; }, 1000);
                
            } catch (error) {
                showToast('लॉगआउट में त्रुटि', 'error');
                setTimeout(() => { window.location.href = 'header.html'; }, 2000);
            }
        }
    </script>
</body>
</html>
