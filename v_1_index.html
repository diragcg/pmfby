<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Data Updation System - DirAgCg</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Poppins Font -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            --primary-color: #800000; /* Maroon red */
            --secondary-color: #333333; /* Dark gray/black */
            --light-color: #f8f8f8;
            --card-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f5f5f5;
            color: var(--secondary-color);
            padding-top: 20px;
            padding-bottom: 50px;
        }
        
        .container {
            max-width: 1000px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h3 {
            color: var(--primary-color);
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .header p {
            color: var(--secondary-color);
            font-size: 1.1rem;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            margin-bottom: 30px;
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            padding: 15px 20px;
            border-bottom: none;
        }
        
        .card-body {
            padding: 25px;
        }
        
        .form-label {
            font-weight: 500;
            color: var(--secondary-color);
            margin-bottom: 8px;
        }
        
        .form-control, .form-select {
            border-radius: 8px;
            padding: 10px 15px;
            border: 1px solid #ddd;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(128, 0, 0, 0.25);
        }
        
        .btn {
            font-weight: 600;
            padding: 12px 25px;
            border-radius: 8px;
            transition: all 0.3s;
            border: none;
            position: relative;
            overflow: hidden;
            font-family: 'Poppins', sans-serif;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 8px rgba(128, 0, 0, 0.3);
            transform: translateY(0);
        }
        
        .btn-primary:hover {
            background-color: #600000;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(128, 0, 0, 0.4);
        }
        
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(128, 0, 0, 0.3);
        }
        
        .btn-secondary {
            background-color: #444;
            color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .btn-secondary:hover {
            background-color: #333;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #218838;
            transform: translateY(-3px);
        }
        
        .btn-outline-primary {
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            background-color: transparent;
        }
        
        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        .form-section {
            margin-bottom: 20px;
        }
        
        .form-section-title {
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
            color: var(--secondary-color);
            font-weight: 600;
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner-border {
            color: var(--primary-color);
        }
        
        .alert {
            border-radius: 8px;
            font-weight: 500;
        }
        
        .required-field::after {
            content: " *";
            color: var(--primary-color);
        }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            color: #777;
            font-size: 0.9rem;
        }
        
        .field-row {
            border-bottom: 1px solid #eee;
            padding: 15px 0;
        }
        
        .field-row:last-child {
            border-bottom: none;
        }
        
        .field-label {
            font-weight: 600;
            color: var(--secondary-color);
        }
        
        .field-value {
            color: #555;
        }
        
        .verification-buttons {
            display: flex;
            gap: 10px;
        }
        
        .edit-field {
            display: none;
            margin-top: 10px;
        }
        
        .badge {
            font-weight: 500;
            padding: 6px 10px;
        }
        
        .badge-verified {
            background-color: #28a745;
        }
        
        .badge-edited {
            background-color: #fd7e14;
        }
        
        .badge-pending {
            background-color: #6c757d;
        }
        
        .progress-section {
            margin: 20px 0;
        }
        
        .progress {
            height: 10px;
            border-radius: 5px;
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        
        .step {
            text-align: center;
            flex: 1;
            position: relative;
        }
        
        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #ddd;
            color: #555;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: 600;
        }
        
        .step.active .step-number {
            background-color: var(--primary-color);
            color: white;
        }
        
        .step.completed .step-number {
            background-color: #28a745;
            color: white;
        }
        
        .step-title {
            font-size: 0.9rem;
            color: #777;
        }
        
        .step.active .step-title {
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .step.completed .step-title {
            color: #28a745;
        }
        
        .step-line {
            position: absolute;
            top: 15px;
            height: 2px;
            background-color: #ddd;
            width: 100%;
            left: -50%;
            z-index: -1;
        }
        
        .step:first-child .step-line {
            display: none;
        }
        
        .step.completed .step-line {
            background-color: #28a745;
        }
        
        .logo {
            max-width: 100px;
            margin-bottom: 15px;
        }
        
        .year-picker {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
        }
        
        /* Login styles */
        .login-options {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .login-option {
            flex: 1;
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 0 10px;
        }
        
        .login-option:hover {
            transform: translateY(-5px);
        }
        
        .login-option.active {
            background-color: rgba(128, 0, 0, 0.1);
            border: 2px solid var(--primary-color);
        }
        
        .login-option i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .login-form {
            display: none;
        }
        
        .login-form.active {
            display: block;
        }
        
        /* Admin dashboard styles */
        .dashboard-card {
            margin-bottom: 20px;
        }
        
        .dashboard-card .card-header {
            font-size: 1.2rem;
        }
        
        .stats-box {
            text-align: center;
            background-color: #fff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .stats-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
            background-color: #f8f8f8;
        }
        
        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .stats-label {
            color: #555;
            font-size: 0.9rem;
        }
        
        .employee-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .employee-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
        }
        
        .employee-item:last-child {
            border-bottom: none;
        }
        
        .employee-name {
            font-weight: 500;
        }
        
        .employee-status.updated {
            color: #28a745;
        }
        
        .employee-status.pending {
            color: #dc3545;
        }
        
        /* Advanced search and filtering */
        .filter-section {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .filter-section .form-group {
            margin-bottom: 10px;
        }
        
        .filter-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 10px;
        }
        
        /* Export functionality */
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .export-buttons .btn {
            display: flex;
            align-items: center;
        }
        
        .export-buttons .btn i {
            margin-right: 5px;
        }
        
        /* Approval workflow */
        .approval-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .comment-section {
            margin-top: 15px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
        
        .comment-box {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
        }
        
        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.85rem;
            color: #666;
        }
        
        /* Audit trail */
        .audit-log {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
        }
        
        .audit-item {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }
        
        .audit-item:last-child {
            border-bottom: none;
        }
        
        .audit-timestamp {
            color: #666;
            font-size: 0.8rem;
        }
        
        .audit-user {
            font-weight: 600;
        }
        
        .audit-action {
            margin-left: 5px;
        }
        
        .audit-details {
            margin-top: 5px;
            color: #555;
        }
        
        /* Bulk actions */
        .bulk-actions {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .select-all-container {
            margin-bottom: 10px;
        }
        
        .bulk-buttons {
            display: flex;
            gap: 10px;
        }
        
        /* Timeline view */
        .timeline {
            position: relative;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .timeline::after {
            content: '';
            position: absolute;
            width: 6px;
            background-color: #ddd;
            top: 0;
            bottom: 0;
            left: 50%;
            margin-left: -3px;
        }
        
        .timeline-item {
            padding: 10px 40px;
            position: relative;
            background-color: inherit;
            width: 50%;
        }
        
        .timeline-item::after {
            content: '';
            position: absolute;
            width: 25px;
            height: 25px;
            right: -13px;
            background-color: white;
            border: 4px solid var(--primary-color);
            top: 15px;
            border-radius: 50%;
            z-index: 1;
        }
        
        .timeline-left {
            left: 0;
        }
        
        .timeline-right {
            left: 50%;
        }
        
        .timeline-left::before {
            content: " ";
            height: 0;
            position: absolute;
            top: 22px;
            width: 0;
            z-index: 1;
            right: 30px;
            border: medium solid #fff;
            border-width: 10px 0 10px 10px;
            border-color: transparent transparent transparent white;
        }
        
        .timeline-right::before {
            content: " ";
            height: 0;
            position: absolute;
            top: 22px;
            width: 0;
            z-index: 1;
            left: 30px;
            border: medium solid #fff;
            border-width: 10px 10px 10px 0;
            border-color: transparent white transparent transparent;
        }
        
        .timeline-right::after {
            left: -12px;
        }
        
        .timeline-content {
            padding: 15px;
            background-color: white;
            position: relative;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .timeline-date {
            color: #666;
            font-size: 0.8rem;
        }
        
        /* Pagination styles */
        .pagination-container {
            margin-top: 20px;
            margin-bottom: 20px;
        }
        
        .pagination {
            justify-content: center;
        }
        
        .page-link {
            color: var(--primary-color);
            border-color: #ddd;
        }
        
        .page-link:hover {
            color: #600000;
            background-color: #f5f5f5;
        }
        
        .page-item.active .page-link {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .page-item.disabled .page-link {
            color: #999;
        }
        
        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .step-title {
                font-size: 0.7rem;
            }
            
            .login-options {
                flex-direction: column;
                gap: 15px;
            }
            
            .timeline::after {
                left: 31px;
            }
            
            .timeline-item {
                width: 100%;
                padding-left: 70px;
                padding-right: 25px;
            }
            
            .timeline-right {
                left: 0;
            }
            
            .timeline-left::before, 
            .timeline-right::before {
                left: 60px;
                border-width: 10px 10px 10px 0;
                border-color: transparent white transparent transparent;
            }
            
            .timeline-left::after, 
            .timeline-right::after {
                left: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h3>EMPLOYEE DATA SELF VERIFICATION & UPDATION SYSTEM FOR SPARROW</h3>
            <p>Directorate of Agriculture Chhattisgarh</p>
        </div>
        
        <!-- Login Card -->
        <div class="card" id="loginCard">
            <div class="card-header">
                <i class="fas fa-sign-in-alt me-2"></i> Login to System
            </div>
            <div class="card-body">
                <div class="alert alert-danger d-none" id="loginError"></div>
                
                <div class="login-options">
                    <div class="login-option active" id="employeeLoginOption">
                        <i class="fas fa-user"></i>
                        <h5>Employee Login</h5>
                        <p>Login with your mobile number</p>
                    </div>
                    <div class="login-option" id="adminLoginOption">
                        <i class="fas fa-user-shield"></i>
                        <h5>Admin Login</h5>
                        <p>Login to admin dashboard</p>
                    </div>
                </div>
                
                <!-- Employee Login Form -->
                <div class="login-form active" id="employeeLoginForm">
                    <div class="mb-3">
                        <label for="employeeMobile" class="form-label required-field">Mobile Number</label>
                        <input type="text" class="form-control" id="employeeMobile" placeholder="Enter your registered mobile number">
                        <div class="form-text">Please enter the mobile number registered in E-office.</div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" id="employeeLoginButton" type="button">
                            <i class="fas fa-sign-in-alt me-2"></i> LOGIN
                        </button>
                    </div>
                </div>
                
                <!-- Admin Login Form -->
                <div class="login-form" id="adminLoginForm">
                    <div class="mb-3">
                        <label for="adminUserId" class="form-label required-field">User ID</label>
                        <input type="text" class="form-control" id="adminUserId" placeholder="Enter admin user ID">
                    </div>
                    
                    <div class="mb-3">
                        <label for="adminPassword" class="form-label required-field">Password</label>
                        <input type="password" class="form-control" id="adminPassword" placeholder="Enter admin password">
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" id="adminLoginButton" type="button">
                            <i class="fas fa-sign-in-alt me-2"></i> LOGIN
                        </button>
                    </div>
                </div>
                
                <div class="loading-spinner" id="loginSpinner">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-2">Logging in...</div>
                </div>
            </div>
        </div>
        
        <!-- Admin Dashboard Card -->
        <div class="card d-none" id="adminDashboardCard">
            <div class="card-header">
                <i class="fas fa-tachometer-alt me-2"></i> Admin Dashboard
            </div>
            <div class="card-body">
                <div class="alert alert-success mb-4">
                    <i class="fas fa-info-circle me-2"></i> Welcome to the Admin Dashboard. Here you can monitor employee data updation status.
                </div>
                
                <!-- Export and Bulk Actions -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="export-buttons">
                            <button class="btn btn-outline-primary" id="exportCsvBtn">
                                <i class="fas fa-file-csv"></i> Export CSV
                            </button>
                            <button class="btn btn-outline-primary" id="exportExcelBtn">
                                <i class="fas fa-file-excel"></i> Export Excel
                            </button>
                            <button class="btn btn-outline-primary" id="exportBulkPdfBtn">
                                <i class="fas fa-file-pdf"></i> Bulk PDF
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-outline-secondary" id="showFiltersBtn">
                            <i class="fas fa-filter"></i> Advanced Filters
                        </button>
                    </div>
                </div>
                
                <!-- Advanced Filters (initially hidden) -->
                <div class="filter-section d-none" id="filterSection">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="filterStatus">Status</label>
                                <select class="form-select" id="filterStatus">
                                    <option value="">All</option>
                                    <option value="updated">Updated</option>
                                    <option value="pending">Pending</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="filterDesignation">Designation</label>
                                <select class="form-select" id="filterDesignation">
                                    <option value="">All</option>
                                    <!-- Will be populated dynamically -->
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="filterDateFrom">From Date</label>
                                <input type="date" class="form-control" id="filterDateFrom">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="filterDateTo">To Date</label>
                                <input type="date" class="form-control" id="filterDateTo">
                            </div>
                        </div>
                    </div>
                    <div class="filter-buttons">
                        <button class="btn btn-primary" id="applyFiltersBtn">Apply Filters</button>
                        <button class="btn btn-secondary" id="resetFiltersBtn">Reset</button>
                    </div>
                </div>
                
                <!-- Statistics -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="stats-box" id="totalEmployeesBox" title="Click to show all employees">
                            <div class="stats-number" id="totalEmployees">0</div>
                            <div class="stats-label">Total Employees</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-box" id="updatedProfilesBox" title="Click to show updated employees">
                            <div class="stats-number" id="updatedProfiles">0</div>
                            <div class="stats-label">Updated Profiles</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-box" id="pendingProfilesBox" title="Click to show pending employees">
                            <div class="stats-number" id="pendingProfiles">0</div>
                            <div class="stats-label">Pending Profiles</div>
                        </div>
                    </div>
                    <div class="col-12 mt-3">
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar bg-success" role="progressbar" 
                                 style="width: 0%;" id="completionProgress"
                                 aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                0% Complete
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Timeline View -->
                <div class="card dashboard-card mb-4">
                    <div class="card-header">
                        <i class="fas fa-history me-2"></i> Recent Updates Timeline
                    </div>
                    <div class="card-body">
                        <div class="timeline" id="updatesTimeline">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>
                </div>
                
                <!-- Employee List with Bulk Actions -->
                <div class="card dashboard-card">
                    <div class="card-header">
                        <i class="fas fa-users me-2"></i> Employee Update Status
                    </div>
                    <div class="card-body">
                        <!-- Bulk Actions -->
                        <div class="bulk-actions mb-3">
                            <div class="select-all-container">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="selectAllEmployees">
                                    <label class="form-check-label" for="selectAllEmployees">
                                        Select All
                                    </label>
                                </div>
                            </div>
                            <div class="bulk-buttons">
                                <button class="btn btn-sm btn-outline-primary" id="bulkVerifyBtn" disabled>
                                    <i class="fas fa-check-double me-1"></i> Bulk Verify
                                </button>
                                <button class="btn btn-sm btn-outline-primary" id="bulkApproveBtn" disabled>
                                    <i class="fas fa-check-circle me-1"></i> Approve Selected
                                </button>
                                <button class="btn btn-sm btn-outline-danger" id="bulkRejectBtn" disabled>
                                    <i class="fas fa-times-circle me-1"></i> Reject Selected
                                </button>
                            </div>
                        </div>
                        
                        <!-- Search box -->
                        <div class="mb-3">
                            <input type="text" class="form-control" id="employeeSearch" placeholder="Search employees...">
                        </div>
                        
                        <!-- Employee list table -->
                        <div class="table-responsive">
                            <table class="table table-hover" id="employeeTable">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="headerCheckbox"></th>
                                        <th>Employee Name</th>
                                        <th>Mobile Number</th>
                                        <th>Designation</th>
                                        <th>Status</th>
                                        <th>Last Updated</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="employeeList">
                                    <!-- Will be populated dynamically -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination container -->
                        <div id="paginationContainer" class="mt-3">
                            <!-- Pagination will be inserted here -->
                        </div>
                    </div>
                </div>
                
                <!-- Audit Trail -->
                <div class="card dashboard-card mt-4">
                    <div class="card-header">
                        <i class="fas fa-history me-2"></i> Audit Trail
                    </div>
                    <div class="card-body">
                        <div class="audit-log" id="auditLog">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>
                </div>
                
                <div class="text-end mt-4">
                    <button class="btn btn-secondary" id="adminLogoutButton" type="button">
                        <i class="fas fa-sign-out-alt me-2"></i> LOGOUT
                    </button>
                </div>
            </div>
        </div>
        
<!-- Employee Details Modal -->
<div class="modal fade" id="employeeDetailsModal" tabindex="-1" aria-labelledby="employeeDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="employeeDetailsModalLabel">Employee Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="employeeDetailsContent">
                <!-- Will be populated dynamically -->
            </div>
            <div class="modal-footer">
                <!-- Approval Workflow Buttons -->
                <div class="approval-actions">
                    <button type="button" class="btn btn-success" id="approveBtn">
                        <i class="fas fa-check-circle me-1"></i> Approve
                    </button>
                    <button type="button" class="btn btn-danger" id="rejectBtn">
                        <i class="fas fa-times-circle me-1"></i> Reject
                    </button>
                </div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Comments Modal -->
<div class="modal fade" id="commentsModal" tabindex="-1" aria-labelledby="commentsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="commentsModalLabel">Add Comment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="commentText">Comment</label>
                    <textarea class="form-control" id="commentText" rows="3"></textarea>
                </div>
                <div class="comment-section" id="previousComments">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="saveCommentBtn">Save Comment</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Step Indicator -->
<div class="step-indicator d-none" id="stepIndicator">
    <div class="step active" id="step1">
        <div class="step-line"></div>
        <div class="step-number">1</div>
        <div class="step-title">Search</div>
    </div>
    <div class="step" id="step2">
        <div class="step-line"></div>
        <div class="step-number">2</div>
        <div class="step-title">Verify</div>
    </div>
    <div class="step" id="step3">
        <div class="step-line"></div>
        <div class="step-number">3</div>
        <div class="step-title">Review</div>
    </div>
    <div class="step" id="step4">
        <div class="step-line"></div>
        <div class="step-number">4</div>
        <div class="step-title">Submit</div>
    </div>
</div>

<!-- Search Card -->
<div class="card d-none" id="searchCard">
    <div class="card-header">
        <i class="fas fa-search me-2"></i> Search Your Record
    </div>
    <div class="card-body">
        <div class="alert alert-danger d-none" id="searchError"></div>
        
        <div class="mb-3">
            <label for="mobileNumber" class="form-label required-field">Mobile Number</label>
            <input type="text" class="form-control" id="mobileNumber" placeholder="Enter your registered mobile number">
            <div class="form-text">Please enter the mobile number registered in E-office.</div>
        </div>
        
        <div class="d-grid gap-2">
            <button class="btn btn-primary" id="searchButton" type="button">
                <i class="fas fa-search me-2"></i> FIND MY RECORD
            </button>
        </div>
        
        <div class="loading-spinner" id="searchSpinner">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-2">Searching for your record...</div>
        </div>
    </div>
</div>

<!-- Verification Card -->
<div class="card d-none" id="verificationCard">
    <div class="card-header">
        <i class="fas fa-user-check me-2"></i> Verify Your Information
    </div>
    <div class="card-body">
        <div class="alert alert-info mb-4">
            <i class="fas fa-info-circle me-2"></i> Please verify each field below. Click "Yes" if the information is correct, or "No" to edit.
        </div>
        
        <div class="progress-section">
            <div class="d-flex justify-content-between mb-1">
                <span>Verification Progress</span>
                <span id="progressText">0%</span>
            </div>
            <div class="progress">
                <div class="progress-bar bg-success" role="progressbar" style="width: 0%" id="progressBar"></div>
            </div>
        </div>
        
        <div id="fieldsContainer">
            <!-- Fields will be dynamically added here -->
        </div>
        
        <div class="d-flex justify-content-between mt-4">
            <button type="button" class="btn btn-secondary" id="backButton">
                <i class="fas fa-arrow-left me-2"></i> GO BACK
            </button>
            <button type="button" class="btn btn-primary" id="saveDraftButton">
                <i class="fas fa-save me-2"></i> SAVE DRAFT
            </button>
            <button type="button" class="btn btn-success" id="continueButton" disabled>
                <i class="fas fa-check me-2"></i> CONTINUE
            </button>
        </div>
        
        <div class="loading-spinner" id="verifySpinner">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-2">Processing...</div>
        </div>
    </div>
</div>

<!-- Review Card -->
<div class="card d-none" id="reviewCard">
    <div class="card-header">
        <i class="fas fa-clipboard-check me-2"></i> Review Your Information
    </div>
    <div class="card-body">
        <div class="alert alert-info mb-4">
            <i class="fas fa-info-circle me-2"></i> Please review all your information below before final submission.
        </div>
        
        <div id="reviewContainer">
            <!-- Review information will be added here -->
        </div>
        
        <div class="form-check mb-4 mt-3">
            <input class="form-check-input" type="checkbox" id="confirmCheck">
            <label class="form-check-label" for="confirmCheck">
                I confirm that all the information provided is accurate and complete.
            </label>
        </div>
        
        <div class="d-flex justify-content-between">
            <button type="button" class="btn btn-secondary" id="backToVerifyButton">
                <i class="fas fa-arrow-left me-2"></i> BACK TO VERIFY
            </button>
            <button type="button" class="btn btn-success" id="submitButton" disabled>
                <i class="fas fa-paper-plane me-2"></i> SUBMIT
            </button>
        </div>
        
        <div class="loading-spinner" id="submitSpinner">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-2">Submitting your information...</div>
        </div>
    </div>
</div>

<!-- Success Card -->
<div class="card d-none" id="successCard">
    <div class="card-header bg-success text-white">
        <i class="fas fa-check-circle me-2"></i> Submission Successful
    </div>
    <div class="card-body text-center">
        <div class="mb-4">
            <i class="fas fa-check-circle text-success" style="font-size: 64px;"></i>
        </div>
        <h3 class="mb-3">Thank You!</h3>
        <p>Your information has been successfully verified and submitted.</p>
        <div class="mt-4">
            <button class="btn btn-primary me-2" id="downloadPdfButton" type="button">
                <i class="fas fa-file-pdf me-2"></i> DOWNLOAD PDF
            </button>
            <button class="btn btn-secondary" id="startOverButton" type="button">
                <i class="fas fa-redo me-2"></i> START OVER
            </button>
        </div>
    </div>
</div>

<div class="footer">
    <p>&copy; 2025 सूचना प्रौद्योगिकी शाखा, संचालनालय कृषि छत्तीसगढ. रायपुर . सर्वाधिकार सुरक्षित.</p>
</div>
    </div>
    
    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- SheetJS for Excel export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <script>
        // Global variables
        let currentEmployee = null;
        let fieldStatuses = {};
        let editedFields = {};
        let isAdminLoggedIn = false;
        let allEmployees = [];
        let auditTrail = [];
        let selectedEmployees = new Set();
        let currentPage = 1;
        const employeesPerPage = 10; // Show 10 employees per page
        
        // Admin credentials
        const ADMIN_USER_ID = '7354900500';
        const ADMIN_PASSWORD = '9329807288';
        
        // Generate year options for year picker (1950 to current year)
        function generateYearOptions() {
            const currentYear = new Date().getFullYear();
            let options = [];
            for (let year = currentYear; year >= 1950; year--) {
                options.push(year.toString());
            }
            return options;
        }
        
        // Field definitions - matching your table structure exactly with dropdown options
        const fieldDefinitions = [
            { id: "Mobile Number", label: "Mobile Number", type: "text", required: true, readonly: true },
            { id: "Employee Name", label: "Employee Name", type: "text", required: true },
            { id: "Nic E-mail ID", label: "Email ID", type: "email" },
            { id: "Gender", label: "Gender", type: "select", options: ["Male", "Female", "Other"] },
            { id: "Father's Name", label: "Father's Name", type: "text" },
            { id: "Date of Birth", label: "Date of Birth", type: "date" },
            { id: "Nationality", label: "Nationality", type: "select", options: ["Indian", "NRI"] },
            { id: "Religion", label: "Religion", type: "select", options: ["Hindu", "Jain", "Buddhist", "Christian", "Islam", "Sikh", "Others"] },
            { id: "Category", label: "Category", type: "select", options: ["Unreserved", "OBC", "SC", "ST"] },
            { id: "Designation", label: "Designation", type: "select", options: [
                "Ad Director (AE)", "Ad Director", "JDA", "JDA (AE)", "JDF", 
                "DDA", "DDA (Statistics)", "DDA (AE)", "DDF", "ADA", 
                "ADA(AE)", "ADA(Statistics)", "ASO", "SADO", "ADO", 
                "RAEO", "Surveyor", "Supritendant", "Asst Supritendant", "STENO", 
                "AG1", "AG2", "AG3", "COMP. OPER.", "Driver", "daftari", "Peon"
            ]},
            { id: "Service", label: "Service", type: "select", options: ["Permanent", "Not Permanent"] },
            { id: "Orgnazation", label: "Organization", type: "select", options: ["Directorate of Agriculture", "Deputation"] },
            { id: "Organization from Date", label: "Date of Joining", type: "date" },
            { id: "Designation on Joining Date", label: "Designation on Joining", type: "select", options: [
                "Ad Director (AE)", "Ad Director", "JDA", "JDA (AE)", "JDF", 
                "DDA", "DDA (Statistics)", "DDA (AE)", "DDF", "ADA", 
                "ADA(AE)", "ADA(Statistics)", "ASO", "SADO", "ADO", 
                "RAEO", "Surveyor", "Supritendant", "Asst Supritendant", "STENO", 
                "AG1", "AG2", "AG3", "COMP. OPER.", "Driver", "daftari", "Peon"
            ]},
            { id: "Type of Appointment", label: "Type of Appointment", type: "select", options: ["Regular", "Temporary"] },
            { id: "Appointment Order Date", label: "Appointment Order Date", type: "date" },
            { id: "Roles", label: "Roles (In CR reporting System)", type: "text" },
            { id: "Allotment Year", label: "Allotment Year (Year of Promotion)", type: "year", options: generateYearOptions() }
        ];
        
        // Initialize Supabase client
        const supabaseUrl = 'https://txjbfqrbbtvzlxpeegkv.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4amJmcXJiYnR2emx4cGVlZ2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMTU2NTQsImV4cCI6MjA2ODY5MTY1NH0.sE5UbwEOSnd9ED-k_Ix5OfdZbf7dmwlHZSjQQrEAyCo';
        let supabaseClient;
        
        // Document ready function - initialize everything when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Document loaded");
            
            try {
                // Initialize Supabase client
                supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
                console.log("Supabase client initialized");
                
                // Add click event listeners directly to buttons
                addAllEventListeners();
                
                // Test database connection
                testConnection();
                
                // Initialize tooltips
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
            } catch (error) {
                console.error("Error initializing application:", error);
                alert("Error initializing application. Please check the console for details.");
            }
        });
        
        // Add all event listeners
        function addAllEventListeners() {
            // Login section
            document.getElementById('employeeLoginOption').addEventListener('click', switchToEmployeeLogin);
            document.getElementById('adminLoginOption').addEventListener('click', switchToAdminLogin);
            document.getElementById('employeeLoginButton').addEventListener('click', loginEmployee);
            document.getElementById('adminLoginButton').addEventListener('click', loginAdmin);
            
            // Search and verification
            document.getElementById('searchButton').addEventListener('click', searchEmployee);
            document.getElementById('backButton').addEventListener('click', goBackToSearch);
            document.getElementById('saveDraftButton').addEventListener('click', saveDraft);
            document.getElementById('continueButton').addEventListener('click', showReview);
            document.getElementById('backToVerifyButton').addEventListener('click', goBackToVerify);
            document.getElementById('confirmCheck').addEventListener('change', toggleSubmitButton);
            document.getElementById('submitButton').addEventListener('click', submitForm);
            document.getElementById('downloadPdfButton').addEventListener('click', generatePDF);
            document.getElementById('startOverButton').addEventListener('click', startOver);
            
            // Admin dashboard
            document.getElementById('adminLogoutButton').addEventListener('click', logoutAdmin);
            document.getElementById('employeeSearch').addEventListener('input', filterEmployees);
            document.getElementById('showFiltersBtn').addEventListener('click', toggleFilterSection);
            document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
            document.getElementById('resetFiltersBtn').addEventListener('click', resetFilters);
            document.getElementById('exportCsvBtn').addEventListener('click', exportToCSV);
            document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);
            document.getElementById('exportBulkPdfBtn').addEventListener('click', exportBulkPDF);
            document.getElementById('selectAllEmployees').addEventListener('change', toggleSelectAllEmployees);
            document.getElementById('headerCheckbox').addEventListener('change', toggleSelectAllEmployees);
            document.getElementById('bulkVerifyBtn').addEventListener('click', bulkVerify);
            document.getElementById('bulkApproveBtn').addEventListener('click', bulkApprove);
            document.getElementById('bulkRejectBtn').addEventListener('click', bulkReject);
            
            // Stats boxes for filtering
            document.getElementById('totalEmployeesBox').addEventListener('click', function() {
                currentPage = 1; // Reset to first page
                populateEnhancedEmployeeList(allEmployees);
                highlightStatsBox(this);
            });
            
            document.getElementById('updatedProfilesBox').addEventListener('click', function() {
                currentPage = 1; // Reset to first page
                const filtered = allEmployees.filter(emp => emp.last_updated);
                populateEnhancedEmployeeList(filtered);
                highlightStatsBox(this);
            });
            
            document.getElementById('pendingProfilesBox').addEventListener('click', function() {
                currentPage = 1; // Reset to first page
                const filtered = allEmployees.filter(emp => !emp.last_updated);
                populateEnhancedEmployeeList(filtered);
                highlightStatsBox(this);
            });
            
            // Modal buttons
            document.getElementById('approveBtn').addEventListener('click', approveEmployee);
            document.getElementById('rejectBtn').addEventListener('click', showCommentsModal);
            document.getElementById('saveCommentBtn').addEventListener('click', saveComment);
            
            console.log("All event listeners added successfully");
        }
        
        // Highlight the active stats box
        function highlightStatsBox(element) {
            // Remove highlight from all stats boxes
            document.querySelectorAll('.stats-box').forEach(box => {
                box.style.border = 'none';
            });
            
            // Highlight the clicked stats box
            element.style.border = '2px solid #800000';
            element.style.boxShadow = '0 0 10px rgba(128, 0, 0, 0.3)';
        }
        
        // Toggle filter section visibility
        function toggleFilterSection() {
            const filterSection = document.getElementById('filterSection');
            filterSection.classList.toggle('d-none');
        }
        
        // Switch to employee login form
        function switchToEmployeeLogin() {
            document.getElementById('employeeLoginOption').classList.add('active');
            document.getElementById('adminLoginOption').classList.remove('active');
            document.getElementById('employeeLoginForm').classList.add('active');
            document.getElementById('adminLoginForm').classList.remove('active');
            console.log("Switched to employee login");
        }
        
        // Switch to admin login form
        function switchToAdminLogin() {
            document.getElementById('employeeLoginOption').classList.remove('active');
            document.getElementById('adminLoginOption').classList.add('active');
            document.getElementById('employeeLoginForm').classList.remove('active');
            document.getElementById('adminLoginForm').classList.add('active');
            console.log("Switched to admin login");
        }
        
        // Login employee
        function loginEmployee() {
            const mobileNumber = document.getElementById('employeeMobile').value.trim();
            console.log("Employee login attempt with mobile:", mobileNumber);
            
            if (!mobileNumber) {
                showMessage('loginError', 'Please enter your mobile number', true);
                return;
            }
            
            // Show spinner
            document.getElementById('loginSpinner').style.display = 'block';
            document.getElementById('employeeLoginButton').disabled = true;
            
            // Transfer mobile number to search field and proceed to search card
            document.getElementById('mobileNumber').value = mobileNumber;
            
            // Hide login card and show search card and step indicator
            setTimeout(function() {
                document.getElementById('loginSpinner').style.display = 'none';
                document.getElementById('employeeLoginButton').disabled = false;
                document.getElementById('loginCard').classList.add('d-none');
                document.getElementById('searchCard').classList.remove('d-none');
                document.getElementById('stepIndicator').classList.remove('d-none');
                updateStepIndicator(1);
                console.log("Employee login successful, showing search card");
                
                // Check for saved draft
                checkForSavedDraft(mobileNumber);
            }, 1000);
        }
        
        // Login admin
        async function loginAdmin() {
            const userId = document.getElementById('adminUserId').value.trim();
            const password = document.getElementById('adminPassword').value.trim();
            console.log("Admin login attempt");
            
            if (!userId || !password) {
                showMessage('loginError', 'Please enter both User ID and Password', true);
                return;
            }
            
            // Show spinner
            document.getElementById('loginSpinner').style.display = 'block';
            document.getElementById('adminLoginButton').disabled = true;
            
            // Check admin credentials
            if (userId === ADMIN_USER_ID && password === ADMIN_PASSWORD) {
                // Successful login - load admin dashboard
                isAdminLoggedIn = true;
                await loadAdminDashboard();
                
                // Hide login card and show admin dashboard
                document.getElementById('loginSpinner').style.display = 'none';
                document.getElementById('adminLoginButton').disabled = false;
                document.getElementById('loginCard').classList.add('d-none');
                document.getElementById('adminDashboardCard').classList.remove('d-none');
                console.log("Admin login successful, showing dashboard");
                
                // Add audit entry
                addAuditEntry('Admin login', 'Admin logged into the system');
            } else {
                // Failed login
                document.getElementById('loginSpinner').style.display = 'none';
                document.getElementById('adminLoginButton').disabled = false;
                showMessage('loginError', 'Invalid User ID or Password', true);
                console.log("Admin login failed - invalid credentials");
            }
        }
        
        // Logout admin
        function logoutAdmin() {
            console.log("Admin logout");
            isAdminLoggedIn = false;
            document.getElementById('adminDashboardCard').classList.add('d-none');
            document.getElementById('loginCard').classList.remove('d-none');
            
            // Clear admin login fields
            document.getElementById('adminUserId').value = '';
            document.getElementById('adminPassword').value = '';
            switchToEmployeeLogin();
            
            // Add audit entry
            addAuditEntry('Admin logout', 'Admin logged out of the system');
        }
        
        // Test connection to Supabase
        async function testConnection() {
            try {
                console.log("Testing connection to Supabase...");
                
                // Simple query to test connection
                const { data, error } = await supabaseClient
                    .from('employees')
                    .select('count');
                
                if (error) {
                    console.error("Connection test failed:", error);
                } else {
                    console.log("Connection successful!");
                }
            } catch (error) {
                console.error("Error in connection test:", error);
            }
        }
        
        // Load admin dashboard data
        async function loadAdminDashboard() {
            console.log("Loading admin dashboard data");
            try {
                // Fetch all employees from the database
                const { data: employees, error } = await supabaseClient
                    .from('employees')
                    .select('*');
                
                if (error) {
                    console.error("Error fetching employees:", error);
                    return;
                }
                
                // Store employees for later use
                allEmployees = employees;
                
                // Count total, updated, and pending profiles
                const totalCount = employees.length;
                
                // Check for last_updated field to determine status
                const updatedEmployees = employees.filter(emp => emp.last_updated);
                const updatedCount = updatedEmployees.length;
                const pendingCount = totalCount - updatedCount;
                
                // Update stats display
                document.getElementById('totalEmployees').textContent = totalCount;
                document.getElementById('updatedProfiles').textContent = updatedCount;
                document.getElementById('pendingProfiles').textContent = pendingCount;
                
                // Calculate completion percentage
                const completionPercentage = totalCount > 0 ? Math.round((updatedCount / totalCount) * 100) : 0;
                
                // Update progress bar
                const progressBar = document.getElementById('completionProgress');
                progressBar.style.width = completionPercentage + '%';
                progressBar.textContent = completionPercentage + '% Complete';
                progressBar.setAttribute('aria-valuenow', completionPercentage);
                
                // Populate designation filter options
                populateDesignationFilter(employees);
                
                // Populate employee list with enhanced information
                populateEnhancedEmployeeList(employees);
                
                // Populate timeline
                populateTimeline(updatedEmployees);
                
                // Populate audit trail (in real app, this would come from a database)
                populateAuditTrail();
                
                console.log("Admin dashboard loaded successfully");
                
            } catch (error) {
                console.error("Error loading admin dashboard:", error);
            }
        }
        
        // Populate designation filter
        function populateDesignationFilter(employees) {
            const designations = new Set();
            
            // Collect all unique designations
            employees.forEach(emp => {
                if (emp.Designation) {
                    designations.add(emp.Designation);
                }
            });
            
            // Sort designations alphabetically
            const sortedDesignations = Array.from(designations).sort();
            
            // Populate the select element
            const selectElement = document.getElementById('filterDesignation');
            selectElement.innerHTML = '<option value="">All</option>';
            
            sortedDesignations.forEach(designation => {
                const option = document.createElement('option');
                option.value = designation;
                option.textContent = designation;
                selectElement.appendChild(option);
            });
        }
        
        // Populate enhanced employee list with pagination
        function populateEnhancedEmployeeList(employees) {
            console.log("Populating enhanced employee list with", employees.length, "employees");
            const container = document.getElementById('employeeList');
            container.innerHTML = '';
            
            if (employees.length === 0) {
                container.innerHTML = '<tr><td colspan="7" class="text-center">No employees found</td></tr>';
                
                // Hide pagination if no employees
                document.getElementById('paginationContainer').classList.add('d-none');
                return;
            }
            
            // Sort employees: updated first, then alphabetically
            employees.sort((a, b) => {
                // First sort by update status
                const aUpdated = a.last_updated ? 1 : 0;
                const bUpdated = b.last_updated ? 1 : 0;
                
                if (bUpdated !== aUpdated) {
                    return bUpdated - aUpdated; // Updated profiles first
                }
                
                // Then sort alphabetically by name
                return (a['Employee Name'] || '').localeCompare(b['Employee Name'] || '');
            });
            
            // Calculate pagination
            const totalPages = Math.ceil(employees.length / employeesPerPage);
            
            // Ensure current page is valid
            if (currentPage > totalPages) {
                currentPage = totalPages;
            }
            if (currentPage < 1) {
                currentPage = 1;
            }
            
            // Get current page employees
            const startIndex = (currentPage - 1) * employeesPerPage;
            const endIndex = Math.min(startIndex + employeesPerPage, employees.length);
            const currentPageEmployees = employees.slice(startIndex, endIndex);
            
            // Populate table with current page employees
            currentPageEmployees.forEach(function(employee) {
                const isUpdated = employee.last_updated ? true : false;
                const lastUpdateDate = isUpdated ? new Date(employee.last_updated).toLocaleString() : 'Never';
                
                const row = document.createElement('tr');
                row.dataset.id = employee.id || '';
                row.dataset.name = employee['Employee Name'] || '';
                row.dataset.mobile = employee['Mobile Number'] || '';
                
                // Checkbox column
                const checkboxCell = document.createElement('td');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'employee-checkbox';
                checkbox.dataset.id = employee.id || '';
                checkbox.addEventListener('change', function() {
                    toggleEmployeeSelection(employee.id);
                });
                checkboxCell.appendChild(checkbox);
                
                // Employee name column
                const nameCell = document.createElement('td');
                nameCell.textContent = employee['Employee Name'] || 'Unknown';
                
                // Mobile number column
                const mobileCell = document.createElement('td');
                mobileCell.textContent = employee['Mobile Number'] || '';
                
                // Designation column
                const designationCell = document.createElement('td');
                designationCell.textContent = employee['Designation'] || 'Not specified';
                
                // Status column
                const statusCell = document.createElement('td');
                const statusBadge = document.createElement('span');
                statusBadge.className = `badge ${isUpdated ? 'bg-success' : 'bg-danger'}`;
                statusBadge.textContent = isUpdated ? 'Updated' : 'Pending';
                statusCell.appendChild(statusBadge);
                
                // Last updated column
                const lastUpdateCell = document.createElement('td');
                lastUpdateCell.textContent = lastUpdateDate;
                
                // Actions column
                const actionsCell = document.createElement('td');
                
                // View details button
                const viewBtn = document.createElement('button');
                viewBtn.className = 'btn btn-sm btn-primary me-1';
                viewBtn.innerHTML = '<i class="fas fa-eye"></i>';
                viewBtn.title = 'View Details';
                viewBtn.addEventListener('click', function() {
                    showEmployeeDetails(employee);
                });
                
                // PDF button
                const pdfBtn = document.createElement('button');
                pdfBtn.className = 'btn btn-sm btn-secondary me-1';
                pdfBtn.innerHTML = '<i class="fas fa-file-pdf"></i>';
                pdfBtn.title = 'Download PDF';
                pdfBtn.addEventListener('click', function() {
                    generateEmployeePDF(employee);
                });
                
                actionsCell.appendChild(viewBtn);
                actionsCell.appendChild(pdfBtn);
                
                // Add all cells to the row
                row.appendChild(checkboxCell);
                row.appendChild(nameCell);
                row.appendChild(mobileCell);
                row.appendChild(designationCell);
                row.appendChild(statusCell);
                row.appendChild(lastUpdateCell);
                row.appendChild(actionsCell);
                
                container.appendChild(row);
            });
            
            // Update bulk action button states
            updateBulkActionButtonStates();
            
            // Update pagination UI
            updatePagination(employees.length, totalPages, startIndex, endIndex);
        }
        
        // Update pagination controls
        function updatePagination(totalEmployees, totalPages, startIndex, endIndex) {
            const paginationContainer = document.getElementById('paginationContainer');
            
            // Show pagination only if needed
            if (totalPages <= 1) {
                paginationContainer.classList.add('d-none');
                return;
            } else {
                paginationContainer.classList.remove('d-none');
            }
            
            // Clear existing pagination
            paginationContainer.innerHTML = '';
            
            // Create pagination element
            const nav = document.createElement('nav');
            nav.setAttribute('aria-label', 'Employee list pagination');
            
            const ul = document.createElement('ul');
            ul.className = 'pagination justify-content-center';
            
            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            const prevLink = document.createElement('a');
            prevLink.className = 'page-link';
            prevLink.href = '#';
            prevLink.textContent = 'Previous';
            prevLink.addEventListener('click', function(e) {
                e.preventDefault();
                if (currentPage > 1) {
                    currentPage--;
                    // Re-render with same filters
                    const visibleEmployees = getVisibleEmployees();
                    populateEnhancedEmployeeList(visibleEmployees);
                }
            });
            prevLi.appendChild(prevLink);
            ul.appendChild(prevLi);
            
            // Page numbers
            const maxPages = Math.min(totalPages, 5); // Show max 5 page numbers
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + maxPages - 1);
            
            // Adjust if we're near the end
            if (endPage - startPage + 1 < maxPages) {
                startPage = Math.max(1, endPage - maxPages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
                const pageLink = document.createElement('a');
                pageLink.className = 'page-link';
                pageLink.href = '#';
                pageLink.textContent = i;
                pageLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    currentPage = i;
                    // Re-render with same filters
                    const visibleEmployees = getVisibleEmployees();
                    populateEnhancedEmployeeList(visibleEmployees);
                });
                pageLi.appendChild(pageLink);
                ul.appendChild(pageLi);
            }
            
            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            const nextLink = document.createElement('a');
            nextLink.className = 'page-link';
            nextLink.href = '#';
            nextLink.textContent = 'Next';
            nextLink.addEventListener('click', function(e) {
                e.preventDefault();
                if (currentPage < totalPages) {
                    currentPage++;
                    // Re-render with same filters
                    const visibleEmployees = getVisibleEmployees();
                    populateEnhancedEmployeeList(visibleEmployees);
                }
            });
            nextLi.appendChild(nextLink);
            ul.appendChild(nextLi);
            
            nav.appendChild(ul);
            paginationContainer.appendChild(nav);
            
            // Add page info
            const pageInfo = document.createElement('div');
            pageInfo.className = 'text-center mt-2';
            pageInfo.textContent = `Showing ${startIndex + 1} to ${endIndex} of ${totalEmployees} employees`;
            paginationContainer.appendChild(pageInfo);
        }
        
        // Get visible employees (those currently filtered)
        function getVisibleEmployees() {
            // If you're using filters, return the filtered employees
            // Otherwise return all employees
            const filterStatus = document.getElementById('filterStatus').value;
            const filterDesignation = document.getElementById('filterDesignation').value;
            const filterDateFrom = document.getElementById('filterDateFrom').value;
            const filterDateTo = document.getElementById('filterDateTo').value;
            
            let filteredEmployees = [...allEmployees];
            
            // Apply filters if any are set
            if (filterStatus || filterDesignation || filterDateFrom || filterDateTo) {
                // Filter by status
                if (filterStatus) {
                    filteredEmployees = filteredEmployees.filter(emp => {
                        if (filterStatus === 'updated') {
                            return emp.last_updated;
                        } else if (filterStatus === 'pending') {
                            return !emp.last_updated;
                        }
                        return true;
                    });
                }
                
                // Filter by designation
                if (filterDesignation) {
                    filteredEmployees = filteredEmployees.filter(emp => 
                        emp.Designation === filterDesignation
                    );
                }
                
                // Filter by date range
                if (filterDateFrom) {
                    const fromDate = new Date(filterDateFrom);
                    filteredEmployees = filteredEmployees.filter(emp => {
                        if (!emp.last_updated) return false;
                        return new Date(emp.last_updated) >= fromDate;
                    });
                }
                
                if (filterDateTo) {
                    const toDate = new Date(filterDateTo);
                    toDate.setHours(23, 59, 59, 999); // End of the day
                    filteredEmployees = filteredEmployees.filter(emp => {
                        if (!emp.last_updated) return false;
                        return new Date(emp.last_updated) <= toDate;
                    });
                }
            }
            
            return filteredEmployees;
        }
        
        // Populate timeline
        function populateTimeline(updatedEmployees) {
            const container = document.getElementById('updatesTimeline');
            container.innerHTML = '';
            
            // Sort by update date, newest first
            const sortedEmployees = [...updatedEmployees].sort((a, b) => {
                return new Date(b.last_updated) - new Date(a.last_updated);
            });
            
            // Take only the 10 most recent updates
            const recentUpdates = sortedEmployees.slice(0, 10);
            
            if (recentUpdates.length === 0) {
                container.innerHTML = '<div class="text-center p-3">No recent updates</div>';
                return;
            }
            
            recentUpdates.forEach((employee, index) => {
                const timelineItem = document.createElement('div');
                timelineItem.className = `timeline-item ${index % 2 === 0 ? 'timeline-left' : 'timeline-right'}`;
                
                const timelineContent = document.createElement('div');
                timelineContent.className = 'timeline-content';
                
                const title = document.createElement('h5');
                title.textContent = employee['Employee Name'] || 'Unknown';
                
                const designation = document.createElement('p');
                designation.textContent = employee['Designation'] || 'Not specified';
                
                const date = document.createElement('div');
                date.className = 'timeline-date';
                date.textContent = new Date(employee.last_updated).toLocaleString();
                
                timelineContent.appendChild(title);
                timelineContent.appendChild(designation);
                timelineContent.appendChild(date);
                timelineItem.appendChild(timelineContent);
                
                container.appendChild(timelineItem);
            });
        }
        
        // Populate audit trail
        function populateAuditTrail() {
            const container = document.getElementById('auditLog');
            container.innerHTML = '';
            
            if (auditTrail.length === 0) {
                container.innerHTML = '<div class="text-center p-3">No audit records found</div>';
                return;
            }
            
            // Sort by timestamp, newest first
            auditTrail.sort((a, b) => b.timestamp - a.timestamp);
            
            auditTrail.forEach(entry => {
                const auditItem = document.createElement('div');
                auditItem.className = 'audit-item';
                
                const header = document.createElement('div');
                header.innerHTML = `
                    <span class="audit-timestamp">${entry.timestamp.toLocaleString()}</span> - 
                    <span class="audit-user">${entry.user}</span>
                    <span class="audit-action">${entry.action}</span>
                `;
                
                const details = document.createElement('div');
                details.className = 'audit-details';
                details.textContent = entry.details;
                
                auditItem.appendChild(header);
                auditItem.appendChild(details);
                container.appendChild(auditItem);
            });
        }
        
        // Add audit entry
        function addAuditEntry(action, details, user = 'Admin') {
            const entry = {
                timestamp: new Date(),
                user: user,
                action: action,
                details: details
            };
            
            auditTrail.push(entry);
            
            // If admin dashboard is visible, update the audit trail display
            if (!document.getElementById('adminDashboardCard').classList.contains('d-none')) {
                populateAuditTrail();
            }
        }
        
        // Filter employees based on search input
        function filterEmployees() {
            const searchTerm = document.getElementById('employeeSearch').value.toLowerCase();
            currentPage = 1; // Reset to first page when searching
            
            // Get all employees
            let filteredEmployees = [...allEmployees];
            
            // Apply search filter
            if (searchTerm) {
                filteredEmployees = filteredEmployees.filter(emp => {
                    const name = (emp['Employee Name'] || '').toLowerCase();
                    const mobile = (emp['Mobile Number'] || '').toLowerCase();
                    const designation = (emp['Designation'] || '').toLowerCase();
                    
                    return name.includes(searchTerm) || 
                           mobile.includes(searchTerm) ||
                           designation.includes(searchTerm);
                });
            }
            
            // Re-render the employee list with filtered data
            populateEnhancedEmployeeList(filteredEmployees);
        }
        
        // Apply advanced filters
        function applyFilters() {
            currentPage = 1; // Reset to first page when applying filters
            const filteredEmployees = getVisibleEmployees();
            
            // Update the employee list with filtered data
            populateEnhancedEmployeeList(filteredEmployees);
            
            // Add audit entry
            const filterStatus = document.getElementById('filterStatus').value;
            const filterDesignation = document.getElementById('filterDesignation').value;
            const filterDateFrom = document.getElementById('filterDateFrom').value;
            const filterDateTo = document.getElementById('filterDateTo').value;
            addAuditEntry('Applied filters', `Filtered employees: Status=${filterStatus}, Designation=${filterDesignation}, DateRange=${filterDateFrom} to ${filterDateTo}`);
        }
        
        // Reset filters
        function resetFilters() {
            currentPage = 1; // Reset to first page when resetting filters
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterDesignation').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            
            // Reload all employees
            populateEnhancedEmployeeList(allEmployees);
            
            // Add audit entry
            addAuditEntry('Reset filters', 'All filters reset');
        }
        
        // Toggle employee selection
        function toggleEmployeeSelection(employeeId) {
            if (selectedEmployees.has(employeeId)) {
                selectedEmployees.delete(employeeId);
            } else {
                selectedEmployees.add(employeeId);
            }
            
            // Update bulk action button states
            updateBulkActionButtonStates();
        }
        
        // Toggle select all employees
        function toggleSelectAllEmployees() {
            const headerCheckbox = document.getElementById('headerCheckbox');
            const selectAllCheckbox = document.getElementById('selectAllEmployees');
            
            // Synchronize the checkboxes
            const isChecked = headerCheckbox.checked;
            selectAllCheckbox.checked = isChecked;
            
            // Get all visible employee checkboxes
            const checkboxes = document.querySelectorAll('#employeeList tr .employee-checkbox');
            
            // Clear the set first if we're selecting all
            if (isChecked) {
                selectedEmployees.clear();
            }
            
            // Update each checkbox and the selection set
            checkboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
                const employeeId = checkbox.dataset.id;
                
                if (isChecked) {
                    selectedEmployees.add(employeeId);
                } else {
                    selectedEmployees.delete(employeeId);
                }
            });
            
            // Update bulk action button states
            updateBulkActionButtonStates();
        }
        
        // Update bulk action button states
        function updateBulkActionButtonStates() {
            const bulkVerifyBtn = document.getElementById('bulkVerifyBtn');
            const bulkApproveBtn = document.getElementById('bulkApproveBtn');
            const bulkRejectBtn = document.getElementById('bulkRejectBtn');
            
            const hasSelection = selectedEmployees.size > 0;
            
            bulkVerifyBtn.disabled = !hasSelection;
            bulkApproveBtn.disabled = !hasSelection;
            bulkRejectBtn.disabled = !hasSelection;
        }
        
        // Show employee details in a modal
        function showEmployeeDetails(employee) {
            console.log("Showing details for employee:", employee);
            
            // Get modal elements
            const modal = document.getElementById('employeeDetailsModal');
            const modalTitle = document.getElementById('employeeDetailsModalLabel');
            const modalContent = document.getElementById('employeeDetailsContent');
            
            // Set modal title
            modalTitle.textContent = `Employee Details: ${employee['Employee Name'] || 'Unknown'}`;
            
            // Clear modal content
            modalContent.innerHTML = '';
            
            // Create sections
            const personalSection = document.createElement('div');
            personalSection.className = 'mb-4';
            
            const personalTitle = document.createElement('h5');
            personalTitle.className = 'form-section-title';
            personalTitle.textContent = 'Personal Information';
            personalSection.appendChild(personalTitle);
            
            const professionalSection = document.createElement('div');
            professionalSection.className = 'mb-4';
            
            const professionalTitle = document.createElement('h5');
            professionalTitle.className = 'form-section-title';
            professionalTitle.textContent = 'Professional Information';
            professionalSection.appendChild(professionalTitle);
            
            // Add fields to appropriate sections
            fieldDefinitions.forEach(function(field) {
                const value = employee[field.id] || '';
                
                // Create row div
                const rowDiv = document.createElement('div');
                rowDiv.className = 'row mb-2';
                
                // Create label column
                const labelCol = document.createElement('div');
                labelCol.className = 'col-md-4';
                const strongLabel = document.createElement('strong');
                strongLabel.textContent = field.label + ':';
                labelCol.appendChild(strongLabel);
                
                // Create value column
                const valueCol = document.createElement('div');
                valueCol.className = 'col-md-8';
                valueCol.textContent = value;
                
                // Add columns to row
                rowDiv.appendChild(labelCol);
                rowDiv.appendChild(valueCol);
                
                // Add to appropriate section based on field type
                if (['Mobile Number', 'Employee Name', 'Nic E-mail ID', 'Gender', 'Father\'s Name', 'Date of Birth', 'Nationality', 'Religion', 'Category'].includes(field.id)) {
                    personalSection.appendChild(rowDiv);
                } else {
                    professionalSection.appendChild(rowDiv);
                }
            });
            
            // Add update status information
            const updateSection = document.createElement('div');
            updateSection.className = 'mb-4';
            
            const updateTitle = document.createElement('h5');
            updateTitle.className = 'form-section-title';
            updateTitle.textContent = 'Update Status';
            updateSection.appendChild(updateTitle);
            
            const updateStatusRow = document.createElement('div');
            updateStatusRow.className = 'row mb-2';
            
            const updateStatusLabel = document.createElement('div');
            updateStatusLabel.className = 'col-md-4';
            const updateStatusStrong = document.createElement('strong');
            updateStatusStrong.textContent = 'Status:';
            updateStatusLabel.appendChild(updateStatusStrong);
            
            const updateStatusValue = document.createElement('div');
            updateStatusValue.className = 'col-md-8';
            
            const isUpdated = employee.last_updated ? true : false;
            const badge = document.createElement('span');
            badge.className = `badge ${isUpdated ? 'bg-success' : 'bg-danger'}`;
            badge.textContent = isUpdated ? 'Updated' : 'Pending';
            updateStatusValue.appendChild(badge);
            
            updateStatusRow.appendChild(updateStatusLabel);
            updateStatusRow.appendChild(updateStatusValue);
            updateSection.appendChild(updateStatusRow);
            
            if (isUpdated) {
                const lastUpdateRow = document.createElement('div');
                lastUpdateRow.className = 'row mb-2';
                
                const lastUpdateLabel = document.createElement('div');
                lastUpdateLabel.className = 'col-md-4';
                const lastUpdateStrong = document.createElement('strong');
                lastUpdateStrong.textContent = 'Last Updated:';
                lastUpdateLabel.appendChild(lastUpdateStrong);
                
                const lastUpdateValue = document.createElement('div');
                lastUpdateValue.className = 'col-md-8';
                lastUpdateValue.textContent = new Date(employee.last_updated).toLocaleString();
                
                lastUpdateRow.appendChild(lastUpdateLabel);
                lastUpdateRow.appendChild(lastUpdateValue);
                updateSection.appendChild(lastUpdateRow);
            }
            
            // Add approval status if available
            if (employee.approval_status) {
                const approvalRow = document.createElement('div');
                approvalRow.className = 'row mb-2';
                
                const approvalLabel = document.createElement('div');
                approvalLabel.className = 'col-md-4';
                const approvalStrong = document.createElement('strong');
                approvalStrong.textContent = 'Approval Status:';
                approvalLabel.appendChild(approvalStrong);
                
                const approvalValue = document.createElement('div');
                approvalValue.className = 'col-md-8';
                
                const approvalBadge = document.createElement('span');
                let badgeClass = '';
                
                switch (employee.approval_status) {
                    case 'approved':
                        badgeClass = 'bg-success';
                        break;
                    case 'rejected':
                        badgeClass = 'bg-danger';
                        break;
                    default:
                        badgeClass = 'bg-warning';
                }
                
                approvalBadge.className = `badge ${badgeClass}`;
                approvalBadge.textContent = employee.approval_status.charAt(0).toUpperCase() + employee.approval_status.slice(1);
                approvalValue.appendChild(approvalBadge);
                
                approvalRow.appendChild(approvalLabel);
                approvalRow.appendChild(approvalValue);
                updateSection.appendChild(approvalRow);
            }
            
            // Store the current employee in the modal for reference
            modal.dataset.employeeId = employee.id;
            
            // Add sections to modal
            modalContent.appendChild(updateSection);
            modalContent.appendChild(personalSection);
            modalContent.appendChild(professionalSection);
            
            // Display comments if any
            if (employee.comments && employee.comments.length > 0) {
                const commentsSection = document.createElement('div');
                commentsSection.className = 'mb-4';
                
                const commentsTitle = document.createElement('h5');
                commentsTitle.className = 'form-section-title';
                commentsTitle.textContent = 'Comments';
                commentsSection.appendChild(commentsTitle);
                
                employee.comments.forEach(comment => {
                    const commentBox = document.createElement('div');
                    commentBox.className = 'comment-box';
                    
                    const commentHeader = document.createElement('div');
                    commentHeader.className = 'comment-header';
                    commentHeader.textContent = `By ${comment.user} on ${new Date(comment.timestamp).toLocaleString()}`;
                    
                    const commentText = document.createElement('div');
                    commentText.textContent = comment.text;
                    
                    commentBox.appendChild(commentHeader);
                    commentBox.appendChild(commentText);
                    commentsSection.appendChild(commentBox);
                });
                
                modalContent.appendChild(commentsSection);
            }
            
            // Show modal
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            // Add audit entry
            addAuditEntry('Viewed employee details', `Viewed details for employee: ${employee['Employee Name']} (${employee['Mobile Number']})`);
        }
        
        // Show comments modal
        function showCommentsModal() {
            const employeeDetailsModal = document.getElementById('employeeDetailsModal');
            const employeeId = employeeDetailsModal.dataset.employeeId;
            
            // Find the employee
            const employee = allEmployees.find(emp => emp.id == employeeId);
            
            if (!employee) {
                console.error("Employee not found for ID:", employeeId);
                return;
            }
            
            // Set modal title
            const commentsModalLabel = document.getElementById('commentsModalLabel');
            commentsModalLabel.textContent = `Add Comment for ${employee['Employee Name']}`;
            
            // Clear previous comments
            document.getElementById('commentText').value = '';
            
            // Populate previous comments
            const previousCommentsContainer = document.getElementById('previousComments');
            previousCommentsContainer.innerHTML = '';
            
            if (employee.comments && employee.comments.length > 0) {
                employee.comments.forEach(comment => {
                    const commentBox = document.createElement('div');
                    commentBox.className = 'comment-box';
                    
                    const commentHeader = document.createElement('div');
                    commentHeader.className = 'comment-header';
                    commentHeader.textContent = `By ${comment.user} on ${new Date(comment.timestamp).toLocaleString()}`;
                    
                    const commentText = document.createElement('div');
                    commentText.textContent = comment.text;
                    
                    commentBox.appendChild(commentHeader);
                    commentBox.appendChild(commentText);
                    previousCommentsContainer.appendChild(commentBox);
                });
            } else {
                previousCommentsContainer.innerHTML = '<div class="text-center p-2">No previous comments</div>';
            }
            
            // Store the employee ID in the modal
            const commentsModal = document.getElementById('commentsModal');
            commentsModal.dataset.employeeId = employeeId;
            
            // Show the modal
            const bsModal = new bootstrap.Modal(commentsModal);
            bsModal.show();
        }
        // Save comment and reject employee
        async function saveComment() {
            const commentsModal = document.getElementById('commentsModal');
            const employeeId = commentsModal.dataset.employeeId;
            const commentText = document.getElementById('commentText').value.trim();
            
            if (!commentText) {
                alert("Please enter a comment before saving.");
                return;
            }
            
            // Find the employee
            const employeeIndex = allEmployees.findIndex(emp => emp.id == employeeId);
            
            if (employeeIndex === -1) {
                console.error("Employee not found for ID:", employeeId);
                return;
            }
            
            // Create comment object
            const comment = {
                text: commentText,
                user: 'Admin',
                timestamp: new Date().toISOString()
            };
            
            // Initialize comments array if it doesn't exist
            if (!allEmployees[employeeIndex].comments) {
                allEmployees[employeeIndex].comments = [];
            }
            
            // Add the comment
            allEmployees[employeeIndex].comments.push(comment);
            
            // Update approval status
            allEmployees[employeeIndex].approval_status = 'rejected';
            
            try {
                // In a real app, you would save this to the database
                await updateEmployeeInDatabase(allEmployees[employeeIndex]);
                
                // Hide the comments modal
                const bsModal = bootstrap.Modal.getInstance(commentsModal);
                bsModal.hide();
                
                // Hide the employee details modal
                const employeeDetailsModal = document.getElementById('employeeDetailsModal');
                const empDetailsBsModal = bootstrap.Modal.getInstance(employeeDetailsModal);
                empDetailsBsModal.hide();
                
                // Refresh the employee list
                populateEnhancedEmployeeList(getVisibleEmployees());
                
                // Add audit entry
                addAuditEntry('Rejected employee', `Rejected employee: ${allEmployees[employeeIndex]['Employee Name']} with comment: ${commentText}`);
                
                // Show success message
                alert("Employee data rejected with comment.");
            } catch (error) {
                console.error("Error saving comment:", error);
                alert("Error saving comment: " + error.message);
            }
        }
        
        // Approve employee
        async function approveEmployee() {
            const modal = document.getElementById('employeeDetailsModal');
            const employeeId = modal.dataset.employeeId;
            
            // Find the employee
            const employeeIndex = allEmployees.findIndex(emp => emp.id == employeeId);
            
            if (employeeIndex === -1) {
                console.error("Employee not found for ID:", employeeId);
                return;
            }
            
            try {
                // Update approval status
                allEmployees[employeeIndex].approval_status = 'approved';
                
                // In a real app, you would save this to the database
                await updateEmployeeInDatabase(allEmployees[employeeIndex]);
                
                // Hide the modal
                const bsModal = bootstrap.Modal.getInstance(modal);
                bsModal.hide();
                
                // Refresh the employee list
                populateEnhancedEmployeeList(getVisibleEmployees());
                
                // Add audit entry
                addAuditEntry('Approved employee', `Approved employee: ${allEmployees[employeeIndex]['Employee Name']}`);
                
                // Show success message
                alert("Employee data approved successfully.");
            } catch (error) {
                console.error("Error approving employee:", error);
                alert("Error approving employee: " + error.message);
            }
        }
        
        // Update employee in database
        async function updateEmployeeInDatabase(employee) {
            try {
                const { error } = await supabaseClient
                    .from('employees')
                    .update({
                        approval_status: employee.approval_status,
                        comments: employee.comments
                    })
                    .eq('id', employee.id);
                
                if (error) {
                    console.error("Error updating employee in database:", error);
                    throw error;
                }
                
                console.log("Employee updated successfully in database");
            } catch (error) {
                console.error("Exception updating employee:", error);
                throw error;
            }
        }
        
        // Bulk verify employees
        function bulkVerify() {
            if (selectedEmployees.size === 0) {
                alert("Please select employees to verify.");
                return;
            }
            
            // In a real app, you would update the database
            const count = selectedEmployees.size;
            
            // Add audit entry
            addAuditEntry('Bulk verify', `Bulk verified ${count} employees`);
            
            // Show success message
            alert(`${count} employees have been verified.`);
            
            // Clear selections
            selectedEmployees.clear();
            
            // Update checkboxes
            document.querySelectorAll('.employee-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.getElementById('selectAllEmployees').checked = false;
            document.getElementById('headerCheckbox').checked = false;
            
            // Update bulk action button states
            updateBulkActionButtonStates();
        }
        
        // Bulk approve employees
        async function bulkApprove() {
            if (selectedEmployees.size === 0) {
                alert("Please select employees to approve.");
                return;
            }
            
            // Show confirmation dialog
            if (!confirm(`Are you sure you want to approve ${selectedEmployees.size} employees?`)) {
                return;
            }
            
            try {
                // For each selected employee, update their approval status
                for (const employeeId of selectedEmployees) {
                    const employeeIndex = allEmployees.findIndex(emp => emp.id == employeeId);
                    
                    if (employeeIndex !== -1) {
                        allEmployees[employeeIndex].approval_status = 'approved';
                        await updateEmployeeInDatabase(allEmployees[employeeIndex]);
                    }
                }
                
                // Add audit entry
                addAuditEntry('Bulk approve', `Bulk approved ${selectedEmployees.size} employees`);
                
                // Show success message
                alert(`${selectedEmployees.size} employees have been approved.`);
                
                // Clear selections
                selectedEmployees.clear();
                
                // Update checkboxes
                document.querySelectorAll('.employee-checkbox').forEach(checkbox => {
                    checkbox.checked = false;
                });
                document.getElementById('selectAllEmployees').checked = false;
                document.getElementById('headerCheckbox').checked = false;
                
                // Update bulk action button states
                updateBulkActionButtonStates();
                
                // Refresh the employee list
                populateEnhancedEmployeeList(getVisibleEmployees());
            } catch (error) {
                console.error("Error in bulk approve:", error);
                alert("Error approving employees: " + error.message);
            }
        }
        
        // Bulk reject employees
        async function bulkReject() {
            if (selectedEmployees.size === 0) {
                alert("Please select employees to reject.");
                return;
            }
            
            // Prompt for rejection comment
            const comment = prompt("Please enter a rejection comment:");
            
            if (comment === null) {
                // User cancelled
                return;
            }
            
            if (comment.trim() === "") {
                alert("A comment is required for rejection.");
                return;
            }
            
            try {
                // For each selected employee, update their approval status and add comment
                for (const employeeId of selectedEmployees) {
                    const employeeIndex = allEmployees.findIndex(emp => emp.id == employeeId);
                    
                    if (employeeIndex !== -1) {
                        // Create comment object
                        const commentObj = {
                            text: comment,
                            user: 'Admin',
                            timestamp: new Date().toISOString()
                        };
                        
                        // Initialize comments array if it doesn't exist
                        if (!allEmployees[employeeIndex].comments) {
                            allEmployees[employeeIndex].comments = [];
                        }
                        
                        // Add the comment
                        allEmployees[employeeIndex].comments.push(commentObj);
                        
                        // Update approval status
                        allEmployees[employeeIndex].approval_status = 'rejected';
                        
                        // Update in database
                        await updateEmployeeInDatabase(allEmployees[employeeIndex]);
                    }
                }
                
                // Add audit entry
                addAuditEntry('Bulk reject', `Bulk rejected ${selectedEmployees.size} employees with comment: ${comment}`);
                
                // Show success message
                alert(`${selectedEmployees.size} employees have been rejected with comment: ${comment}`);
                
                // Clear selections
                selectedEmployees.clear();
                
                // Update checkboxes
                document.querySelectorAll('.employee-checkbox').forEach(checkbox => {
                    checkbox.checked = false;
                });
                document.getElementById('selectAllEmployees').checked = false;
                document.getElementById('headerCheckbox').checked = false;
                
                // Update bulk action button states
                updateBulkActionButtonStates();
                
                // Refresh the employee list
                populateEnhancedEmployeeList(getVisibleEmployees());
            } catch (error) {
                console.error("Error in bulk reject:", error);
                alert("Error rejecting employees: " + error.message);
            }
        }
        
        // Export to CSV
        function exportToCSV() {
            // Get all employees or filtered employees
            const employeesToExport = getVisibleEmployees();
            
            if (employeesToExport.length === 0) {
                alert("No employees to export.");
                return;
            }
            
            // Create CSV header
            let csv = 'Mobile Number,Employee Name,Email ID,Gender,Date of Birth,Designation,Status,Last Updated\n';
            
            // Add employee data
            employeesToExport.forEach(emp => {
                const status = emp.last_updated ? 'Updated' : 'Pending';
                const lastUpdated = emp.last_updated ? new Date(emp.last_updated).toLocaleString() : 'Never';
                
                // Escape fields that might contain commas
                const escapedName = `"${(emp['Employee Name'] || '').replace(/"/g, '""')}"`;
                const escapedEmail = `"${(emp['Nic E-mail ID'] || '').replace(/"/g, '""')}"`;
                const escapedDesignation = `"${(emp['Designation'] || '').replace(/"/g, '""')}"`;
                
                csv += `${emp['Mobile Number'] || ''},${escapedName},${escapedEmail},${emp['Gender'] || ''},${emp['Date of Birth'] || ''},${escapedDesignation},${status},${lastUpdated}\n`;
            });
            
            // Create and download the CSV file
            downloadFile(csv, 'employees.csv', 'text/csv');
            
            // Add audit entry
            addAuditEntry('Exported CSV', `Exported ${employeesToExport.length} employees to CSV`);
        }
        
        // Export to Excel
        function exportToExcel() {
            // Get all employees or filtered employees
            const employeesToExport = getVisibleEmployees();
            
            if (employeesToExport.length === 0) {
                alert("No employees to export.");
                return;
            }
            
            // Create worksheet data
            const wsData = [
                ['Mobile Number', 'Employee Name', 'Email ID', 'Gender', 'Date of Birth', 'Designation', 'Status', 'Last Updated']
            ];
            
            // Add employee data
            employeesToExport.forEach(emp => {
                const status = emp.last_updated ? 'Updated' : 'Pending';
                const lastUpdated = emp.last_updated ? new Date(emp.last_updated).toLocaleString() : 'Never';
                
                wsData.push([
                    emp['Mobile Number'] || '',
                    emp['Employee Name'] || '',
                    emp['Nic E-mail ID'] || '',
                    emp['Gender'] || '',
                    emp['Date of Birth'] || '',
                    emp['Designation'] || '',
                    status,
                    lastUpdated
                ]);
            });
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Employees');
            
            // Generate Excel file and trigger download
            XLSX.writeFile(wb, 'employees.xlsx');
            
            // Add audit entry
            addAuditEntry('Exported Excel', `Exported ${employeesToExport.length} employees to Excel`);
        }
        
        // Export bulk PDF
        function exportBulkPDF() {
            // Get all employees or filtered employees
            const employeesToExport = getVisibleEmployees();
            
            if (employeesToExport.length === 0) {
                alert("No employees to export.");
                return;
            }
            
            // Show confirmation dialog for large exports
            if (employeesToExport.length > 10) {
                if (!confirm(`You are about to generate PDFs for ${employeesToExport.length} employees. This may take some time. Continue?`)) {
                    return;
                }
            }
            
            try {
                // Initialize jsPDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: "portrait",
                    unit: "mm",
                    format: "a4"
                });
                
                // Define constants for layout
                const pageWidth = doc.internal.pageSize.width;
                const margin = 15;
                
                let currentPage = 1;
                
                // For each employee
                employeesToExport.forEach((employee, index) => {
                    // Add a new page for each employee except the first one
                    if (index > 0) {
                        doc.addPage();
                        currentPage++;
                    }
                    
                    // Add header with logo placeholder
                    doc.setFillColor(128, 0, 0); // Maroon red
                    doc.rect(0, 0, pageWidth, 25, 'F');
                    
                    doc.setTextColor(255, 255, 255); // White text
                    doc.setFontSize(16);
                    doc.setFont(undefined, 'bold');
                    doc.text('EMPLOYEE DATA VERIFICATION REPORT', pageWidth/2, 10, { align: 'center' });
                    
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'normal');
                    doc.text('Directorate of Agriculture Chhattisgarh', pageWidth/2, 18, { align: 'center' });
                    
                    // Add employee information section
                    doc.setTextColor(0, 0, 0); // Black text
                    doc.setFillColor(240, 240, 240); // Light gray background
                    doc.rect(margin, 30, pageWidth - (margin * 2), 25, 'F');
                    
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('Employee Information', margin + 5, 38);
                    
                    doc.setFont(undefined, 'normal');
                    doc.text('Name: ' + (employee['Employee Name'] || 'N/A'), margin + 5, 45);
                    doc.text('Mobile: ' + (employee['Mobile Number'] || 'N/A'), pageWidth - margin - 50, 45);
                    
                    // Add verification status section
                    doc.setFillColor(245, 245, 245); // Lighter gray
                    doc.rect(margin, 60, pageWidth - (margin * 2), 15, 'F');
                    
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    doc.text('Verification Status', margin + 5, 68);
                    
                    const verificationDate = employee.last_updated ? 
                        new Date(employee.last_updated).toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        }) : 'Not Verified';
                        
                    doc.setFont(undefined, 'normal');
                    doc.text('Status: ' + (employee.last_updated ? 'Verified' : 'Pending'), margin + 70, 68);
                    doc.text('Date: ' + verificationDate, pageWidth - margin - 60, 68);
                    
                    // Prepare data for tables
                    const personalFields = [
                        'Mobile Number', 'Employee Name', 'Nic E-mail ID', 'Gender', 
                        'Father\'s Name', 'Date of Birth', 'Nationality', 'Religion', 'Category'
                    ];
                    
                    const personalData = [];
                    const professionalData = [];
                    
                    fieldDefinitions.forEach(function(field) {
                        const value = employee[field.id] || '';
                        
                        // Add to appropriate array based on field type
                        if (personalFields.includes(field.id)) {
                            personalData.push([field.label, value]);
                        } else {
                            professionalData.push([field.label, value]);
                        }
                    });
                    
                    // Add personal information table
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('Personal Information', margin, 85);
                    
                    doc.autoTable({
                        startY: 90,
                        head: [['Field', 'Value']],
                        body: personalData,
                        margin: { left: margin, right: margin },
                        styles: {
                            fontSize: 10,
                            cellPadding: 3,
                            lineWidth: 0.1
                        },
                        headStyles: {
                            fillColor: [128, 0, 0],
                            textColor: [255, 255, 255],
                            fontStyle: 'bold'
                        },
                        alternateRowStyles: {
                            fillColor: [245, 245, 245]
                        },
                        columnStyles: {
                            0: { fontStyle: 'bold', cellWidth: 50 },
                            1: { cellWidth: 'auto' }
                        }
                    });
                    
                    // Add professional information table
                    const professionalStartY = doc.previousAutoTable.finalY + 15;
                    
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('Professional Information', margin, professionalStartY);
                    
                    doc.autoTable({
                        startY: professionalStartY + 5,
                        head: [['Field', 'Value']],
                        body: professionalData,
                        margin: { left: margin, right: margin },
                        styles: {
                            fontSize: 10,
                            cellPadding: 3,
                            lineWidth: 0.1
                        },
                        headStyles: {
                            fillColor: [128, 0, 0],
                            textColor: [255, 255, 255],
                            fontStyle: 'bold'
                        },
                        alternateRowStyles: {
                            fillColor: [245, 245, 245]
                        },
                        columnStyles: {
                            0: { fontStyle: 'bold', cellWidth: 50 },
                            1: { cellWidth: 'auto' }
                        }
                    });
                    
                    // Add footer with page numbers
                    doc.setDrawColor(128, 0, 0); // Maroon red
                    doc.setLineWidth(0.5);
                    doc.line(margin, 280, pageWidth - margin, 280);
                    
                    doc.setFontSize(8);
                    doc.setTextColor(0, 0, 0);
                    doc.text('Directorate of Agriculture Chhattisgarh - SPARROW Data Verification System', pageWidth / 2, 285, { align: 'center' });
                    doc.text('Page ' + currentPage, pageWidth - margin, 285, { align: 'right' });
                    doc.text('Generated on: ' + new Date().toLocaleString(), margin, 285, { align: 'left' });
                });
                
                // Save the PDF
                doc.save('employees_bulk_report.pdf');
                
                // Add audit entry
                addAuditEntry('Exported bulk PDF', `Generated PDF report for ${employeesToExport.length} employees`);
            } catch (error) {
                console.error("Error generating bulk PDF:", error);
                alert("Error generating bulk PDF: " + error.message);
            }
        }
        
        // Download file helper
        function downloadFile(content, fileName, contentType) {
            const a = document.createElement('a');
            const file = new Blob([content], { type: contentType });
            a.href = URL.createObjectURL(file);
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(a.href);
        }
        
        // Generate employee PDF
        function generateEmployeePDF(employee) {
            try {
                // Initialize jsPDF with A4 size
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: "portrait",
                    unit: "mm",
                    format: "a4"
                });
                
                // Define constants for layout
                const pageWidth = doc.internal.pageSize.width;
                const margin = 15;
                const contentWidth = pageWidth - (margin * 2);
                
                // Add header with logo placeholder
                doc.setFillColor(128, 0, 0); // Maroon red
                doc.rect(0, 0, pageWidth, 25, 'F');
                
                doc.setTextColor(255, 255, 255); // White text
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('EMPLOYEE DATA VERIFICATION REPORT', pageWidth/2, 10, { align: 'center' });
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text('Directorate of Agriculture Chhattisgarh', pageWidth/2, 18, { align: 'center' });
                
                // Add employee information section
                doc.setTextColor(0, 0, 0); // Black text
                doc.setFillColor(240, 240, 240); // Light gray background
                doc.rect(margin, 30, contentWidth, 25, 'F');
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Employee Information', margin + 5, 38);
                
                doc.setFont(undefined, 'normal');
                doc.text('Name: ' + (employee['Employee Name'] || 'N/A'), margin + 5, 45);
                doc.text('Mobile: ' + (employee['Mobile Number'] || 'N/A'), pageWidth - margin - 50, 45);
                
                // Add verification status section
                doc.setFillColor(245, 245, 245); // Lighter gray
                doc.rect(margin, 60, contentWidth, 15, 'F');
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text('Verification Status', margin + 5, 68);
                
                const verificationDate = employee.last_updated ? 
                    new Date(employee.last_updated).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    }) : 'Not Verified';
                    
                doc.setFont(undefined, 'normal');
                doc.text('Status: ' + (employee.last_updated ? 'Verified' : 'Pending'), margin + 70, 68);
                doc.text('Date: ' + verificationDate, pageWidth - margin - 60, 68);
                
                // Prepare data for tables with better formatting
                const personalFields = [
                    'Mobile Number', 'Employee Name', 'Nic E-mail ID', 'Gender', 
                    'Father\'s Name', 'Date of Birth', 'Nationality', 'Religion', 'Category'
                ];
                
                const personalData = [];
                const professionalData = [];
                
                fieldDefinitions.forEach(function(field) {
                    const value = employee[field.id] || '';
                    
                    // Add to appropriate array based on field type
                    if (personalFields.includes(field.id)) {
                        personalData.push([field.label, value]);
                    } else {
                        professionalData.push([field.label, value]);
                    }
                });
                
                // Add personal information table with better styling
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Personal Information', margin, 85);
                
                doc.autoTable({
                    startY: 90,
                    head: [['Field', 'Value']],
                    body: personalData,
                    margin: { left: margin, right: margin },
                    styles: {
                        fontSize: 10,
                        cellPadding: 3,
                        lineWidth: 0.1
                    },
                    headStyles: {
                        fillColor: [128, 0, 0],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [245, 245, 245]
                    },
                    columnStyles: {
                        0: { fontStyle: 'bold', cellWidth: 50 },
                        1: { cellWidth: 'auto' }
                    }
                });
                
                // Add professional information table
                const professionalStartY = doc.previousAutoTable.finalY + 15;
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Professional Information', margin, professionalStartY);
                
                doc.autoTable({
                    startY: professionalStartY + 5,
                    head: [['Field', 'Value']],
                    body: professionalData,
                    margin: { left: margin, right: margin },
                    styles: {
                        fontSize: 10,
                        cellPadding: 3,
                        lineWidth: 0.1
                    },
                    headStyles: {
                        fillColor: [128, 0, 0],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [245, 245, 245]
                    },
                    columnStyles: {
                        0: { fontStyle: 'bold', cellWidth: 50 },
                        1: { cellWidth: 'auto' }
                    }
                });
                
                // Add approval status if available
                if (employee.approval_status) {
                    const approvalY = doc.previousAutoTable.finalY + 15;
                    
                    doc.setFillColor(240, 240, 240);
                    doc.rect(margin, approvalY, contentWidth, 20, 'F');
                    
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('Approval Information', margin + 5, approvalY + 8);
                    
                    doc.setFont(undefined, 'normal');
                    const status = employee.approval_status.charAt(0).toUpperCase() + employee.approval_status.slice(1);
                    doc.text('Status: ' + status, margin + 5, approvalY + 16);
                }
                
                // Add signature section
                const signatureY = doc.previousAutoTable.finalY + 25;
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text('Employee Signature', margin, signatureY);
                doc.line(margin, signatureY + 15, margin + 50, signatureY + 15);
                
                doc.text('Authorized Signature', pageWidth - margin - 50, signatureY);
                doc.line(pageWidth - margin - 50, signatureY + 15, pageWidth - margin, signatureY + 15);
                
                // Add footer with page numbers
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    
                    // Add footer line
                    doc.setDrawColor(128, 0, 0); // Maroon red
                    doc.setLineWidth(0.5);
                    doc.line(margin, 280, pageWidth - margin, 280);
                    
                    // Add footer text
                    doc.setFontSize(8);
                    doc.setTextColor(0, 0, 0);
                    doc.text('Directorate of Agriculture Chhattisgarh - SPARROW Data Verification System', pageWidth / 2, 285, { align: 'center' });
                    doc.text('Page ' + i + ' of ' + pageCount, pageWidth - margin, 285, { align: 'right' });
                    doc.text('Generated on: ' + new Date().toLocaleString(), margin, 285, { align: 'left' });
                }
                
                // Save the PDF
                const fileName = 'Employee_Verification_' + (employee['Employee Name'] || 'Unknown').replace(/\s+/g, '_') + '.pdf';
                doc.save(fileName);
                
                // Add audit entry
                addAuditEntry('Generated PDF', `Generated PDF for employee: ${employee['Employee Name']} (${employee['Mobile Number']})`);
                
                console.log("PDF generated successfully:", fileName);
            } catch (error) {
                console.error("Error generating PDF:", error);
                alert('Error generating PDF: ' + error.message);
            }
        }
        // Search for employee by mobile number
        async function searchEmployee() {
            console.log("Search function called");
            
            const mobileNumber = document.getElementById('mobileNumber').value.trim();
            console.log("Mobile number entered:", mobileNumber);
            
            if (!mobileNumber) {
                showMessage('searchError', 'Please enter your mobile number', true);
                return;
            }
            
            // Show spinner
            document.getElementById('searchSpinner').style.display = 'block';
            document.getElementById('searchButton').disabled = true;
            
            try {
                console.log("Querying Supabase for mobile number:", mobileNumber);
                
                // Query Supabase for employee with this mobile number
                const { data, error } = await supabaseClient
                    .from('employees')
                    .select('*')
                    .eq('Mobile Number', mobileNumber);
                
                console.log("Query complete. Data:", data);
                console.log("Query error:", error);
                
                // Hide spinner
                document.getElementById('searchSpinner').style.display = 'none';
                document.getElementById('searchButton').disabled = false;
                
                if (error) {
                    console.error("Error from Supabase:", error);
                    showMessage('searchError', 'Database error: ' + error.message, true);
                    return;
                }
                
                if (data && data.length > 0) {
                    console.log("Employee found:", data[0]);
                    
                    // Store employee data
                    currentEmployee = data[0];
                    
                    // Initialize field statuses
                    fieldDefinitions.forEach(function(field) {
                        // Check if the employee record has been updated previously
                        if (currentEmployee.last_updated) {
                            // If the employee has already submitted data, mark all fields as verified
                            fieldStatuses[field.id] = 'verified';
                        } else {
                            // Otherwise, mark as pending
                            fieldStatuses[field.id] = 'pending';
                        }
                    });
                    
                    // Show verification card
                    document.getElementById('searchCard').classList.add('d-none');
                    document.getElementById('verificationCard').classList.remove('d-none');
                    
                    // Update step indicator
                    updateStepIndicator(2);
                    
                    // Generate verification fields
                    generateVerificationFields();
                } else {
                    console.log("No employee found with mobile number:", mobileNumber);
                    showMessage('searchError', 'No employee found with this mobile number', true);
                }
            } catch (error) {
                console.error("Exception in searchEmployee:", error);
                
                // Hide spinner
                document.getElementById('searchSpinner').style.display = 'none';
                document.getElementById('searchButton').disabled = false;
                
                // Show error message
                showMessage('searchError', 'Error: ' + error.message, true);
            }
        }
        
        // Generate verification fields
        function generateVerificationFields() {
            console.log("Generating verification fields");
            const container = document.getElementById('fieldsContainer');
            container.innerHTML = '';
            
            fieldDefinitions.forEach(function(field) {
                console.log("Processing field:", field.id, field.label);
                const value = currentEmployee[field.id] || '';
                const fieldId = field.id.replace(/[^a-zA-Z0-9]/g, '_');
                
                const fieldRow = document.createElement('div');
                fieldRow.className = 'field-row';
                fieldRow.id = 'row-' + fieldId;
                
                // Create inner content
                const rowDiv = document.createElement('div');
                rowDiv.className = 'row';
                
                // Label column
                const labelCol = document.createElement('div');
                labelCol.className = 'col-md-4';
                const labelDiv = document.createElement('div');
                labelDiv.className = 'field-label';
                labelDiv.textContent = field.label;
                labelCol.appendChild(labelDiv);
                
                // Value column
                const valueCol = document.createElement('div');
                valueCol.className = 'col-md-4';
                const valueDiv = document.createElement('div');
                valueDiv.className = 'field-value';
                valueDiv.id = 'value-' + fieldId;
                valueDiv.textContent = value;
                valueCol.appendChild(valueDiv);
                
                // Verification column
                const verifyCol = document.createElement('div');
                verifyCol.className = 'col-md-4';
                
                // Verification buttons
                const buttonsDiv = document.createElement('div');
                buttonsDiv.className = 'verification-buttons';
                
                // Yes button
                const yesButton = document.createElement('button');
                yesButton.className = 'btn btn-sm btn-outline-success verify-yes';
                yesButton.setAttribute('data-field', field.id);
                yesButton.innerHTML = '<i class="fas fa-check"></i> Yes';
                yesButton.onclick = function() {
                    console.log("Yes clicked for field:", field.id);
                    verifyField(field.id, true);
                };
                
                // No button
                const noButton = document.createElement('button');
                noButton.className = 'btn btn-sm btn-outline-danger verify-no';
                noButton.setAttribute('data-field', field.id);
                noButton.innerHTML = '<i class="fas fa-times"></i> No';
                noButton.onclick = function() {
                    console.log("No clicked for field:", field.id);
                    verifyField(field.id, false);
                };
                
                // Status badge
                const statusSpan = document.createElement('span');
                const status = fieldStatuses[field.id];
                statusSpan.className = 'ms-2 badge ' + getBadgeClass(status);
                statusSpan.id = 'status-' + fieldId;
                
                // Display appropriate text based on status
                if (status === 'verified' && currentEmployee.last_updated) {
                    // If verified and there's a submission date, show "Submitted" with the date
                    const submissionDate = new Date(currentEmployee.last_updated).toLocaleDateString();
                    statusSpan.textContent = 'Submitted ' + submissionDate;
                } else {
                    // Otherwise show the regular status text
                    statusSpan.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                }
                
                // If employee has already submitted data, disable the buttons
                if (currentEmployee.last_updated) {
                    yesButton.disabled = true;
                    noButton.disabled = true;
                }
                
                // Add buttons and badge to buttons div
                buttonsDiv.appendChild(yesButton);
                buttonsDiv.appendChild(noButton);
                buttonsDiv.appendChild(statusSpan);
                
                // Edit field div
                const editDiv = document.createElement('div');
                editDiv.className = 'edit-field';
                editDiv.id = 'edit-' + fieldId;
                editDiv.style.display = 'none';
                
                // Create input field based on field type
                if (field.type === 'select' && field.options) {
                    // Create select element
                    const select = document.createElement('select');
                    select.className = 'form-select';
                    select.id = 'input-' + fieldId;
                    
                    // Add default option
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = 'Select ' + field.label;
                    select.appendChild(defaultOption);
                    
                    // Add options
                    field.options.forEach(function(opt) {
                        const option = document.createElement('option');
                        option.value = opt;
                        option.textContent = opt;
                        if (value === opt) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                    
                    editDiv.appendChild(select);
                } else if (field.type === 'date') {
                    // Create date input element
                    const input = document.createElement('input');
                    input.type = 'date';
                    input.className = 'form-control';
                    input.id = 'input-' + fieldId;
                    
                    // Format date value if it exists
                    if (value) {
                        try {
                            // Try to format the date
                            const dateObj = new Date(value);
                            if (!isNaN(dateObj.getTime())) {
                                input.value = dateObj.toISOString().split('T')[0];
                            } else {
                                input.value = value;
                            }
                        } catch (e) {
                            console.error("Error formatting date:", e);
                            input.value = value;
                        }
                    }
                    
                    if (field.readonly) {
                        input.readOnly = true;
                    }
                    
                    editDiv.appendChild(input);
                } else if (field.type === 'year') {
                    // Create select element for year picker
                    const select = document.createElement('select');
                    select.className = 'form-select';
                    select.id = 'input-' + fieldId;
                    
                    // Add default option
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = 'Select Year';
                    select.appendChild(defaultOption);
                    
                    // Add year options
                    field.options.forEach(function(year) {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        if (value === year) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                    
                    editDiv.appendChild(select);
                } else {
                    // Create standard input element
                    const input = document.createElement('input');
                    input.type = field.type;
                    input.className = 'form-control';
                    input.id = 'input-' + fieldId;
                    input.value = value;
                    if (field.readonly) {
                        input.readOnly = true;
                    }
                    
                    editDiv.appendChild(input);
                }
                
                // Add buttons container
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'mt-2';
                
                // Save button
                const saveButton = document.createElement('button');
                saveButton.className = 'btn btn-sm btn-primary save-edit';
                saveButton.textContent = 'Save';
                saveButton.onclick = function() {
                    saveEdit(field.id);
                };
                
                // Cancel button
                const cancelButton = document.createElement('button');
                cancelButton.className = 'btn btn-sm btn-secondary cancel-edit ms-2';
                cancelButton.textContent = 'Cancel';
                cancelButton.onclick = function() {
                    cancelEdit(field.id);
                };
                
                buttonContainer.appendChild(saveButton);
                buttonContainer.appendChild(cancelButton);
                editDiv.appendChild(buttonContainer);
                
                // Add all elements to verification column
                verifyCol.appendChild(buttonsDiv);
                verifyCol.appendChild(editDiv);
                
                // Add all columns to row
                rowDiv.appendChild(labelCol);
                rowDiv.appendChild(valueCol);
                rowDiv.appendChild(verifyCol);
                
                // Add row to field row
                fieldRow.appendChild(rowDiv);
                
                // Add field row to container
                container.appendChild(fieldRow);
            });
            
            // If employee has already submitted data, show a message
            if (currentEmployee.last_updated) {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-info mt-3';
                alertDiv.innerHTML = `<i class="fas fa-info-circle me-2"></i> Your information was previously submitted on \${new Date(currentEmployee.last_updated).toLocaleString()}. You can review your information below.`;
                container.prepend(alertDiv);
                
                // Also update the continue button to be enabled
                document.getElementById('continueButton').disabled = false;
            }
            
            console.log("Verification fields generated");
            
            // Update progress based on the current status
            updateProgress();
            checkAllFieldsVerified();
        }
        
        // Verify a field
        function verifyField(fieldId, isCorrect) {
            console.log("verifyField called for:", fieldId, "isCorrect:", isCorrect);
            
            const safeFieldId = fieldId.replace(/[^a-zA-Z0-9]/g, '_');
            
            if (isCorrect) {
                // Field is correct
                fieldStatuses[fieldId] = 'verified';
                updateFieldStatus(fieldId, 'verified');
                console.log("Field marked as verified:", fieldId);
            } else {
                // Field needs editing
                const editElement = document.getElementById('edit-' + safeFieldId);
                if (editElement) {
                    editElement.style.display = 'block';
                    console.log("Edit form displayed for field:", fieldId);
                } else {
                    console.error("Could not find edit element for field:", fieldId);
                }
            }
            
            updateProgress();
            checkAllFieldsVerified();
        }
        
        // Save edited field
        function saveEdit(fieldId) {
            console.log("saveEdit called for:", fieldId);
            
            const safeFieldId = fieldId.replace(/[^a-zA-Z0-9]/g, '_');
            const inputElement = document.getElementById('input-' + safeFieldId);
            
            if (!inputElement) {
                console.error("Could not find input element for field:", fieldId);
                return;
            }
            
            const newValue = inputElement.value;
            console.log("New value:", newValue);
            
            // Update the displayed value
            const valueElement = document.getElementById('value-' + safeFieldId);
            if (valueElement) {
                valueElement.textContent = newValue;
            }
            
            // Hide the edit form
            const editElement = document.getElementById('edit-' + safeFieldId);
            if (editElement) {
                editElement.style.display = 'none';
            }
            
            // Mark as edited
            fieldStatuses[fieldId] = 'edited';
            updateFieldStatus(fieldId, 'edited');
            
            // Store the edited value
            editedFields[fieldId] = newValue;
            
            console.log("Field edited successfully:", fieldId);
            
            updateProgress();
            checkAllFieldsVerified();
        }
        
        // Cancel edit
        function cancelEdit(fieldId) {
            console.log("cancelEdit called for:", fieldId);
            
            const safeFieldId = fieldId.replace(/[^a-zA-Z0-9]/g, '_');
            const editElement = document.getElementById('edit-' + safeFieldId);
            
            if (editElement) {
                editElement.style.display = 'none';
                console.log("Edit form hidden for field:", fieldId);
            } else {
                console.error("Could not find edit element for field:", fieldId);
            }
        }
        
        // Update field status badge
        function updateFieldStatus(fieldId, status) {
            console.log("updateFieldStatus called for:", fieldId, "status:", status);
            
            const safeFieldId = fieldId.replace(/[^a-zA-Z0-9]/g, '_');
            const statusElement = document.getElementById('status-' + safeFieldId);
            
            if (statusElement) {
                statusElement.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                statusElement.className = 'ms-2 badge ' + getBadgeClass(status);
                console.log("Status updated for field:", fieldId);
            } else {
                console.error("Could not find status element for field:", fieldId);
            }
        }
        
        // Get badge class based on status
        function getBadgeClass(status) {
            switch (status) {
                case 'verified': return 'badge-verified';
                case 'edited': return 'badge-edited';
                default: return 'badge-pending';
            }
        }
        
        // Update progress bar
        function updateProgress() {
            const totalFields = Object.keys(fieldStatuses).length;
            const verifiedFields = Object.values(fieldStatuses).filter(function(status) {
                return status === 'verified' || status === 'edited';
            }).length;
            
            const percentage = Math.round((verifiedFields / totalFields) * 100);
            
            const progressBar = document.getElementById('progressBar');
            if (progressBar) {
                progressBar.style.width = percentage + '%';
            }
            
            const progressText = document.getElementById('progressText');
            if (progressText) {
                progressText.textContent = percentage + '%';
            }
            
            console.log("Progress updated:", percentage + '%');
        }
        
        // Check if all fields have been verified
        function checkAllFieldsVerified() {
            const allVerified = Object.values(fieldStatuses).every(function(status) {
                return status === 'verified' || status === 'edited';
            });
            
            const continueButton = document.getElementById('continueButton');
            if (continueButton) {
                continueButton.disabled = !allVerified;
            }
            
            console.log("All fields verified:", allVerified);
        }
        
        // Save draft of current progress
        function saveDraft() {
            console.log("Saving draft");
            
            // Show spinner
            document.getElementById('verifySpinner').style.display = 'block';
            
            // Store the current state in localStorage
            const draftData = {
                employee: currentEmployee,
                statuses: fieldStatuses,
                edits: editedFields,
                timestamp: new Date().toISOString()
            };
            
            try {
                localStorage.setItem('employeeDraft_' + currentEmployee['Mobile Number'], JSON.stringify(draftData));
                console.log("Draft saved successfully");
                
                // Hide spinner after a short delay
                setTimeout(function() {
                    document.getElementById('verifySpinner').style.display = 'none';
                    alert('Your progress has been saved as a draft. You can continue later.');
                }, 1000);
            } catch (error) {
                console.error("Error saving draft:", error);
                document.getElementById('verifySpinner').style.display = 'none';
                alert('Error saving draft: ' + error.message);
            }
        }
        
        // Show review screen
        function showReview() {
            console.log("Showing review screen");
            
            // Generate review content
            generateReviewContent();
            
            // Show review card
            document.getElementById('verificationCard').classList.add('d-none');
            document.getElementById('reviewCard').classList.remove('d-none');
            
            // Update step indicator
            updateStepIndicator(3);
        }
        
        // Generate review content
        function generateReviewContent() {
            console.log("Generating review content");
            
            const container = document.getElementById('reviewContainer');
            container.innerHTML = '';
            
            // If the employee has already submitted data, show a message
            if (currentEmployee.last_updated) {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-info mb-4';
                alertDiv.innerHTML = '<i class="fas fa-info-circle me-2"></i> Your information was previously submitted on ' + 
                    new Date(currentEmployee.last_updated).toLocaleString() + '. You can review your information below.';
                container.appendChild(alertDiv);
            }
            
            // Create sections
            const personalSection = document.createElement('div');
            personalSection.className = 'mb-4';
            
            const personalTitle = document.createElement('h5');
            personalTitle.className = 'form-section-title';
            personalTitle.textContent = 'Personal Information';
            personalSection.appendChild(personalTitle);
            
            const professionalSection = document.createElement('div');
            professionalSection.className = 'mb-4';
            
            const professionalTitle = document.createElement('h5');
            professionalTitle.className = 'form-section-title';
            professionalTitle.textContent = 'Professional Information';
            professionalSection.appendChild(professionalTitle);
            
            // Add fields to appropriate sections
            fieldDefinitions.forEach(function(field) {
                let value = currentEmployee[field.id] || '';
                
                // If this field was edited, use the edited value
                if (editedFields[field.id] !== undefined) {
                    value = editedFields[field.id];
                }
                
                const status = fieldStatuses[field.id];
                const statusText = status.charAt(0).toUpperCase() + status.slice(1);
                
                // Create row div
                const rowDiv = document.createElement('div');
                rowDiv.className = 'row mb-2';
                
                // Create label column
                const labelCol = document.createElement('div');
                labelCol.className = 'col-md-4';
                const strongLabel = document.createElement('strong');
                strongLabel.textContent = field.label + ':';
                labelCol.appendChild(strongLabel);
                
                // Create value column
                const valueCol = document.createElement('div');
                valueCol.className = 'col-md-6';
                valueCol.textContent = value;
                
                // Create status column
                const statusCol = document.createElement('div');
                statusCol.className = 'col-md-2 text-end';
                
                const statusBadge = document.createElement('span');
                statusBadge.className = 'badge ' + getBadgeClass(status);
                statusBadge.textContent = statusText;
                statusCol.appendChild(statusBadge);
                
                // Add columns to row
                rowDiv.appendChild(labelCol);
                rowDiv.appendChild(valueCol);
                rowDiv.appendChild(statusCol);
                
                // Add to appropriate section based on field type
                if (['Mobile Number', 'Employee Name', 'Nic E-mail ID', 'Gender', 'Father\'s Name', 'Date of Birth', 'Nationality', 'Religion', 'Category'].includes(field.id)) {
                    personalSection.appendChild(rowDiv);
                } else {
                    professionalSection.appendChild(rowDiv);
                }
            });
            
            // Add sections to container
            container.appendChild(personalSection);
            container.appendChild(professionalSection);
            
            console.log("Review content generated");
        }
        
        // Toggle submit button based on confirmation checkbox
        function toggleSubmitButton() {
            const isChecked = document.getElementById('confirmCheck').checked;
            document.getElementById('submitButton').disabled = !isChecked;
            console.log("Submit button toggled:", !isChecked ? "disabled" : "enabled");
        }
        
        // Submit the form
        async function submitForm() {
            console.log("Submitting form");
            
            // Show spinner
            document.getElementById('submitSpinner').style.display = 'block';
            document.getElementById('submitButton').disabled = true;
            
            try {
                // Create update object with edited fields
                const updateData = { ...editedFields };
                
                // Add last_updated field to track profile updates
                updateData.last_updated = new Date().toISOString();
                
                // Update the employee record in Supabase
                const { data, error } = await supabaseClient
                    .from('employees')
                    .update(updateData)
                    .eq('Mobile Number', currentEmployee['Mobile Number']);
                    
                console.log("Update response:", { data, error });
                
                if (error) throw error;
                
                // Hide spinner
                document.getElementById('submitSpinner').style.display = 'none';
                
                // Show success card
                document.getElementById('reviewCard').classList.add('d-none');
                document.getElementById('successCard').classList.remove('d-none');
                
                // Update step indicator
                updateStepIndicator(4);
                
                // Clear any saved draft
                try {
                    localStorage.removeItem('employeeDraft_' + currentEmployee['Mobile Number']);
                } catch (e) {
                    console.error("Error removing draft from localStorage:", e);
                }
                
                console.log("Form submission completed successfully");
                
            } catch (error) {
                console.error("Error submitting form:", error);
                
                // Hide spinner
                document.getElementById('submitSpinner').style.display = 'none';
                document.getElementById('submitButton').disabled = false;
                
                // Show error
                alert('Error submitting form: ' + error.message);
            }
        }
        
        // Generate PDF for employee
        function generatePDF() {
            console.log("Generating enhanced PDF");
            
            try {
                // Check if jsPDF is loaded
                if (typeof window.jspdf === 'undefined') {
                    console.error("jsPDF library not loaded");
                    alert("PDF generation library not loaded. Please try again later.");
                    return;
                }
                
                // Initialize jsPDF with A4 size
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: "portrait",
                    unit: "mm",
                    format: "a4"
                });
                
                // Define constants for layout
                const pageWidth = doc.internal.pageSize.width;
                const margin = 15;
                const contentWidth = pageWidth - (margin * 2);
                
                // Add header with logo placeholder
                doc.setFillColor(128, 0, 0); // Maroon red
                doc.rect(0, 0, pageWidth, 25, 'F');
                
                doc.setTextColor(255, 255, 255); // White text
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('EMPLOYEE DATA VERIFICATION REPORT', pageWidth/2, 10, { align: 'center' });
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text('Directorate of Agriculture Chhattisgarh', pageWidth/2, 18, { align: 'center' });
                
                // Add employee information section
                doc.setTextColor(0, 0, 0); // Black text
                doc.setFillColor(240, 240, 240); // Light gray background
                doc.rect(margin, 30, contentWidth, 25, 'F');
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Employee Information', margin + 5, 38);
                
                doc.setFont(undefined, 'normal');
                doc.text('Name: ' + (currentEmployee['Employee Name'] || 'N/A'), margin + 5, 45);
                doc.text('Mobile: ' + (currentEmployee['Mobile Number'] || 'N/A'), pageWidth - margin - 50, 45);
                
                // Add verification status section
                doc.setFillColor(245, 245, 245); // Lighter gray
                doc.rect(margin, 60, contentWidth, 15, 'F');
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text('Verification Status', margin + 5, 68);
                
                const verificationDate = new Date().toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                doc.setFont(undefined, 'normal');
                doc.text('Verified on: ' + verificationDate, pageWidth - margin - 60, 68);
                
                // Prepare data for tables with better formatting
                const personalFields = [
                    'Mobile Number', 'Employee Name', 'Nic E-mail ID', 'Gender', 
                    'Father\'s Name', 'Date of Birth', 'Nationality', 'Religion', 'Category'
                ];
                
                const personalData = [];
                const professionalData = [];
                
                fieldDefinitions.forEach(function(field) {
                    let value = currentEmployee[field.id] || '';
                    
                    // If this field was edited, use the edited value
                    if (editedFields[field.id] !== undefined) {
                        value = editedFields[field.id];
                    }
                    
                    const status = fieldStatuses[field.id] || 'pending';
                    const statusText = status.charAt(0).toUpperCase() + status.slice(1);
                    
                    const row = [field.label, value, statusText];
                    
                    // Add to appropriate array based on field type
                    if (personalFields.includes(field.id)) {
                        personalData.push(row);
                    } else {
                        professionalData.push(row);
                    }
                });
                
                // Add personal information table with better styling
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Personal Information', margin, 85);
                
                doc.autoTable({
                    startY: 90,
                    head: [['Field', 'Value', 'Status']],
                    body: personalData,
                    margin: { left: margin, right: margin },
                    styles: {
                        fontSize: 10,
                        cellPadding: 3,
                        lineWidth: 0.1
                    },
                    headStyles: {
                        fillColor: [128, 0, 0],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [245, 245, 245]
                    },
                    columnStyles: {
                        0: { fontStyle: 'bold', cellWidth: 50 },
                        1: { cellWidth: 'auto' },
                        2: { cellWidth: 30 }
                    }
                });
                
                // Add professional information table
                const professionalStartY = doc.previousAutoTable.finalY + 15;
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Professional Information', margin, professionalStartY);
                
                doc.autoTable({
                    startY: professionalStartY + 5,
                    head: [['Field', 'Value', 'Status']],
                    body: professionalData,
                    margin: { left: margin, right: margin },
                    styles: {
                        fontSize: 10,
                        cellPadding: 3,
                        lineWidth: 0.1
                    },
                    headStyles: {
                        fillColor: [128, 0, 0],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [245, 245, 245]
                    },
                    columnStyles: {
                        0: { fontStyle: 'bold', cellWidth: 50 },
                        1: { cellWidth: 'auto' },
                        2: { cellWidth: 30 }
                    }
                });
                
                // Add signature section
                const signatureY = doc.previousAutoTable.finalY + 25;
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text('Employee Signature', margin, signatureY);
                doc.line(margin, signatureY + 15, margin + 50, signatureY + 15);
                
                doc.text('Authorized Signature', pageWidth - margin - 50, signatureY);
                doc.line(pageWidth - margin - 50, signatureY + 15, pageWidth - margin, signatureY + 15);
                
                // Add footer with page numbers
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <=                pageCount; i++) {
                    doc.setPage(i);
                    
                    // Add footer line
                    doc.setDrawColor(128, 0, 0); // Maroon red
                    doc.setLineWidth(0.5);
                    doc.line(margin, 280, pageWidth - margin, 280);
                    
                    // Add footer text
                    doc.setFontSize(8);
                    doc.setTextColor(0, 0, 0);
                    doc.text('Directorate of Agriculture Chhattisgarh - SPARROW Data Verification System', pageWidth / 2, 285, { align: 'center' });
                    doc.text('Page ' + i + ' of ' + pageCount, pageWidth - margin, 285, { align: 'right' });
                    doc.text('Generated on: ' + new Date().toLocaleString(), margin, 285, { align: 'left' });
                }
                
                // Save the PDF
                const fileName = 'Employee_Verification_' + (currentEmployee['Employee Name'] || 'Unknown').replace(/\s+/g, '_') + '.pdf';
                doc.save(fileName);
                
                console.log("Enhanced PDF generated successfully:", fileName);
            } catch (error) {
                console.error("Error generating PDF:", error);
                alert('Error generating PDF: ' + error.message);
            }
        }
        
        // Go back to search
        function goBackToSearch() {
            console.log("Going back to search");
            
            document.getElementById('verificationCard').classList.add('d-none');
            document.getElementById('searchCard').classList.remove('d-none');
            
            // Reset state
            currentEmployee = null;
            fieldStatuses = {};
            editedFields = {};
            
            // Update step indicator
            updateStepIndicator(1);
        }
        
        // Go back to verify
        function goBackToVerify() {
            console.log("Going back to verify");
            
            document.getElementById('reviewCard').classList.add('d-none');
            document.getElementById('verificationCard').classList.remove('d-none');
            
            // Update step indicator
            updateStepIndicator(2);
        }
        
        // Start over from the beginning
        function startOver() {
            console.log("Starting over");
            
            document.getElementById('successCard').classList.add('d-none');
            document.getElementById('loginCard').classList.remove('d-none');
            
            // Clear search field
            document.getElementById('mobileNumber').value = '';
            document.getElementById('employeeMobile').value = '';
            
            // Hide step indicator
            document.getElementById('stepIndicator').classList.add('d-none');
            
            // Reset state
            currentEmployee = null;
            fieldStatuses = {};
            editedFields = {};
            
            // Switch to employee login option
            switchToEmployeeLogin();
        }
        
        // Update step indicator
        function updateStepIndicator(currentStep) {
            console.log("Updating step indicator to step:", currentStep);
            
            // Reset all steps
            for (let i = 1; i <= 4; i++) {
                const stepElement = document.getElementById('step' + i);
                if (stepElement) {
                    stepElement.className = 'step';
                    
                    if (i < currentStep) {
                        stepElement.classList.add('completed');
                    } else if (i === currentStep) {
                        stepElement.classList.add('active');
                    }
                }
            }
        }
        
        // Show message
        function showMessage(elementId, message, isError) {
            console.log("Showing message:", message, "isError:", isError);
            
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.classList.remove('d-none');
                
                // Hide message after 5 seconds
                setTimeout(function() {
                    element.classList.add('d-none');
                }, 5000);
            } else {
                console.error("Message element not found:", elementId);
            }
        }
        
        // Check for saved draft on page load
        function checkForSavedDraft(mobileNumber) {
            console.log("Checking for saved draft for:", mobileNumber);
            
            try {
                const draftKey = 'employeeDraft_' + mobileNumber;
                const savedDraft = localStorage.getItem(draftKey);
                
                if (savedDraft) {
                    const draftData = JSON.parse(savedDraft);
                    const timestamp = new Date(draftData.timestamp);
                    const now = new Date();
                    const hoursDiff = Math.abs(now - timestamp) / 36e5; // Convert to hours
                    
                    console.log("Found saved draft from:", timestamp);
                    
                    // If draft is less than 24 hours old, ask to restore
                    if (hoursDiff < 24) {
                        const confirm = window.confirm('You have a saved draft from ' + timestamp.toLocaleString() + '. Would you like to restore it?');
                        
                        if (confirm) {
                            console.log("Restoring saved draft");
                            
                            // Restore the saved state
                            currentEmployee = draftData.employee;
                            fieldStatuses = draftData.statuses;
                            editedFields = draftData.edits;
                            
                            // Show verification card
                            document.getElementById('searchCard').classList.add('d-none');
                            document.getElementById('verificationCard').classList.remove('d-none');
                            
                            // Update step indicator
                            updateStepIndicator(2);
                            
                            // Generate verification fields
                            generateVerificationFields();
                            
                            // Update progress
                            updateProgress();
                            checkAllFieldsVerified();
                            
                            return true;
                        }
                    }
                }
            } catch (error) {
                console.error("Error checking for saved draft:", error);
            }
            
            return false;
        }
    </script>
</body>
</html>




