<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>संभाग स्तर कार्यालय - वाहन आबंटन प्रबंधन</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Using Mangal and Noto Sans Devanagari fonts for consistency with dashboard -->
    <link href="https://fonts.googleapis.com/css2?family=Mangal:wght@100;200;300;400;500;600;700&family=Noto+Sans+Devanagari:wght@100;200;300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* General & Layout - Consistent with dashboard.html */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Mangal', 'Noto Sans Devanagari', sans-serif; 
            font-weight: 400; /* Adjusted for better readability */
            background: url('https://github.com/diragcg/pmfby/blob/main/images/Gemini_Generated_Image_eowpoueowpoueowp.png?raw=true') no-repeat center center fixed;
            background-size: cover;
            min-height: 100vh;
            letter-spacing: 0.3px;
            position: relative;
        }
        
        /* Background overlay for better image visibility - Consistent with dashboard.html */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.3);
            z-index: -1;
        }

        .hindi { 
            font-weight: 400; /* Adjusted for better readability */
            letter-spacing: 0.2px;
        }
        
        /* Header Strip - Replicated from dashboard.html */
        .header-strip {
            background: rgba(204, 206, 206, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #e9ecef;
            padding: 15px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 20px 20px 0 20px;
            border-bottom-left-radius: 15px;
            border-bottom-right-radius: 15px;
        }
        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }
        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .cg-logo {
            height: 60px;
            width: auto;
        }
        .logo-text h1 {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
            font-family: 'Mangal', 'Noto Sans Devanagari', sans-serif;
        }
        .logo-text p {
            font-size: 14px;
            color: #6c757d;
            font-weight: 400;
            font-family: 'Mangal', 'Noto Sans Devanagari', sans-serif;
        }

        /* Navbar - Replicated from dashboard.html, adjusted for user info/logout in-line */
        .navbar { 
            background: rgba(52, 58, 64, 0.95); 
            backdrop-filter: blur(10px); 
            border-bottom: 1px solid #dee2e6; 
            border-bottom-left-radius: 15px; 
            border-bottom-right-radius: 15px; 
            margin: 0 20px; 
            position: relative; 
            z-index: 1000; 
        }
        .nav-container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 0 20px; 
        }
        .nav-menu { 
            display: flex; 
            list-style: none; 
            margin: 0; 
            padding: 0; 
            align-items: center; 
            width: 100%; /* Ensure it takes full width for spacing */
            justify-content: space-between; /* Distribute items evenly */
        }
        .nav-item { 
            position: relative; 
        }
        .nav-link { 
            display: flex; 
            align-items: center; 
            padding: 15px 20px; 
            color: #ffffff; 
            text-decoration: none; 
            font-size: 14px; 
            font-weight: 500; 
            transition: all 0.2s; 
            gap: 8px; 
            font-family: 'Mangal', 'Noto Sans Devanagari', sans-serif; 
            border-radius: 8px; 
        }
        .nav-link:hover, .nav-link.active { 
            background: #037af1; 
            border-radius: 12px; 
            padding: 12px 20px; 
            color: white;
            text-decoration: none;
        }
        .nav-link:focus { 
            outline: 2px solid #037af1; 
            outline-offset: 2px; 
            background: #037af1; 
        }
        .nav-link i { 
            font-size: 14px; 
        }

        /* User info styling within Navbar */
        .user-info-nav {
            background: linear-gradient(135deg, #e8f5e8, #f0f8f0); 
            color: #b8860b !important; 
            padding: 8px 15px; /* Slightly smaller padding for in-line */
            border-radius: 12px; 
            box-shadow: 0 2px 8px rgba(184, 134, 11, 0.2); 
            border: 1px solid rgba(184, 134, 11, 0.3); 
            margin-left: auto; /* Push to the far right, next to logout button */
            margin-right: 15px; /* Space before logout */
            font-family: 'Mangal', 'Noto Sans Devanagari', sans-serif;
            font-weight: 600;
            font-size: 13px;
            display: flex;
            align-items: center;
            white-space: nowrap; /* Prevent wrapping */
        }
        
        /* Logout button styling within Navbar */
        .logout-btn-nav {
            background-color: #dc3545 !important;
            border-color: #dc3545 !important;
            color: white !important;
            font-weight: 400;
            padding: 8px 15px; /* Match user-info-nav padding */
            border-radius: 12px; /* Match user-info-nav border-radius */
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s ease;
            font-family: 'Mangal', 'Noto Sans Devanagari', sans-serif;
            white-space: nowrap; /* Prevent wrapping */
        }
        .logout-btn-nav:hover {
            background-color: #c82333 !important;
            border-color: #c82333 !important;
        }
        
        /* Main Content Container - Consistent with dashboard.html */
        .container.mt-4 {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(8px);
            margin: 20px auto; /* Use auto for horizontal centering */
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            max-width: 1200px; /* Limit width as per dashboard */
        }

        /* Page Header */
        .page-header {
            background: rgba(255, 255, 255, 0.85); /* Consistent with dashboard page-title */
            backdrop-filter: blur(8px); /* Consistent with dashboard page-title */
            border-radius: 15px; /* Consistent with dashboard page-title */
            padding: 20px;
            margin-bottom: 25px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); /* Consistent with dashboard page-title */
            border-top: none; /* Remove red border-top */
        }

        .page-header h4 {
            color: #2c3e50; /* Consistent with dashboard page-title h3 */
            font-weight: 500; /* Consistent with dashboard page-title h3 */
            margin: 0;
            font-size: 1.8rem; /* Consistent with dashboard page-title h3 */
            font-family: 'Mangal', 'Noto Sans Devanagari', sans-serif;
            text-align: center;
        }

        /* Filter Section */
        .filter-section {
            background: rgba(255, 255, 255, 0.85); /* Consistent with dashboard cards */
            backdrop-filter: blur(8px); /* Consistent with dashboard cards */
            border-radius: 15px; /* Consistent with dashboard cards */
            padding: 18px;
            margin-bottom: 18px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* Consistent with dashboard cards */
            border-left: 3px solid #007bff; /* Use primary blue for filter accent */
        }

        .filter-title {
            color: #007bff; /* Use primary blue for filter title */
            font-weight: 600;
            margin-bottom: 12px;
            font-size: 1.05rem;
            font-family: 'Mangal', 'Noto Sans Devanagari', sans-serif;
        }

        /* Table Container */
        .table-container { 
            background: rgba(255, 255, 255, 0.85); /* Consistent with dashboard cards */
            backdrop-filter: blur(8px); /* Consistent with dashboard cards */
            border-radius: 15px; 
            padding: 20px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-top: 3px solid #007bff; /* Use primary blue for table accent */
        }

        /* Table Styling */
        .table {
            border: 1px solid #dee2e6; /* Lighter border */
            border-radius: 8px; /* Slightly larger border radius */
            overflow: hidden;
            margin-bottom: 0;
        }

        .table thead th {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); /* Primary blue gradient */
            color: white;
            font-weight: 500;
            text-align: center;
            vertical-align: middle;
            border: 1px solid #0056b3;
            padding: 10px 6px;
            font-size: 0.85rem;
            font-family: 'Mangal', 'Noto Sans Devanagari', sans-serif;
        }

        .table tbody td {
            text-align: center;
            vertical-align: middle;
            border: 1px solid #dee2e6;
            padding: 8px 6px;
            font-weight: 300;
            font-size: 0.8rem;
            font-family: 'Mangal', 'Noto Sans Devanagari', sans-serif;
        }

        .table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .table tbody tr:hover {
            background-color: #e9f5ff; /* Lighter blue hover */
        }

        /* Form Controls */
        .form-control, .form-select { 
            border-radius: 8px; /* Larger border radius */
            border: 1px solid #ced4da;
            font-weight: 300;
            font-size: 0.85rem;
            padding: 8px 12px;
            height: auto;
            font-family: 'Mangal', 'Noto Sans Devanagari', sans-serif;
        }

        .form-control:focus, .form-select:focus {
            border-color: #007bff; /* Primary blue focus */
            box-shadow: 0 0 0 0.15rem rgba(0, 123, 255, 0.2); /* Lighter shadow */
        }

        .form-label {
            font-weight: 500;
            color: #2c3e50;
            font-size: 0.9rem;
            margin-bottom: 5px;
            font-family: 'Mangal', 'Noto Sans Devanagari', sans-serif;
        }

        /* Button Styling */
        .btn-division, .btn-secondary, .btn-info { /* Grouped for common styles */
            border: none;
            color: white;
            font-weight: 400;
            border-radius: 8px; /* Larger border radius */
            padding: 8px 18px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            font-family: 'Mangal', 'Noto Sans Devanagari', sans-serif;
        }

        .btn-division { 
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); /* Primary blue gradient */
        }
        .btn-division:hover { 
            background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }
        .btn-info:hover {
            background: linear-gradient(135deg, #138496 0%, #0f6674 100%);
        }

        /* Modal Styling */
        .modal-content {
            border-radius: 15px; /* Larger border radius */
            border: none;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            background: rgba(255, 255, 255, 0.95); /* Light background for modal content */
            backdrop-filter: blur(5px);
        }

        .modal-header {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); /* Primary blue gradient */
            color: white;
            border-radius: 15px 15px 0 0; /* Match modal content border radius */
            border-bottom: none;
            padding: 15px 20px;
        }

        .modal-title {
            font-weight: 500;
            font-size: 1.2rem; /* Slightly larger title */
            font-family: 'Mangal', 'Noto Sans Devanagari', sans-serif;
        }
        .btn-close-white {
            filter: invert(1);
        }

        /* Action Buttons in Table */
        .action-btn {
            padding: 5px 10px; /* Slightly larger padding */
            border-radius: 6px; /* Larger border radius */
            font-size: 0.8rem; /* Slightly larger font size */
            font-family: 'Mangal', 'Noto Sans Devanagari', sans-serif;
        }

        .btn-warning.action-btn {
            background: #f39c12;
            color: white;
        }

        .btn-danger.action-btn {
            background: #dc3545;
            color: white;
        }

        /* Pagination */
        .pagination {
            justify-content: center;
            margin-top: 20px; /* More margin for spacing */
        }

        .page-link {
            color: #007bff; /* Primary blue for links */
            border-color: #007bff;
            font-weight: 400;
            font-size: 0.9rem; /* Slightly larger font */
            padding: 8px 12px; /* Increased padding */
            font-family: 'Mangal', 'Noto Sans Devanagari', sans-serif;
        }

        .page-link:hover {
            background-color: #007bff;
            border-color: #007bff;
            color: white;
        }

        .page-item.active .page-link {
            background-color: #007bff;
            border-color: #007bff;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
        }

        .loading-spinner {
            color: white;
            font-size: 2rem; /* Larger spinner */
        }
        .loading-overlay p {
            font-size: 1rem;
            color: white;
            margin-top: 10px;
            font-family: 'Mangal', 'Noto Sans Devanagari', sans-serif;
        }

        /* Responsive Design */
        @media (max-width: 991.98px) { /* Bootstrap's lg breakpoint for navbar-expand-lg */
            .header-strip {
                margin: 10px 10px 0 10px;
            }
            .header-container {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            .nav-menu {
                flex-direction: column; /* Stack nav items vertically */
                align-items: flex-start; /* Align to left */
                justify-content: flex-start; /* Reset justify for column layout */
            }
            .nav-menu .user-info-nav,
            .nav-menu .logout-btn-nav {
                margin-left: 0; /* Remove auto margin */
                margin-right: 0;
                width: 100%; /* Take full width */
                justify-content: center; /* Center content */
                margin-top: 10px; /* Space between items */
            }
            .navbar {
                margin: 0 10px;
            }
            .container.mt-4 {
                margin: 10px auto;
                padding: 20px;
            }
            .row.g-4 > div { /* Target the column divs directly */
                flex: 0 0 100%;
                max-width: 100%;
            }
            .page-header h4 {
                font-size: 1.4rem;
            }
            .filter-title {
                font-size: 1rem;
            }
            .form-control, .form-select, .form-label, .btn {
                font-size: 0.85rem;
            }
            .table thead th, .table tbody td {
                font-size: 0.75rem;
                padding: 6px 4px;
            }
            .action-btn {
                padding: 3px 6px;
                font-size: 0.65rem;
            }
        }
        @media (max-width: 575.98px) { /* Bootstrap's sm breakpoint */
            .header-strip {
                padding: 10px 0;
            }
            .cg-logo {
                height: 50px;
            }
            .logo-text h1 {
                font-size: 20px;
            }
            .logo-text p {
                font-size: 12px;
            }
            .nav-link {
                padding: 10px 15px;
                font-size: 13px;
            }
            .user-info-nav, .logout-btn-nav {
                padding: 6px 10px;
                font-size: 12px;
            }
            .page-header h4 {
                font-size: 1.2rem;
            }
            .table-container {
                padding: 10px;
            }
        }

        /* Print Styles */
        @media print {
            .navbar, .filter-section, .modal, .btn, .pagination, .action-btn, .header-strip .user-section {
                display: none !important;
            }
            
            .table-container {
                box-shadow: none;
                border: 1px solid #000;
                padding: 0;
            }
            
            .table {
                font-size: 9px;
                width: 100%;
                margin: 0;
            }
            
            .table th, .table td {
                border: 1px solid #000 !important;
                padding: 3px 2px !important;
                text-align: center !important;
                vertical-align: middle !important;
            }

            .page-header {
                text-align: center;
                margin-bottom: 15px;
                box-shadow: none;
                border: none;
            }
            .page-header h4 {
                font-size: 1.1rem;
                color: #000;
            }
            
            body {
                font-size: 10px;
                color: #000;
                background-color: white !important;
            }
            
            .table thead th {
                background: #e7e7e7 !important;
                color: #000 !important;
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
                border: 1px solid #000 !important;
            }
        }
    </style>
</head>
<body>
    <!-- Header Strip - Replicated from dashboard.html -->
    <div class="header-strip">
        <div class="header-container">
            <div class="logo-section">
                <a class="navbar-brand hindi" href="dashboard.html"> <!-- Link logo to dashboard -->
                    <img src="https://upload.wikimedia.org/wikipedia/commons/8/87/Coat_of_arms_of_Chhattisgarh.svg" alt="छत्तीसगढ़" height="40" class="me-2 cg-logo">
                    <div class="logo-text">
                        <h1>संचालनालय कृषि छत्तीसगढ़</h1>
                        <p>Directorate of Agriculture, Chhattisgarh</p>
                    </div>
                </a>
            </div>
            <!-- User info and logout are now in the navbar -->
        </div>
    </div>

    <!-- Navigation Bar - Replicated from dashboard.html, with user info/logout in-line -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="nav-container">
            <!-- Navbar Toggler for mobile (Bootstrap standard) -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav"> 
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="dashboard.html" class="nav-link"> <!-- Home button to dashboard -->
                            <i class="fas fa-home"></i> होम
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link active"> <!-- Active link for current page -->
                            <i class="fas fa-arrow-left me-2"></i>संभाग स्तर कार्यालय
                        </a>
                    </li>
                    <!-- User Info and Logout on the same line, pushed to the right -->
                    <li class="nav-item user-info-nav" id="userInfo"></li> <!-- User info will be populated by JS -->
                    <li class="nav-item">
                        <button class="btn btn-sm logout-btn-nav" onclick="logout()">
                            <i class="fas fa-sign-out-alt me-1"></i> लॉगआउट
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Page Header -->
        <div class="page-header">
            <h4 class="hindi text-center">संभाग स्तर कार्यालय - वाहन आबंटन प्रबंधन</h4>
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
            <h6 class="filter-title hindi">
                <i class="fas fa-filter me-2"></i>फिल्टर और खोज विकल्प
            </h6>
            <div class="row g-2">
                <div class="col-md-4">
                    <label class="form-label hindi">खोजें</label>
                    <input type="text" class="form-control" id="searchInput" placeholder="कार्यालय, पदनाम, पंजीकरण संख्या, मेक/मॉडल या रिमार्क में खोजें" onkeyup="filterTable()">
                </div>
                <div class="col-md-3">
                    <label class="form-label hindi">वाहन की पात्रता</label>
                    <select class="form-select" id="eligibilityFilter" onchange="filterTable()">
                        <option value="">सभी</option>
                        <option value="हाँ">हाँ</option>
                        <option value="नहीं">नहीं</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label hindi">वर्तमान आबंटन</label>
                    <select class="form-select" id="allocationFilter" onchange="filterTable()">
                        <option value="">सभी</option>
                        <option value="हाँ">हाँ</option>
                        <option value="नहीं">नहीं</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <button class="btn btn-secondary w-100" onclick="clearFilters()">
                        <i class="fas fa-times me-2"></i>साफ़ करें
                    </button>
                </div>
            </div>
        </div>

        <!-- Table Container -->
        <div class="table-container">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h5 class="hindi mb-0" style="color: #007bff; font-size: 1.1rem;">संभाग स्तर कार्यालय</h5>
                    <small class="text-muted">कुल एंट्री: <span id="totalEntries">0</span></small>
                </div>
                <div>
                    <button class="btn btn-division me-2" onclick="addNewRow()">
                        <i class="fas fa-plus me-2"></i>नई एंट्री जोड़ें
                    </button>
                    <div class="btn-group">
                        <button class="btn btn-info dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-download me-2"></i>एक्सपोर्ट
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="exportToExcel()">
                                <i class="fas fa-file-excel me-2"></i>Excel में डाउनलोड
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportToPDF()">
                                <i class="fas fa-file-pdf me-2"></i>PDF में डाउनलोड
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="divisionTable">
                    <thead>
                        <tr class="hindi">
                            <th style="width: 5%;">
                                क्रमांक
                                <i class="fas fa-sort ms-1" onclick="sortTable(0)" style="cursor: pointer;"></i>
                            </th>
                            <th style="width: 15%;">
                                कार्यालय का नाम एवं जिला
                                <i class="fas fa-sort ms-1" onclick="sortTable(1)" style="cursor: pointer;"></i>
                            </th>
                            <th style="width: 10%;">
                                पदनाम
                                <i class="fas fa-sort ms-1" onclick="sortTable(2)" style="cursor: pointer;"></i>
                            </th>
                            <th style="width: 10%;">
                                वेतनमान
                                <i class="fas fa-sort ms-1" onclick="sortTable(3)" style="cursor: pointer;"></i>
                            </th>
                            <th style="width: 10%;">
                                स्वीकृत पद संख्या
                                <i class="fas fa-sort ms-1" onclick="sortTable(4)" style="cursor: pointer;"></i>
                            </th>
                             <th style="width: 10%;">
                                वाहन पंजीकरण संख्या
                                <i class="fas fa-sort ms-1" onclick="sortTable(5)" style="cursor: pointer;"></i>
                            </th>
                            <th style="width: 10%;">
                                मेक/मॉडल
                                <i class="fas fa-sort ms-1" onclick="sortTable(6)" style="cursor: pointer;"></i>
                            </th>
                            <th style="width: 8%;">
                                वाहन की पात्रता
                            </th>
                            <th style="width: 8%;">
                                वर्तमान में वाहन आबंटित
                            </th>
                            <th style="width: 12%;">रिमार्क</th>
                            <th style="width: 7%;">एक्शन</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Dynamic rows will be added here -->
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <nav aria-label="Table pagination">
                <ul class="pagination" id="pagination">
                    <!-- Pagination will be generated here -->
                </ul>
            </nav>

            <div class="mt-3 text-center">
                <button class="btn btn-secondary me-2" onclick="loadData()">
                    <i class="fas fa-refresh me-2"></i>डेटा रिफ्रेश करें
                </button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div class="modal fade" id="entryModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title hindi" id="modalTitle">नई एंट्री जोड़ें</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="entryForm">
                        <input type="hidden" id="entryId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label hindi">क्रमांक</label>
                                <input type="number" class="form-control" id="serialNo" readonly style="background-color: #e9ecef;">
                                <small class="text-muted hindi">यह स्वचालित रूप से भरा जाएगा</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label hindi">कार्यालय का नाम एवं जिला</label>
                                <input type="text" class="form-control" id="officeName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label hindi">पदनाम</label>
                                <input type="text" class="form-control" id="designation" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label hindi">वेतनमान</label>
                                <input type="text" class="form-control" id="payScale">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label hindi">स्वीकृत पद संख्या</label>
                                <input type="number" class="form-control" id="sanctionedPosts">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label hindi">वाहन पंजीकरण संख्या</label>
                                <input type="text" class="form-control" id="vehicleRegistrationNo">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label hindi">मेक/मॉडल</label>
                                <input type="text" class="form-control" id="makeModel">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label hindi">वाहन की पात्रता</label>
                                <select class="form-select" id="vehicleEligibility" required>
                                    <option value="">चुनें</option>
                                    <option value="हाँ">हाँ</option>
                                    <option value="नहीं">नहीं</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label hindi">वर्तमान में वाहन आबंटित</label>
                                <select class="form-select" id="currentAllocation" required>
                                    <option value="">चुनें</option>
                                    <option value="हाँ">हाँ</option>
                                    <option value="नहीं">नहीं</option>
                                </select>
                            </div>
                            <div class="col-12 mb-3">
                                <label class="form-label hindi">रिमार्क</label>
                                <textarea class="form-control" id="remarks" rows="3"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">रद्द करें</button>
                    <button type="button" class="btn btn-division" onclick="saveEntry()">
                        <i class="fas fa-save me-2"></i>सेव करें
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="text-center">
            <div class="spinner-border loading-spinner" role="status"></div>
            <p class="text-white mt-2">प्रोसेसिंग हो रही है...</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script>
        let currentEditId = null;
        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        let itemsPerPage = 10;
        let sortColumn = -1;
        let sortDirection = 'asc';
        
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth(); // This function should be defined in js/auth.js
            displayUserInfo();
            loadData(); // This will handle the "Loading..." state
        });

        function displayUserInfo() {
            const user = getCurrentUser(); // This function should be defined in js/auth.js
            if (user) {
                document.getElementById('userInfo').textContent = 
                    `${user.fullName} (${user.districtName})`;
            } else {
                // If user is not logged in, redirect to index.html
                console.log('User not authenticated, redirecting to index.html');
                window.location.href = 'index.html'; 
            }
        }

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        async function loadData() {
            try {
                showLoading();
                
                const { data, error } = await supabaseClient
                    .from('division_office_vehicles')
                    .select('*')
                    .order('serial_no', { ascending: true });

                if (error) throw error;

                allData = data || [];
                filteredData = [...allData];
                
                updateTotalCount();
                renderTable();
                renderPagination();
                
                hideLoading();

            } catch (error) {
                hideLoading();
                alert('डेटा लोड करने में त्रुटि: ' + error.message);
            }
        }

        function updateTotalCount() {
            document.getElementById('totalEntries').textContent = filteredData.length;
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = filteredData.slice(startIndex, endIndex);

            pageData.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${row.serial_no || startIndex + index + 1}</strong></td>
                    <td>${row.office_name_district || ''}</td>
                    <td>${row.designation || ''}</td>
                    <td>${row.pay_scale || ''}</td>
                    <td>${row.sanctioned_posts || ''}</td>
                    <td>${row.vehicle_registration_no || ''}</td>
                    <td>${row.make_model || ''}</td>
                    <td>
                        <span class="badge ${row.vehicle_eligibility === 'हाँ' ? 'bg-success' : 'bg-danger'}">
                            ${row.vehicle_eligibility || ''}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${row.current_allocation === 'हाँ' ? 'bg-success' : 'bg-warning'}">
                            ${row.current_allocation || ''}
                        </span>
                    </td>
                    <td>${row.remarks || ''}</td>
                    <td>
                        <button class="btn btn-sm btn-warning action-btn me-1" onclick="editEntry('${row.id}')" title="एडिट करें">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger action-btn" onclick="deleteEntry('${row.id}')" title="डिलीट करें">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderPagination() {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            
            if (totalPages <= 1) return;

            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">पिछला</a>`;
            pagination.appendChild(prevLi);

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
                pagination.appendChild(li);
            }

            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">अगला</a>`;
            pagination.appendChild(nextLi);
        }

        function changePage(page) {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            renderTable();
            renderPagination();
        }

        function filterTable() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const eligibilityFilter = document.getElementById('eligibilityFilter').value;
            const allocationFilter = document.getElementById('allocationFilter').value;

            filteredData = allData.filter(row => {
                const matchesSearch = !searchTerm || 
                    (row.office_name_district && row.office_name_district.toLowerCase().includes(searchTerm)) ||
                    (row.designation && row.designation.toLowerCase().includes(searchTerm)) ||
                    (row.vehicle_registration_no && row.vehicle_registration_no.toLowerCase().includes(searchTerm)) || // New search field
                    (row.make_model && row.make_model.toLowerCase().includes(searchTerm)) || // New search field
                    (row.remarks && row.remarks.toLowerCase().includes(searchTerm));

                const matchesEligibility = !eligibilityFilter || row.vehicle_eligibility === eligibilityFilter;
                const matchesAllocation = !allocationFilter || row.current_allocation === allocationFilter;

                return matchesSearch && matchesEligibility && matchesAllocation;
            });

            currentPage = 1;
            updateTotalCount();
            renderTable();
            renderPagination();
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('eligibilityFilter').value = '';
            document.getElementById('allocationFilter').value = '';
            filterTable();
        }

        function sortTable(columnIndex) {
            const columns = ['serial_no', 'office_name_district', 'designation', 'pay_scale', 'sanctioned_posts', 'vehicle_registration_no', 'make_model']; // Updated columns
            const column = columns[columnIndex];
            
            if (sortColumn === columnIndex) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = columnIndex;
                sortDirection = 'asc';
            }

            filteredData.sort((a, b) => {
                let aVal = a[column] || '';
                let bVal = b[column] || '';
                
                if (columnIndex === 0 || columnIndex === 4) { // serial_no or sanctioned_posts are numbers
                    aVal = parseInt(aVal) || 0;
                    bVal = parseInt(bVal) || 0;
                }
                
                if (sortDirection === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });

            renderTable();
            renderPagination();
        }

        async function getNextSerialNumber() {
            try {
                const { data, error } = await supabaseClient
                    .from('division_office_vehicles')
                    .select('serial_no')
                    .order('serial_no', { ascending: false })
                    .limit(1);

                if (error) throw error;

                return data && data.length > 0 && data[0].serial_no !== null ? data[0].serial_no + 1 : 1;
            } catch (error) {
                console.error('Error getting next serial number: ', error);
                // Fallback if DB query fails, use current filtered data length + 1
                return allData.length + 1;
            }
        }

        async function addNewRow() {
            currentEditId = null;
            document.getElementById('modalTitle').textContent = 'नई एंट्री जोड़ें';
            document.getElementById('entryForm').reset();
            document.getElementById('entryId').value = '';
            
            // Auto-fill serial number
            const nextSerial = await getNextSerialNumber();
            document.getElementById('serialNo').value = nextSerial;
            
            const modal = new bootstrap.Modal(document.getElementById('entryModal'));
            modal.show();
        }

        async function editEntry(id) {
            try {
                const { data, error } = await supabaseClient
                    .from('division_office_vehicles')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (error) throw error;

                currentEditId = id;
                document.getElementById('modalTitle').textContent = 'एंट्री एडिट करें';
                document.getElementById('entryId').value = data.id;
                document.getElementById('serialNo').value = data.serial_no || '';
                document.getElementById('officeName').value = data.office_name_district || '';
                document.getElementById('designation').value = data.designation || '';
                document.getElementById('payScale').value = data.pay_scale || '';
                document.getElementById('sanctionedPosts').value = data.sanctioned_posts || '';
                document.getElementById('vehicleRegistrationNo').value = data.vehicle_registration_no || ''; // New field
                document.getElementById('makeModel').value = data.make_model || ''; // New field
                document.getElementById('vehicleEligibility').value = data.vehicle_eligibility || '';
                document.getElementById('currentAllocation').value = data.current_allocation || '';
                document.getElementById('remarks').value = data.remarks || '';

                const modal = new bootstrap.Modal(document.getElementById('entryModal'));
                modal.show();

            } catch (error) {
                alert('डेटा लोड करने में त्रुटि: ' + error.message);
            }
        }

        async function saveEntry() {
            try {
                showLoading();
                const formData = {
                    serial_no: parseInt(document.getElementById('serialNo').value) || null,
                    office_name_district: document.getElementById('officeName').value,
                    designation: document.getElementById('designation').value,
                    pay_scale: document.getElementById('payScale').value,
                    sanctioned_posts: parseInt(document.getElementById('sanctionedPosts').value) || null,
                    vehicle_registration_no: document.getElementById('vehicleRegistrationNo').value, // New field
                    make_model: document.getElementById('makeModel').value, // New field
                    vehicle_eligibility: document.getElementById('vehicleEligibility').value,
                    current_allocation: document.getElementById('currentAllocation').value,
                    remarks: document.getElementById('remarks').value
                };

                let result;
                if (currentEditId) {
                    // Update existing record
                    result = await supabaseClient
                        .from('division_office_vehicles')
                        .update(formData)
                        .eq('id', currentEditId);
                } else {
                    // Insert new record
                    result = await supabaseClient
                        .from('division_office_vehicles')
                        .insert([formData]);
                }

                if (result.error) throw result.error;

                alert('डेटा सफलतापूर्वक सेव हो गया!');
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('entryModal'));
                modal.hide();
                
                loadData();
                hideLoading();

            } catch (error) {
                hideLoading();
                alert('डेटा सेव करने में त्रुटि: ' + error.message);
            }
        }

        async function deleteEntry(id) {
            if (confirm('क्या आप वाकई इस एंट्री को डिलीट करना चाहते हैं?')) {
                try {
                    showLoading();
                    const { error } = await supabaseClient
                        .from('division_office_vehicles')
                        .delete()
                        .eq('id', id);

                    if (error) throw error;

                    alert('एंट्री सफलतापूर्वक डिलीट हो गई!');
                    loadData();
                    hideLoading();

                } catch (error) {
                    hideLoading();
                    alert('डिलीट करने में त्रुटि: ' + error.message);
                }
            }
        }

        // Helper for Excel binary export
        function s2ab(s) {
            const buf = new ArrayBuffer(s.length);
            const view = new Uint8Array(buf);
            for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
            return buf;
        }

        function exportToExcel() {
            showLoading();
            const ws_data = [
                ['संचालनालय कृषि छत्तीसगढ़ रायपुर'],
                ['संभागीय वाहन आबंटन की जानकारी'],
                ['रिपोर्ट दिनांक: ' + new Date().toLocaleDateString('hi-IN')],
                [], // Empty row for spacing
                ['क्रमांक', 'कार्यालय का नाम एवं जिला', 'पदनाम', 'वेतनमान', 'स्वीकृत पद संख्या', 'वाहन पंजीकरण संख्या', 'मेक/मॉडल', 'वाहन की पात्रता है अथवा नहीं', 'वर्तमान में वाहन आबंटित है या नहीं', 'रिमार्क'] // Updated Excel headers
            ];

            filteredData.forEach(row => {
                ws_data.push([
                    row.serial_no || '',
                    row.office_name_district || '',
                    row.designation || '',
                    row.pay_scale || '',
                    row.sanctioned_posts || '',
                    row.vehicle_registration_no || '', // New field
                    row.make_model || '', // New field
                    row.vehicle_eligibility || '',
                    row.current_allocation || '',
                    row.remarks || ''
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(ws_data);

            // Set column widths
            const colWidths = [
                { wch: 8 }, { wch: 25 }, { wch: 15 }, { wch: 15 }, 
                { wch: 18 }, { wch: 20 }, { wch: 15 }, { wch: 20 }, 
                { wch: 25 }, { wch: 30 } // Adjusted column widths
            ];
            ws['!cols'] = colWidths;

            // Merge cells for title
            ws['!merges'] = [
                { s: { r: 0, c: 0 }, e: { r: 0, c: 9 } }, // Adjusted merge range
                { s: { r: 1, c: 0 }, e: { r: 1, c: 9 } }, // Adjusted merge range
                { s: { r: 2, c: 0 }, e: { r: 2, c: 9 } }  // Adjusted merge range
            ];

            // Style for titles and headers
            const titleStyle = { 
                font: { bold: true, sz: 16, color: { rgb: "FF000000" } }, /* Black color */
                alignment: { horizontal: "center", vertical: "center", wrapText: true }
            };
            const subtitleStyle = { 
                font: { bold: true, sz: 14, color: { rgb: "FF000000" } }, /* Black color */
                alignment: { horizontal: "center", vertical: "center", wrapText: true }
            };
            const dateStyle = { 
                font: { sz: 11, color: { rgb: "FF000000" } }, /* Black color */
                alignment: { horizontal: "center", vertical: "center", wrapText: true }
            };
            const headerCellStyle = {
                font: { bold: true, sz: 12, color: { rgb: "FF000000" } }, /* Black color */
                alignment: { horizontal: "center", vertical: "center", wrapText: true },
                fill: { fgColor: { rgb: "FFD3D3D3" } }, /* Light gray background */
                border: {
                    top: { style: "thin", color: { rgb: "FF000000" } },
                    bottom: { style: "thin", color: { rgb: "FF000000" } },
                    left: { style: "thin", color: { rgb: "FF000000" } },
                    right: { style: "thin", color: { rgb: "FF000000" } }
                }
            };
            const dataCellStyle = {
                alignment: { horizontal: "center", vertical: "center", wrapText: true },
                border: {
                    top: { style: "thin", color: { rgb: "FF000000" } },
                    bottom: { style: "thin", color: { rgb: "FF000000" } },
                    left: { style: "thin", color: { rgb: "FF000000" } },
                    right: { style: "thin", color: { rgb: "FF000000" } }
                }
            };
            
            if (ws['A1']) ws['A1'].s = titleStyle;
            if (ws['A2']) ws['A2'].s = subtitleStyle;
            if (ws['A3']) ws['A3'].s = dateStyle;

            // Apply header style to table headers
            for (let c = 0; c < ws_data[4].length; c++) {
                const cellRef = XLSX.utils.encode_cell({ r: 4, c: c });
                if (!ws[cellRef]) ws[cellRef] = {};
                ws[cellRef].s = headerCellStyle;
            }

            // Apply data cell styles to data rows
            for (let r = 5; r < ws_data.length; r++) {
                for (let c = 0; c < ws_data[r].length; c++) {
                    const cellRef = XLSX.utils.encode_cell({ r: r, c: c });
                    if (!ws[cellRef]) ws[cellRef] = {};
                    ws[cellRef].s = dataCellStyle;
                }
            }

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'संभाग_वाहन');

            // Landscape orientation
            if (!wb.Sheets['संभाग_वाहन']['!pageSetup']) wb.Sheets['संभाग_वाहन']['!pageSetup'] = {};
            wb.Sheets['संभाग_वाहन']['!pageSetup'].orientation = 'landscape';

            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });
            const blob = new Blob([s2ab(wbout)], { type: 'application/octet-stream' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'संभाग_स्तर_कार्यालय_वाहन_आबंटन.xlsx';
            link.click();
            hideLoading();
        }

        async function exportToPDF() {
            showLoading();
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4'); // 'l' for landscape

            // IMPORTANT: For Hindi to render correctly, you MUST embed a Unicode font.
            // This is a placeholder. You need to generate font files for jsPDF
            // using tools like `jspdf-customfonts` or `jspdf-autotable` font generation.
            // Example: doc.addFont('NotoSansDevanagari-Regular.ttf', 'NotoSansDevanagari', 'normal');
            // doc.setFont('NotoSansDevanagari');
            // For this example, we'll use a generic font. Hindi might not display correctly.
            doc.setFont('helvetica'); // Fallback font, might not render Hindi characters

            doc.setTextColor(0, 0, 0); // Black text color
            doc.setFontSize(16);
            doc.text('संचालनालय कृषि छत्तीसगढ़ रायपुर', doc.internal.pageSize.getWidth() / 2, 15, { align: 'center' });
            doc.setFontSize(14);
            doc.text('संभागीय वाहन आबंटन की जानकारी', doc.internal.pageSize.getWidth() / 2, 25, { align: 'center' });
            doc.setFontSize(10);
            doc.text('रिपोर्ट दिनांक: ' + new Date().toLocaleDateString('hi-IN'), doc.internal.pageSize.getWidth() / 2, 35, { align: 'center' });

            const headers = [
                'क्रमांक', 'कार्यालय का नाम एवं जिला', 'पदनाम', 'वेतनमान', 
                'स्वीकृत पद संख्या', 'वाहन पंजीकरण संख्या', 'मेक/मॉडल', 'वाहन की पात्रता', 'वर्तमान में वाहन आबंटित', 'रिमार्क' // Updated PDF headers
            ];

            const data = filteredData.map(row => [
                row.serial_no || '',
                row.office_name_district || '',
                row.designation || '',
                row.pay_scale || '',
                row.sanctioned_posts || '',
                row.vehicle_registration_no || '', // New field
                row.make_model || '', // New field
                row.vehicle_eligibility || '',
                row.current_allocation || '',
                row.remarks || ''
            ]);

            doc.autoTable({
                head: [headers],
                body: data,
                startY: 45,
                theme: 'grid',
                headStyles: { 
                    fillColor: [211, 211, 211], // Light gray background
                    textColor: [0, 0, 0], // Black text
                    fontStyle: 'bold', 
                    halign: 'center',
                    valign: 'middle',
                    fontSize: 8,
                    lineColor: [0, 0, 0], // Black border
                    lineWidth: 0.2
                },
                bodyStyles: { 
                    textColor: [0, 0, 0], // Black text
                    halign: 'center', 
                    valign: 'middle',
                    fontSize: 8,
                    lineColor: [0, 0, 0], // Black border
                    lineWidth: 0.1
                },
                alternateRowStyles: { 
                    fillColor: [248, 249, 250] // Light gray for alternate rows
                },
                styles: {
                    font: 'helvetica', // Use a font that supports Hindi, or embed one
                    cellPadding: 2,
                    lineWidth: 0.1,
                    lineColor: [0, 0, 0] // All borders black
                },
                // Removed columnStyles to enable auto-fitting widths
            });

            doc.save('संभाग_स्तर_कार्यालय_वाहन_आबंटन.pdf');
            hideLoading();
        }

        function logout() {
            if (confirm('क्या आप वाकई लॉगआउट करना चाहते हैं?')) {
                localStorage.removeItem('user');
                sessionStorage.removeItem('user');
                window.location.href = 'index.html';
            }
        }
    </script>
</body>
</html>
