<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡§∏‡§Ç‡§ö‡§æ‡§≤‡§®‡§æ‡§≤‡§Ø ‡§ï‡•É‡§∑‡§ø ‡§õ‡§§‡•ç‡§§‡•Ä‡§∏‡§ó‡§¢‡§º - ‡§ñ‡§∏‡§∞‡§æ ‡§°‡•á‡§ü‡§æ ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Mukta:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --admin-primary: #1B5E20;
            --admin-secondary: #2E7D32;
            --admin-accent: #4CAF50;
            --text-dark: #1A1A1A;
            --text-medium: #666666;
            --text-light: #fff;
            --background-light: #FAFAFA;
            --border-color: #E5E5E5;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 8px 24px rgba(27, 94, 32, 0.2);
            --primary-bg-color: #1B5E20;
            --light-green: #E8F5E8;
            --warning-bg: #FFF3CD;
            --warning-border: #FFEAA7;
            --warning-text: #856404;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Mukta', sans-serif;
            background: linear-gradient(135deg, var(--background-light) 0%, var(--text-light) 100%);
            min-height: 100vh;
            color: var(--text-dark);
        }

        .hindi {
            font-weight: 500;
            letter-spacing: 0.3px;
            line-height: 1.5;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-bg-color) 0%, var(--admin-secondary) 100%);
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 3px solid var(--admin-accent);
        }
        
        .navbar {
            padding: 12px 0;
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--text-light);
            display: flex;
            align-items: center;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .navbar-brand img {
            height: 45px;
            margin-right: 15px;
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.9) !important;
            font-weight: 600;
            padding: 12px 20px !important;
            margin: 0 5px;
            border-radius: 8px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .nav-link:hover {
            color: var(--text-light) !important;
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }

        .logout-btn {
            background-color: #DC3545 !important;
            color: var(--text-light) !important;
            padding: 8px 16px !important;
            border-radius: 8px;
        }

        .logout-btn:hover {
            background-color: #B02A37 !important;
            transform: translateY(-1px);
        }

        .main-container {
            padding: 30px 0;
            min-height: calc(100vh - 80px);
        }

        .card {
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            background-color: #FFFFFF;
            margin-bottom: 30px;
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-bg-color) 0%, var(--admin-secondary) 100%);
            color: var(--text-light);
            padding: 20px 30px;
            border-bottom: 3px solid var(--admin-accent);
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }
        
        .card-header h4 {
            font-weight: 700;
            margin-bottom: 5px;
            font-size: 1.3rem;
        }
        
        .card-body {
            padding: 30px;
        }

        .form-label {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
            font-size: 1.05rem;
        }

        .form-control, .form-select {
            height: 50px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            padding: 10px 15px;
            font-size: 1.05rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            background-color: #FFFFFF;
            font-family: 'Mukta', sans-serif;
            color: var(--text-dark);
        }

        .form-control:focus, .form-select:focus {
            outline: none;
            border-color: var(--admin-accent);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .breadcrumb-container {
            background-color: var(--light-green);
            padding: 15px 30px;
            border-radius: 8px;
            margin-bottom: 25px;
        }

        .breadcrumb {
            background: none;
            margin-bottom: 0;
            padding: 0;
        }

        .breadcrumb-item {
            color: var(--admin-primary);
            font-weight: 600;
        }

        .breadcrumb-item.active {
            color: var(--text-medium);
        }

        .village-table {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid var(--border-color);
            border-radius: 8px;
        }

        .table {
            margin-bottom: 0;
        }

        .table thead th {
            background-color: var(--primary-bg-color);
            color: var(--text-light);
            border: none;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .table tbody tr:hover {
            background-color: var(--light-green);
        }

        .village-checkbox {
            width: 1.2rem;
            height: 1.2rem;
            accent-color: var(--admin-accent);
        }

        .khasra-entry-section {
            background-color: #F8F9FA;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .khasra-village-card {
            background-color: white;
            border: 2px solid var(--admin-accent);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .khasra-village-title {
            color: var(--admin-primary);
            font-weight: 700;
            margin-bottom: 10px;
        }

        .khasra-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .khasra-input {
            flex: 1;
        }

        .add-khasra-btn, .remove-khasra-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            font-size: 1.1rem;
            cursor: pointer;
        }

        .add-khasra-btn {
            background-color: var(--admin-accent);
            color: white;
        }

        .add-khasra-btn:hover {
            background-color: var(--admin-secondary);
        }

        .remove-khasra-btn {
            background-color: #DC3545;
            color: white;
        }

        .remove-khasra-btn:hover {
            background-color: #B02A37;
        }

        .btn-primary-custom {
            background: linear-gradient(135deg, var(--admin-accent) 0%, var(--admin-secondary) 100%);
            border: none;
            color: var(--text-light);
            font-weight: 700;
            border-radius: 8px;
            padding: 12px 30px;
            font-size: 1.1rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-sm);
            cursor: pointer;
        }

        .btn-primary-custom:hover {
            background: linear-gradient(135deg, var(--admin-secondary) 0%, var(--admin-primary) 100%);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
            color: var(--text-light);
        }

        .btn-secondary-custom {
            background-color: #6C757D;
            border: none;
            color: white;
            font-weight: 600;
            border-radius: 8px;
            padding: 12px 30px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .btn-secondary-custom:hover {
            background-color: #5A6268;
            transform: translateY(-1px);
        }

        .alert {
            border-radius: 8px;
            font-weight: 500;
            padding: 16px;
            margin-bottom: 25px;
            box-shadow: var(--shadow-sm);
            border: none;
        }

        .alert-success {
            background: linear-gradient(135deg, #D4EDDA 0%, #C3E6CB 100%);
            color: #155724;
            border-left: 4px solid #28A745;
        }

        .alert-danger {
            background: linear-gradient(135deg, #F8D7DA 0%, #F5C6CB 100%);
            color: #721C24;
            border-left: 4px solid #DC3545;
        }

        .alert-info {
            background: linear-gradient(135deg, #D1ECF1 0%, #BEE5EB 100%);
            color: #0C5460;
            border-left: 4px solid #17A2B8;
        }

        .alert-warning {
            background: linear-gradient(135deg, #FFF3CD 0%, #FFEAA7 100%);
            color: #856404;
            border-left: 4px solid #FFC107;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }

        @media (max-width: 768px) {
            .navbar-brand {
                font-size: 1.3rem;
            }
            
            .navbar-brand img {
                height: 35px;
            }
            
            .card-body {
                padding: 20px 15px;
            }
            
            .main-container {
                padding: 20px 0;
            }

            .khasra-input-group {
                flex-direction: column;
                gap: 5px;
            }

            .add-khasra-btn, .remove-khasra-btn {
                width: 100%;
                border-radius: 8px;
                height: 35px;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-10px); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <nav class="navbar navbar-expand-lg navbar-dark">
                <div class="container-fluid">
                    <a class="navbar-brand" href="#">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/8/87/Coat_of_arms_of_Chhattisgarh.svg" alt="‡§õ‡§§‡•ç‡§§‡•Ä‡§∏‡§ó‡§¢‡§º ‡§∏‡§∞‡§ï‡§æ‡§∞">
                        <span class="hindi">‡§∏‡§Ç‡§ö‡§æ‡§≤‡§®‡§æ‡§≤‡§Ø ‡§ï‡•É‡§∑‡§ø ‡§õ‡§§‡•ç‡§§‡•Ä‡§∏‡§ó‡§¢‡§º</span>
                    </a>
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarNav">
                        <ul class="navbar-nav ms-auto">
                            <li class="nav-item">
                                <span class="nav-link hindi">Loggged In, <span id="userFullName">‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ</span></span>
                            </li>
                            <li class="nav-item">
                                <span class="nav-link hindi">‡§ú‡§ø‡§≤‡§æ: <span id="userDistrict">-</span></span>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link logout-btn hindi" href="#" id="logoutBtn">
                                    <i class="fas fa-sign-out-alt me-1"></i> ‡§≤‡•â‡§ó‡§Ü‡§â‡§ü
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <div class="main-container">
        <div class="container">
            <div id="alertBox" class="alert" style="display: none;"></div>

            <div class="card">
                <div class="card-header">
                    <h5 class="hindi" style="padding: 10px; background-color: blue;">Only Urban Village - ‡§ñ‡§∏‡§∞‡§æ ‡§°‡•á‡§ü‡§æ ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä</h5>
                    <p class="hindi mb-0">‡§ï‡•á‡§µ‡§≤ ‡§â‡§∏‡•Ä ‡§ó‡§æ‡§Ç‡§µ ‡§ï‡§æ ‡§ö‡§Ø‡§® ‡§ï‡§∞‡•á‡§Ç, ‡§ú‡§π‡§æ‡§Ç ‡§ñ‡§∏‡§∞‡§æ ‡§µ‡•á‡§∞‡•Ä‡§´‡§ø‡§ï‡•á‡§∂‡§® ‡§ï‡§æ ‡§á‡§∂‡•Ç ‡§π‡•à ‡§§‡§•‡§æ ‡§ñ‡§∏‡§∞‡§æ ‡§®‡§Ç‡§¨‡§∞ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç</p>
                </div>
                <div class="card-body">
                    <div class="breadcrumb-container">
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item hindi" id="breadcrumbDistrict">‡§ú‡§ø‡§≤‡§æ: -</li>
                                <li class="breadcrumb-item hindi" id="breadcrumbLevel4">‡§∏‡•ç‡§§‡§∞ 4: -</li>
                                <li class="breadcrumb-item hindi" id="breadcrumbLevel5">‡§∏‡•ç‡§§‡§∞ 5: -</li>
                            </ol>
                        </nav>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6 mb-3">
                            <label for="level4Select" class="form-label hindi">‡§∏‡•ç‡§§‡§∞ 4 (‡§§‡§π‡§∏‡•Ä‡§≤) ‡§ï‡§æ ‡§ö‡§Ø‡§® ‡§ï‡§∞‡•á‡§Ç</label>
                            <select class="form-select" id="level4Select">
                                <option value="">-- ‡§∏‡•ç‡§§‡§∞ 4 ‡§ö‡•Å‡§®‡•á‡§Ç --</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="level5Select" class="form-label hindi">‡§∏‡•ç‡§§‡§∞ 5(‡§∞‡§æ0‡§®‡§ø0‡§Æ) ‡§ï‡§æ ‡§ö‡§Ø‡§® ‡§ï‡§∞‡•á‡§Ç</label>
                            <select class="form-select" id="level5Select" disabled>
                                <option value="">-- ‡§™‡§π‡§≤‡•á ‡§∏‡•ç‡§§‡§∞ 4 ‡§ö‡•Å‡§®‡•á‡§Ç --</option>
                            </select>
                        </div>
                    </div>

                    <div id="villagesSection" style="display: none;">
                        <h5 class="hindi mb-3">‡§ó‡§æ‡§Ç‡§µ ‡§ï‡§æ ‡§ö‡§Ø‡§® ‡§ï‡§∞‡•á‡§Ç:</h5>
                        <div class="village-table">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th class="hindi">‡§ö‡§Ø‡§®</th>
                                        <th class="hindi">‡§ó‡§æ‡§Ç‡§µ ‡§ï‡§æ ‡§®‡§æ‡§Æ</th>
                                        <th class="hindi">‡§ó‡§æ‡§Ç‡§µ ‡§ï‡•ã‡§°</th>
                                    </tr>
                                </thead>
                                <tbody id="villagesTableBody">
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-3">
                            <button type="button" class="btn btn-sm btn-secondary-custom me-2" id="selectAllBtn">
                                <i class="fas fa-check-square me-1"></i> <span class="hindi">‡§∏‡§≠‡•Ä ‡§ö‡•Å‡§®‡•á‡§Ç</span>
                            </button>
                            <button type="button" class="btn btn-sm btn-secondary-custom" id="deselectAllBtn">
                                <i class="fas fa-square me-1"></i> <span class="hindi">‡§∏‡§≠‡•Ä ‡§π‡§ü‡§æ‡§è‡§Ç</span>
                            </button>
                        </div>
                    </div>

                    <div id="khasraEntrySection" class="khasra-entry-section" style="display: none;">
                        <h5 class="hindi mb-3">‡§ö‡§Ø‡§®‡§ø‡§§ ‡§ó‡§æ‡§Ç‡§µ‡•ã‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ñ‡§∏‡§∞‡§æ ‡§®‡§Ç‡§¨‡§∞ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç:</h5>
                        <div id="khasraEntryContainer">
                        </div>
                    </div>

                    <div class="text-center mt-4" id="actionButtons" style="display: none;">
                        <button type="button" class="btn btn-primary-custom me-3" id="saveDataBtn">
                            <i class="fas fa-save me-2"></i> <span class="hindi">‡§°‡•á‡§ü‡§æ ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç</span>
                        </button>
                        <button type="button" class="btn btn-secondary-custom" id="resetFormBtn">
                            <i class="fas fa-undo me-2"></i> <span class="hindi">‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
    <script>
        // Supabase configuration
        const supabaseUrl = 'https://txjbfqrbbtvzlxpeegkv.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4amJmcXJiYnR2emx4cGVlZ2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMTU2NTQsImV4cCI6MjA2ODY5MTY1NH0.sE5UbwEOSnd9ED-k_Ix5OfdZbf7dmwlHZSjQQrEAyCo';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(supabaseUrl, supabaseKey);

        // Global variables
        let currentUser = null;
        let villageHierarchyData = [];
        let selectedVillages = [];

        // Show alert message
        function showAlert(message, type) {
            const alertBox = document.getElementById('alertBox');
            alertBox.textContent = message;
            alertBox.className = `alert alert-${type} hindi fade-in`;
            alertBox.style.display = 'block';
            
            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 5000);
        }

        // Check authentication and load user data
        async function checkAuthentication() {
            try {
                const storedUser = localStorage.getItem('user') || sessionStorage.getItem('user');
                
                if (!storedUser) {
                    window.location.href = 'login.html';
                    return;
                }
                
                currentUser = JSON.parse(storedUser);
                console.log('Current user:', currentUser);
                
                // Update UI with user info
                document.getElementById('userFullName').textContent = currentUser.fullName || currentUser.username || '‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ';
                document.getElementById('userDistrict').textContent = currentUser.districtName || 'N/A';
                document.getElementById('breadcrumbDistrict').textContent = `‡§ú‡§ø‡§≤‡§æ: ${currentUser.districtName || 'N/A'}`;
                
                // Load village hierarchy data for user's district
                await loadVillageHierarchy();
                
            } catch (error) {
                console.error('Authentication error:', error);
                showAlert('‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡•Ä‡§ï‡§∞‡§£ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡•á‡§Ç‡•§', 'danger');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
            }
        }

        // Load village hierarchy data
        async function loadVillageHierarchy() {
            try {
                if (!currentUser || !currentUser.districtName) {
                    showAlert('‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§ú‡§ø‡§≤‡§æ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§', 'warning');
                    return;
                }

                showAlert('‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...', 'info');
                
                const { data, error } = await supabaseClient
                    .from('village_hierarchy')
                    .select('*')
                    .eq('districtname', currentUser.districtName)
                    .order('level4name', { ascending: true });
                
                if (error) {
                    console.error('Supabase error:', error);
                    throw error;
                }
                
                villageHierarchyData = data || [];
                console.log('Loaded village hierarchy data:', villageHierarchyData.length, 'records');
                
                if (villageHierarchyData.length === 0) {
                    showAlert(`‡§ú‡§ø‡§≤‡§æ "${currentUser.districtName}" ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§`, 'warning');
                    return;
                }
                
                // Populate level4 dropdown
                populateLevel4Dropdown();
                showAlert('‡§°‡•á‡§ü‡§æ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§≤‡•ã‡§° ‡§π‡•ã ‡§ó‡§Ø‡§æ‡•§', 'success');
                
            } catch (error) {
                console.error('Error loading village hierarchy:', error);
                showAlert('‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§', 'danger');
            }
        }

        // Populate Level 4 dropdown
        function populateLevel4Dropdown() {
            const level4Select = document.getElementById('level4Select');
            
            // Get unique level4 names
            const level4Options = [...new Set(villageHierarchyData
                .map(item => item.level4name)
                .filter(name => name && name.trim() !== '')
            )].sort();
            
            // Clear existing options except first
            level4Select.innerHTML = '<option value="">-- ‡§∏‡•ç‡§§‡§∞ 4 ‡§ö‡•Å‡§®‡•á‡§Ç --</option>';
            
            // Add level4 options
            level4Options.forEach(level4 => {
                const option = document.createElement('option');
                option.value = level4;
                option.textContent = level4;
                level4Select.appendChild(option);
            });
            
            console.log('Level 4 options loaded:', level4Options.length);
        }

        // Handle Level 4 selection
        function handleLevel4Change() {
            const level4Select = document.getElementById('level4Select');
            const level5Select = document.getElementById('level5Select');
            const selectedLevel4 = level4Select.value;
            
            // Update breadcrumb
            document.getElementById('breadcrumbLevel4').textContent = `‡§∏‡•ç‡§§‡§∞ 4: ${selectedLevel4 || '-'}`;
            document.getElementById('breadcrumbLevel5').textContent = '‡§∏‡•ç‡§§‡§∞ 5: -';
            
            // Reset level5 and hide villages
            level5Select.innerHTML = '<option value="">-- ‡§∏‡•ç‡§§‡§∞ 5 ‡§ö‡•Å‡§®‡•á‡§Ç --</option>';
            level5Select.disabled = !selectedLevel4;
            hideVillagesSection();
            
            if (!selectedLevel4) return;
            
            // Get unique level5 names for selected level4
            const level5Options = [...new Set(villageHierarchyData
                .filter(item => item.level4name === selectedLevel4)
                .map(item => item.level5name)
                .filter(name => name && name.trim() !== '')
            )].sort();
            
            // Populate level5 dropdown
            level5Options.forEach(level5 => {
                const option = document.createElement('option');
                option.value = level5;
                option.textContent = level5;
                level5Select.appendChild(option);
            });
            
            console.log('Level 5 options loaded:', level5Options.length);
        }

        // Handle Level 5 selection
        function handleLevel5Change() {
            const level4Select = document.getElementById('level4Select');
            const level5Select = document.getElementById('level5Select');
            const selectedLevel4 = level4Select.value;
            const selectedLevel5 = level5Select.value;
            
            // Update breadcrumb
            document.getElementById('breadcrumbLevel5').textContent = `‡§∏‡•ç‡§§‡§∞ 5: \${selectedLevel5 || '-'}`;
            
            if (!selectedLevel4 || !selectedLevel5) {
                hideVillagesSection();
                return;
            }
            
            // Filter villages for selected level4 and level5
            const villages = villageHierarchyData.filter(item => 
                item.level4name === selectedLevel4 && 
                item.level5name === selectedLevel5 &&
                item.villagename && 
                item.villagecode
            );
            
            // Remove duplicates based on village code
            const uniqueVillages = villages.filter((village, index, self) =>
                index === self.findIndex(v => v.villagecode === village.villagecode)
            ).sort((a, b) => a.villagename.localeCompare(b.villagename));
            
            console.log('Villages loaded:', uniqueVillages.length);
            
            // Populate villages table
            populateVillagesTable(uniqueVillages);
            showVillagesSection();
        }

        // Populate villages table
        function populateVillagesTable(villages) {
            const tableBody = document.getElementById('villagesTableBody');
            
            // Clear existing content
            tableBody.innerHTML = '';
            
            if (villages.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="3" class="text-center text-muted hindi">‡§ï‡•ã‡§à ‡§ó‡§æ‡§Ç‡§µ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ</td>';
                tableBody.appendChild(row);
                return;
            }
            
            // Create rows using DOM methods
            villages.forEach(village => {
                const row = document.createElement('tr');
                
                // Checkbox cell
                const checkboxCell = document.createElement('td');
                checkboxCell.className = 'text-center';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'village-checkbox';
                checkbox.value = village.villagecode;
                checkbox.setAttribute('data-village-name', village.villagename);
                checkbox.setAttribute('data-level4', village.level4name);
                checkbox.setAttribute('data-level5', village.level5name);
                checkbox.setAttribute('data-level6', village.level6code || '');
                checkbox.addEventListener('change', handleVillageSelection);
                
                checkboxCell.appendChild(checkbox);
                
                // Village name cell
                const nameCell = document.createElement('td');
                nameCell.className = 'hindi';
                nameCell.textContent = village.villagename;
                
                // Village code cell
                const codeCell = document.createElement('td');
                codeCell.textContent = village.villagecode;
                
                // Append cells to row
                row.appendChild(checkboxCell);
                row.appendChild(nameCell);
                row.appendChild(codeCell);
                
                // Append row to table body
                tableBody.appendChild(row);
            });
        }

        // Show villages section
        function showVillagesSection() {
            document.getElementById('villagesSection').style.display = 'block';
        }

        // Hide villages section
        function hideVillagesSection() {
            document.getElementById('villagesSection').style.display = 'none';
            document.getElementById('khasraEntrySection').style.display = 'none';
            document.getElementById('actionButtons').style.display = 'none';
            selectedVillages = [];
        }

        // Handle village selection
        function handleVillageSelection() {
            const checkboxes = document.querySelectorAll('.village-checkbox:checked');
            selectedVillages = [];
            
            checkboxes.forEach(checkbox => {
                selectedVillages.push({
                    villagecode: checkbox.value,
                    villagename: checkbox.getAttribute('data-village-name'),
                    level4name: checkbox.getAttribute('data-level4'),
                    level5name: checkbox.getAttribute('data-level5'),
                    level6code: checkbox.getAttribute('data-level6'),
                    districtname: currentUser.districtName
                });
            });
            
            console.log('Selected villages:', selectedVillages.length);
            
            if (selectedVillages.length > 0) {
                showKhasraEntrySection();
                document.getElementById('actionButtons').style.display = 'block';
            } else {
                document.getElementById('khasraEntrySection').style.display = 'none';
                document.getElementById('actionButtons').style.display = 'none';
            }
        }

        // Show khasra entry section
        function showKhasraEntrySection() {
            const container = document.getElementById('khasraEntryContainer');
            
            // Clear existing content
            container.innerHTML = '';
            
            selectedVillages.forEach(village => {
                const villageCard = document.createElement('div');
                villageCard.className = 'khasra-village-card fade-in';
                villageCard.setAttribute('data-village-code', village.villagecode);
                
                const titleDiv = document.createElement('div');
                titleDiv.className = 'khasra-village-title hindi';
                titleDiv.innerHTML = `<i class="fas fa-map-marker-alt me-2"></i>${village.villagename} (${village.villagecode})`;
                
                const inputsContainer = document.createElement('div');
                inputsContainer.className = 'khasra-inputs-container';
                
                const inputGroup = document.createElement('div');
                inputGroup.className = 'khasra-input-group';
                
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'form-control khasra-input';
                input.placeholder = '‡§ñ‡§∏‡§∞‡§æ ‡§®‡§Ç‡§¨‡§∞ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç';
                input.setAttribute('data-village-code', village.villagecode);
                
                const addBtn = document.createElement('button');
                addBtn.type = 'button';
                addBtn.className = 'add-khasra-btn';
                addBtn.title = '‡§ñ‡§∏‡§∞‡§æ ‡§®‡§Ç‡§¨‡§∞ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç';
                addBtn.innerHTML = '<i class="fas fa-plus"></i>';
                addBtn.addEventListener('click', () => addKhasraInput(village.villagecode));
                
                inputGroup.appendChild(input);
                inputGroup.appendChild(addBtn);
                inputsContainer.appendChild(inputGroup);
                
                villageCard.appendChild(titleDiv);
                villageCard.appendChild(inputsContainer);
                
                container.appendChild(villageCard);
            });
            
            document.getElementById('khasraEntrySection').style.display = 'block';
        }

        // Add khasra input field
        function addKhasraInput(villageCode) {
            const villageCard = document.querySelector(`[data-village-code="${villageCode}"]`);
            const container = villageCard.querySelector('.khasra-inputs-container');
            
            const inputGroup = document.createElement('div');
            inputGroup.className = 'khasra-input-group fade-in';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-control khasra-input';
            input.placeholder = '‡§ñ‡§∏‡§∞‡§æ ‡§®‡§Ç‡§¨‡§∞ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç';
            input.setAttribute('data-village-code', villageCode);
            
            const addBtn = document.createElement('button');
            addBtn.type = 'button';
            addBtn.className = 'add-khasra-btn';
            addBtn.title = '‡§ñ‡§∏‡§∞‡§æ ‡§®‡§Ç‡§¨‡§∞ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç';
            addBtn.innerHTML = '<i class="fas fa-plus"></i>';
            addBtn.addEventListener('click', () => addKhasraInput(villageCode));
            
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'remove-khasra-btn';
            removeBtn.title = '‡§ñ‡§∏‡§∞‡§æ ‡§®‡§Ç‡§¨‡§∞ ‡§π‡§ü‡§æ‡§è‡§Ç';
            removeBtn.innerHTML = '<i class="fas fa-minus"></i>';
            removeBtn.addEventListener('click', () => removeKhasraInput(removeBtn));
            
            inputGroup.appendChild(input);
            inputGroup.appendChild(addBtn);
            inputGroup.appendChild(removeBtn);
            
            container.appendChild(inputGroup);
        }

        // Remove khasra input field
        function removeKhasraInput(button) {
            const inputGroup = button.parentElement;
            inputGroup.style.animation = 'fadeOut 0.3s ease-in-out';
            setTimeout(() => {
                inputGroup.remove();
            }, 300);
        }

        // Select all villages
        function selectAllVillages() {
            const checkboxes = document.querySelectorAll('.village-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
            handleVillageSelection();
        }

        // Deselect all villages
        function deselectAllVillages() {
            const checkboxes = document.querySelectorAll('.village-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            handleVillageSelection();
        }

        // Collect khasra data
        function collectKhasraData() {
            const khasraData = [];
            
            selectedVillages.forEach(village => {
                const inputs = document.querySelectorAll(`input[data-village-code="${village.villagecode}"]`);
                
                inputs.forEach(input => {
                    const khasraNumber = input.value.trim();
                    if (khasraNumber) {
                        khasraData.push({
                            user_id: currentUser.id,
                            districtname: village.districtname,
                            level4name: village.level4name,
                            level5name: village.level5name,
                            level6code: village.level6code,
                            villagename: village.villagename,
                            villagecode: village.villagecode,
                            khasra_number: khasraNumber
                        });
                    }
                });
            });
            
            return khasraData;
        }

        // Validate khasra data
        function validateKhasraData(data) {
            if (data.length === 0) {
                showAlert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ ‡§è‡§ï ‡§ñ‡§∏‡§∞‡§æ ‡§®‡§Ç‡§¨‡§∞ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§', 'warning');
                return false;
            }
            
            // Check for duplicate khasra numbers within same village
            const duplicates = [];
            const seen = new Set();
            
            data.forEach(item => {
                const key = `${item.villagecode}-${item.khasra_number}`;
                if (seen.has(key)) {
                    duplicates.push(`${item.villagename} ‡§Æ‡•á‡§Ç ‡§ñ‡§∏‡§∞‡§æ ‡§®‡§Ç‡§¨‡§∞ ${item.khasra_number}`);
                }
                seen.add(key);
            });
            
            if (duplicates.length > 0) {
                showAlert(`‡§°‡•Å‡§™‡•ç‡§≤‡§ø‡§ï‡•á‡§ü ‡§ñ‡§∏‡§∞‡§æ ‡§®‡§Ç‡§¨‡§∞ ‡§Æ‡§ø‡§≤‡•á: ${duplicates.join(', ')}`, 'warning');
                return false;
            }
            
            return true;
        }

        // Save khasra data
        async function saveKhasraData() {
            try {
                const khasraData = collectKhasraData();
                
                if (!validateKhasraData(khasraData)) {
                    return;
                }
                
                // Show loading state
                const saveBtn = document.getElementById('saveDataBtn');
                const originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> <span class="hindi">‡§∏‡•á‡§µ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</span>';
                saveBtn.disabled = true;
                
                console.log('Saving khasra data:', khasraData);
                
                // Insert data in batches
                const batchSize = 100;
                let totalSaved = 0;
                
                for (let i = 0; i < khasraData.length; i += batchSize) {
                    const batch = khasraData.slice(i, i + batchSize);
                    
                    const { data, error } = await supabaseClient
                        .from('khasra_data')
                        .insert(batch);
                    
                    if (error) {
                        console.error('Supabase insert error:', error);
                        throw error;
                    }
                    
                    totalSaved += batch.length;
                    console.log(`Saved batch ${Math.floor(i/batchSize) + 1}, total: ${totalSaved}`);
                }
                
                showAlert(`‡§∏‡§´‡§≤‡§§‡§æ! ${totalSaved} ‡§ñ‡§∏‡§∞‡§æ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§∏‡•á‡§µ ‡§π‡•ã ‡§ó‡§è‡•§`, 'success');
                
                // Reset form
                resetForm();
                
            } catch (error) {
                console.error('Error saving khasra data:', error);
                showAlert(`‡§°‡•á‡§ü‡§æ ‡§∏‡•á‡§µ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${error.message}`, 'danger');
            } finally {
                // Reset button
                const saveBtn = document.getElementById('saveDataBtn');
                saveBtn.innerHTML = '<i class="fas fa-save me-2"></i> <span class="hindi">‡§°‡•á‡§ü‡§æ ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç</span>';
                saveBtn.disabled = false;
            }
        }

        // Reset form
        function resetForm() {
            // Reset dropdowns
            document.getElementById('level4Select').value = '';
            document.getElementById('level5Select').value = '';
            document.getElementById('level5Select').disabled = true;
            
            // Reset breadcrumb
            document.getElementById('breadcrumbLevel4').textContent = '‡§∏‡•ç‡§§‡§∞ 4: -';
            document.getElementById('breadcrumbLevel5').textContent = '‡§∏‡•ç‡§§‡§∞ 5: -';
            
            // Hide sections
            hideVillagesSection();
            
            // Clear selected villages
            selectedVillages = [];
            
            console.log('Form reset completed');
        }

        // Handle logout
        function handleLogout() {
            if (confirm('‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§≤‡•â‡§ó‡§Ü‡§â‡§ü ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?')) {
                // Clear storage
                localStorage.removeItem('user');
                sessionStorage.removeItem('user');
                
                // Redirect to login
                window.location.href = 'login.html';
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded');
            
            // Check authentication
            checkAuthentication();
            
            // Level 4 dropdown change
            document.getElementById('level4Select').addEventListener('change', handleLevel4Change);
            
            // Level 5 dropdown change
            document.getElementById('level5Select').addEventListener('change', handleLevel5Change);
            
            // Select/Deselect all buttons
            document.getElementById('selectAllBtn').addEventListener('click', selectAllVillages);
            document.getElementById('deselectAllBtn').addEventListener('click', deselectAllVillages);
            
            // Save data button
            document.getElementById('saveDataBtn').addEventListener('click', saveKhasraData);
            
            // Reset form button
            document.getElementById('resetFormBtn').addEventListener('click', resetForm);
            
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            console.log('All event listeners attached');
        });

        // Handle page unload
        window.addEventListener('beforeunload', function(e) {
            const khasraData = collectKhasraData();
            if (khasraData.length > 0) {
                e.preventDefault();
                e.returnValue = '‡§Ü‡§™‡§ï‡§æ ‡§°‡•á‡§ü‡§æ ‡§∏‡•á‡§µ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü ‡§π‡•à‡•§ ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§™‡•á‡§ú ‡§õ‡•ã‡§°‡§º‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?';
            }
        });

        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl + S to save
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                const saveBtn = document.getElementById('saveDataBtn');
                if (saveBtn && saveBtn.style.display !== 'none' && !saveBtn.disabled) {
                    saveKhasraData();
                }
            }
            
            // Ctrl + R to reset
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                resetForm();
            }
            
            // Escape to deselect all
            if (e.key === 'Escape') {
                deselectAllVillages();
            }
        });

        // Add error boundary
        window.addEventListener('error', function(e) {
            console.error('Unhandled error:', e.error);
            showAlert('‡§è‡§ï ‡§§‡§ï‡§®‡•Ä‡§ï‡•Ä ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•á‡§ú ‡§ï‡•ã ‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡•á‡§Ç‡•§', 'danger');
        });

        // Add promise rejection handler
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
            showAlert('‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§π‡•Å‡§à ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§', 'warning');
        });

        // Console welcome message
        console.log(`
        ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
        ‚ïë                     ‡§ñ‡§∏‡§∞‡§æ ‡§°‡•á‡§ü‡§æ ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§∏‡§ø‡§∏‡•ç‡§ü‡§Æ                  ‚ïë
        ‚ïë                    Khasra Data Entry System                  ‚ïë
        ‚ïë                                                              ‚ïë
        ‚ïë  üåæ Village Hierarchy Integration Active                    ‚ïë
        ‚ïë  üìä Multi-Village Khasra Entry Enabled                      ‚ïë
        ‚ïë  üîí User Authentication & Authorization                      ‚ïë
        ‚ïë  üíæ Auto-Save & Validation Features                         ‚ïë
        ‚ïë                                                              ‚ïë
        ‚ïë  Keyboard Shortcuts:                                        ‚ïë
        ‚ïë  ‚Ä¢ Ctrl + S: Save Data                                      ‚ïë
        ‚ïë  ‚Ä¢ Ctrl + R: Reset Form                                     ‚ïë
        ‚ïë  ‚Ä¢ Escape: Deselect All Villages                            ‚ïë
        ‚ïë                                                              ‚ïë
        ‚ïë  For technical support: diagri-cg@cg.gov.in                ‚ïë
        ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
        `);

        // Development helpers (remove in production)
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            window.debugHelpers = {
                getCurrentUser: () => currentUser,
                getVillageData: () => villageHierarchyData,
                getSelectedVillages: () => selectedVillages,
                collectKhasraData: collectKhasraData,
                resetForm: resetForm,
                testSave: () => {
                    console.log('Test data:', collectKhasraData());
                }
            };
            console.log('üõ†Ô∏è Debug helpers available in window.debugHelpers');
        }
    </script>
</body>
</html>

