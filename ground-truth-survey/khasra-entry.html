<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>खसरा डेटा एंट्री - संचालनालय कृषि छत्तीसगढ़</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Mukta:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --admin-primary: #1B5E20;
            --admin-secondary: #2E7D32;
            --admin-accent: #4CAF50;
            --text-dark: #1A1A1A;
            --text-medium: #666666;
            --text-light: #fff;
            --background-light: #FAFAFA;
            --border-color: #E5E5E5;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 8px 24px rgba(27, 94, 32, 0.2);
            --primary-bg-color: #1B5E20;
            --light-green: #E8F5E8;
            --light-blue: #E3F2FD;
            --report-blue: #2196F3;
            --warning-bg: #FFF3CD;
            --warning-border: #FFEAA7;
            --warning-text: #856404;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Mukta', sans-serif;
            background: linear-gradient(135deg, var(--background-light) 0%, var(--text-light) 100%);
            min-height: 100vh;
            color: var(--text-dark);
        }

        .hindi {
            font-weight: 500;
            letter-spacing: 0.3px;
            line-height: 1.5;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-bg-color) 0%, var(--admin-secondary) 100%);
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 3px solid var(--admin-accent);
        }
        
        .navbar {
            padding: 12px 0;
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--text-light);
            display: flex;
            align-items: center;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .navbar-brand img {
            height: 45px;
            margin-right: 15px;
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.9) !important;
            font-weight: 600;
            padding: 12px 20px !important;
            margin: 0 5px;
            border-radius: 8px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .nav-link:hover {
            color: var(--text-light) !important;
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }

        /* Report Dropdown Styles */
        .report-dropdown {
            background-color: var(--report-blue) !important;
            color: var(--text-light) !important;
            padding: 8px 16px !important;
            border-radius: 8px;
        }

        .report-dropdown:hover {
            background-color: #1976D2 !important;
            transform: translateY(-1px);
        }

        .report-dropdown-menu {
            background-color: var(--light-blue);
            border: 2px solid var(--report-blue);
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            padding: 10px 0;
            min-width: 250px;
        }

        .report-dropdown-item {
            color: var(--text-dark) !important;
            padding: 12px 20px;
            font-weight: 600;
            transition: all 0.2s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
        }

        .report-dropdown-item:hover {
            background-color: var(--report-blue);
            color: var(--text-light) !important;
            transform: translateX(5px);
        }

        .report-dropdown-item i {
            width: 20px;
            margin-right: 10px;
        }

        /* District Entry Button for Users */
        .district-entry-btn {
            background-color: #FF9800 !important;
            color: var(--text-light) !important;
            padding: 8px 16px !important;
            border-radius: 8px;
        }

        .district-entry-btn:hover {
            background-color: #F57C00 !important;
            transform: translateY(-1px);
        }

        .logout-btn {
            background-color: #DC3545 !important;
            color: var(--text-light) !important;
            padding: 8px 16px !important;
            border-radius: 8px;
        }

        .logout-btn:hover {
            background-color: #B02A37 !important;
            transform: translateY(-1px);
        }

        .main-container {
            padding: 30px 0;
            min-height: calc(100vh - 80px);
        }

        .card {
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            background-color: #FFFFFF;
            margin-bottom: 30px;
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-bg-color) 0%, var(--admin-secondary) 100%);
            color: var(--text-light);
            padding: 20px 30px;
            border-bottom: 3px solid var(--admin-accent);
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }
        
        .card-header h4 {
            font-weight: 700;
            margin-bottom: 5px;
            font-size: 1.3rem;
        }
        
        .card-body {
            padding: 30px;
        }

        .form-label {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
            font-size: 1.05rem;
        }

        .form-control, .form-select {
            height: 50px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            padding: 10px 15px;
            font-size: 1.05rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            background-color: #FFFFFF;
            font-family: 'Mukta', sans-serif;
            color: var(--text-dark);
        }

        .form-control:focus, .form-select:focus {
            outline: none;
            border-color: var(--admin-accent);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .breadcrumb-container {
            background-color: var(--light-green);
            padding: 15px 30px;
            border-radius: 8px;
            margin-bottom: 25px;
        }

        .breadcrumb {
            background: none;
            margin-bottom: 0;
            padding: 0;
        }

        .breadcrumb-item {
            color: var(--admin-primary);
            font-weight: 600;
        }

        .breadcrumb-item.active {
            color: var(--text-medium);
        }

        .village-table {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid var(--border-color);
            border-radius: 8px;
        }

        .table {
            margin-bottom: 0;
        }

        .table thead th {
            background-color: var(--primary-bg-color);
            color: var(--text-light);
            border: none;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .table tbody tr:hover {
            background-color: var(--light-green);
        }

        .village-checkbox {
            width: 1.2rem;
            height: 1.2rem;
            accent-color: var(--admin-accent);
        }

        .khasra-entry-section {
            background-color: #F8F9FA;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .khasra-village-card {
            background-color: white;
            border: 2px solid var(--admin-accent);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .khasra-village-title {
            color: var(--admin-primary);
            font-weight: 700;
            margin-bottom: 10px;
        }

        .khasra-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .khasra-input {
            flex: 1;
        }

        .add-khasra-btn, .remove-khasra-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            font-size: 1.1rem;
            cursor: pointer;
        }

        .add-khasra-btn {
            background-color: var(--admin-accent);
            color: white;
        }

        .add-khasra-btn:hover {
            background-color: var(--admin-secondary);
        }

        .remove-khasra-btn {
            background-color: #DC3545;
            color: white;
        }

        .remove-khasra-btn:hover {
            background-color: #B02A37;
        }

        .btn-primary-custom {
            background: linear-gradient(135deg, var(--admin-accent) 0%, var(--admin-secondary) 100%);
            border: none;
            color: var(--text-light);
            font-weight: 700;
            border-radius: 8px;
            padding: 12px 30px;
            font-size: 1.1rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-sm);
            cursor: pointer;
        }

        .btn-primary-custom:hover {
            background: linear-gradient(135deg, var(--admin-secondary) 0%, var(--admin-primary) 100%);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
            color: var(--text-light);
        }

        .btn-secondary-custom {
            background-color: #6C757D;
            border: none;
            color: white;
            font-weight: 600;
            border-radius: 8px;
            padding: 12px 30px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .btn-secondary-custom:hover {
            background-color: #5A6268;
            transform: translateY(-1px);
        }

        .alert {
            border-radius: 8px;
            font-weight: 500;
            padding: 16px;
            margin-bottom: 25px;
            box-shadow: var(--shadow-sm);
            border: none;
        }

        .alert-success {
            background: linear-gradient(135deg, #D4EDDA 0%, #C3E6CB 100%);
            color: #155724;
            border-left: 4px solid #28A745;
        }

        .alert-danger {
            background: linear-gradient(135deg, #F8D7DA 0%, #F5C6CB 100%);
            color: #721C24;
            border-left: 4px solid #DC3545;
        }

        .alert-info {
            background: linear-gradient(135deg, #D1ECF1 0%, #BEE5EB 100%);
            color: #0C5460;
            border-left: 4px solid #17A2B8;
        }

        .alert-warning {
            background: linear-gradient(135deg, #FFF3CD 0%, #FFEAA7 100%);
            color: #856404;
            border-left: 4px solid #FFC107;
        }

        /* Report Modal Styles */
        .report-modal .modal-content {
            border-radius: 12px;
            border: none;
            box-shadow: var(--shadow-lg);
        }

        .report-modal .modal-header {
            background: linear-gradient(135deg, var(--report-blue) 0%, #1976D2 100%);
            color: var(--text-light);
            border-bottom: none;
            padding: 20px 30px;
        }

        .report-modal .modal-title {
            font-weight: 700;
            font-size: 1.3rem;
        }

        .report-modal .modal-body {
            padding: 30px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .coverage-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--light-blue) 0%, #E1F5FE 100%);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid var(--report-blue);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--report-blue);
        }

        .stat-label {
            color: var(--text-dark);
            font-weight: 600;
            margin-top: 5px;
        }

        .coverage-table {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid var(--border-color);
            border-radius: 8px;
        }

        .coverage-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .has-data {
            background-color: #28A745;
        }

        .no-data {
            background-color: #DC3545;
        }

        .export-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .export-card {
            background-color: var(--light-blue);
            padding: 20px;
            border-radius: 8px;
            border: 2px solid var(--report-blue);
            text-align: center;
        }

        .export-btn {
            background-color: var(--report-blue);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            margin-top: 10px;
        }

        .export-btn:hover {
            background-color: #1976D2;
            transform: translateY(-2px);
        }

        /* Pagination Styles */
        .pagination {
            justify-content: center;
            margin-top: 20px;
        }

        .page-link {
            color: var(--admin-primary);
            border: 2px solid var(--border-color);
            padding: 8px 16px;
            margin: 0 2px;
            border-radius: 8px;
            font-weight: 600;
        }

        .page-link:hover {
            background-color: var(--admin-accent);
            color: white;
            border-color: var(--admin-accent);
        }

        .page-item.active .page-link {
            background-color: var(--admin-primary);
            border-color: var(--admin-primary);
            color: white;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            box-shadow: var(--shadow-lg);
        }

        @media (max-width: 768px) {
            .navbar-brand {
                font-size: 1.3rem;
            }
            
            .navbar-brand img {
                height: 35px;
            }
            
            .card-body {
                padding: 20px 15px;
            }
            
            .main-container {
                padding: 20px 0;
            }

            .khasra-input-group {
                flex-direction: column;
                gap: 5px;
            }

            .add-khasra-btn, .remove-khasra-btn {
                width: 100%;
                border-radius: 8px;
                height: 35px;
            }

            .report-dropdown-menu {
                min-width: 200px;
            }

            .table-responsive {
                font-size: 0.8rem;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-10px); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-3 hindi">
                <strong id="loadingText">डेटा लोड हो रहा है...</strong>
            </div>
        </div>
    </div>

    <header class="header">
        <div class="container">
            <nav class="navbar navbar-expand-lg navbar-dark">
                <div class="container-fluid">
                    <a class="navbar-brand" href="#">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/8/87/Coat_of_arms_of_Chhattisgarh.svg" alt="छत्तीसगढ़ सरकार">
                        <span class="hindi">संचालनालय कृषि छत्तीसगढ़</span>
                    </a>
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarNav">
                        <ul class="navbar-nav ms-auto">
                            <li class="nav-item">
                                <span class="nav-link hindi">स्वागत, <span id="userFullName">उपयोगकर्ता</span></span>
                            </li>
                            <li class="nav-item">
                                <span class="nav-link hindi">जिला: <span id="userDistrict">-</span></span>
                            </li>
                            
                            <!-- Admin Report Dropdown -->
                            <li class="nav-item dropdown" id="adminReportSection" style="display: none;">
                                <a class="nav-link dropdown-toggle report-dropdown hindi" href="#" id="reportDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-chart-bar me-1"></i> रिपोर्ट
                                </a>
                                <ul class="dropdown-menu report-dropdown-menu" aria-labelledby="reportDropdown">
                                    <li>
                                        <button class="report-dropdown-item hindi" id="villageCoverageBtn">
                                            <i class="fas fa-map-marked-alt"></i> गांव कवरेज रिपोर्ट
                                        </button>
                                    </li>
                                    <li>
                                        <button class="report-dropdown-item hindi" id="dataExportBtn">
                                            <i class="fas fa-download"></i> डेटा एक्सपोर्ट
                                        </button>
                                    </li>
                                    <li>
                                        <button class="report-dropdown-item hindi" id="districtReportBtn">
                                            <i class="fas fa-chart-pie"></i> जिला रिपोर्ट
                                        </button>
                                    </li>
                                </ul>
                            </li>
                            
                            <!-- User District Entry Button -->
                            <li class="nav-item" id="userDistrictSection" style="display: none;">
                                <a class="nav-link district-entry-btn hindi" href="#" id="districtEntryBtn">
                                    <i class="fas fa-list me-1"></i> जिला एंट्री
                                </a>
                            </li>
                            
                            <li class="nav-item">
                                <a class="nav-link logout-btn hindi" href="#" id="logoutBtn">
                                    <i class="fas fa-sign-out-alt me-1"></i> लॉगआउट
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <div class="main-container">
        <div class="container">
            <div id="alertBox" class="alert" style="display: none;"></div>

            <!-- Data Entry Section (Default) -->
            <div id="dataEntrySection" class="card">
                <div class="card-header">
                    <h4 class="hindi">खसरा डेटा एंट्री</h4>
                    <p class="hindi mb-0">गांव का चयन करें और खसरा नंबर दर्ज करें</p>
                </div>
                <div class="card-body">
                    <div class="breadcrumb-container">
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item hindi" id="breadcrumbDistrict">जिला: -</li>
                                <li class="breadcrumb-item hindi" id="breadcrumbLevel4">स्तर 4: -</li>
                                <li class="breadcrumb-item hindi" id="breadcrumbLevel5">स्तर 5: -</li>
                            </ol>
                        </nav>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6 mb-3">
                            <label for="level4Select" class="form-label hindi">स्तर 4 का चयन करें</label>
                            <select class="form-select" id="level4Select">
                                <option value="">-- स्तर 4 चुनें --</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="level5Select" class="form-label hindi">स्तर 5 का चयन करें</label>
                            <select class="form-select" id="level5Select" disabled>
                                <option value="">-- पहले स्तर 4 चुनें --</option>
                            </select>
                        </div>
                    </div>

                    <div id="villagesSection" style="display: none;">
                        <h5 class="hindi mb-3">गांव का चयन करें:</h5>
                        <div class="village-table">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th class="hindi">चयन</th>
                                        <th class="hindi">गांव का नाम</th>
                                        <th class="hindi">गांव कोड</th>
                                    </tr>
                                </thead>
                                <tbody id="villagesTableBody">
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-3">
                            <button type="button" class="btn btn-sm btn-secondary-custom me-2" id="selectAllBtn">
                                <i class="fas fa-check-square me-1"></i> <span class="hindi">सभी चुनें</span>
                            </button>
                            <button type="button" class="btn btn-sm btn-secondary-custom" id="deselectAllBtn">
                                <i class="fas fa-square me-1"></i> <span class="hindi">सभी हटाएं</span>
                            </button>
                        </div>
                    </div>

                    <div id="khasraEntrySection" class="khasra-entry-section" style="display: none;">
                        <h5 class="hindi mb-3">चयनित गांवों के लिए खसरा नंबर दर्ज करें:</h5>
                        <div id="khasraEntryContainer">
                        </div>
                    </div>

                    <div class="text-center mt-4" id="actionButtons" style="display: none;">
                        <button type="button" class="btn btn-primary-custom me-3" id="saveDataBtn">
                            <i class="fas fa-save me-2"></i> <span class="hindi">डेटा सेव करें</span>
                        </button>
                        <button type="button" class="btn btn-secondary-custom" id="resetFormBtn">
                            <i class="fas fa-undo me-2"></i> <span class="hindi">रीसेट करें</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- User District Entry Section -->
            <div id="userDataSection" class="card" style="display: none;">
                <div class="card-header">
                    <h4 class="hindi">मेरी जिला एंट्री</h4>
                    <p class="hindi mb-0">आपके द्वारा दर्ज किए गए खसरा डेटा</p>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <input type="text" class="form-control" id="searchInput" placeholder="गांव या खसरा नंबर खोजें...">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="filterVillage">
                                <option value="">सभी गांव</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-primary-custom w-100" onclick="searchUserData()">
                                <i class="fas fa-search me-1"></i> खोजें
                            </button>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th class="hindi">जिला</th>
                                    <th class="hindi">स्तर 4</th>
                                    <th class="hindi">स्तर 5</th>
                                    <th class="hindi">गांव का नाम</th>
                                    <th class="hindi">गांव कोड</th>
                                    <th class="hindi">खसरा नंबर</th>
                                    <th class="hindi">एंट्री तारीख</th>
                                </tr>
                            </thead>
                            <tbody id="userDataTableBody">
                                <tr>
                                    <td colspan="7" class="text-center hindi">डेटा लोड हो रहा है...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <nav aria-label="Page navigation">
                        <ul class="pagination" id="paginationContainer">
                            <!-- Pagination will be populated here -->
                        </ul>
                    </nav>

                    <div class="text-center mt-3">
                        <button class="btn btn-secondary-custom" onclick="backToDataEntry()">
                            <i class="fas fa-arrow-left me-1"></i> <span class="hindi">डेटा एंट्री पर वापस जाएं</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Village Coverage Report Modal -->
    <div class="modal fade report-modal" id="villageCoverageModal" tabindex="-1" aria-labelledby="villageCoverageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title hindi" id="villageCoverageModalLabel">
                        <i class="fas fa-map-marked-alt me-2"></i> गांव कवरेज रिपोर्ट
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="coverage-stats" id="coverageStats">
                        <!-- Statistics will be populated here -->
                    </div>
                    
                    <h6 class="hindi mb-3">विस्तृत कवरेज जानकारी:</h6>
                    <div class="coverage-table">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th class="hindi">स्थिति</th>
                                    <th class="hindi">गांव का नाम</th>
                                    <th class="hindi">गांव कोड</th>
                                    <th class="hindi">स्तर 4</th>
                                    <th class="hindi">स्तर 5</th>
                                    <th class="hindi">कुल एंट्री</th>
                                </tr>
                            </thead>
                            <tbody id="coverageTableBody">
                                <!-- Coverage data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">बंद करें</button>
                    <button type="button" class="btn btn-primary" onclick="exportCoverageReport()">
                        <i class="fas fa-download me-1"></i> रिपोर्ट डाउनलोड करें
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Export Modal -->
    <div class="modal fade report-modal" id="dataExportModal" tabindex="-1" aria-labelledby="dataExportModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title hindi" id="dataExportModalLabel">
                        <i class="fas fa-download me-2"></i> डेटा एक्सपोर्ट
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="export-options">
                        <div class="export-card">
                            <h6 class="hindi"><i class="fas fa-file-csv text-success me-2"></i>CSV फॉर्मेट</h6>
                            <p class="hindi">सभी खसरा डेटा CSV फाइल में डाउनलोड करें</p>
                            <button class="export-btn" onclick="exportData('csv')">
                                <i class="fas fa-download me-1"></i> CSV डाउनलोड
                            </button>
                        </div>
                        
                        <div class="export-card">
                            <h6 class="hindi"><i class="fas fa-file-excel text-success me-2"></i>Excel फॉर्मेट</h6>
                            <p class="hindi">सभी खसरा डेटा Excel फाइल में डाउनलोड करें</p>
                            <button class="export-btn" onclick="exportData('excel')">
                                <i class="fas fa-download me-1"></i> Excel डाउनलोड
                            </button>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="exportStartDate" class="form-label hindi">शुरुआती तारीख:</label>
                            <input type="date" class="form-control" id="exportStartDate">
                        </div>
                        <div class="col-md-6">
                            <label for="exportEndDate" class="form-label hindi">अंतिम तारीख:</label>
                            <input type="date" class="form-control" id="exportEndDate">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="exportDistrict" class="form-label hindi">जिला फिल्टर:</label>
                        <select class="form-select" id="exportDistrict">
                            <option value="">सभी जिले</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">बंद करें</button>
                </div>
            </div>
        </div>
    </div>

    <!-- District Report Modal -->
    <div class="modal fade report-modal" id="districtReportModal" tabindex="-1" aria-labelledby="districtReportModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title hindi" id="districtReportModalLabel">
                        <i class="fas fa-chart-pie me-2"></i> जिला रिपोर्ट
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="reportDistrict" class="form-label hindi">जिला चुनें:</label>
                            <select class="form-select" id="reportDistrict">
                                <option value="">-- जिला चुनें --</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="reportDateRange" class="form-label hindi">रिपोर्ट अवधि:</label>
                            <select class="form-select" id="reportDateRange">
                                <option value="7">पिछले 7 दिन</option>
                                <option value="30" selected>पिछले 30 दिन</option>
                                <option value="90">पिछले 90 दिन</option>
                                <option value="all">सभी डेटा</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="coverage-stats" id="districtStats">
                        <!-- District statistics will be populated here -->
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="hindi mb-3">उपयोगकर्ता-वार डेटा एंट्री:</h6>
                            <div class="coverage-table" style="max-height: 300px;">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th class="hindi">उपयोगकर्ता</th>
                                            <th class="hindi">कुल एंट्री</th>
                                            <th class="hindi">अंतिम एंट्री</th>
                                        </tr>
                                    </thead>
                                    <tbody id="userStatsTable">
                                        <!-- User stats will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h6 class="hindi mb-3">गांव-वार डेटा एंट्री:</h6>
                            <div class="coverage-table" style="max-height: 300px;">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th class="hindi">गांव</th>
                                            <th class="hindi">कुल एंट्री</th>
                                            <th class="hindi">अंतिम एंट्री</th>
                                        </tr>
                                    </thead>
                                    <tbody id="villageStatsTable">
                                        <!-- Village stats will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">बंद करें</button>
                    <button type="button" class="btn btn-primary" onclick="generateDistrictReport()">
                        <i class="fas fa-file-pdf me-1"></i> PDF रिपोर्ट बनाएं
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
    <script>
        // Supabase configuration
        const supabaseUrl = 'https://txjbfqrbbtvzlxpeegkv.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4amJmcXJiYnR2emx4cGVlZ2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMTU2NTQsImV4cCI6MjA2ODY5MTY1NH0.sE5UbwEOSnd9ED-k_Ix5OfdZbf7dmwlHZSjQQrEAyCo';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(supabaseUrl, supabaseKey);

        // Global variables
        let currentUser = null;
        let villageHierarchyData = [];
        let selectedVillages = [];
        let currentPage = 1;
        let totalPages = 1;
        let itemsPerPage = 5;
        let userKhasraData = [];
        let filteredUserData = [];

        // Show loading overlay
        function showLoading(text = 'डेटा लोड हो रहा है...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        // Hide loading overlay
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // Show alert message
        function showAlert(message, type) {
            const alertBox = document.getElementById('alertBox');
            alertBox.textContent = message;
            alertBox.className = 'alert alert-' + type + ' hindi fade-in';
            alertBox.style.display = 'block';
            
            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 5000);
        }

        // Check authentication and setup UI based on role
        async function checkAuthentication() {
            try {
                const storedUser = localStorage.getItem('user') || sessionStorage.getItem('user');
                
                if (!storedUser) {
                    window.location.href = 'login.html';
                    return;
                }
                
                currentUser = JSON.parse(storedUser);
                console.log('Current user:', currentUser);
                
                // Update UI with user info
                document.getElementById('userFullName').textContent = currentUser.fullName || currentUser.username || 'उपयोगकर्ता';
                document.getElementById('userDistrict').textContent = currentUser.districtName || 'N/A';
                document.getElementById('breadcrumbDistrict').textContent = 'जिला: ' + (currentUser.districtName || 'N/A');
                
                // Setup UI based on user role
                setupUIBasedOnRole();
                
                // Load village hierarchy data for user's district
                await loadVillageHierarchy();
                
            } catch (error) {
                console.error('Authentication error:', error);
                showAlert('प्रमाणीकरण त्रुटि। कृपया पुनः लॉगिन करें।', 'danger');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
            }
        }

        // Setup UI based on user role
        function setupUIBasedOnRole() {
            const adminSection = document.getElementById('adminReportSection');
            const userSection = document.getElementById('userDistrictSection');
            
            if (currentUser.role === 'admin') {
                // Show admin report dropdown
                adminSection.style.display = 'block';
                userSection.style.display = 'none';
                console.log('Admin user detected - showing report dropdown');
            } else {
                // Show user district entry button  
                adminSection.style.display = 'none';
                userSection.style.display = 'block';
                console.log('Regular user detected - showing district entry button');
            }
        }

        // Load village hierarchy data
        async function loadVillageHierarchy() {
            try {
                if (!currentUser || !currentUser.districtName) {
                    showAlert('उपयोगकर्ता जिला जानकारी उपलब्ध नहीं है।', 'warning');
                    return;
                }

                showAlert('डेटा लोड हो रहा है...', 'info');
                
                const { data, error } = await supabaseClient
                    .from('village_hierarchy')
                    .select('*')
                    .eq('districtname', currentUser.districtName)
                    .order('level4name', { ascending: true });
                
                if (error) {
                    console.error('Supabase error:', error);
                    throw error;
                }
                
                villageHierarchyData = data || [];
                console.log('Loaded village hierarchy data:', villageHierarchyData.length, 'records');
                
                if (villageHierarchyData.length === 0) {
                    showAlert('जिला "' + currentUser.districtName + '" के लिए कोई डेटा नहीं मिला।', 'warning');
                    return;
                }
                
                // Populate level4 dropdown
                populateLevel4Dropdown();
                showAlert('डेटा सफलतापूर्वक लोड हो गया।', 'success');
                
            } catch (error) {
                console.error('Error loading village hierarchy:', error);
                showAlert('डेटा लोड करने में त्रुटि हुई।', 'danger');
            }
        }

        // Populate Level 4 dropdown
        function populateLevel4Dropdown() {
            const level4Select = document.getElementById('level4Select');
            
            // Get unique level4 names
            const level4Options = [...new Set(villageHierarchyData
                .map(item => item.level4name)
                .filter(name => name && name.trim() !== '')
            )].sort();
            
            // Clear existing options except first
            level4Select.innerHTML = '<option value="">-- स्तर 4 चुनें --</option>';
            
            // Add level4 options
            level4Options.forEach(level4 => {
                const option = document.createElement('option');
                option.value = level4;
                option.textContent = level4;
                level4Select.appendChild(option);
            });
            
            console.log('Level 4 options loaded:', level4Options.length);
        }

        // Handle Level 4 selection
        function handleLevel4Change() {
            const level4Select = document.getElementById('level4Select');
            const level5Select = document.getElementById('level5Select');
            const selectedLevel4 = level4Select.value;
            
            // Update breadcrumb
            document.getElementById('breadcrumbLevel4').textContent = 'स्तर 4: ' + (selectedLevel4 || '-');
            document.getElementById('breadcrumbLevel5').textContent = 'स्तर 5: -';
            
            // Reset level5 and hide villages
            level5Select.innerHTML = '<option value="">-- स्तर 5 चुनें --</option>';
            level5Select.disabled = !selectedLevel4;
            hideVillagesSection();
            
            if (!selectedLevel4) return;
            
            // Get unique level5 names for selected level4
            const level5Options = [...new Set(villageHierarchyData
                .filter(item => item.level4name === selectedLevel4)
                .map(item => item.level5name)
                .filter(name => name && name.trim() !== '')
            )].sort();
            
            // Populate level5 dropdown
            level5Options.forEach(level5 => {
                const option = document.createElement('option');
                option.value = level5;
                option.textContent = level5;
                level5Select.appendChild(option);
            });
            
            console.log('Level 5 options loaded:', level5Options.length);
        }

        // Handle Level 5 selection
        function handleLevel5Change() {
            const level4Select = document.getElementById('level4Select');
            const level5Select = document.getElementById('level5Select');
            const selectedLevel4 = level4Select.value;
            const selectedLevel5 = level5Select.value;
            
            // Update breadcrumb
            document.getElementById('breadcrumbLevel5').textContent = 'स्तर 5: ' + (selectedLevel5 || '-');
            
            if (!selectedLevel4 || !selectedLevel5) {
                hideVillagesSection();
                return;
            }
            
            // Filter villages for selected level4 and level5
            const villages = villageHierarchyData.filter(item => 
                item.level4name === selectedLevel4 && 
                item.level5name === selectedLevel5 &&
                item.villagename && 
                item.villagecode
            );
            
            // Remove duplicates based on village code
            const uniqueVillages = villages.filter((village, index, self) =>
                index === self.findIndex(v => v.villagecode === village.villagecode)
            ).sort((a, b) => a.villagename.localeCompare(b.villagename));
            
            console.log('Villages loaded:', uniqueVillages.length);
            
            // Populate villages table
            populateVillagesTable(uniqueVillages);
            showVillagesSection();
        }

        // Populate villages table
        function populateVillagesTable(villages) {
            const tableBody = document.getElementById('villagesTableBody');
            
            // Clear existing content
            tableBody.innerHTML = '';
            
            if (villages.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="3" class="text-center text-muted hindi">कोई गांव नहीं मिला</td>';
                tableBody.appendChild(row);
                return;
            }
            
            // Create rows using DOM methods
            villages.forEach(village => {
                const row = document.createElement('tr');
                
                // Checkbox cell
                const checkboxCell = document.createElement('td');
                checkboxCell.className = 'text-center';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'village-checkbox';
                checkbox.value = village.villagecode;
                checkbox.setAttribute('data-village-name', village.villagename);
                checkbox.setAttribute('data-level4', village.level4name);
                checkbox.setAttribute('data-level5', village.level5name);
                checkbox.setAttribute('data-level6', village.level6code || '');
                checkbox.addEventListener('change', handleVillageSelection);
                
                checkboxCell.appendChild(checkbox);
                
                // Village name cell
                const nameCell = document.createElement('td');
                nameCell.className = 'hindi';
                nameCell.textContent = village.villagename;
                
                // Village code cell
                const codeCell = document.createElement('td');
                codeCell.textContent = village.villagecode;
                
                // Append cells to row
                row.appendChild(checkboxCell);
                row.appendChild(nameCell);
                row.appendChild(codeCell);
                
                // Append row to table body
                tableBody.appendChild(row);
            });
        }

        // Show villages section
        function showVillagesSection() {
            document.getElementById('villagesSection').style.display = 'block';
        }

        // Hide villages section
        function hideVillagesSection() {
            document.getElementById('villagesSection').style.display = 'none';
            document.getElementById('khasraEntrySection').style.display = 'none';
            document.getElementById('actionButtons').style.display = 'none';
            selectedVillages = [];
        }

        // Handle village selection
        function handleVillageSelection() {
            const checkboxes = document.querySelectorAll('.village-checkbox:checked');
            selectedVillages = [];
            
            checkboxes.forEach(checkbox => {
                selectedVillages.push({
                    villagecode: checkbox.value,
                    villagename: checkbox.getAttribute('data-village-name'),
                    level4name: checkbox.getAttribute('data-level4'),
                    level5name: checkbox.getAttribute('data-level5'),
                    level6code: checkbox.getAttribute('data-level6'),
                    districtname: currentUser.districtName
                });
            });
            
            console.log('Selected villages:', selectedVillages.length);
            
            if (selectedVillages.length > 0) {
                showKhasraEntrySection();
                document.getElementById('actionButtons').style.display = 'block';
            } else {
                document.getElementById('khasraEntrySection').style.display = 'none';
                document.getElementById('actionButtons').style.display = 'none';
            }
        }

        // Show khasra entry section
        function showKhasraEntrySection() {
            const container = document.getElementById('khasraEntryContainer');
            
            // Clear existing content
            container.innerHTML = '';
            
            selectedVillages.forEach(village => {
                const villageCard = document.createElement('div');
                villageCard.className = 'khasra-village-card fade-in';
                villageCard.setAttribute('data-village-code', village.villagecode);
                
                const titleDiv = document.createElement('div');
                titleDiv.className = 'khasra-village-title hindi';
                titleDiv.innerHTML = '<i class="fas fa-map-marker-alt me-2"></i>' + village.villagename + ' (' + village.villagecode + ')';
                
                const inputsContainer = document.createElement('div');
                inputsContainer.className = 'khasra-inputs-container';
                
                const inputGroup = document.createElement('div');
                inputGroup.className = 'khasra-input-group';
                
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'form-control khasra-input';
                input.placeholder = 'खसरा नंबर दर्ज करें';
                input.setAttribute('data-village-code', village.villagecode);
                
                const addBtn = document.createElement('button');
                addBtn.type = 'button';
                addBtn.className = 'add-khasra-btn';
                addBtn.title = 'खसरा नंबर जोड़ें';
                addBtn.innerHTML = '<i class="fas fa-plus"></i>';
                addBtn.addEventListener('click', () => addKhasraInput(village.villagecode));
                
                inputGroup.appendChild(input);
                inputGroup.appendChild(addBtn);
                inputsContainer.appendChild(inputGroup);
                
                villageCard.appendChild(titleDiv);
                villageCard.appendChild(inputsContainer);
                
                container.appendChild(villageCard);
            });
            
            document.getElementById('khasraEntrySection').style.display = 'block';
        }

        // Add khasra input field
        function addKhasraInput(villageCode) {
            const villageCard = document.querySelector('[data-village-code="' + villageCode + '"]');
            const container = villageCard.querySelector('.khasra-inputs-container');
            
            const inputGroup = document.createElement('div');
            inputGroup.className = 'khasra-input-group fade-in';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-control khasra-input';
            input.placeholder = 'खसरा नंबर दर्ज करें';
            input.setAttribute('data-village-code', villageCode);
            
            const addBtn = document.createElement('button');
            addBtn.type = 'button';
            addBtn.className = 'add-khasra-btn';
            addBtn.title = 'खसरा नंबर जोड़ें';
            addBtn.innerHTML = '<i class="fas fa-plus"></i>';
            addBtn.addEventListener('click', () => addKhasraInput(villageCode));
            
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'remove-khasra-btn';
            removeBtn.title = 'खसरा नंबर हटाएं';
            removeBtn.innerHTML = '<i class="fas fa-minus"></i>';
            removeBtn.addEventListener('click', () => removeKhasraInput(removeBtn));
            
            inputGroup.appendChild(input);
            inputGroup.appendChild(addBtn);
            inputGroup.appendChild(removeBtn);
            
            container.appendChild(inputGroup);
        }

        // Remove khasra input field
        function removeKhasraInput(button) {
            const inputGroup = button.parentElement;
            inputGroup.style.animation = 'fadeOut 0.3s ease-in-out';
            setTimeout(() => {
                inputGroup.remove();
            }, 300);
        }

        // Select all villages
        function selectAllVillages() {
            const checkboxes = document.querySelectorAll('.village-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
            handleVillageSelection();
        }

        // Deselect all villages
        function deselectAllVillages() {
            const checkboxes = document.querySelectorAll('.village-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            handleVillageSelection();
        }

        // Collect khasra data
        function collectKhasraData() {
            const khasraData = [];
            
            selectedVillages.forEach(village => {
                const inputs = document.querySelectorAll('input[data-village-code="' + village.villagecode + '"]');
                
                inputs.forEach(input => {
                    const khasraNumber = input.value.trim();
                    if (khasraNumber) {
                        khasraData.push({
                            user_id: currentUser.id,
                            districtname: village.districtname,
                            level4name: village.level4name,
                            level5name: village.level5name,
                            level6code: village.level6code,
                            villagename: village.villagename,
                            villagecode: village.villagecode,
                            khasra_number: khasraNumber
                        });
                    }
                });
            });
            
            return khasraData;
        }

        // Validate khasra data
        function validateKhasraData(data) {
            if (data.length === 0) {
                showAlert('कृपया कम से कम एक खसरा नंबर दर्ज करें।', 'warning');
                return false;
            }
            
            // Check for duplicate khasra numbers within same village
            const duplicates = [];
            const seen = new Set();
            
            data.forEach(item => {
                const key = item.villagecode + '-' + item.khasra_number;
                if (seen.has(key)) {
                    duplicates.push(item.villagename + ' में खसरा नंबर ' + item.khasra_number);
                }
                seen.add(key);
            });
            
            if (duplicates.length > 0) {
                showAlert('डुप्लिकेट खसरा नंबर मिले: ' + duplicates.join(', '), 'warning');
                return false;
            }
            
            return true;
        }

        // Save khasra data
        async function saveKhasraData() {
            try {
                const khasraData = collectKhasraData();
                
                if (!validateKhasraData(khasraData)) {
                    return;
                }
                
                // Show loading state
                const saveBtn = document.getElementById('saveDataBtn');
                const originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> <span class="hindi">सेव हो रहा है...</span>';
                saveBtn.disabled = true;
                
                console.log('Saving khasra data:', khasraData);
                
                // Insert data in batches
                const batchSize = 100;
                let totalSaved = 0;
                
                for (let i = 0; i < khasraData.length; i += batchSize) {
                    const batch = khasraData.slice(i, i + batchSize);
                    
                    const { data, error } = await supabaseClient
                        .from('khasra_data')
                        .insert(batch);
                    
                    if (error) {
                        console.error('Supabase insert error:', error);
                        throw error;
                    }
                    
                    totalSaved += batch.length;
                    console.log('Saved batch ' + (Math.floor(i/batchSize) + 1) + ', total: ' + totalSaved);
                }
                
                showAlert('सफलता! ' + totalSaved + ' खसरा रिकॉर्ड सेव हो गए।', 'success');
                
                // Reset form
                resetForm();
                
            } catch (error) {
                console.error('Error saving khasra data:', error);
                showAlert('डेटा सेव करने में त्रुटि: ' + error.message, 'danger');
            } finally {
                // Reset button
                const saveBtn = document.getElementById('saveDataBtn');
                saveBtn.innerHTML = '<i class="fas fa-save me-2"></i> <span class="hindi">डेटा सेव करें</span>';
                saveBtn.disabled = false;
            }
        }

        // Reset form
        function resetForm() {
            // Reset dropdowns
            document.getElementById('level4Select').value = '';
            document.getElementById('level5Select').value = '';
            document.getElementById('level5Select').disabled = true;
            
            // Reset breadcrumb
            document.getElementById('breadcrumbLevel4').textContent = 'स्तर 4: -';
            document.getElementById('breadcrumbLevel5').textContent = 'स्तर 5: -';
            
            // Hide sections
            hideVillagesSection();
            
            // Clear selected villages
            selectedVillages = [];
            
            console.log('Form reset completed');
        }

        // Handle logout
        function handleLogout() {
            if (confirm('क्या आप वाकई लॉगआउट करना चाहते हैं?')) {
                // Clear storage
                localStorage.removeItem('user');
                sessionStorage.removeItem('user');
                
                // Redirect to login
                window.location.href = 'login.html';
            }
        }

        // USER DATA FUNCTIONS

        // Show user's district entry data
        async function showUserDistrictData() {
            try {
                showLoading('आपका डेटा लोड हो रहा है...');
                
                // Hide data entry section and show user data section
                document.getElementById('dataEntrySection').style.display = 'none';
                document.getElementById('userDataSection').style.display = 'block';
                
                // Load user's khasra data
                await loadUserKhasraData();
                
                hideLoading();
                
            } catch (error) {
                console.error('Error showing user data:', error);
                showAlert('डेटा लोड करने में त्रुटि: ' + error.message, 'danger');
                hideLoading();
            }
        }

        // Load user's khasra data
        async function loadUserKhasraData() {
            try {
                const { data, error } = await supabaseClient
                    .from('khasra_data')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                userKhasraData = data || [];
                filteredUserData = [...userKhasraData];
                
                console.log('Loaded user khasra data:', userKhasraData.length, 'records');
                
                // Populate village filter dropdown
                populateVillageFilter();
                
                // Display paginated data
                currentPage = 1;
                displayUserData();
                
                if (userKhasraData.length === 0) {
                    showAlert('आपने अभी तक कोई डेटा एंट्री नहीं की है।', 'info');
                }
                
            } catch (error) {
                console.error('Error loading user khasra data:', error);
                throw error;
            }
        }

        // Populate village filter dropdown
        function populateVillageFilter() {
            const filterSelect = document.getElementById('filterVillage');
            
            // Get unique villages from user data
            const uniqueVillages = [...new Set(userKhasraData.map(item => item.villagename))].sort();
            
            filterSelect.innerHTML = '<option value="">सभी गांव</option>';
            
            uniqueVillages.forEach(village => {
                const option = document.createElement('option');
                option.value = village;
                option.textContent = village;
                filterSelect.appendChild(option);
            });
        }

       // Display user data with pagination - FIXED
        function displayUserData() {
            const tableBody = document.getElementById('userDataTableBody');
            
            // Calculate pagination
            totalPages = Math.ceil(filteredUserData.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = filteredUserData.slice(startIndex, endIndex);
            
            // Clear table
            tableBody.innerHTML = '';
            
            if (pageData.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="7" class="text-center text-muted hindi">कोई डेटा नहीं मिला</td>';
                tableBody.appendChild(row);
            } else {
                pageData.forEach(item => {
                    const row = document.createElement('tr');
                    
                    // Create cells individually to avoid template literal issues
                    const districtCell = document.createElement('td');
                    districtCell.className = 'hindi';
                    districtCell.textContent = item.districtname || '-';
                    
                    const level4Cell = document.createElement('td');
                    level4Cell.className = 'hindi';
                    level4Cell.textContent = item.level4name || '-';
                    
                    const level5Cell = document.createElement('td');
                    level5Cell.className = 'hindi';
                    level5Cell.textContent = item.level5name || '-';
                    
                    const villageNameCell = document.createElement('td');
                    villageNameCell.className = 'hindi';
                    villageNameCell.textContent = item.villagename || '-';
                    
                    const villageCodeCell = document.createElement('td');
                    villageCodeCell.textContent = item.villagecode || '-';
                    
                    const khasraCell = document.createElement('td');
                    khasraCell.innerHTML = '<strong>' + (item.khasra_number || '-') + '</strong>';
                    
                    const dateCell = document.createElement('td');
                    dateCell.textContent = new Date(item.created_at).toLocaleDateString('hi-IN');
                    
                    // Append all cells to row
                    row.appendChild(districtCell);
                    row.appendChild(level4Cell);
                    row.appendChild(level5Cell);
                    row.appendChild(villageNameCell);
                    row.appendChild(villageCodeCell);
                    row.appendChild(khasraCell);
                    row.appendChild(dateCell);
                    
                    // Append row to table body
                    tableBody.appendChild(row);
                });
            }
            
            // Update pagination
            updatePagination();
        }

            
            // Update pagination
            updatePagination();
        }

        // Update pagination controls
        function updatePagination() {
            const paginationContainer = document.getElementById('paginationContainer');
            paginationContainer.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // Previous button
            const prevItem = document.createElement('li');
            prevItem.className = 'page-item' + (currentPage === 1 ? ' disabled' : '');
            prevItem.innerHTML = `
                <a class="page-link" href="#" onclick="changePage(\${currentPage - 1})">
                    <i class="fas fa-chevron-left"></i>
                </a>
            `;
            paginationContainer.appendChild(prevItem);
            
            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                const pageItem = document.createElement('li');
                pageItem.className = 'page-item' + (i === currentPage ? ' active' : '');
                pageItem.innerHTML = `
                    <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                `;
                paginationContainer.appendChild(pageItem);
            }
            
            // Next button
            const nextItem = document.createElement('li');
            nextItem.className = 'page-item' + (currentPage === totalPages ? ' disabled' : '');
            nextItem.innerHTML = `
                <a class="page-link" href="#" onclick="changePage(\${currentPage + 1})">
                    <i class="fas fa-chevron-right"></i>
                </a>
            `;
            paginationContainer.appendChild(nextItem);
            
            // Add page info
            const infoItem = document.createElement('li');
            infoItem.className = 'page-item disabled';
            infoItem.innerHTML = `
                <span class="page-link hindi">
                    कुल ${filteredUserData.length} में से ${((currentPage - 1) * itemsPerPage) + 1}-\${Math.min(currentPage * itemsPerPage, filteredUserData.length)}
                </span>
            `;
            paginationContainer.appendChild(infoItem);
        }

        // Change page
        function changePage(page) {
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                displayUserData();
            }
        }

        // Search user data
        function searchUserData() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const villageFilter = document.getElementById('filterVillage').value;
            
            filteredUserData = userKhasraData.filter(item => {
                const matchesSearch = searchTerm === '' || 
                    item.villagename.toLowerCase().includes(searchTerm) ||
                    item.khasra_number.toLowerCase().includes(searchTerm) ||
                    item.villagecode.toLowerCase().includes(searchTerm);
                
                const matchesVillage = villageFilter === '' || item.villagename === villageFilter;
                
                return matchesSearch && matchesVillage;
            });
            
            currentPage = 1;
            displayUserData();
            
            if (filteredUserData.length === 0) {
                showAlert('खोज के लिए कोई परिणाम नहीं मिला।', 'info');
            }
        }

        // Back to data entry
        function backToDataEntry() {
            document.getElementById('userDataSection').style.display = 'none';
            document.getElementById('dataEntrySection').style.display = 'block';
        }

        // ADMIN REPORT FUNCTIONS (Fixed)

        // Show Village Coverage Report (Fixed)
        async function showVillageCoverageReport() {
            try {
                showLoading('कवरेज रिपोर्ट तैयार हो रही है...');
                
                // Get all villages from hierarchy
                const { data: allVillages, error: villageError } = await supabaseClient
                    .from('village_hierarchy')
                    .select('villagecode, villagename, level4name, level5name, districtname')
                    .eq('districtname', currentUser.districtName);
                
                if (villageError) throw villageError;
                
                // Get village codes with khasra data (separate query)
                const { data: khasraVillages, error: khasraError } = await supabaseClient
                    .from('khasra_data')
                    .select('villagecode')
                    .eq('districtname', currentUser.districtName);
                
                if (khasraError) throw khasraError;
                
                // Count entries per village
                const villageCounts = {};
                if (khasraVillages) {
                    khasraVillages.forEach(item => {
                        villageCounts[item.villagecode] = (villageCounts[item.villagecode] || 0) + 1;
                    });
                }
                
                // Calculate statistics
                const totalVillages = allVillages ? allVillages.length : 0;
                const villagesWithData = Object.keys(villageCounts).length;
                const villagesWithoutData = totalVillages - villagesWithData;
                const coveragePercentage = totalVillages > 0 ? Math.round((villagesWithData / totalVillages) * 100) : 0;
                
                // Populate statistics
                const statsContainer = document.getElementById('coverageStats');
                statsContainer.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">\${totalVillages}</div>
                        <div class="stat-label hindi">कुल गांव</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">\${villagesWithData}</div>
                        <div class="stat-label hindi">डेटा के साथ गांव</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">\${villagesWithoutData}</div>
                        <div class="stat-label hindi">डेटा के बिना गांव</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">\${coveragePercentage}%</div>
                        <div class="stat-label hindi">कवरेज प्रतिशत</div>
                    </div>
                `;
                
                // Populate coverage table
                const tableBody = document.getElementById('coverageTableBody');
                tableBody.innerHTML = '';
                
                if (allVillages) {
                    allVillages.forEach(village => {
                        const hasData = villageCounts[village.villagecode] > 0;
                        const entryCount = villageCounts[village.villagecode] || 0;
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>
                                <span class="coverage-indicator \${hasData ? 'has-data' : 'no-data'}"></span>
                                \${hasData ? 'डेटा उपलब्ध' : 'डेटा नहीं'}
                            </td>
                            <td class="hindi">\${village.villagename}</td>
                            <td>\${village.villagecode}</td>
                            <td class="hindi">\${village.level4name || '-'}</td>
                            <td class="hindi">\${village.level5name || '-'}</td>
                            <td>\${entryCount}</td>
                        `;
                        tableBody.appendChild(row);
                    });
                }
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('villageCoverageModal'));
                modal.show();
                
                hideLoading();
                showAlert('कवरेज रिपोर्ट तैयार हो गई।', 'success');
                
            } catch (error) {
                console.error('Error generating coverage report:', error);
                hideLoading();
                showAlert('कवरेज रिपोर्ट बनाने में त्रुटि: ' + error.message, 'danger');
            }
        }

        // Export Coverage Report (Fixed)
        function exportCoverageReport() {
            try {
                const table = document.querySelector('#villageCoverageModal table');
                
                // Create CSV with UTF-8 BOM
                let csv = '\uFEFF'; // UTF-8 BOM
                csv += 'स्थिति,गांव का नाम,गांव कोड,स्तर 4,स्तर 5,कुल एंट्री\n';
                
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    const rowData = [];
                    cells.forEach(cell => {
                        let text = cell.textContent.trim();
                        // Clean status text
                        if (text.includes('डेटा उपलब्ध') || text.includes('डेटा नहीं')) {
                            text = text.replace(/.*?(डेटा उपलब्ध|डेटा नहीं)/, '$1');
                        }
                        rowData.push('"' + text + '"');
                    });
                    csv += rowData.join(',') + '\n';
                });
                
                // Download CSV with proper encoding
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'गांव_कवरेज_रिपोर्ट_' + new Date().toISOString().split('T')[0] + '.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showAlert('कवरेज रिपोर्ट डाउनलोड हो गई।', 'success');
                
            } catch (error) {
                console.error('Error exporting coverage report:', error);
                showAlert('रिपोर्ट एक्सपोर्ट करने में त्रुटि।', 'danger');
            }
        }

        // Show Data Export Modal
        async function showDataExportModal() {
            try {
                // Populate district filter
                const { data: districts, error } = await supabaseClient
                    .from('village_hierarchy')
                    .select('districtname')
                    .order('districtname');
                
                if (!error && districts) {
                    const uniqueDistricts = [...new Set(districts.map(d => d.districtname))];
                    const exportDistrictSelect = document.getElementById('exportDistrict');
                    exportDistrictSelect.innerHTML = '<option value="">सभी जिले</option>';
                    
                    uniqueDistricts.forEach(district => {
                        const option = document.createElement('option');
                        option.value = district;
                        option.textContent = district;
                        if (district === currentUser.districtName) {
                            option.selected = true;
                        }
                        exportDistrictSelect.appendChild(option);
                    });
                }
                
                // Set default dates (last 30 days)
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - 30);
                
                document.getElementById('exportEndDate').value = endDate.toISOString().split('T')[0];
                document.getElementById('exportStartDate').value = startDate.toISOString().split('T')[0];
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('dataExportModal'));
                modal.show();
                
            } catch (error) {
                console.error('Error showing export modal:', error);
                showAlert('एक्सपोर्ट मोडल खोलने में त्रुटि।', 'danger');
            }
        }

        // Export Data Function (Fixed)
        async function exportData(format) {
            try {
                const startDate = document.getElementById('exportStartDate').value;
                const endDate = document.getElementById('exportEndDate').value;
                const selectedDistrict = document.getElementById('exportDistrict').value;
                
                showLoading('डेटा एक्सपोर्ट हो रहा है...');
                
                // Build query
                let query = supabaseClient
                    .from('khasra_data')
                    .select(`
                        districtname,
                        level4name,
                        level5name,
                        level6code,
                        villagename,
                        villagecode,
                        khasra_number,
                        created_at,
                        test_users(full_name, username)
                    `);
                
                // Apply filters
                if (selectedDistrict) {
                    query = query.eq('districtname', selectedDistrict);
                }
                
                if (startDate) {
                    query = query.gte('created_at', startDate + 'T00:00:00');
                }
                
                if (endDate) {
                    query = query.lte('created_at', endDate + 'T23:59:59');
                }
                
                const { data, error } = await query.order('created_at', { ascending: false });
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    hideLoading();
                    showAlert('चयनित फिल्टर के लिए कोई डेटा नहीं मिला।', 'warning');
                    return;
                }
                
                // Prepare data for export
                const exportData = data.map(item => ({
                    'जिला': item.districtname,
                    'स्तर 4': item.level4name,
                    'स्तर 5': item.level5name,
                    'स्तर 6 कोड': item.level6code,
                    'गांव का नाम': item.villagename,
                    'गांव कोड': item.villagecode,
                    'खसरा नंबर': item.khasra_number,
                    'उपयोगकर्ता': item.test_users?.full_name || item.test_users?.username || 'N/A',
                    'एंट्री तारीख': new Date(item.created_at).toLocaleDateString('hi-IN')
                }));
                
                if (format === 'csv') {
                    exportToCSV(exportData);
                } else if (format === 'excel') {
                    exportToExcel(exportData);
                }
                
                hideLoading();
                
            } catch (error) {
                console.error('Error exporting data:', error);
                hideLoading();
                showAlert('डेटा एक्सपोर्ट करने में त्रुटि: ' + error.message, 'danger');
            }
        }

        // Export to CSV (Fixed)
        function exportToCSV(data) {
            const headers = Object.keys(data[0]);
            
            // Create CSV with UTF-8 BOM
            let csv = '\uFEFF'; // UTF-8 BOM for proper Hindi display
            csv += headers.join(',') + '\n';
            
            data.forEach(row => {
                const values = headers.map(header => '"' + (row[header] || '') + '"');
                csv += values.join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'खसरा_डेटा_' + new Date().toISOString().split('T')[0] + '.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showAlert('CSV फाइल डाउनलोड हो गई।', 'success');
        }

        // Export to Excel (Fixed)
        function exportToExcel(data) {
            const headers = Object.keys(data[0]);
            
            // Create tab-separated values with UTF-8 BOM
            let tsv = '\uFEFF'; // UTF-8 BOM
            tsv += headers.join('\t') + '\n';
            
            data.forEach(row => {
                const values = headers.map(header => row[header] || '');
                tsv += values.join('\t') + '\n';
            });
            
            const blob = new Blob([tsv], { type: 'application/vnd.ms-excel;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'खसरा_डेटा_' + new Date().toISOString().split('T')[0] + '.xlsx');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showAlert('Excel फाइल डाउनलोड हो गई।', 'success');
        }

        // Show District Report Modal (Fixed)
        async function showDistrictReportModal() {
            try {
                showLoading('जिला रिपोर्ट तैयार हो रही है...');
                
                // Populate district dropdown
                const { data: districts, error } = await supabaseClient
                    .from('village_hierarchy')
                    .select('districtname')
                    .order('districtname');
                
                if (!error && districts) {
                    const uniqueDistricts = [...new Set(districts.map(d => d.districtname))];
                    const reportDistrictSelect = document.getElementById('reportDistrict');
                    reportDistrictSelect.innerHTML = '<option value="">-- जिला चुनें --</option>';
                    
                    uniqueDistricts.forEach(district => {
                        const option = document.createElement('option');
                        option.value = district;
                        option.textContent = district;
                        if (district === currentUser.districtName) {
                            option.selected = true;
                        }
                        reportDistrictSelect.appendChild(option);
                    });
                }
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('districtReportModal'));
                modal.show();
                
                // Generate initial report for user's district
                if (currentUser.districtName) {
                    await generateDistrictReportData(currentUser.districtName, 30);
                }
                
                hideLoading();
                
            } catch (error) {
                console.error('Error showing district report modal:', error);
                hideLoading();
                showAlert('जिला रिपोर्ट मोडल खोलने में त्रुटि।', 'danger');
            }
        }

        // Generate District Report Data (Fixed)
        async function generateDistrictReportData(district, days) {
            try {
                showLoading('जिला रिपोर्ट बन रही है...');
                
                let dateFilter = null;
                if (days !== 'all') {
                    const startDate = new Date();
                    startDate.setDate(startDate.getDate() - parseInt(days));
                    dateFilter = startDate.toISOString();
                }
                
                // Get district statistics with user info
                let query = supabaseClient
                    .from('khasra_data')
                    .select(`
                        id,
                        villagecode,
                        villagename,
                        created_at,
                        test_users(full_name, username)
                    `)
                    .eq('districtname', district)
                    .limit(1000); // Limit to prevent browser freeze
                
                if (dateFilter) {
                    query = query.gte('created_at', dateFilter);
                }
                
                const { data: khasraData, error } = await query;
                
                if (error) throw error;
                
                // Calculate statistics
                const totalEntries = khasraData ? khasraData.length : 0;
                const uniqueVillages = khasraData ? new Set(khasraData.map(item => item.villagecode)).size : 0;
                const uniqueUsers = khasraData ? new Set(khasraData.map(item => item.test_users?.username)).size : 0;
                
                // User-wise statistics
                const userStats = {};
                const villageStats = {};
                
                if (khasraData) {
                    khasraData.forEach(item => {
                        const userName = item.test_users?.full_name || item.test_users?.username || 'Unknown';
                        const villageName = item.villagename;
                        
                        if (!userStats[userName]) {
                            userStats[userName] = { count: 0, lastEntry: item.created_at };
                        }
                        userStats[userName].count++;
                        if (new Date(item.created_at) > new Date(userStats[userName].lastEntry)) {
                            userStats[userName].lastEntry = item.created_at;
                        }
                        
                        if (!villageStats[villageName]) {
                            villageStats[villageName] = { count: 0, lastEntry: item.created_at };
                        }
                        villageStats[villageName].count++;
                        if (new Date(item.created_at) > new Date(villageStats[villageName].lastEntry)) {
                            villageStats[villageName].lastEntry = item.created_at;
                        }
                    });
                }
                
                // Populate statistics
                const statsContainer = document.getElementById('districtStats');
                statsContainer.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">\${totalEntries}</div>
                        <div class="stat-label hindi">कुल एंट्री</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">\${uniqueVillages}</div>
                        <div class="stat-label hindi">कवर गांव</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">\${uniqueUsers}</div>
                        <div class="stat-label hindi">सक्रिय उपयोगकर्ता</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">\${uniqueVillages > 0 ? Math.round(totalEntries / uniqueVillages) : 0}</div>
                        <div class="stat-label hindi">औसत एंट्री प्रति गांव</div>
                    </div>
                `;
                
                // Populate user stats table
                const userStatsTable = document.getElementById('userStatsTable');
                userStatsTable.innerHTML = '';
                
                Object.entries(userStats)
                    .sort(([,a], [,b]) => b.count - a.count)
                    .slice(0, 10)
                    .forEach(([userName, stats]) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="hindi">\${userName}</td>
                            <td>\${stats.count}</td>
                            <td>\${new Date(stats.lastEntry).toLocaleDateString('hi-IN')}</td>
                        `;
                        userStatsTable.appendChild(row);
                    });
                
                // Populate village stats table
                const villageStatsTable = document.getElementById('villageStatsTable');
                villageStatsTable.innerHTML = '';
                
                Object.entries(villageStats)
                    .sort(([,a], [,b]) => b.count - a.count)
                    .slice(0, 10)
                    .forEach(([villageName, stats]) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="hindi">\${villageName}</td>
                            <td>\${stats.count}</td>
                            <td>\${new Date(stats.lastEntry).toLocaleDateString('hi-IN')}</td>
                        `;
                        villageStatsTable.appendChild(row);
                    });
                
                hideLoading();
                showAlert('जिला रिपोर्ट तैयार हो गई।', 'success');
                
            } catch (error) {
                console.error('Error generating district report:', error);
                hideLoading();
                showAlert('जिला रिपोर्ट बनाने में त्रुटि: ' + error.message, 'danger');
            }
        }

        // Generate District Report (triggered by dropdown changes)
        function generateDistrictReport() {
            const selectedDistrict = document.getElementById('reportDistrict').value;
            const selectedDays = document.getElementById('reportDateRange').value;
            
            if (selectedDistrict) {
                generateDistrictReportData(selectedDistrict, selectedDays);
            } else {
                showAlert('कृपया पहले जिला चुनें।', 'warning');
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded');
            
            // Check authentication and setup UI
            checkAuthentication();
            
            // Data Entry Event Listeners
            document.getElementById('level4Select').addEventListener('change', handleLevel4Change);
            document.getElementById('level5Select').addEventListener('change', handleLevel5Change);
            document.getElementById('selectAllBtn').addEventListener('click', selectAllVillages);
            document.getElementById('deselectAllBtn').addEventListener('click', deselectAllVillages);
            document.getElementById('saveDataBtn').addEventListener('click', saveKhasraData);
            document.getElementById('resetFormBtn').addEventListener('click', resetForm);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // User District Entry Button
            document.getElementById('districtEntryBtn').addEventListener('click', showUserDistrictData);
            
            // Admin Report Buttons (only if elements exist)
            const villageCoverageBtn = document.getElementById('villageCoverageBtn');
            const dataExportBtn = document.getElementById('dataExportBtn');
            const districtReportBtn = document.getElementById('districtReportBtn');
            
            if (villageCoverageBtn) {
                villageCoverageBtn.addEventListener('click', showVillageCoverageReport);
            }
            if (dataExportBtn) {
                dataExportBtn.addEventListener('click', showDataExportModal);
            }
            if (districtReportBtn) {
                districtReportBtn.addEventListener('click', showDistrictReportModal);
            }
            
            // District report change handlers
            const reportDistrictSelect = document.getElementById('reportDistrict');
            const reportDateRangeSelect = document.getElementById('reportDateRange');
            
            if (reportDistrictSelect) {
                reportDistrictSelect.addEventListener('change', function() {
                    const selectedDistrict = this.value;
                    const selectedDays = reportDateRangeSelect.value;
                    if (selectedDistrict) {
                        generateDistrictReportData(selectedDistrict, selectedDays);
                    }
                });
            }
            
            if (reportDateRangeSelect) {
                reportDateRangeSelect.addEventListener('change', function() {
                    const selectedDistrict = reportDistrictSelect.value;
                    const selectedDays = this.value;
                    if (selectedDistrict) {
                        generateDistrictReportData(selectedDistrict, selectedDays);
                    }
                });
            }
            
            // Search functionality for user data
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchUserData();
                }
            });
            
            document.getElementById('filterVillage').addEventListener('change', searchUserData);
            
            console.log('All event listeners attached');
        });

        // Handle page unload
        window.addEventListener('beforeunload', function(e) {
            const khasraData = collectKhasraData();
            if (khasraData.length > 0) {
                e.preventDefault();
                e.returnValue = 'आपका डेटा सेव नहीं हुआ है। क्या आप वाकई पेज छोड़ना चाहते हैं?';
            }
        });

        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl + S to save
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                const saveBtn = document.getElementById('saveDataBtn');
                if (saveBtn && saveBtn.style.display !== 'none' && !saveBtn.disabled) {
                    saveKhasraData();
                }
            }
            
            // Ctrl + R to reset
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                resetForm();
            }
            
            // Escape to deselect all
            if (e.key === 'Escape') {
                deselectAllVillages();
            }
            
            // Ctrl + D for district entry (users only)
            if (e.ctrlKey && e.key === 'd' && currentUser && currentUser.role !== 'admin') {
                e.preventDefault();
                showUserDistrictData();
            }
        });

        // Add error boundary
        window.addEventListener('error', function(e) {
            console.error('Unhandled error:', e.error);
            hideLoading();
            showAlert('एक तकनीकी त्रुटि हुई है। कृपया पेज को रिफ्रेश करें।', 'danger');
        });

        // Add promise rejection handler
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
            hideLoading();
            showAlert('डेटा लोड करने में समस्या हुई है। कृपया पुनः प्रयास करें।', 'warning');
        });

        // Network status monitoring
        window.addEventListener('online', function() {
            showAlert('इंटरनेट कनेक्शन बहाल हो गया।', 'success');
        });

        window.addEventListener('offline', function() {
            showAlert('इंटरनेट कनेक्शन नहीं है। कृपया कनेक्शन जांचें।', 'warning');
        });

        // Console welcome message
        console.log(`
        ╔══════════════════════════════════════════════════════════════╗
        ║                     खसरा डेटा एंट्री सिस्टम                  ║
        ║                    Khasra Data Entry System                  ║
        ║                                                              ║
        ║  🌾 Village Hierarchy Integration Active                    ║
        ║  📊 Multi-Village Khasra Entry Enabled                      ║
        ║  🔒 User Authentication & Authorization                      ║
        ║  👥 Role-Based Access Control                               ║
        ║  💾 Auto-Save & Validation Features                         ║
        ║  📈 Advanced Reporting System (Admin)                       ║
        ║  📋 Personal Data View (Users)                              ║
        ║                                                              ║
        ║  Admin Features:                                            ║
        ║  • Village Coverage Analysis                                ║
        ║  • Data Export (CSV/Excel)                                  ║
        ║  • District-wise Reports                                    ║
        ║                                                              ║
        ║  User Features:                                             ║
        ║  • Personal Data Entry View                                 ║
        ║  • Search & Filter Own Data                                 ║
        ║  • Pagination Support                                       ║
        ║                                                              ║
        ║  Keyboard Shortcuts:                                        ║
        ║  • Ctrl + S: Save Data                                      ║
        ║  • Ctrl + R: Reset Form                                     ║
        ║  • Ctrl + D: District Entry (Users)                        ║
        ║  • Escape: Deselect All Villages                            ║
        ║                                                              ║
        ║  For technical support: diagri-cg@cg.gov.in                ║
        ╚══════════════════════════════════════════════════════════════╝
        `);

        // Development helpers (remove in production)
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            window.debugHelpers = {
                getCurrentUser: () => currentUser,
                getVillageData: () => villageHierarchyData,
                getSelectedVillages: () => selectedVillages,
                getUserKhasraData: () => userKhasraData,
                collectKhasraData: collectKhasraData,
                resetForm: resetForm,
                showUserData: showUserDistrictData,
                testSave: () => {
                    console.log('Test data:', collectKhasraData());
                },
                // Admin functions
                showCoverageReport: showVillageCoverageReport,
                showExportModal: showDataExportModal,
                showDistrictReport: showDistrictReportModal,
                // User functions
                searchData: searchUserData,
                changePage: changePage
            };
            console.log('🛠️ Debug helpers available in window.debugHelpers');
            console.log('Available commands:');
            console.log('- debugHelpers.getCurrentUser()');
            console.log('- debugHelpers.showUserData()');
            console.log('- debugHelpers.searchData()');
            if (currentUser && currentUser.role === 'admin') {
                console.log('- debugHelpers.showCoverageReport()');
                console.log('- debugHelpers.showExportModal()');
                console.log('- debugHelpers.showDistrictReport()');
            }
        }

        // Performance monitoring
        function logPerformance() {
            if (window.performance && window.performance.timing) {
                const timing = window.performance.timing;
                const loadTime = timing.loadEventEnd - timing.navigationStart;
                console.log('Page load time: ' + loadTime + 'ms');
            }
        }

        // Log performance on load
        window.addEventListener('load', logPerformance);

        // Memory usage monitoring (for large datasets)
        function checkMemoryUsage() {
            if (window.performance && window.performance.memory) {
                const memory = window.performance.memory;
                const usedMB = Math.round(memory.usedJSHeapSize / 1048576);
                const totalMB = Math.round(memory.totalJSHeapSize / 1048576);
                console.log('Memory usage: ' + usedMB + 'MB / ' + totalMB + 'MB');
                
                // Warning if memory usage is high
                if (usedMB > 100) {
                    console.warn('High memory usage detected. Consider optimizing data handling.');
                }
            }
        }

        // Check memory usage every 5 minutes
        setInterval(checkMemoryUsage, 5 * 60 * 1000);

        // Auto-save draft functionality (optional)
        let autoSaveTimeout;
        function autoSaveDraft() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                const draftData = collectKhasraData();
                if (draftData.length > 0) {
                    localStorage.setItem('khasra_draft_' + currentUser.id, JSON.stringify(draftData));
                    console.log('Draft auto-saved');
                }
            }, 30000); // Auto-save after 30 seconds of inactivity
        }

        // Load draft on page load
        function loadDraft() {
            const draftKey = 'khasra_draft_' + currentUser.id;
            const draft = localStorage.getItem(draftKey);
            if (draft) {
                try {
                    const draftData = JSON.parse(draft);
                    if (draftData.length > 0) {
                        const loadDraft = confirm('आपका एक अधूरा डेटा एंट्री मिला है। क्या आप इसे लोड करना चाहते हैं?');
                        if (loadDraft) {
                            // Logic to restore draft data would go here
                            console.log('Draft data:', draftData);
                        } else {
                            localStorage.removeItem(draftKey);
                        }
                    }
                } catch (error) {
                    console.error('Error loading draft:', error);
                    localStorage.removeItem(draftKey);
                }
            }
        }

        // Clear draft after successful save
        function clearDraft() {
            const draftKey = 'khasra_draft_' + currentUser.id;
            localStorage.removeItem(draftKey);
        }

        // Add input listeners for auto-save
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('khasra-input')) {
                autoSaveDraft();
            }
        });
    </script>
</body>
</html>

