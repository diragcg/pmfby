<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feedback Form - ‡§∏‡§Ç‡§ö‡§æ‡§≤‡§®‡§æ‡§≤‡§Ø ‡§ï‡•É‡§∑‡§ø ‡§õ‡§§‡•ç‡§§‡•Ä‡§∏‡§ó‡§¢‡§º</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Noto+Sans+Devanagari:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-green: #1B5E20;
            --secondary-green: #2E7D32;
            --accent-green: #4CAF50;
            --light-green: #E8F5E8;
            --light-orange: #FFF3E0;
            --sky-blue: #87CEEB;
            --highlight-blue: #007BFF;
            --text-primary: #1A1A1A;
            --text-secondary: #666666;
            --text-muted: #999999;
            --white: #FFFFFF;
            --gray-50: #FAFAFA;
            --gray-100: #F5F5F5;
            --gray-200: #EEEEEE;
            --gray-300: #E0E0E0;
            --border-light: #E5E5E5;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--gray-50) 0%, var(--white) 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .hindi {
            font-family: 'Noto Sans Devanagari', 'Poppins', sans-serif;
            font-weight: 500;
        }

        /* Header Styles */
        .header {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%);
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 3px solid var(--accent-green);
        }

        .navbar {
            padding: 1rem 0;
            min-height: 70px;
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.4rem;
            color: var(--white);
            text-decoration: none;
            display: flex;
            align-items: center;
            transition: var(--transition);
            font-family: 'Poppins', sans-serif;
        }

        .navbar-brand:hover {
            color: var(--white);
            transform: translateX(2px);
        }

        .navbar-brand img {
            height: 40px;
            margin-right: 12px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
            font-family: 'Poppins', sans-serif;
            background-color: yellow;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
        }

        .logout-btn {
            background-color: black !important;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--white);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            font-weight: 500;
            transition: var(--transition);
            backdrop-filter: blur(10px);
            font-family: 'Poppins', sans-serif;
        }

        .logout-btn:hover {
            background-color: #333333 !important;
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        /* Main Container */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1rem;
            min-height: calc(100vh - 120px);
        }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 2rem;
            align-items: start;
        }

        /* Form Card */
        .form-card {
            background: var(--white);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }

        .form-header {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%);
            color: var(--white);
            padding: 1.5rem 2rem;
            text-align: center;
        }

        .form-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            font-family: 'Poppins', sans-serif;
        }

        .form-subtitle {
            font-size: 1rem;
            opacity: 0.9;
            font-family: 'Poppins', sans-serif;
        }

        .form-body {
            padding: 2rem;
        }

        /* Template Sections */
        .template-section {
            margin-bottom: 3rem;
            border: 2px solid #000;
            background: var(--white);
        }

        .template-header {
            background: #f8f9fa;
            border-bottom: 2px solid #000;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 1.2rem;
            font-family: 'Poppins', sans-serif;
        }

        .template-content {
            padding: 20px;
        }

        /* Form Fields with Light Orange Background */
        .field-group {
            margin-bottom: 25px;
        }

        .field-label {
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 8px;
            display: block;
            color: #000;
            font-family: 'Poppins', sans-serif;
        }

        .field-description {
            font-style: italic;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
            font-family: 'Poppins', sans-serif;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #000;
            background: var(--light-orange) !important;
            font-size: 1rem;
            font-family: 'Poppins', sans-serif;
            transition: var(--transition);
            text-transform: none;
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
            text-align: justify;
            line-height: 1.5;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        /* Two Column Layout for Template 1 */
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        /* Officer Details Section */
        .officer-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        /* Submit Button */
        .submit-container {
            margin-top: 3rem;
            text-align: center;
            padding: 2rem;
            border-top: 2px solid var(--border-light);
        }

        .submit-btn {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%);
            border: none;
            color: var(--white);
            padding: 1rem 2.5rem;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 1.1rem;
            min-width: 200px;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
            margin: 0 10px;
            font-family: 'Poppins', sans-serif;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Admin Panel with Sky Blue Background */
        .admin-panel {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-light);
            height: fit-content;
            position: sticky;
            top: 90px;
        }

        .admin-header {
            background-color: var(--sky-blue);
            color: var(--text-primary);
            padding: 1.25rem 1.5rem;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        }

        .admin-header h3 {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            font-family: 'Poppins', sans-serif;
        }

        .admin-body {
            padding: 1.5rem;
        }

        .stats-card {
            background: var(--light-green);
            border: 1px solid var(--accent-green);
            border-radius: var(--radius-sm);
            padding: 1rem;
            margin-bottom: 1rem;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stats-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stats-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-green);
            font-family: 'Poppins', sans-serif;
        }

        .stats-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
            font-family: 'Poppins', sans-serif;
        }

        .admin-btn {
            background: linear-gradient(135deg, #455A64 0%, #546E7A 100%);
            border: none;
            color: var(--white);
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-sm);
            font-weight: 500;
            font-size: 0.9rem;
            width: 100%;
            transition: var(--transition);
            margin-bottom: 0.5rem;
            font-family: 'Poppins', sans-serif;
        }

        .admin-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .date-filter {
            margin-bottom: 1rem;
        }

        .form-input-admin {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-light);
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            transition: var(--transition);
            background: var(--white);
            font-family: 'Poppins', sans-serif;
        }

        .form-input-admin:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .form-label-admin {
            display: block;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            font-family: 'Poppins', sans-serif;
        }

        /* Alert Styles */
        .alert {
            padding: 1rem;
            border-radius: var(--radius-md);
            margin-bottom: 1.5rem;
            border: none;
            font-weight: 500;
            font-family: 'Poppins', sans-serif;
        }

        .alert-danger {
            background: #FFEBEE;
            color: #C62828;
            border-left: 4px solid #F44336;
        }

        .alert-success {
            background: #E8F5E8;
            color: #2E7D32;
            border-left: 4px solid #4CAF50;
        }

        .alert-info {
            background: #E3F2FD;
            color: #1565C0;
            border-left: 4px solid #2196F3;
        }

        .alert-warning {
            background: #FFF3CD;
            color: #856404;
            border-left: 4px solid #FFC107;
        }

        /* Loading State */
        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 3rem;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-light);
            border-radius: 50%;
            border-top-color: var(--primary-green);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Character Counter */
        .character-counter {
            font-size: 0.8rem;
            color: #666;
            text-align: right;
            margin-top: 5px;
            font-family: 'Poppins', sans-serif;
        }

        /* Footer Styles */
        .footer {
            background: var(--gray-100);
            border-top: 1px solid var(--border-light);
            padding: 1.5rem 0;
            text-align: center;
            margin-top: 2rem;
            font-family: 'Poppins', sans-serif;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .footer-text {
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .footer-datetime {
            color: var(--highlight-blue);
            font-weight: 600;
            background: rgba(0, 123, 255, 0.1);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-sm);
            display: inline-block;
            font-size: 0.9rem;
        }

        /* Auto-resize textareas */
        .form-textarea {
            overflow: hidden;
        }

        /* Submit Success Animation */
        .submit-success-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
            color: white;
            font-size: 1.5rem;
            font-family: 'Poppins', sans-serif;
        }

        .submit-success-overlay .spinner-grow {
            width: 3rem;
            height: 3rem;
            margin-bottom: 1rem;
        }

        /* Print Styles for PDF Generation */
        @media print {
            body {
                background: white !important;
                font-family: 'Times New Roman', serif;
                font-size: 12px;
                line-height: 1.4;
            }
            
            .header, .admin-panel, .submit-container, .footer, .submit-success-overlay {
                display: none !important;
            }
            
            .main-container {
                max-width: none;
                margin: 0;
                padding: 20px;
            }
            
            .content-grid {
                grid-template-columns: 1fr;
            }
            
            .form-card {
                box-shadow: none;
                border: 2px solid #000;
            }
            
            .template-section {
                page-break-inside: avoid;
                margin-bottom: 20px;
            }
            
            .form-input, .form-textarea, .form-select {
                background: white !important;
            }
            
            .two-column {
                display: block;
            }
            
            .two-column .field-group {
                margin-bottom: 15px;
            }
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .content-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            .admin-panel {
                position: static;
            }
            
            .two-column {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 1rem;
            }
            
            .form-body {
                padding: 1.5rem;
            }
            
            .navbar-brand {
                font-size: 1.2rem;
            }
            
            .navbar-brand img {
                height: 32px;
            }
            
            .user-info {
                flex-direction: column;
                gap: 0.5rem;
                align-items: flex-end;
            }

            .officer-details {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .submit-btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="container-fluid">
            <nav class="navbar">
                <div class="container-fluid px-3">
                    <a class="navbar-brand" href="selectmodule.html">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/8/87/Coat_of_arms_of_Chhattisgarh.svg" alt="‡§õ‡§§‡•ç‡§§‡•Ä‡§∏‡§ó‡§¢‡§º ‡§∏‡§∞‡§ï‡§æ‡§∞" class="cg-logo">
                        <span class="hindi">‡§∏‡§Ç‡§ö‡§æ‡§≤‡§®‡§æ‡§≤‡§Ø ‡§ï‡•É‡§∑‡§ø ‡§õ‡§§‡•ç‡§§‡•Ä‡§∏‡§ó‡§¢‡§º</span>
                    </a>
                    <div class="user-info" id="userInfoContainer">
                        <span id="userInfo" class="hindi"></span>
                        <button id="btnLogout" class="btn logout-btn hindi">
                            <i class="fas fa-sign-out-alt me-1"></i>
                            ‡§≤‡•â‡§ó‡§Ü‡§â‡§ü
                        </button>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <main class="main-container">
        <!-- Loading State -->
        <div id="loadingState" class="loading-container">
            <div class="spinner"></div>
        </div>

        <!-- Main Content -->
        <div id="mainContent" style="display: none;">
            <div class="content-grid">
                <!-- Feedback Form -->
                <div class="form-card">
                    <div class="form-header">
                        <div class="form-title">National Summit Feedback Form</div>
                        <div class="form-subtitle">Template 1 & Template 2</div>
                    </div>
                    
                    <div class="form-body">
                        <div id="alertBox" class="alert alert-danger" style="display: none;"></div>
                        
                        <form id="feedbackForm">
                            <!-- Template 1: State Specific Note & Background Note -->
                            <div class="template-section">
                                <div class="template-header">
                                    Template 1: State Specific Note & Background Note
                                </div>
                                <div class="template-content">
                                    <div class="two-column">
                                        <!-- Left Column -->
                                        <div>
                                            <div class="field-group">
                                                <label class="field-label">I. Introduction</label>
                                                <div class="field-description">(Why is this topic important for the States/UTs? Highlight the data evidence to support the same)</div>
                                                <textarea class="form-textarea" id="introduction" rows="4" required placeholder="Enter introduction details..."></textarea>
                                            </div>

                                            <div class="field-group">
                                                <label class="field-label">II. Current Situation</label>
                                                <div class="field-description">(Current policy landscape, programmes, schemes and their progress)</div>
                                                <textarea class="form-textarea" id="currentSituation" rows="4" required placeholder="Describe current situation..."></textarea>
                                            </div>

                                            <div class="field-group">
                                                <label class="field-label">III. Challenges</label>
                                                <div class="field-description">(Major policy, programmatic and capacity building gaps affecting the working of the States/UTs Administration)</div>
                                                <textarea class="form-textarea" id="challenges" rows="4" required placeholder="List major challenges..."></textarea>
                                            </div>

                                            <div class="field-group">
                                                <label class="field-label">IV. Possible Solutions</label>
                                                <div class="field-description">(Proposed ideas, actions that can be undertaken by different stakeholders. Scope for convergence with other schemes/programmes)</div>
                                                <textarea class="form-textarea" id="possibleSolutions" rows="4" required placeholder="Suggest possible solutions..."></textarea>
                                            </div>
                                        </div>

                                        <!-- Right Column -->
                                        <div>
                                            <div class="field-group">
                                                <label class="field-label">V. Best Practices</label>
                                                <div class="field-description">(International (if any), Major Initiatives undertaken by States/UTs Administration. May also include initiatives for training and capacity-building that have been taken for effective implementation. Strategic communication campaigns undertaken to disseminate the programme, convergence, new technologies used for effective implementation)</div>
                                                <textarea class="form-textarea" id="bestPractices" rows="4" required placeholder="Describe best practices..."></textarea>
                                            </div>

                                            <div class="field-group">
                                                <label class="field-label">VI. Priority Areas</label>
                                                <div class="field-description">(Selected for implementation by the States in the next 5 years)</div>
                                                <textarea class="form-textarea" id="priorityAreas" rows="4" required placeholder="Define priority areas..."></textarea>
                                            </div>

                                            <div class="field-group">
                                                <label class="field-label">VII. Way Forward - Strategy for Implementation</label>
                                                <div class="field-description">(Modality for implementation - Legal, Administrative, Technological, Budgetary reforms required for implementation)</div>
                                                <textarea class="form-textarea" id="wayForwardStrategy" rows="4" required placeholder="Outline implementation strategy..."></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Template 2: Feedback Note by Officers -->
                            <div class="template-section">
                                <div class="template-header">
                                    Template 2: Feedback Note by Officers
                                </div>
                                <div class="template-content">
                                    <!-- Section 1: Officer Name and Details -->
                                    <div class="field-group">
                                        <label class="field-label">Feedback Note (by all IAS officers / State Department Officers)</label>
                                    </div>

                                    <div class="field-group">
                                        <label class="field-label">Section 1: Officer Name and Details:</label>
                                        <div class="officer-details">
                                            <div>
                                                <label class="field-label">‚Ä¢ Name:</label>
                                                <input type="text" class="form-input" id="officerName" required placeholder="Enter officer name">
                                            </div>
                                            <div>
                                                <label class="field-label">‚Ä¢ Designation:</label>
                                                <input type="text" class="form-input" id="designation" required placeholder="Enter designation">
                                            </div>
                                            <div>
                                                <label class="field-label">‚Ä¢ Batch:</label>
                                                <input type="text" class="form-input" id="batch" required placeholder="Enter batch year">
                                            </div>
                                            <div>
                                                <label class="field-label">‚Ä¢ Current Posting:</label>
                                                <input type="text" class="form-input" id="currentPosting" required placeholder="Enter current posting">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Section 2: Feedback for Summit -->
                                    <div class="field-group">
                                        <label class="field-label">Section 2: Feedback for Summit on &lt;Theme name&gt;</label>
                                    </div>

                                    <div class="field-group">
                                        <label class="field-label">1. Name of the sub theme</label>
                                        <div class="field-description">(Choose from the sub theme of the summit)</div>
                                        <textarea class="form-textarea" id="subThemeName" rows="3" required placeholder="Enter sub theme name..."></textarea>
                                    </div>

                                    <div class="field-group">
                                        <label class="field-label">2. Policy Gaps and Challenges</label>
                                        <div class="field-description">(Current policy challenges, administrative and implementing challenges with respect to the sub theme selected)</div>
                                        <textarea class="form-textarea" id="policyGapsChallenges" rows="4" required placeholder="Describe policy gaps and challenges..."></textarea>
                                    </div>

                                    <div class="field-group">
                                        <label class="field-label">3. Potential Solutions</label>
                                        <div class="field-description">(Can potentially highlight new technology solutions, scope for convergence with other schemes/programmes etc.)</div>
                                        <textarea class="form-textarea" id="potentialSolutions" rows="4" required placeholder="Suggest potential solutions..."></textarea>
                                    </div>

                                    <div class="field-group">
                                        <label class="field-label">4. Best Practices</label>
                                        <div class="field-description">(Highlight the practices, which are sustainable, replicable, scalable, monitorable etc. Can also highlight the block/district/State level practices)</div>
                                        <textarea class="form-textarea" id="feedbackBestPractices" rows="4" required placeholder="Describe best practices..."></textarea>
                                    </div>
                                </div>
                            </div>

                            <div class="submit-container">
                                <button type="submit" class="btn submit-btn">
                                    <i class="fas fa-paper-plane me-2"></i>
                                    Submit Feedback
                                </button>
                                <button type="button" class="btn submit-btn" id="previewBtn" style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);">
                                    <i class="fas fa-eye me-2"></i>
                                    Preview PDF
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Admin Panel -->
                <div id="adminPanel" class="admin-panel" style="display: none;">
                    <div class="admin-header">
                        <h3 class="hindi">‡§´‡•Ä‡§°‡§¨‡•à‡§ï ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§®</h3>
                        <p class="hindi mb-0">‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§î‡§∞ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°</p>
                    </div>
                    <div class="admin-body">
                        <div class="stats-card" id="totalFeedbacksCard">
                            <div class="stats-number" id="totalFeedbacks">0</div>
                            <div class="stats-label hindi">‡§ï‡•Å‡§≤ ‡§´‡•Ä‡§°‡§¨‡•à‡§ï</div>
                        </div>

                        <div class="stats-card" id="todayFeedbacksCard">
                            <div class="stats-number" id="todayFeedbacks">0</div>
                            <div class="stats-label hindi">‡§Ü‡§ú ‡§ï‡•á ‡§´‡•Ä‡§°‡§¨‡•à‡§ï</div>
                        </div>

                        <div class="date-filter">
                            <label for="startDate" class="form-label-admin hindi">‡§™‡•ç‡§∞‡§æ‡§∞‡§Ç‡§≠ ‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï</label>
                            <input type="date" class="form-input-admin" id="startDate">
                        </div>

                        <div class="date-filter">
                            <label for="endDate" class="form-label-admin hindi">‡§Ö‡§Ç‡§§ ‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï</label>
                            <input type="date" class="form-input-admin" id="endDate">
                        </div>

                        <button class="admin-btn" id="downloadSinglePDF">
                            <i class="fas fa-file-pdf me-2"></i>
                            <span class="hindi">‡§è‡§ï‡§≤ PDF ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°</span>
                        </button>

                        <button class="admin-btn" id="downloadBulkPDF">
                            <i class="fas fa-file-archive me-2"></i>
                            <span class="hindi">‡§¨‡§≤‡•ç‡§ï PDF ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°</span>
                        </button>

                        <button class="admin-btn" id="viewAllFeedbacks">
                            <i class="fas fa-list me-2"></i>
                            <span class="hindi">‡§∏‡§≠‡•Ä ‡§´‡•Ä‡§°‡§¨‡•à‡§ï ‡§¶‡•á‡§ñ‡•á‡§Ç</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-text hindi">
                2025 ‡§∏‡§Ç‡§ö‡§æ‡§≤‡§®‡§æ‡§≤‡§Ø ‡§ï‡•É‡§∑‡§ø ‡§õ‡§§‡•ç‡§§‡•Ä‡§∏‡§ó‡§¢‡§º | ‡§∏‡§∞‡•ç‡§µ‡§æ‡§ß‡§ø‡§ï‡§æ‡§∞ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§
            </div>
            <div class="footer-datetime" id="footerDateTime">
                <!-- Date and time will be inserted here -->
            </div>
        </div>
    </footer>

    <!-- Feedback List Modal -->
    <div class="modal fade" id="feedbackListModal" tabindex="-1" aria-labelledby="feedbackListModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%); color: white;">
                    <h5 class="modal-title hindi" id="feedbackListModalLabel">‡§´‡•Ä‡§°‡§¨‡•à‡§ï ‡§∏‡•Ç‡§ö‡•Ä</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Officer Name</th>
                                    <th>Designation</th>
                                    <th>Batch</th>
                                    <th>Current Posting</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="feedbackTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary hindi" data-bs-dismiss="modal">‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Submit Success Overlay -->
    <div class="submit-success-overlay" id="submitSuccessOverlay" style="display: none;">
        <div class="spinner-grow text-success" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="hindi">‡§´‡•Ä‡§°‡§¨‡•à‡§ï ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ!</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <script>
        // Supabase configuration
        const supabaseUrl = 'https://txjbfqrbbtvzlxpeegkv.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4amJmcXJiYnR2emx4cGVlZ2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMTU2NTQsImV4cCI6MjA2ODY5MTY1NH0.sE5UbwEOSnd9ED-k_Ix5OfdZbf7dmwlHZSjQQrEAyCo';
        
        let supabaseClient = null;
        let currentUser = null;

        // Helper function to safely get form values and prevent undefined
        function getFormValue(elementId) {
            const element = document.getElementById(elementId);
            return element ? (element.value || '').trim() : '';
        }

        // Helper function to safely get data from object (handles both camelCase and snake_case)
        function safeGetValue(data, camelCase, snake_case) {
            if (!data) return '';
            return data[camelCase] || data[snake_case] || '';
        }

        // Map database data to form data format
        function mapDatabaseToFormData(dbData) {
            if (!dbData) return {};
            
            return {
                // Template 1 fields - map database snake_case to camelCase
                introduction: safeGetValue(dbData, 'introduction', 'introduction'),
                currentSituation: safeGetValue(dbData, 'currentSituation', 'current_situation'),
                challenges: safeGetValue(dbData, 'challenges', 'challenges'),
                possibleSolutions: safeGetValue(dbData, 'possibleSolutions', 'possible_solutions'),
                bestPractices: safeGetValue(dbData, 'bestPractices', 'best_practices'),
                priorityAreas: safeGetValue(dbData, 'priorityAreas', 'priority_areas'),
                wayForwardStrategy: safeGetValue(dbData, 'wayForwardStrategy', 'way_forward_strategy'),
                
                // Template 2 fields - map database snake_case to camelCase
                officerName: safeGetValue(dbData, 'officerName', 'officer_name'),
                designation: safeGetValue(dbData, 'designation', 'designation'),
                batch: safeGetValue(dbData, 'batch', 'batch'),
                currentPosting: safeGetValue(dbData, 'currentPosting', 'current_posting'),
                subThemeName: safeGetValue(dbData, 'subThemeName', 'sub_theme_name'),
                policyGapsChallenges: safeGetValue(dbData, 'policyGapsChallenges', 'policy_gaps_challenges'),
                potentialSolutions: safeGetValue(dbData, 'potentialSolutions', 'potential_solutions'),
                feedbackBestPractices: safeGetValue(dbData, 'feedbackBestPractices', 'feedback_best_practices')
            };
        }

        // Initialize Supabase
        function initializeSupabase() {
            try {
                if (typeof supabase !== 'undefined' && supabase.createClient) {
                    const { createClient } = supabase;
                    supabaseClient = createClient(supabaseUrl, supabaseKey);
                    console.log('‚úì Supabase client initialized successfully');
                    return true;
                } else {
                    console.error('‚úó Supabase library not loaded');
                    return false;
                }
            } catch (error) {
                console.error('‚úó Failed to initialize Supabase:', error);
                return false;
            }
        }

        // Update Footer Date and Time
        function updateFooterDateTime() {
            const now = new Date();
            const options = {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            };
            const dateTimeString = now.toLocaleString('en-US', options);
            document.getElementById('footerDateTime').textContent = dateTimeString;
        }

        // Utility Functions
        function showAlert(message, type, elementId = 'alertBox') {
            console.log(`Alert: ${type} - ${message}`);
            const alertBox = document.getElementById(elementId);
            if (!alertBox) {
                console.error('Alert box not found:', elementId);
                return;
            }
            
            alertBox.textContent = message;
            alertBox.className = `alert alert-${type}`;
            alertBox.style.display = 'block';
            
            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 5000);
        }

        function hideLoading() {
            console.log('Hiding loading state');
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }

        function showLoading() {
            console.log('Showing loading state');
            document.getElementById('loadingState').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';
        }

        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('user');
                sessionStorage.removeItem('user');
                window.location.href = 'login.html';
            }
        }

        // Initialize Page
        async function initializePage() {
            console.log('üöÄ Initializing feedback form page...');
            
            try {
                // Initialize Supabase first
                if (!initializeSupabase()) {
                    throw new Error('Supabase initialization failed');
                }

                // Get stored user
                const storedUser = localStorage.getItem('user') || sessionStorage.getItem('user');
                console.log('üì¶ Stored user data:', storedUser ? 'Found' : 'Not found');
                
                if (!storedUser) {
                    showAlert('Session expired. Please login again.', 'danger');
                    setTimeout(() => window.location.href = 'login.html', 2000);
                    return;
                }

                // Parse user data
                currentUser = JSON.parse(storedUser);
                currentUser.role = currentUser.role?.trim();
                console.log('üë§ Current user:', currentUser);
                
                // Update UI with user info
                const userInfoSpan = document.getElementById('userInfo');
                if (userInfoSpan) {
                    userInfoSpan.textContent = `${currentUser.fullName || currentUser.username} (${currentUser.districtName || 'N/A'})`;
                }
                
                console.log('‚úì User info updated');
                
                // Show admin panel if user is admin
                if (currentUser.role === 'admin' || currentUser.role === 'state_admin') {
                    document.getElementById('adminPanel').style.display = 'block';
                    console.log('‚úì Admin panel enabled');
                    await loadFeedbackStats();
                }
                
                // Update footer date time
                updateFooterDateTime();
                setInterval(updateFooterDateTime, 1000); // Update every second
                
                // Hide loading and show content
                hideLoading();
                
            } catch (error) {
                console.error('‚úó Error initializing page:', error);
                hideLoading();
                showAlert('Error loading page. Please login again.', 'danger');
                setTimeout(() => window.location.href = 'login.html', 2000);
            }
        }

        // Load Feedback Statistics
        async function loadFeedbackStats() {
            try {
                // Get total feedbacks
                const { data: totalData, error: totalError, count: totalCount } = await supabaseClient
                    .from('feedbacks')
                    .select('id', { count: 'exact' });

                if (totalError) throw totalError;

                // Get today's feedbacks
                const today = new Date().toISOString().split('T')[0];
                const { data: todayData, error: todayError, count: todayCount } = await supabaseClient
                    .from('feedbacks')
                    .select('id', { count: 'exact' })
                    .gte('created_at', today + 'T00:00:00.000Z')
                    .lt('created_at', today + 'T23:59:59.999Z');

                if (todayError) throw todayError;

                document.getElementById('totalFeedbacks').textContent = totalCount || 0;
                document.getElementById('todayFeedbacks').textContent = todayCount || 0;

            } catch (error) {
                console.error('Error loading feedback stats:', error);
                document.getElementById('totalFeedbacks').textContent = '0';
                document.getElementById('todayFeedbacks').textContent = '0';
            }
        }

        // Show Submit Success Animation
        function showSubmitSuccess() {
            const overlay = document.getElementById('submitSuccessOverlay');
            overlay.style.display = 'flex';
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 2000); // Hide after 2 seconds
        }

        // Submit Feedback Form
        async function submitFeedback(formData) {
            try {
                const { data, error } = await supabaseClient
                    .from('feedbacks')
                    .insert([{
                        user_id: currentUser.id,
                        // Template 1 fields
                        introduction: formData.introduction,
                        current_situation: formData.currentSituation,
                        challenges: formData.challenges,
                        possible_solutions: formData.possibleSolutions,
                        best_practices: formData.bestPractices,
                        priority_areas: formData.priorityAreas,
                        way_forward_strategy: formData.wayForwardStrategy,
                        // Template 2 fields
                        officer_name: formData.officerName,
                        designation: formData.designation,
                        batch: formData.batch,
                        current_posting: formData.currentPosting,
                        sub_theme_name: formData.subThemeName,
                        policy_gaps_challenges: formData.policyGapsChallenges,
                        potential_solutions: formData.potentialSolutions,
                        feedback_best_practices: formData.feedbackBestPractices,
                        created_at: new Date().toISOString()
                    }])
                    .select();

                if (error) throw error;

                console.log('‚úÖ Feedback submitted successfully:', data);
                showSubmitSuccess(); // Show success animation
                
                // Reset form
                document.getElementById('feedbackForm').reset();
                
                // Clear draft after successful submission
                clearFormDraft();
                
                // Reload stats if admin
                if (currentUser.role === 'admin' || currentUser.role === 'state_admin') {
                    await loadFeedbackStats();
                }

                return data[0];

            } catch (error) {
                console.error('‚ùå Error submitting feedback:', error);
                throw error;
            }
        }

        // UPDATED PDF Generation Function with proper data handling
        async function generatePDF(feedbackData, isPreview = false) {
            try {
                console.log('PDF Data received:', feedbackData);
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                // PDF margins
                const margin = 12;
                const pageWidth = 210;
                const pageHeight = 297;
                const contentWidth = pageWidth - (2 * margin);
                let yPosition = margin;

                // Set default font to Times New Roman
                pdf.setFont('times');
                pdf.setFontSize(10);

                // Helper function to add text with proper formatting
                function addText(text, x, y, options = {}) {
                    const fontSize = options.fontSize || 9;
                    const maxWidth = options.maxWidth || contentWidth;
                    const lineHeight = options.lineHeight || fontSize * 0.4;
                    
                    // Ensure text is never undefined
                    const safeText = (text || '').toString();
                    
                    pdf.setFontSize(fontSize);
                    if (options.font === 'times' && options.fontStyle === 'bold') pdf.setFont('times', 'bold');
                    else if (options.font === 'times' && options.fontStyle === 'italic') pdf.setFont('times', 'italic');
                    else if (options.font === 'times') pdf.setFont('times', 'normal');
                    else if (options.font === 'helvetica' && options.fontStyle === 'bold') pdf.setFont('helvetica', 'bold');
                    else if (options.font === 'helvetica' && options.fontStyle === 'italic') pdf.setFont('helvetica', 'italic');
                    else pdf.setFont('helvetica', 'normal');

                    if (options.align) {
                        pdf.text(safeText, x, y, { align: options.align, maxWidth: maxWidth });
                        return y + lineHeight + 2;
                    } else {
                        const lines = pdf.splitTextToSize(safeText, maxWidth);
                        lines.forEach((line, index) => {
                            pdf.text(line, x, y + (index * lineHeight), { align: options.justify ? 'justify' : 'left' });
                        });
                        return y + (lines.length * lineHeight) + 3;
                    }
                }

                // PAGE 1: Template 1: State Specific Note & Background Note
                pdf.setFontSize(14);
                pdf.setFont('times', 'bold');
                pdf.text('Template 1: State Specific Note & Background Note', pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 15;

                // Two column layout
                const leftColX = margin;
                const rightColX = margin + (contentWidth / 2) + 5;
                const colWidth = (contentWidth / 2) - 5;
                let leftY = yPosition;
                let rightY = yPosition;

                // National Summit headers CENTERED in each column
                pdf.setFontSize(10);
                pdf.setFont('times', 'normal');
                // Left column header
                pdf.text('National Summit', leftColX + (colWidth / 2), leftY, { align: 'center' });
                leftY += 4;
                pdf.text('Theme:', leftColX + (colWidth / 2), leftY, { align: 'center' });
                leftY += 4;
                pdf.text('Template: State Specific Note', leftColX + (colWidth / 2), leftY, { align: 'center' });
                leftY += 10;

                // Right column header
                pdf.text('National Summit', rightColX + (colWidth / 2), rightY, { align: 'center' });
                rightY += 4;
                pdf.text('Theme:', rightColX + (colWidth / 2), rightY, { align: 'center' });
                rightY += 4;
                pdf.text('Template: State Specific Note', rightColX + (colWidth / 2), rightY, { align: 'center' });
                rightY += 10;

                // Template 1: State Specific Note (left side header)
                addText('Template 1: State Specific Note', leftColX, leftY, { fontSize: 11, font: 'times', fontStyle: 'bold' });
                leftY += 10;

                // LEFT COLUMN
                // I. Introduction
                addText('I.    Introduction', leftColX, leftY, { fontSize: 11, font: 'times', fontStyle: 'bold' });
                leftY += 4;
                const introDesc = '(Why is this topic important for the States/UTs? Highlight the data evidence to support the same)';
                addText(introDesc, leftColX, leftY, { fontSize: 9, font: 'times', fontStyle: 'italic', maxWidth: colWidth, justify: true });
                leftY += pdf.splitTextToSize(introDesc, colWidth).length * 3.5 + 5;

                // Text box for Introduction
                pdf.rect(leftColX, leftY, colWidth, 22);
                addText(safeGetValue(feedbackData, 'introduction', 'introduction'), leftColX + 2, leftY + 4, { fontSize: 9, font: 'times', justify: true, maxWidth: colWidth - 4 });
                leftY += 27;

                // II. Current Situation
                addText('II.   Current Situation', leftColX, leftY, { fontSize: 11, font: 'times', fontStyle: 'bold' });
                leftY += 4;
                const currDesc = '(Current policy landscape, programmes, schemes and their progress)';
                addText(currDesc, leftColX, leftY, { fontSize: 9, font: 'times', fontStyle: 'italic', maxWidth: colWidth, justify: true });
                leftY += pdf.splitTextToSize(currDesc, colWidth).length * 3.5 + 5;

                // Text box for Current Situation
                pdf.rect(leftColX, leftY, colWidth, 22);
                addText(safeGetValue(feedbackData, 'currentSituation', 'current_situation'), leftColX + 2, leftY + 4, { fontSize: 9, font: 'times', justify: true, maxWidth: colWidth - 4 });
                leftY += 27;

                // III. Challenges
                addText('III.  Challenges', leftColX, leftY, { fontSize: 11, font: 'times', fontStyle: 'bold' });
                leftY += 4;
                const challDesc = '(Major policy, programmatic and capacity building gaps affecting the working of the States/UTs Administration)';
                addText(challDesc, leftColX, leftY, { fontSize: 9, font: 'times', fontStyle: 'italic', maxWidth: colWidth, justify: true });
                leftY += pdf.splitTextToSize(challDesc, colWidth).length * 3.5 + 5;

                // Text box for Challenges
                pdf.rect(leftColX, leftY, colWidth, 22);
                addText(safeGetValue(feedbackData, 'challenges', 'challenges'), leftColX + 2, leftY + 4, { fontSize: 9, font: 'times', justify: true, maxWidth: colWidth - 4 });
                leftY += 27;

                // IV. Possible Solutions
                addText('IV.   Possible Solutions', leftColX, leftY, { fontSize: 11, font: 'times', fontStyle: 'bold' });
                leftY += 4;
                const solDesc = '(Proposed ideas, actions that can be undertaken by different stakeholders. Scope for convergence with other schemes/programmes)';
                addText(solDesc, leftColX, leftY, { fontSize: 9, font: 'times', fontStyle: 'italic', maxWidth: colWidth, justify: true });
                leftY += pdf.splitTextToSize(solDesc, colWidth).length * 3.5 + 5;

                // Text box for Possible Solutions
                pdf.rect(leftColX, leftY, colWidth, 22);
                addText(safeGetValue(feedbackData, 'possibleSolutions', 'possible_solutions'), leftColX + 2, leftY + 4, { fontSize: 9, font: 'times', justify: true, maxWidth: colWidth - 4 });

                // RIGHT COLUMN
                // V. Best Practices
                addText('V.    Best Practices', rightColX, rightY, { fontSize: 11, font: 'times', fontStyle: 'bold' });
                rightY += 4;
                const bestDesc = '(International (if any), Major Initiatives undertaken by States/UTs Administration. May also include initiatives for training and capacity-building that have been taken for effective implementation. Strategic communication campaigns undertaken to disseminate the programme, convergence, new technologies used for effective implementation)';
                addText(bestDesc, rightColX, rightY, { fontSize: 9, font: 'times', fontStyle: 'italic', maxWidth: colWidth, justify: true });
                rightY += pdf.splitTextToSize(bestDesc, colWidth).length * 3.5 + 5;

                // Text box for Best Practices
                pdf.rect(rightColX, rightY, colWidth, 22);
                addText(safeGetValue(feedbackData, 'bestPractices', 'best_practices'), rightColX + 2, rightY + 4, { fontSize: 9, font: 'times', justify: true, maxWidth: colWidth - 4 });
                rightY += 27;

                // VI. Priority Areas
                addText('VI.   Priority Areas', rightColX, rightY, { fontSize: 11, font: 'times', fontStyle: 'bold' });
                rightY += 4;
                const prioDesc = '(Selected for implementation by the States in the next 5 years)';
                addText(prioDesc, rightColX, rightY, { fontSize: 9, font: 'times', fontStyle: 'italic', maxWidth: colWidth, justify: true });
                rightY += pdf.splitTextToSize(prioDesc, colWidth).length * 3.5 + 5;

                // Text box for Priority Areas
                pdf.rect(rightColX, rightY, colWidth, 22);
                addText(safeGetValue(feedbackData, 'priorityAreas', 'priority_areas'), rightColX + 2, rightY + 4, { fontSize: 9, font: 'times', justify: true, maxWidth: colWidth - 4 });
                rightY += 27;

                // VII. Way Forward - Strategy for Implementation
                addText('VII.  Way Forward - Strategy for Implementation', rightColX, rightY, { fontSize: 11, font: 'times', fontStyle: 'bold' });
                rightY += 4;
                const wayDesc = '(Modality for implementation - Legal, Administrative, Technological, Budgetary reforms required for implementation)';
                addText(wayDesc, rightColX, rightY, { fontSize: 9, font: 'times', fontStyle: 'italic', maxWidth: colWidth, justify: true });
                rightY += pdf.splitTextToSize(wayDesc, colWidth).length * 3.5 + 5;

                // Text box for Way Forward
                pdf.rect(rightColX, rightY, colWidth, 22);
                addText(safeGetValue(feedbackData, 'wayForwardStrategy', 'way_forward_strategy'), rightColX + 2, rightY + 4, { fontSize: 9, font: 'times', justify: true, maxWidth: colWidth - 4 });

                // PAGE 2: Template 2: Feedback Note by Officers
                pdf.addPage();
                yPosition = margin;

                // Template 2 Header
                pdf.setFontSize(14);
                pdf.setFont('times', 'bold');
                pdf.text('Template 2: Feedback Note by Officers', pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 15;

                // National Summit headers for Template 2 - CENTERED
                pdf.setFontSize(10);
                pdf.setFont('times', 'normal');
                // Left side
                pdf.text('National Summit', leftColX + (colWidth / 2), yPosition, { align: 'center' });
                pdf.text('Theme:', leftColX + (colWidth / 2), yPosition + 4, { align: 'center' });
                pdf.text('Template: Feedback Note', leftColX + (colWidth / 2), yPosition + 8, { align: 'center' });
                
                // Right side
                pdf.text('National Summit', rightColX + (colWidth / 2), yPosition, { align: 'center' });
                pdf.text('Theme:', rightColX + (colWidth / 2), yPosition + 4, { align: 'center' });
                pdf.text('Template: Feedback Note', rightColX + (colWidth / 2), yPosition + 8, { align: 'center' });
                yPosition += 20;

                // Feedback Note header
                addText('Feedback Note (by all IAS officers / State Department Officers)', margin, yPosition, { fontSize: 11, font: 'times', fontStyle: 'bold' });
                yPosition += 15;

                // Section 1: Officer Name and Details
                addText('Section 1: Officer Name and Details:', margin, yPosition, { fontSize: 11, font: 'times', fontStyle: 'bold' });
                yPosition += 10;

                pdf.setFontSize(10);
                pdf.setFont('times', 'normal');
                pdf.text(`‚Ä¢ Name: ${safeGetValue(feedbackData, 'officerName', 'officer_name')}`, margin, yPosition);
                yPosition += 6;
                pdf.text(`‚Ä¢ Designation: ${safeGetValue(feedbackData, 'designation', 'designation')}`, margin, yPosition);
                yPosition += 6;
                pdf.text(`‚Ä¢ Batch: ${safeGetValue(feedbackData, 'batch', 'batch')}`, margin, yPosition);
                yPosition += 6;
                pdf.text(`‚Ä¢ Current Posting: \${safeGetValue(feedbackData, 'currentPosting', 'current_posting')}`, margin, yPosition);
                yPosition += 15;

                // Section 2: Feedback for Summit
                addText('Section 2: Feedback for Summit on <Theme name>', margin, yPosition, { fontSize: 11, font: 'times', fontStyle: 'bold' });
                yPosition += 15;

                // 1. Name of the sub theme
                addText('1. Name of the sub theme', margin, yPosition, { fontSize: 11, font: 'times', fontStyle: 'bold' });
                yPosition += 4;
                const subThemeDesc = '(Choose from the sub theme of the summit)';
                addText(subThemeDesc, margin, yPosition, { fontSize: 9, font: 'times', fontStyle: 'italic', maxWidth: contentWidth, justify: true });
                yPosition += pdf.splitTextToSize(subThemeDesc, contentWidth).length * 3.5 + 5;

                // Text box for sub theme
                pdf.rect(margin, yPosition, contentWidth, 15);
                addText(safeGetValue(feedbackData, 'subThemeName', 'sub_theme_name'), margin + 2, yPosition + 4, { fontSize: 9, font: 'times', justify: true, maxWidth: contentWidth - 4 });
                yPosition += 20;

                // 2. Policy Gaps and Challenges
                addText('2. Policy Gaps and Challenges', margin, yPosition, { fontSize: 11, font: 'times', fontStyle: 'bold' });
                yPosition += 4;
                const policyDesc = '(Current policy challenges, administrative and implementing challenges with respect to the sub theme selected)';
                addText(policyDesc, margin, yPosition, { fontSize: 9, font: 'times', fontStyle: 'italic', maxWidth: contentWidth, justify: true });
                yPosition += pdf.splitTextToSize(policyDesc, contentWidth).length * 3.5 + 5;

                // Text box for Policy Gaps
                pdf.rect(margin, yPosition, contentWidth, 22);
                addText(safeGetValue(feedbackData, 'policyGapsChallenges', 'policy_gaps_challenges'), margin + 2, yPosition + 4, { fontSize: 9, font: 'times', justify: true, maxWidth: contentWidth - 4 });
                yPosition += 27;

                // 3. Potential Solutions
                addText('3. Potential Solutions', margin, yPosition, { fontSize: 11, font: 'times', fontStyle: 'bold' });
                yPosition += 4;
                const potentialDesc = '(Can potentially highlight new technology solutions, scope for convergence with other schemes/programmes etc.)';
                addText(potentialDesc, margin, yPosition, { fontSize: 9, font: 'times', fontStyle: 'italic', maxWidth: contentWidth, justify: true });
                yPosition += pdf.splitTextToSize(potentialDesc, contentWidth).length * 3.5 + 5;

                // Text box for Potential Solutions
                pdf.rect(margin, yPosition, contentWidth, 22);
                addText(safeGetValue(feedbackData, 'potentialSolutions', 'potential_solutions'), margin + 2, yPosition + 4, { fontSize: 9, font: 'times', justify: true, maxWidth: contentWidth - 4 });
                yPosition += 27;

                // Right side box for Template 2 (as shown in your PDF) - Better positioning
                const rightBoxX = rightColX;
                const rightBoxY = 65;
                const rightBoxWidth = colWidth;
                const rightBoxHeight = 65;
                pdf.rect(rightBoxX, rightBoxY, rightBoxWidth, rightBoxHeight);

                // 4. Best Practices (in right box) - description OUTSIDE the main text box
                addText('4. Best Practices', rightBoxX + 2, rightBoxY + 8, { fontSize: 11, font: 'times', fontStyle: 'bold' });
                const bestPracticesDesc = '(Highlight the practices, which are sustainable, replicable, scalable, monitorable etc. Can also highlight the block/district/State level practices)';
                addText(bestPracticesDesc, rightBoxX + 2, rightBoxY + 12, { fontSize: 9, font: 'times', fontStyle: 'italic', maxWidth: rightBoxWidth - 4, justify: true });

                // Text content for Best Practices (inside the box)
                addText(safeGetValue(feedbackData, 'feedbackBestPractices', 'feedback_best_practices'), rightBoxX + 2, rightBoxY + 25, { fontSize: 9, font: 'times', justify: true, maxWidth: rightBoxWidth - 4 });

                // Instructions section at bottom - BETTER ALIGNED
                const instructionsY = pageHeight - 55;
                addText('Instructions for filing feedback note:', margin, instructionsY, { fontSize: 11, font: 'times', fontStyle: 'bold' });

                pdf.setFontSize(9);
                pdf.setFont('times', 'normal');
                
                // 1. References - properly aligned
                pdf.text('1. References:', margin + 5, instructionsY + 8);
                const ref1 = '‚Ä¢ In-text citing as well as the listing of all the references used for compiling the data';
                addText(ref1, margin + 10, instructionsY + 12, { fontSize: 9, font: 'times', justify: true, maxWidth: contentWidth - 15 });
                pdf.text('  and information.', margin + 12, instructionsY + 16);
                pdf.text('‚Ä¢ Hyperlinks can be added in the document', margin + 10, instructionsY + 20);
                
                // 2. Documentation style - properly aligned
                pdf.text('2. Documentation style:', margin + 5, instructionsY + 26);
                const docStyle = '‚óã Microsoft Word - Paper Size A4 with one inch margin from all four sides';
                addText(docStyle, margin + 10, instructionsY + 30, { fontSize: 9, font: 'times', justify: true, maxWidth: contentWidth - 15 });

                if (isPreview) {
                    // Open in new tab for preview
                    const pdfBlob = pdf.output('blob');
                    const url = URL.createObjectURL(pdfBlob);
                    window.open(url, '_blank');
                } else {
                    // Download PDF
                    const fileName = `feedback_${safeGetValue(feedbackData, 'officerName', 'officer_name') || 'form'}_${new Date().toISOString().split('T')[0]}.pdf`;
                    pdf.save(fileName);
                }

                return pdf;

            } catch (error) {
                console.error('Error generating PDF:', error);
                throw error;
            }
        }

        // Get Feedbacks by Date Range
        async function getFeedbacksByDateRange(startDate, endDate) {
            try {
                let query = supabaseClient
                    .from('feedbacks')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (startDate) {
                    query = query.gte('created_at', startDate + 'T00:00:00.000Z');
                }
                
                if (endDate) {
                    query = query.lte('created_at', endDate + 'T23:59:59.999Z');
                }

                const { data, error } = await query;

                if (error) throw error;

                return data || [];

            } catch (error) {
                console.error('Error fetching feedbacks:', error);
                throw error;
            }
        }

        // UPDATED Generate Bulk PDF with proper data mapping
        async function generateBulkPDF(feedbacks) {
            try {
                const zip = new JSZip();

                for (let i = 0; i < feedbacks.length; i++) {
                    const feedback = feedbacks[i];
                    
                    // Map database data to expected format
                    const mappedData = mapDatabaseToFormData(feedback);
                    
                    // Generate PDF for each feedback
                    const pdf = await generatePDF(mappedData, false);
                    const pdfBlob = pdf.output('blob');
                    
                    const fileName = `feedback_${mappedData.officerName || 'form'}_${feedback.created_at.split('T')[0]}.pdf`;
                    zip.file(fileName, pdfBlob);
                }

                // Generate zip file
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                
                // Download zip file
                const url = URL.createObjectURL(zipBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `feedbacks_bulk_\${new Date().toISOString().split('T')[0]}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

            } catch (error) {
                console.error('Error generating bulk PDF:', error);
                throw error;
            }
        }

        // Display Feedbacks in Modal
        async function displayFeedbacksInModal(feedbacks) {
            const tableBody = document.getElementById('feedbackTableBody');
            tableBody.innerHTML = '';

            if (feedbacks.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">No feedbacks found</td>
                    </tr>
                `;
                return;
            }

            feedbacks.forEach(feedback => {
                const row = document.createElement('tr');
                const createdDate = new Date(feedback.created_at).toLocaleDateString('en-US');
                
                row.innerHTML = `
                    <td>\${createdDate}</td>
                    <td>\${feedback.officer_name || 'N/A'}</td>
                    <td>\${feedback.designation || 'N/A'}</td>
                    <td>\${feedback.batch || 'N/A'}</td>
                    <td>\${feedback.current_posting || 'N/A'}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="downloadSingleFeedbackPDF('\${feedback.id}')">
                            <i class="fas fa-download"></i> PDF
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // UPDATED Download Single Feedback PDF with proper data mapping
        async function downloadSingleFeedbackPDF(feedbackId) {
            try {
                const { data, error } = await supabaseClient
                    .from('feedbacks')
                    .select('*')
                    .eq('id', feedbackId)
                    .single();

                if (error) throw error;

                // Map database data to expected format
                const mappedData = mapDatabaseToFormData(data);
                await generatePDF(mappedData, false);

            } catch (error) {
                console.error('Error downloading single feedback PDF:', error);
                showAlert('Error downloading PDF.', 'danger');
            }
        }

        // Auto-save form data to localStorage (draft functionality)
        function saveFormDraft() {
            const formData = {
                // Template 1 fields - using getFormValue to prevent undefined
                introduction: getFormValue('introduction'),
                currentSituation: getFormValue('currentSituation'),
                challenges: getFormValue('challenges'),
                possibleSolutions: getFormValue('possibleSolutions'),
                bestPractices: getFormValue('bestPractices'),
                priorityAreas: getFormValue('priorityAreas'),
                wayForwardStrategy: getFormValue('wayForwardStrategy'),
                // Template 2 fields - using getFormValue to prevent undefined
                officerName: getFormValue('officerName'),
                designation: getFormValue('designation'),
                batch: getFormValue('batch'),
                currentPosting: getFormValue('currentPosting'),
                subThemeName: getFormValue('subThemeName'),
                policyGapsChallenges: getFormValue('policyGapsChallenges'),
                potentialSolutions: getFormValue('potentialSolutions'),
                feedbackBestPractices: getFormValue('feedbackBestPractices')
            };
            
            localStorage.setItem('feedbackDraft', JSON.stringify(formData));
        }

        // Load form draft from localStorage
        function loadFormDraft() {
            const draft = localStorage.getItem('feedbackDraft');
            if (draft) {
                try {
                    const formData = JSON.parse(draft);
                    
                    // Template 1 fields
                    document.getElementById('introduction').value = formData.introduction || '';
                    document.getElementById('currentSituation').value = formData.currentSituation || '';
                    document.getElementById('challenges').value = formData.challenges || '';
                    document.getElementById('possibleSolutions').value = formData.possibleSolutions || '';
                    document.getElementById('bestPractices').value = formData.bestPractices || '';
                    document.getElementById('priorityAreas').value = formData.priorityAreas || '';
                    document.getElementById('wayForwardStrategy').value = formData.wayForwardStrategy || '';
                    // Template 2 fields
                    document.getElementById('officerName').value = formData.officerName || '';
                    document.getElementById('designation').value = formData.designation || '';
                    document.getElementById('batch').value = formData.batch || '';
                    document.getElementById('currentPosting').value = formData.currentPosting || '';
                    document.getElementById('subThemeName').value = formData.subThemeName || '';
                    document.getElementById('policyGapsChallenges').value = formData.policyGapsChallenges || '';
                    document.getElementById('potentialSolutions').value = formData.potentialSolutions || '';
                    document.getElementById('feedbackBestPractices').value = formData.feedbackBestPractices || '';
                    
                    console.log('üìù Form draft loaded');
                } catch (error) {
                    console.error('Error loading form draft:', error);
                    localStorage.removeItem('feedbackDraft');
                }
            }
        }

        // Clear draft after successful submission
        function clearFormDraft() {
            localStorage.removeItem('feedbackDraft');
            console.log('üìù Form draft cleared');
        }

        // Auto-resize textareas
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        // Character counter function
        function addCharacterCounter(textareaId, maxLength = 2000) {
            const textarea = document.getElementById(textareaId);
            if (!textarea) return;
            
            const counter = document.createElement('div');
            counter.className = 'character-counter';
            counter.style.cssText = 'font-size: 0.8rem; color: #666; text-align: right; margin-top: 5px; font-family: Poppins, sans-serif;';
            
            textarea.parentNode.insertBefore(counter, textarea.nextSibling);
            
            function updateCounter() {
                const length = textarea.value.length;
                counter.textContent = `${length}/${maxLength} characters`;
                
                if (length > maxLength * 0.9) {
                    counter.style.color = '#ff6b6b';
                } else if (length > maxLength * 0.7) {
                    counter.style.color = '#ffa726';
                } else {
                    counter.style.color = '#666';
                }
            }
            
            updateCounter();
            textarea.addEventListener('input', updateCounter);
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üìÑ DOM Content Loaded');
            initializePage();
        });

        // Logout button
        document.getElementById('btnLogout').addEventListener('click', handleLogout);

        // UPDATED Feedback form submission with proper data collection
        document.getElementById('feedbackForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            console.log('üìù Feedback form submitted');
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div> Submitting...';
                
                // Collect form data using safe getFormValue function
                const formData = {
                    // Template 1 fields
                    introduction: getFormValue('introduction'),
                    currentSituation: getFormValue('currentSituation'),
                    challenges: getFormValue('challenges'),
                    possibleSolutions: getFormValue('possibleSolutions'),
                    bestPractices: getFormValue('bestPractices'),
                    priorityAreas: getFormValue('priorityAreas'),
                    wayForwardStrategy: getFormValue('wayForwardStrategy'),
                    // Template 2 fields
                    officerName: getFormValue('officerName'),
                    designation: getFormValue('designation'),
                    batch: getFormValue('batch'),
                    currentPosting: getFormValue('currentPosting'),
                    subThemeName: getFormValue('subThemeName'),
                    policyGapsChallenges: getFormValue('policyGapsChallenges'),
                    potentialSolutions: getFormValue('potentialSolutions'),
                    feedbackBestPractices: getFormValue('feedbackBestPractices')
                };

                // Validate required fields
                const requiredFields = [
                    'introduction', 'currentSituation', 'challenges', 'possibleSolutions',
                    'bestPractices', 'priorityAreas', 'wayForwardStrategy',
                    'officerName', 'designation', 'batch', 'currentPosting',
                    'subThemeName', 'policyGapsChallenges', 'potentialSolutions', 'feedbackBestPractices'
                ];

                for (const field of requiredFields) {
                    if (!formData[field]) {
                        throw new Error(`Please fill all required fields.`);
                    }
                }

                // Submit feedback
                await submitFeedback(formData);

            } catch (error) {
                console.error('‚ùå Error submitting feedback:', error);
                const errorMessage = error.message || 'Error submitting feedback.';
                showAlert(errorMessage, 'danger');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });

        // UPDATED Preview button with proper data collection
        document.getElementById('previewBtn').addEventListener('click', async function() {
            try {
                // Collect form data for preview using safe getFormValue function
                const formData = {
                    // Template 1 fields
                    introduction: getFormValue('introduction') || 'This topic is crucial for States/UTs as it addresses fundamental challenges in governance and policy implementation, supported by comprehensive data analysis and evidence-based recommendations for sustainable development.',
                    currentSituation: getFormValue('currentSituation') || 'The current policy landscape encompasses various central and state schemes with varying degrees of implementation success across different regions, requiring systematic evaluation and improvement strategies.',
                    challenges: getFormValue('challenges') || 'Major policy gaps include coordination issues between departments, capacity building requirements, technological infrastructure limitations, and resource allocation challenges affecting effective implementation at grassroots level.',
                    possibleSolutions: getFormValue('possibleSolutions') || 'Proposed solutions include establishing inter-departmental coordination mechanisms, comprehensive capacity building programs, leveraging advanced technology for better convergence, and implementing robust monitoring and evaluation systems.',
                    bestPractices: getFormValue('bestPractices') || 'International best practices from countries like Estonia, Singapore, and Denmark, along with successful state initiatives in Kerala, Gujarat, and Telangana, demonstrate effective digital governance models, innovative implementation strategies, and sustainable development approaches.',
                    priorityAreas: getFormValue('priorityAreas') || 'Key priority areas for the next 5 years include comprehensive digital infrastructure development, human resource capacity building, policy framework modernization, sustainable implementation mechanisms, and citizen-centric service delivery models.',
                    wayForwardStrategy: getFormValue('wayForwardStrategy') || 'Implementation strategy requires comprehensive legal and regulatory reforms, systematic administrative restructuring, strategic technology adoption, adequate budgetary allocation with transparent utilization, phased rollout with continuous monitoring, and stakeholder engagement at all levels.',
                    // Template 2 fields
                    officerName: getFormValue('officerName') || 'Dr. Rajesh Kumar Singh',
                    designation: getFormValue('designation') || 'Joint Secretary',
                    batch: getFormValue('batch') || '2008',
                    currentPosting: getFormValue('currentPosting') || 'Ministry of Agriculture & Farmers Welfare',
                    subThemeName: getFormValue('subThemeName') || 'Digital Agriculture Transformation and Farmer Empowerment through Technology Integration, Sustainable Development Practices, and Comprehensive Rural Development Initiatives',
                    policyGapsChallenges: getFormValue('policyGapsChallenges') || 'Current challenges include fragmented digital systems across departments, lack of interoperability between state and central databases, insufficient digital literacy among field officers, coordination gaps between various implementing agencies, and inadequate infrastructure in remote areas.',
                    potentialSolutions: getFormValue('potentialSolutions') || 'Comprehensive solutions include developing unified digital platforms with seamless integration, implementing systematic training programs for capacity building, establishing robust data governance frameworks, and fostering public-private partnerships for sustainable development.',
                    feedbackBestPractices: getFormValue('feedbackBestPractices') || 'Successful sustainable practices include Andhra Pradesh comprehensive farmer database system with real-time monitoring, Karnataka innovative mobile-based extension services, Telangana integrated crop monitoring system using satellite technology, and various state-level technology adoption models that have shown measurable impact on farmer welfare and agricultural productivity.'
                };

                await generatePDF(formData, true);

            } catch (error) {
                console.error('Error generating preview:', error);
                showAlert('Error generating preview.', 'danger');
            }
        });

        // Admin panel event listeners
        if (document.getElementById('downloadSinglePDF')) {
            document.getElementById('downloadSinglePDF').addEventListener('click', async function() {
                try {
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;

                    if (!startDate || !endDate) {
                        showAlert('Please select date range.', 'warning');
                        return;
                    }

                    this.disabled = true;
                    this.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div> Downloading...';

                    const feedbacks = await getFeedbacksByDateRange(startDate, endDate);
                    
                    if (feedbacks.length === 0) {
                        showAlert('No feedbacks found in selected date range.', 'info');
                        return;
                    }

                    // Download first feedback as sample
                    const mappedData = mapDatabaseToFormData(feedbacks[0]);
                    await generatePDF(mappedData, false);

                } catch (error) {
                    console.error('Error downloading PDF:', error);
                    showAlert('Error downloading PDF.', 'danger');
                } finally {
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-file-pdf me-2"></i><span class="hindi">‡§è‡§ï‡§≤ PDF ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°</span>';
                }
            });
        }

        if (document.getElementById('downloadBulkPDF')) {
            document.getElementById('downloadBulkPDF').addEventListener('click', async function() {
                try {
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;

                    if (!startDate || !endDate) {
                        showAlert('Please select date range.', 'warning');
                        return;
                    }

                    this.disabled = true;
                    this.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div> Preparing...';

                    const feedbacks = await getFeedbacksByDateRange(startDate, endDate);
                    
                    if (feedbacks.length === 0) {
                        showAlert('No feedbacks found in selected date range.', 'info');
                        return;
                    }

                    await generateBulkPDF(feedbacks);
                    showAlert(`Bulk PDF download completed for \${feedbacks.length} feedbacks.`, 'success');

                } catch (error) {
                    console.error('Error downloading bulk PDF:', error);
                    showAlert('Error downloading bulk PDF.', 'danger');
                } finally {
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-file-archive me-2"></i><span class="hindi">‡§¨‡§≤‡•ç‡§ï PDF ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°</span>';
                }
            });
        }

        if (document.getElementById('viewAllFeedbacks')) {
            document.getElementById('viewAllFeedbacks').addEventListener('click', async function() {
                try {
                    this.disabled = true;
                    this.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div> Loading...';

                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;

                    const feedbacks = await getFeedbacksByDateRange(startDate, endDate);
                    await displayFeedbacksInModal(feedbacks);

                    const modal = new bootstrap.Modal(document.getElementById('feedbackListModal'));
                    modal.show();

                } catch (error) {
                    console.error('Error loading feedbacks:', error);
                    showAlert('Error loading feedbacks.', 'danger');
                } finally {
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-list me-2"></i><span class="hindi">‡§∏‡§≠‡•Ä ‡§´‡•Ä‡§°‡§¨‡•à‡§ï ‡§¶‡•á‡§ñ‡•á‡§Ç</span>';
                }
            });
        }

        // Clickable stats cards
        document.getElementById('totalFeedbacksCard').addEventListener('click', async () => {
            const feedbacks = await getFeedbacksByDateRange(null, null); // All feedbacks
            await displayFeedbacksInModal(feedbacks);
            new bootstrap.Modal(document.getElementById('feedbackListModal')).show();
        });

        document.getElementById('todayFeedbacksCard').addEventListener('click', async () => {
            const today = new Date().toISOString().split('T')[0];
            const feedbacks = await getFeedbacksByDateRange(today, today); // Today's feedbacks
            await displayFeedbacksInModal(feedbacks);
            new bootstrap.Modal(document.getElementById('feedbackListModal')).show();
        });

        // Set default date range (last 30 days)
        if (document.getElementById('startDate') && document.getElementById('endDate')) {
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
            
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            document.getElementById('startDate').value = thirtyDaysAgo.toISOString().split('T')[0];
        }

        // Make downloadSingleFeedbackPDF available globally
        window.downloadSingleFeedbackPDF = downloadSingleFeedbackPDF;

        // Auto-save every 30 seconds
        setInterval(saveFormDraft, 30000);

        // Save on form input change
        document.getElementById('feedbackForm').addEventListener('input', saveFormDraft);

        // Load draft when page loads
        setTimeout(loadFormDraft, 1000);

        // Auto-resize textareas on input
        setTimeout(() => {
            const textareas = document.querySelectorAll('textarea');
            textareas.forEach(textarea => {
                textarea.addEventListener('input', function() {
                    autoResizeTextarea(this);
                });
                // Initial resize
                autoResizeTextarea(textarea);
            });
        }, 1500);

        // Add character counters to all textareas
        setTimeout(() => {
            const textareaIds = [
                'introduction', 'currentSituation', 'challenges', 'possibleSolutions',
                'bestPractices', 'priorityAreas', 'wayForwardStrategy',
                'subThemeName', 'policyGapsChallenges', 'potentialSolutions', 'feedbackBestPractices'
            ];
            
            textareaIds.forEach(id => addCharacterCounter(id, 2000));
        }, 1500);

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl + S to save draft
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveFormDraft();
                showAlert('Form draft saved.', 'info');
            }
            
            // Ctrl + Enter to submit form
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                const submitBtn = document.querySelector('button[type="submit"]');
                if (submitBtn && !submitBtn.disabled) {
                    submitBtn.click();
                }
            }
        });

        // Handle network status
        window.addEventListener('online', () => {
            console.log('üåê Network online');
            showAlert('Internet connection restored.', 'success');
        });

        window.addEventListener('offline', () => {
            console.log('üì° Network offline');
            showAlert('Internet connection lost. Please check your connection.', 'danger');
        });

        // Error boundary for unhandled errors
        window.addEventListener('error', (e) => {
            console.error('üí• Unhandled error:', e.error);
            showAlert('An unexpected error occurred. Please refresh the page.', 'danger');
        });

        window.addEventListener('unhandledrejection', (e) => {
            console.error('üí• Unhandled promise rejection:', e.reason);
            showAlert('Data loading error. Please try again.', 'danger');
        });

        // Debug functions for development
        window.debugFeedback = {
            getCurrentUser: () => currentUser,
            getSupabaseClient: () => supabaseClient,
            loadDraft: loadFormDraft,
            saveDraft: saveFormDraft,
            clearDraft: clearFormDraft,
            testPDF: async () => {
                const sampleData = {
                    introduction: 'This topic is crucial for States/UTs as it addresses fundamental challenges in governance and policy implementation, supported by comprehensive data analysis and evidence-based recommendations for sustainable development.',
                    currentSituation: 'The current policy landscape encompasses various central and state schemes with varying degrees of implementation success across different regions, requiring systematic evaluation and improvement strategies.',
                    challenges: 'Major policy gaps include coordination issues between departments, capacity building requirements, technological infrastructure limitations, and resource allocation challenges affecting effective implementation at grassroots level.',
                    possibleSolutions: 'Proposed solutions include establishing inter-departmental coordination mechanisms, comprehensive capacity building programs, leveraging advanced technology for better convergence, and implementing robust monitoring and evaluation systems.',
                    bestPractices: 'International best practices from countries like Estonia, Singapore, and Denmark, along with successful state initiatives in Kerala, Gujarat, and Telangana, demonstrate effective digital governance models, innovative implementation strategies, and sustainable development approaches.',
                    priorityAreas: 'Key priority areas for the next 5 years include comprehensive digital infrastructure development, human resource capacity building, policy framework modernization, sustainable implementation mechanisms, and citizen-centric service delivery models.',
                    wayForwardStrategy: 'Implementation strategy requires comprehensive legal and regulatory reforms, systematic administrative restructuring, strategic technology adoption, adequate budgetary allocation with transparent utilization, phased rollout with continuous monitoring, and stakeholder engagement at all levels.',
                    officerName: 'Dr. Rajesh Kumar Singh',
                    designation: 'Joint Secretary',
                    batch: '2008',
                    currentPosting: 'Ministry of Agriculture & Farmers Welfare',
                    subThemeName: 'Digital Agriculture Transformation and Farmer Empowerment through Technology Integration, Sustainable Development Practices, and Comprehensive Rural Development Initiatives',
                    policyGapsChallenges: 'Current challenges include fragmented digital systems across departments, lack of interoperability between state and central databases, insufficient digital literacy among field officers, coordination gaps between various implementing agencies, and inadequate infrastructure in remote areas.',
                    potentialSolutions: 'Comprehensive solutions include developing unified digital platforms with seamless integration, implementing systematic training programs for capacity building, establishing robust data governance frameworks, and fostering public-private partnerships for sustainable development.',
                                  feedbackBestPractices: 'Successful sustainable practices include Andhra Pradesh comprehensive farmer database system with real-time monitoring, Karnataka innovative mobile-based extension services, Telangana integrated crop monitoring system using satellite technology, and various state-level technology adoption models that have shown measurable impact on farmer welfare and agricultural productivity.'
                };
                await generatePDF(sampleData, true);
            },
            getFormData: () => {
                return {
                    introduction: getFormValue('introduction'),
                    currentSituation: getFormValue('currentSituation'),
                    challenges: getFormValue('challenges'),
                    possibleSolutions: getFormValue('possibleSolutions'),
                    bestPractices: getFormValue('bestPractices'),
                    priorityAreas: getFormValue('priorityAreas'),
                    wayForwardStrategy: getFormValue('wayForwardStrategy'),
                    officerName: getFormValue('officerName'),
                    designation: getFormValue('designation'),
                    batch: getFormValue('batch'),
                    currentPosting: getFormValue('currentPosting'),
                    subThemeName: getFormValue('subThemeName'),
                    policyGapsChallenges: getFormValue('policyGapsChallenges'),
                    potentialSolutions: getFormValue('potentialSolutions'),
                    feedbackBestPractices: getFormValue('feedbackBestPractices')
                };
            },
            mapDatabaseData: mapDatabaseToFormData,
            safeGetValue: safeGetValue
        };

        // Add console welcome message
        console.log(`
        ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
        ‚ïë                ‡§∏‡§Ç‡§ö‡§æ‡§≤‡§®‡§æ‡§≤‡§Ø ‡§ï‡•É‡§∑‡§ø ‡§õ‡§§‡•ç‡§§‡•Ä‡§∏‡§ó‡§¢‡§º                      ‚ïë
        ‚ïë              National Summit Feedback System                 ‚ïë
        ‚ïë                                                              ‚ïë
        ‚ïë  üìù Template 1: State Specific Note & Background Note        ‚ïë
        ‚ïë  üìã Template 2: Feedback Note by Officers                    ‚ïë
        ‚ïë  üìÑ EXACT PDF Layout with REDUCED MARGINS                    ‚ïë
        ‚ïë  üé® Light Orange Background & Sentence Case                  ‚ïë
        ‚ïë  üìä Sky Blue Admin Header & Poppins Font                     ‚ïë
        ‚ïë  üì¶ Single & Bulk PDF Download                               ‚ïë
        ‚ïë  üíæ Auto-save Draft & Character Counters                     ‚ïë
        ‚ïë  üîç Date-wise Filtering & Footer with Date/Time              ‚ïë
        ‚ïë  ‚ú® Justified Text & Better Alignment                        ‚ïë
        ‚ïë  ‚úÖ Submit Success Animation & Clickable Stats               ‚ïë
        ‚ïë  ‚úÖ Times New Roman PDF Font & Current Posting Fix           ‚ïë
        ‚ïë  üö´ UNDEFINED VALUES FIXED - NO MORE "undefined" IN PDFs     ‚ïë
        ‚ïë                                                              ‚ïë
        ‚ïë  Keyboard Shortcuts:                                         ‚ïë
        ‚ïë  ‚Ä¢ Ctrl + S: Save Draft                                      ‚ïë
        ‚ïë  ‚Ä¢ Ctrl + Enter: Submit Form                                 ‚ïë
        ‚ïë                                                              ‚ïë
        ‚ïë  Debug: debugFeedback.testPDF() to test PDF                 ‚ïë
        ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
        `);

        console.log('üéâ Complete National Summit Feedback System loaded successfully');
        console.log('üí° All Features: UNDEFINED VALUES FIXED, reduced margins, centered headers, justified text, sky blue admin panel, Poppins font, sentence case, Times New Roman PDF font, submit animation, clickable stats.');
        console.log('üîß Use debugFeedback.testPDF() to test PDF generation with comprehensive sample data');
        console.log('üõ†Ô∏è Key Fixes Applied:');
        console.log('   ‚úÖ getFormValue() function prevents undefined values');
        console.log('   ‚úÖ safeGetValue() handles both camelCase and snake_case');
        console.log('   ‚úÖ mapDatabaseToFormData() maps database fields correctly');
        console.log('   ‚úÖ All PDF generation uses safe data access');
        console.log('   ‚úÖ Form submission uses proper data collection');
        console.log('   ‚úÖ Preview function uses safe data collection');
    </script>
</body>
</html>


