<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Excel to Supabase Data Portal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f0f2f5; color: #333; }
        .header-bg { background-color: #007bff; color: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .container-main { padding-top: 2rem; padding-bottom: 2rem; max-width: 900px; }
        .card { border-radius: 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: none; }
        .card-header { background-color: #f8f9fa; border-bottom: 1px solid #e9ecef; }
        .form-section { display: none; }
        .form-row { margin-bottom: 1rem; }
        .save-btn-container { margin-top: 1.5rem; }
        .header-list-item { font-family: 'Courier New', Courier, monospace; font-size: 1.1rem; background-color: #e9ecef; border-radius: 5px; padding: 8px 12px; margin-bottom: 5px; }
        .modal-footer .btn { min-width: 120px; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg header-bg fixed-top">
    <div class="container container-main">
        <a class="navbar-brand text-white fw-bold" href="#">
            <img src="https://supabase.com/brand-assets/supabase-logo-icon.png" alt="Supabase Logo" width="28" height="28" class="d-inline-block align-text-top">
            Excel Data Portal
        </a>
        <div class="ms-auto">
            <button class="btn btn-outline-light d-none d-md-inline-block" type="button">Dashboard</button>
            <button class="btn btn-outline-light d-none d-md-inline-block" type="button">Profile</button>
        </div>
    </div>
</nav>

<div class="container container-main" style="margin-top: 80px;">
    <div class="row justify-content-center">
        <div class="col-12">
            <div class="card p-4">
                <h2 class="text-center mb-4 text-primary fw-bold">Data Import & Entry Workflow</h2>

                <div class="mb-4">
                    <div class="card-header bg-light rounded-top p-3">
                        <h5 class="mb-0 fw-semibold">Step 1: Upload & Confirm Data Headers</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">Select your Excel file (.xlsx or .xls) to begin. The first row will be used as the column headers. No data rows from the file will be inserted into the table — only blank fillable forms will be generated for manual entry.</p>
                        <div class="input-group">
                            <input type="file" class="form-control" id="excel-file-input" accept=".xlsx, .xls">
                            <button class="btn btn-primary fw-semibold" type="button" id="process-file-btn">
                                Process File
                                <span id="loading-spinner" class="spinner-border spinner-border-sm ms-2" role="status" aria-hidden="true" style="display:none;"></span>
                            </button>
                        </div>
                    </div>
                </div>

                <div id="form-container" class="form-section">
                    <div class="card-header bg-light rounded-top p-3">
                        <h5 class="mb-0 fw-semibold">Step 3: Data Entry Forms</h5>
                    </div>
                    <div class="card-body" id="forms-body">
                        <p class="text-muted">Editable blank forms based on the file headers will appear here after you create the Supabase table.</p>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="supabaseModal" tabindex="-1" aria-labelledby="supabaseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold" id="supabaseModalLabel">Step 2: Confirm Headers & Create Table</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">We've detected the following columns in your Excel file. Please review them carefully.</p>
                <div class="list-group" id="header-list"></div>
                <div class="alert alert-warning mt-4" role="alert">
                    <strong>Security Warning:</strong> This operation creates a new table. For production, run this on a secure backend.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success fw-semibold" id="run-script-btn">Create Supabase Table</button>
            </div>
        </div>
    </div>
</div>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<script>
    // Use a local client variable to avoid shadowing the global 'supabase' name
    const supabaseUrl = 'https://txjbfqrbbtvzlxpeegkv.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4amJmcXJiYnR2emx4cGVlZ2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMTU2NTQsImV4cCI6MjA2ODY5MTY1NH0.sE5UbwEOSnd9ED-k_Ix5OfdZbf7dmwlHZSjQQrEAyCo';
    const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

    // Global storage
    let currentTableName = '';
    let currentHeaders = [];

    // UI elements
    const excelFileInput = document.getElementById('excel-file-input');
    const processFileBtn = document.getElementById('process-file-btn');
    const loadingSpinner = document.getElementById('loading-spinner');
    const supabaseModal = new bootstrap.Modal(document.getElementById('supabaseModal'));
    const runScriptBtn = document.getElementById('run-script-btn');
    const formContainer = document.getElementById('form-container');
    const formsBody = document.getElementById('forms-body');
    const headerList = document.getElementById('header-list');

    function resetUI() {
        loadingSpinner.style.display = 'none';
        processFileBtn.disabled = false;
    }

    // Helper: sanitize string to valid postgres identifier (letters, numbers, underscore), lowercased
    function sanitizeIdentifier(str) {
        return String(str || '')
            .trim()
            .replace(/\.[^/.]+$/, '') // remove extension if present
            .replace(/\s+/g, '_')
            .replace(/[^a-zA-Z0-9_]/g, '')
            .toLowerCase();
    }

    // PROCESS FILE: read headers and set table name from file name (sanitized)
    processFileBtn.addEventListener('click', () => {
        const file = excelFileInput.files[0];
        if (!file) {
            alert('Please select an Excel file first.');
            return;
        }

        loadingSpinner.style.display = 'inline-block';
        processFileBtn.disabled = true;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                if (jsonData.length === 0 || jsonData[0].length === 0) {
                    alert('The Excel file is empty or has no headers.');
                    resetUI();
                    return;
                }

                // Use first row as headers
                currentHeaders = jsonData[0].map(h => String(h || '').trim());

                // Table name derived from file name (without extension), sanitized
                currentTableName = sanitizeIdentifier(file.name);
                if (!currentTableName) {
                    // fallback if name becomes empty after sanitization
                    currentTableName = `excel_import_${Date.now()}`;
                }

                headerList.innerHTML = currentHeaders.map(header =>
                    `<div class="list-group-item header-list-item">${header}</div>`
                ).join('');

                // show modal to confirm
                supabaseModal.show();
            } catch (error) {
                console.error('Error processing Excel file:', error);
                alert('Could not process the Excel file. Please ensure it is a valid .xlsx or .xls file.');
            } finally {
                resetUI();
            }
        };

        reader.onerror = () => {
            alert('An error occurred while reading the file.');
            resetUI();
        };

        reader.readAsArrayBuffer(file);
    });

    // CREATE TABLE: create table with columns from headers; do NOT insert any file rows
    runScriptBtn.addEventListener('click', async () => {
        runScriptBtn.disabled = true;
        try {
            const createTableScript = generateCreateTableScript(currentTableName, currentHeaders);

            // Call your RPC that executes SQL; ensure it's present and secured as discussed previously.
            const { data, error } = await supabaseClient.rpc('execute_sql_script', { sql_text: createTableScript });

            if (error) throw error;

            alert(`Table "${currentTableName}" created successfully! Now generating blank forms.`);
            supabaseModal.hide();
            generateBlankForms(currentTableName, currentHeaders);
            formContainer.style.display = 'block';
        } catch (error) {
            console.error('Error executing script:', error);
            alert(`Failed to create table. Error: ${error.message || error}`);
            supabaseModal.hide();
        } finally {
            runScriptBtn.disabled = false;
        }
    });

    function generateCreateTableScript(tableName, headers) {
        // Ensure column names are sanitized and unique
        const seen = new Set();
        const columns = headers.map((header, i) => {
            let col = String(header || `column_${i+1}`).trim();
            col = col.replace(/[^a-zA-Z0-9_]/g, '');
            if (!col) col = `column_${i+1}`;
            // avoid duplicates
            let base = col;
            let suffix = 1;
            while (seen.has(col.toLowerCase())) {
                col = `${base}_${suffix++}`;
            }
            seen.add(col.toLowerCase());
            return `"${col}" TEXT`;
        });
        const columnsDefinition = columns.join(', ');
        return `CREATE TABLE IF NOT EXISTS public."${tableName}" (${columnsDefinition});`;
    }

    // Generate blank, fillable forms based on headers only (do NOT pre-fill from file data)
    function generateBlankForms(tableName, headers) {
        formsBody.innerHTML = '';
        // create a single form for manual entry, or create one empty form per header set as user prefers.
        // We'll create one blank form where user can enter values and save — can be extended to multiple records.
        const formWrapper = document.createElement('div');
        formWrapper.className = 'card mb-3';
        formWrapper.innerHTML = `
            <div class="card-body">
                <h6 class="card-title text-success fw-semibold">New Record (Table: ${tableName})</h6>
                <form id="data-form-blank"></form>
                <div class="save-btn-container text-end">
                    <button type="button" class="btn btn-success btn-sm" id="save-record-blank-btn">Save Record</button>
                </div>
            </div>
        `;
        formsBody.appendChild(formWrapper);

        const formEl = document.getElementById('data-form-blank');
        headers.forEach((header, colIndex) => {
            const formRow = document.createElement('div');
            formRow.className = 'form-row';
            const label = document.createElement('label');
            label.textContent = `${header || `Column ${colIndex+1}`}:`;
            label.className = 'form-label text-muted';
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-control';
            // use sanitized column name as input name to match DB column
            let colName = String(header || `column_${colIndex+1}`).trim().replace(/[^a-zA-Z0-9_]/g, '');
            if (!colName) colName = `column_${colIndex+1}`;
            input.name = colName;
            input.value = ''; // intentionally blank (no file data inserted)
            formRow.appendChild(label);
            formRow.appendChild(input);
            formEl.appendChild(formRow);
        });

        // Save button handler: insert the manually-entered record into the created table
        document.getElementById('save-record-blank-btn').addEventListener('click', async () => {
            const form = document.getElementById('data-form-blank');
            const recordData = {};
            form.querySelectorAll('input').forEach(input => {
                // send empty strings as null? keep as-is — user choice. Here keep as entered.
                recordData[input.name] = input.value;
            });

            try {
                const { data, error } = await supabaseClient.from(tableName).insert([recordData]);
                if (error) throw error;
                alert('Record saved successfully!');
                // Optionally clear form after successful save:
                form.querySelectorAll('input').forEach(i => i.value = '');
            } catch (error) {
                console.error('Error saving record:', error);
                alert(`Failed to save record. Error: ${error.message || error}`);
            }
        });
    }

</script>
</body>
</html>
